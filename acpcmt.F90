#include "attr.h"
SUBROUTINE ACPCMT ( KIDIA,KFDIA,KLON,KTDIA,KLEV,KTRA,&
  !-----------------------------------------------------------------------
  ! - INPUT  2D .
  & PALPH,PAPHI,PAPHIF,PAPRS,PAPRSF,PCP,PLH,PR,&
  & PDELP,PLNPR,&
  & PQ,PQI,PQL,PRR,PS,PQLIS,PQSAT,PQW,&
  & PRDELP,PCVGQ,PT,PTW,PU,PV,PTKE,PTRA,&
  & PQLCONV, PQICONV , PQRCONV, PQSCONV, &
  ! - INPUT 1D .
  & PGM, PTS, PQS, PNEIJ, PLSM, PVETAF, &
  ! - OUTPUT 2D .
  & PDIFCQ,PDIFCQL,PDIFCQI,PDIFCQLC,PDIFCQIC,PDIFCS,PDIFCTH,&
  & PFCCQL,PFCCQN,PSTRCU,PSTRCV,PSTRCTRA,&
  & PFIMCC,PFPEVPCL,PFPEVPCN,&
  & PFPLCL,PFPLCN,PMF_UP,&
  & PFPFPCL,PFPFPCN,&
  & PFEDQLC, PFEDQIC, PFEDQRC, PFEDQSC,&
  & PFCNEGQLC,PFCNEGQIC,PFCNEGQRC,PFCNEGQSC, &
  & KNLAB,&
  & PNEBC,PQLIC,PTU,PQU,PQC_DET_PCMT,PCSGC, &
  ! - OUTPUT 1D .
  & KNND, PCAPE,PAIPCMT,PALF_CAPE,PALF_CVGQ,&
  ! - INPUT/OUTPUT 2D .
  & PUDAL,PUDOM,PDDAL,PDDOM, KSTACK, PSTACK, KPSTSZ, KKSTSZ, KPSTPT, KKSTPT)

!**** *ACPCMT * - PCMT CONVECTION SCHEME.

! SUJET.
!     ------

!**   INTERFACE.
!     ----------
!        *CALL* *ACPCMT*
!-----------------------------------------------------------------------
! -   INPUT ARGUMENTS.
!     ----------------

! - PHYSICS DIMENSIONNING PARAMETERS

! KIDIA      : INDICE DE DEPART DES BOUCLES VECTORISEES SUR L'HORIZONT..
! KFDIA      : INDICE DE FIN DES BOUCLES VECTORISEES SUR L'HORIZONTALE.
! KLON       : DIMENSION HORIZONTALE DES TABLEAUX.
! KTDIA      : INDICE DE DEPART DES BOUCLES VERTICALES (1 EN GENERAL).
! KLEV       : DIMENSION VERTICALE DES TABLEAUX "FULL LEVEL".
! KTRA       : NUMBER OF TRACERS (PASSIVE VARIABLES)

! - PHYSICS VARIABLES (ALPHABETICALLY IN EACH CATEGORY)

! - 2D (0:KLEV) .

! PAPHI      : HALF LEVEL GEOPOTENTIAL
! PAPRS      : HALF LEVEL PRESSURE

! - 2D (1:KLEV) .

! PALPH      : LOG(PAPRS(JLEV)/PAPRSF(JLEV)) (FOR HYDROSTATIC MODEL).
! PAPHIF     : FULL LEVEL GEOPOTENTIAL
! PAPRSF     : FULL LEVEL PRESSURE
! PCP        : CHALEUR MASSIQUE A PRESSION CONSTANTE DE L'AIR.
! PR         : CONSTANTE DE L'AIR HUMIDE.
! PDELP      : PRESSURE DIFFERENCE OVER THE LAYER
! PLNPR      : LOG(PAPRS(JLEV)/PAPRS(JLEV-1)) (POUR L'HYDROSTATIQUE).
! PQ         : MICROPHYSICAL WATER VAPOUR SPECIFIC HUMIDITY
! PQI        : MICROPHYSICAL RESOLVED CLOUD ICE SPECIFIC CONTENT
! PQL        : MICROPHYSICAL RESOLVED CLOUD LIQUID SPECIFIC CONTENT
! PRR        : MICROPHYSICAL RESOLVED RAIN LIQUID SPECIFIC CONTENT
! PS         : MICROPHYSICAL RESOLVED RAIN ICE SPECIFIC CONTENT
! PQLIS      : MICROPHYSICAL RESOLVED CLOUD WATER SPECIFIC CONTENT IN THE TIME-STEP
! PQSAT      : SATURATION SPECIFIC MOISTURE
! PQW        : WET BULB SPECIFIC MOISTURE
! PRDELP     : INVERSE DE L'EPAISSEUR EN PRESSION DE LA COUCHE.
! PCVGQ      : CONVERGENCE D'HUMIDITE.
! PT         : TEMPERATURE.
! PTW        : WET BULB TEMPERATURE.
! PU         : U WIND COMPONENT
! PV         : V WIND COMPONENT
! PTKE       : TKE
! PTRA       : TRACER CONCENTRATION

! - 2D (0:KLEV) .

! - 1D .

! PGM        : FACTEUR D'ECHELLE.
! PTS        : SURFACE LAYER TEMPERATURE.
! PQS        : SURFACE LAYER WATER VAPOUR.
! PNEIJ      : FRACTION OF SOIL COVERED BY SNOW.
! PLSM       : LAND/SEA MASK.
! PVETAF     : VERTICAL COORDINATE.

!-----------------------------------------------------------------------

! -   OUTPUT ARGUMENTS
!     ----------------

! - 2D (0:KLEV) .

! PQLCONV    : LIQUID WATER (CONVECTIVE).
! PQICONV    : ICE    WATER (CONVECTIVE).
! PQRCONV    : RAIN   WATER (CONVECTIVE).
! PQSCONV    : SNOW   WATER (CONVECTIVE).
! PDIFCQ     : FLUX CONVECTIF D'HUMIDITE SPECIFIQUE (HORS PLUIE/NEIGE).
! PDIFCQ     : CONVECTIVE FLUX OF SPECIFIC HUMIDITY (NOT RAIN/SNOW).
! PDIFCQI    : FLUX CONVECTIF D'EAU SOLIDE (HORS PLUIE/NEIGE).
! PDIFCQI    : CONVECTIVE FLUX OF SOLID WATER (NOT RAIN/SNOW).
! PDIFCQL    : FLUX CONVECTIF D'EAU LIQUIDE (HORS PLUIE/NEIGE).
! PDIFCQL    : CONVECTIVE FLUX OF LIQUID WATER (NOT RAIN/SNOW).
! PDIFCQLC   : CONVECTIVE TRANSPORT FLUX OF QLC (LIQUID CONVECTIVE).
! PDIFCQIC   : CONVECTIVE TRANSPORT FLUX OF QIC (ICE CONVECTIVE).
! PDIFCS     : DRY STATIC ENERGY CONVECTIVE FLUX
! PDIFCTH    : THETA CONVECTIVE FLUX
! PFCCQL     : LIQUID CONDENSATION FLUX FROM THE CONVECTIVE UPDRAFT
! PFCCQN     : SOLID CONDENSATION FLUX FROM THE CONVECTIVE UPDRAFT
! PSTRCU     : U-MOMENTUM CONVECTIVE SPECIFIC MOISTURE FLUX
! PSTRCV     : V-MOMENTUM CONVECTIVE SPECIFIC MOISTURE FLUX
! PSTRCTRA   : TRACER CONVECTIVE FLUX
! PFHMLTS    : FLUX DE CHALEUR DU A LA FONTE/GEL.
! PFPEVPCL    : EVAPORATION DES PRECIPITATIONS LIQUIDES.
! PFPEVPCN    : EVAPORATION DES PRECIPITATIONS NEIGEUSES.
! PFPLCL     : PRECIPITATIONS CONVECTIVES SOUS FORME LIQUIDE.
! PFPLCN     : PRECIPITATIONS CONVECTIVES SOUS FORME NEIGE.
! PFPFPCL    : FLUX OF CONVECTIVE PRECIPITATION : THE GENERATION TERM.
! PFPFPCN    : FLUX OF CONVECTIVE PRECIPITATION : THE GENERATION TERM.

! - 2D (1:KLEV) .

! PNEBC  : CONVECTIVE CLOUDINESS.
! PQLIC  : CONVECTIVE CONDENSATE.
! PTU    : TEMPERATURE OF THE CLOUDY ASCENT.
! PQU    : WATER VAPOUR SPECIFIC HUMIDITY OF THE CLOUDY ASCENT.
! PQC_DET_PCMT : CLOUD CONDENSATE (QL+QI) DETRAINED BY PCMT CONVECTION.
! KNLAB  : CONVECTIVE ACTIVITY INDEX (ACTIVE IF EQUAL TO ONE).

! - 1D (DIAGNOSTIQUE) .

! KNND   : ZERO WHENEVER A NON PHYSICAL SITUATION OCCURS, ONE OTHERWISE
! PCAPE  : CAPE (CONDITIONAL AVAILABLE POTENTIAL ENERGY).
! PAIPCMT  : ACTIVITY INDEX OF PCMT: 1. IF PCMT IS ACTIVE, 0. ELSE CASE.

!-----------------------------------------------------------------------

! -   INPUT/OUTPUT ARGUMENTS
!     ----------------------

! - 2D (0:KLEV) .

! - 2D (1:KLEV) .

! PUDAL    : PROGNOSTIC UPDRAFT MESH FRACTION
! PUDOM    : PROGNOSTIC UPDRAFT RELATIVE VELOCITY
! PDDAL    : PROGNOSTIC DOWNDRAFT MESH FRACTION
! PDDOM    : PROGNOSTIC DOWNDRAFT RELATIVE VELOCITY

!-----------------------------------------------------------------------

! METHOD.
!     --------

! AUTHOR.
!     -------
! 2011-12-12, J.M. PIRIOU AND J.F. GUEREMY.

! MODIFICATIONS.
!     --------------
! 2014-04---, D. SAINT-MARTIN : tracer transport.
! 2015-02---, I. BEAU: bugfix (argument PDDOM)
! 2015-09---, J.M PIRIOU: phasing of NWP and CLimate versions
! 2015-11---, J.F. Gueremy: explicit transport flux for the dry air potential temperature
! 2017-06---, J.M. Piriou: replace NTPLUI by KTDIA.

!-----------------------------------------------------------------------


USE PARKIND1, ONLY : JPIM, JPRB

USE YOMCST   , ONLY : RG, RCPD, RCS, RCW, RALPD, RALPS,RALPW,RBETD,RBETS, &
  & RBETW,RCPV,RDT,RETV,RGAMD,RGAMS,RGAMW,RLSTT,RLVTT,RTT,RV
USE YOMPHY0  , ONLY : YRPHY0
USE YOMPHY2  , ONLY : YRPHY2

USE YOMPHY   , ONLY : YRPHY
USE YOMSCM   , ONLY : NFRSCM
USE YOMCT3   , ONLY : NSTEP

IMPLICIT NONE

!     DUMMY ARGUMENTS.

INTEGER(KIND=JPIM), INTENT(IN) :: KFDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KIDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KLEV
INTEGER(KIND=JPIM), INTENT(IN) :: KLON
INTEGER(KIND=JPIM), INTENT(IN) :: KTDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KTRA

REAL(KIND=JPRB), INTENT(IN)    :: PALPH(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPHI(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPHIF(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPRS(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPRSF(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PCP(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PLH(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PR(KLON,KLEV)

REAL(KIND=JPRB), INTENT(IN)    :: PDELP(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PLNPR(KLON,KLEV)

REAL(KIND=JPRB), INTENT(IN)    :: PQ(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQI(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQL(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PS(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PRR(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQLIS(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQSAT(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQW(KLON,KLEV)

REAL(KIND=JPRB), INTENT(IN)    :: PRDELP(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PCVGQ(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PT(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PTW(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PU(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PV(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PTKE(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PTRA(KLON, KLEV, KTRA)

REAL(KIND=JPRB), INTENT(IN)    :: PQLCONV(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQICONV(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQRCONV(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQSCONV(KLON,KLEV)

REAL(KIND=JPRB), INTENT(IN)    :: PGM(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PTS(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PQS(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PNEIJ(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PLSM(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PVETAF(KLEV)

REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQ(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQI(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQLC(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQIC(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCS(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCTH(KLON,0:KLEV)

REAL(KIND=JPRB), INTENT(INOUT)   :: PFCCQL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFCCQN(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCU(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCV(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PMF_UP(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCTRA(KLON, 0:KLEV, KTRA)

REAL(KIND=JPRB), INTENT(INOUT)   :: PFIMCC(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPEVPCL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPEVPCN(KLON,0:KLEV)

REAL(KIND=JPRB), INTENT(INOUT)   :: PFPLCL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPLCN(KLON,0:KLEV)

REAL(KIND=JPRB), INTENT(INOUT)   :: PFPFPCL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPFPCN(KLON,0:KLEV)

REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEDQLC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEDQIC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEDQRC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEDQSC(KLON,0:KLEV)

REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQLC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQIC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQRC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQSC(KLON,0:KLEV)

INTEGER(KIND=JPIM), INTENT(INOUT) :: KNLAB(KLON,KLEV)
INTEGER(KIND=JPIM), INTENT(INOUT) :: KNND(KLON)

REAL(KIND=JPRB), INTENT(OUT)   :: PNEBC(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PQLIC(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PTU(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PQU(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PQC_DET_PCMT(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PCSGC(KLON,KLEV)

REAL(KIND=JPRB), INTENT(OUT)   :: PCAPE(KLON)
REAL(KIND=JPRB), INTENT(OUT)   :: PAIPCMT(KLON)

REAL(KIND=JPRB), INTENT(OUT)   :: PALF_CAPE(KLON)
REAL(KIND=JPRB), INTENT(OUT)   :: PALF_CVGQ(KLON)

REAL(KIND=JPRB), INTENT(INOUT) :: PUDAL(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT) :: PUDOM(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT) :: PDDAL(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT) :: PDDOM(KLON,KLEV)
REAL(KIND=JPRB),   INTENT(OUT)   :: PSTACK (KLON, KPSTSZ)
INTEGER(KIND=JPIM),INTENT(OUT)   :: KSTACK (KLON, KKSTSZ)
INTEGER(KIND=JPIM),INTENT(IN)    :: KPSTSZ, KKSTSZ, KPSTPT, KKSTPT


! LOCALS.

REAL(KIND=JPRB)   :: ZTCVIM
REAL(KIND=JPRB)   :: ZICE

     ! downdraft vertical velocity

! ZENTR_U    : ENTRAINEMENT DANS L'UPDRAFT.
! ZDETR_U    : DETRAINEMENT DE L'UPDRAFT.
! ZENTR_D    : ENTRAINEMENT DANS LE DOWNDRAFT.
! ZDETR_D    : DETRAINEMENT DU DOWNDRAFT.






REAL(KIND=JPRB)   :: ZQLCONVPREC
     ! updraft vertical velocity

INTEGER(KIND=JPIM) :: JLEV,JLON,INEBC,IQLIC,IQLIC_MICRO,JTRA
     ! compensating vertical velocity due to the updraft and downdraft
     ! vertical velocity for cloud transport

! ZFHEVPPC   : FLUX DE CHALEUR DU A L'EVAPORATION DES PREC. CONVECTIVES.
! ZFHMLTSC   : FLUX DE CHALEUR DU A LA FONTE/GEL DES PREC. CONVECTIVES.

! ZQLIC_MICRO: convective condensate, to be used in microphysics (evaporation, etc).
! ZNEBC_MICRO: convective cloudiness, to be used in microphysics (evaporation, etc).


 ! QLC+QIC+QRC+QSC, FOR USE IN THE XU-RANDALL CLOUDINESS.
REAL(KIND=JPRB) :: ZCCHSL,ZCCHSN,ZEPS
!REAL(KIND=JPRB) :: ZMAX(KLON)

#include "abor1.intfb.h"

 ! Temperature for microphysics
 ! Specific moisture for microphysics
 ! Evaporation from previous time step.
 ! Energie statique seche de l'updraft.
 ! Prognostic active surface fraction.
REAL(KIND=JPRB) :: ZFRACP,ZTH

LOGICAL         :: LLADJCLD
INTEGER(KIND=JPIM) :: IPSTPT_ZALF

INTEGER(KIND=JPIM) :: IPSTPT_ZSU

INTEGER(KIND=JPIM) :: IPSTPT_ZEVAPO

INTEGER(KIND=JPIM) :: IPSTPT_ZQMIC

INTEGER(KIND=JPIM) :: IPSTPT_ZTMIC

INTEGER(KIND=JPIM) :: IPSTPT_ZTMPVAR

INTEGER(KIND=JPIM) :: IPSTPT_ZDEPTH

INTEGER(KIND=JPIM) :: IPSTPT_ZQ_COND_XR96

INTEGER(KIND=JPIM) :: IPSTPT_ZQICED

INTEGER(KIND=JPIM) :: IPSTPT_ZQLCED

INTEGER(KIND=JPIM) :: IPSTPT_ZDAL

INTEGER(KIND=JPIM) :: IPSTPT_ZNEBC_MICRO

INTEGER(KIND=JPIM) :: IPSTPT_ZQLIC_MICRO

INTEGER(KIND=JPIM) :: IPSTPT_ZFHMLTSC

INTEGER(KIND=JPIM) :: IPSTPT_ZFHEVPPC

INTEGER(KIND=JPIM) :: IPSTPT_ZFCCQNTMP

INTEGER(KIND=JPIM) :: IPSTPT_ZW_CONV

INTEGER(KIND=JPIM) :: IPSTPT_ZW_COMPENS

INTEGER(KIND=JPIM) :: IPSTPT_ZQLC

INTEGER(KIND=JPIM) :: IPSTPT_ZUDW

INTEGER(KIND=JPIM) :: IPSTPT_ZQIC

INTEGER(KIND=JPIM) :: IPSTPT_ZQSC

INTEGER(KIND=JPIM) :: IPSTPT_ZFCCQLTMP

INTEGER(KIND=JPIM) :: IPSTPT_ZDETR_D

INTEGER(KIND=JPIM) :: IPSTPT_ZENTR_D

INTEGER(KIND=JPIM) :: IPSTPT_ZDETR_D_RS

INTEGER(KIND=JPIM) :: IPSTPT_ZDETR_U_RS

INTEGER(KIND=JPIM) :: IPSTPT_ZDETR_U

INTEGER(KIND=JPIM) :: IPSTPT_ZENTR_U

INTEGER(KIND=JPIM) :: IPSTPT_ZUDQC

INTEGER(KIND=JPIM) :: IPSTPT_ZDDW

INTEGER(KIND=JPIM) :: IPSTPT_ZQRC

INTEGER(KIND=JPIM) :: IPSTPT_ZEROV

INTEGER(KIND=JPIM) :: IPSTPT, IKSTPT


#include "acmtud.intfb.h"
#include "fcttrm.func.h"
#include "fctdoi.func.h"




IPSTPT = KPSTPT

IKSTPT = KKSTPT

IPSTPT_ZEROV = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQRC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDDW = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZUDQC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZENTR_U = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDETR_U = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDETR_U_RS = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDETR_D_RS = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZENTR_D = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDETR_D = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZFCCQLTMP = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZQSC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQIC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZUDW = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQLC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZW_COMPENS = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZW_CONV = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZFCCQNTMP = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZFHEVPPC = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZFHMLTSC = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZQLIC_MICRO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZNEBC_MICRO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDAL = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZQLCED = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQICED = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQ_COND_XR96 = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDEPTH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTMPVAR = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTMIC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQMIC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZEVAPO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZSU = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZALF = IPSTPT

IPSTPT = IPSTPT + 1

IF (IPSTPT > KPSTSZ) CALL ABOR1 

IF (IKSTPT > KKSTSZ) CALL ABOR1 
ZEPS=1.E-12_JPRB
ZCCHSL=RCW-RCPD
ZCCHSN=RCS-RCPD
DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PFIMCC(JLON,JLEV)= 0._JPRB
ENDDO
ENDDO

DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDAL)= 0._JPRB
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PQC_DET_PCMT(JLON,JLEV)= 0._JPRB
ENDDO
ENDDO


DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZEVAPO+JLEV-(1))= 0._JPRB
ENDDO
ENDDO

IF(YRPHY0%LCVNHD) THEN
  ! Evaporation from previous time step is got from the PDDAL buffer.
  DO JLEV = KTDIA, KLEV
  DO JLON = KIDIA, KFDIA
  PSTACK (JLON, IPSTPT_ZEVAPO+JLEV-(1))=PDDAL(JLON,JLEV)
  ENDDO
  ENDDO
ENDIF

! UDPDRAFT.
CALL ACMTUD ( KIDIA,KFDIA,KLON,KTDIA,KLEV,KTRA, PALPH, PAPHI, PAPHIF, PAPRS,      &
& PAPRSF, PCP,PLH, PR, PDELP, PLNPR, PQ, PQI, PQL, PQLIS, PQSAT, PQW, PRDELP,     &
& PCVGQ,PT, PTW, PU, PV, PTKE, PTRA,PSTACK (1, IPSTPT_ZEVAPO), PGM,PTS,PQS,       &
& PDIFCQ, PDIFCQL, PDIFCQI, PDIFCS, PDIFCTH, PFCCQL, PFCCQN, PSTRCU, PSTRCV,      &
& PSTRCTRA, PSTACK (1, IPSTPT_ZFHMLTSC),PSTACK (1, IPSTPT_ZFHEVPPC),PFPEVPCL,     &
& PFPEVPCN, PFPLCL,PFPLCN,PMF_UP, PNEBC,PQLIC,PTU,PQU,PSTACK (1, IPSTPT_ZSU),     &
& KNLAB,PSTACK (1, IPSTPT_ZENTR_U),PSTACK (1, IPSTPT_ZDETR_U),                    &
& PSTACK (1, IPSTPT_ZENTR_D),PSTACK (1, IPSTPT_ZDETR_D), KNND,PCAPE,              &
& PSTACK (1, IPSTPT_ZALF), PALF_CAPE, PALF_CVGQ, PUDAL,PUDOM,PDDAL,PDDOM, KSTACK, &
& PSTACK, KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)

END SUBROUTINE
