#include "attr.h"
SUBROUTINE ACPCMT ( KIDIA,KFDIA,KLON,KTDIA,KLEV,KTRA,&
  !-----------------------------------------------------------------------
  ! - INPUT  2D .
  & PALPH,PAPHI,PAPHIF,PAPRS,PAPRSF,PCP,PLH,PR,&
  & PDELP,PLNPR,&
  & PQ,PQI,PQL,PRR,PS,PQLIS,PQSAT,PQW,&
  & PRDELP,PCVGQ,PT,PTW,PU,PV,PTKE,PTRA,&
  & PQLCONV, PQICONV , PQRCONV, PQSCONV, &
  ! - INPUT 1D .
  & PGM, PTS, PQS, PNEIJ, PLSM, PVETAF, &
  ! - OUTPUT 2D .
  & PDIFCQ,PDIFCQL,PDIFCQI,PDIFCQLC,PDIFCQIC,PDIFCS,PDIFCTH,&
  & PFCCQL,PFCCQN,PSTRCU,PSTRCV,PSTRCTRA,&
  & PFIMCC,PFPEVPCL,PFPEVPCN,&
  & PFPLCL,PFPLCN,PMF_UP,&
  & PFPFPCL,PFPFPCN,&
  & PFEDQLC, PFEDQIC, PFEDQRC, PFEDQSC,&
  & PFCNEGQLC,PFCNEGQIC,PFCNEGQRC,PFCNEGQSC, &
  & KNLAB,&
  & PNEBC,PQLIC,PTU,PQU,PQC_DET_PCMT,PCSGC, &
  ! - OUTPUT 1D .
  & KNND, PCAPE,PAIPCMT,PALF_CAPE,PALF_CVGQ,&
  ! - INPUT/OUTPUT 2D .
  & PUDAL,PUDOM,PDDAL,PDDOM, KSTACK, PSTACK, KPSTSZ, KKSTSZ, KPSTPT, KKSTPT)

!**** *ACPCMT * - PCMT CONVECTION SCHEME.

! SUJET.
!     ------

!**   INTERFACE.
!     ----------
!        *CALL* *ACPCMT*
!-----------------------------------------------------------------------
! -   INPUT ARGUMENTS.
!     ----------------

! - PHYSICS DIMENSIONNING PARAMETERS

! KIDIA      : INDICE DE DEPART DES BOUCLES VECTORISEES SUR L'HORIZONT..
! KFDIA      : INDICE DE FIN DES BOUCLES VECTORISEES SUR L'HORIZONTALE.
! KLON       : DIMENSION HORIZONTALE DES TABLEAUX.
! KTDIA      : INDICE DE DEPART DES BOUCLES VERTICALES (1 EN GENERAL).
! KLEV       : DIMENSION VERTICALE DES TABLEAUX "FULL LEVEL".
! KTRA       : NUMBER OF TRACERS (PASSIVE VARIABLES)

! - PHYSICS VARIABLES (ALPHABETICALLY IN EACH CATEGORY)

! - 2D (0:KLEV) .

! PAPHI      : HALF LEVEL GEOPOTENTIAL
! PAPRS      : HALF LEVEL PRESSURE

! - 2D (1:KLEV) .

! PALPH      : LOG(PAPRS(JLEV)/PAPRSF(JLEV)) (FOR HYDROSTATIC MODEL).
! PAPHIF     : FULL LEVEL GEOPOTENTIAL
! PAPRSF     : FULL LEVEL PRESSURE
! PCP        : CHALEUR MASSIQUE A PRESSION CONSTANTE DE L'AIR.
! PR         : CONSTANTE DE L'AIR HUMIDE.
! PDELP      : PRESSURE DIFFERENCE OVER THE LAYER
! PLNPR      : LOG(PAPRS(JLEV)/PAPRS(JLEV-1)) (POUR L'HYDROSTATIQUE).
! PQ         : MICROPHYSICAL WATER VAPOUR SPECIFIC HUMIDITY
! PQI        : MICROPHYSICAL RESOLVED CLOUD ICE SPECIFIC CONTENT
! PQL        : MICROPHYSICAL RESOLVED CLOUD LIQUID SPECIFIC CONTENT
! PRR        : MICROPHYSICAL RESOLVED RAIN LIQUID SPECIFIC CONTENT
! PS         : MICROPHYSICAL RESOLVED RAIN ICE SPECIFIC CONTENT
! PQLIS      : MICROPHYSICAL RESOLVED CLOUD WATER SPECIFIC CONTENT IN THE TIME-STEP
! PQSAT      : SATURATION SPECIFIC MOISTURE
! PQW        : WET BULB SPECIFIC MOISTURE
! PRDELP     : INVERSE DE L'EPAISSEUR EN PRESSION DE LA COUCHE.
! PCVGQ      : CONVERGENCE D'HUMIDITE.
! PT         : TEMPERATURE.
! PTW        : WET BULB TEMPERATURE.
! PU         : U WIND COMPONENT
! PV         : V WIND COMPONENT
! PTKE       : TKE
! PTRA       : TRACER CONCENTRATION

! - 2D (0:KLEV) .

! - 1D .

! PGM        : FACTEUR D'ECHELLE.
! PTS        : SURFACE LAYER TEMPERATURE.
! PQS        : SURFACE LAYER WATER VAPOUR.
! PNEIJ      : FRACTION OF SOIL COVERED BY SNOW.
! PLSM       : LAND/SEA MASK.
! PVETAF     : VERTICAL COORDINATE.

!-----------------------------------------------------------------------

! -   OUTPUT ARGUMENTS
!     ----------------

! - 2D (0:KLEV) .

! PQLCONV    : LIQUID WATER (CONVECTIVE).
! PQICONV    : ICE    WATER (CONVECTIVE).
! PQRCONV    : RAIN   WATER (CONVECTIVE).
! PQSCONV    : SNOW   WATER (CONVECTIVE).
! PDIFCQ     : FLUX CONVECTIF D'HUMIDITE SPECIFIQUE (HORS PLUIE/NEIGE).
! PDIFCQ     : CONVECTIVE FLUX OF SPECIFIC HUMIDITY (NOT RAIN/SNOW).
! PDIFCQI    : FLUX CONVECTIF D'EAU SOLIDE (HORS PLUIE/NEIGE).
! PDIFCQI    : CONVECTIVE FLUX OF SOLID WATER (NOT RAIN/SNOW).
! PDIFCQL    : FLUX CONVECTIF D'EAU LIQUIDE (HORS PLUIE/NEIGE).
! PDIFCQL    : CONVECTIVE FLUX OF LIQUID WATER (NOT RAIN/SNOW).
! PDIFCQLC   : CONVECTIVE TRANSPORT FLUX OF QLC (LIQUID CONVECTIVE).
! PDIFCQIC   : CONVECTIVE TRANSPORT FLUX OF QIC (ICE CONVECTIVE).
! PDIFCS     : DRY STATIC ENERGY CONVECTIVE FLUX
! PDIFCTH    : THETA CONVECTIVE FLUX
! PFCCQL     : LIQUID CONDENSATION FLUX FROM THE CONVECTIVE UPDRAFT
! PFCCQN     : SOLID CONDENSATION FLUX FROM THE CONVECTIVE UPDRAFT
! PSTRCU     : U-MOMENTUM CONVECTIVE SPECIFIC MOISTURE FLUX
! PSTRCV     : V-MOMENTUM CONVECTIVE SPECIFIC MOISTURE FLUX
! PSTRCTRA   : TRACER CONVECTIVE FLUX
! PFHMLTS    : FLUX DE CHALEUR DU A LA FONTE/GEL.
! PFPEVPCL    : EVAPORATION DES PRECIPITATIONS LIQUIDES.
! PFPEVPCN    : EVAPORATION DES PRECIPITATIONS NEIGEUSES.
! PFPLCL     : PRECIPITATIONS CONVECTIVES SOUS FORME LIQUIDE.
! PFPLCN     : PRECIPITATIONS CONVECTIVES SOUS FORME NEIGE.
! PFPFPCL    : FLUX OF CONVECTIVE PRECIPITATION : THE GENERATION TERM.
! PFPFPCN    : FLUX OF CONVECTIVE PRECIPITATION : THE GENERATION TERM.

! - 2D (1:KLEV) .

! PNEBC  : CONVECTIVE CLOUDINESS.
! PQLIC  : CONVECTIVE CONDENSATE.
! PTU    : TEMPERATURE OF THE CLOUDY ASCENT.
! PQU    : WATER VAPOUR SPECIFIC HUMIDITY OF THE CLOUDY ASCENT.
! PQC_DET_PCMT : CLOUD CONDENSATE (QL+QI) DETRAINED BY PCMT CONVECTION.
! KNLAB  : CONVECTIVE ACTIVITY INDEX (ACTIVE IF EQUAL TO ONE).

! - 1D (DIAGNOSTIQUE) .

! KNND   : ZERO WHENEVER A NON PHYSICAL SITUATION OCCURS, ONE OTHERWISE
! PCAPE  : CAPE (CONDITIONAL AVAILABLE POTENTIAL ENERGY).
! PAIPCMT  : ACTIVITY INDEX OF PCMT: 1. IF PCMT IS ACTIVE, 0. ELSE CASE.

!-----------------------------------------------------------------------

! -   INPUT/OUTPUT ARGUMENTS
!     ----------------------

! - 2D (0:KLEV) .

! - 2D (1:KLEV) .

! PUDAL    : PROGNOSTIC UPDRAFT MESH FRACTION
! PUDOM    : PROGNOSTIC UPDRAFT RELATIVE VELOCITY
! PDDAL    : PROGNOSTIC DOWNDRAFT MESH FRACTION
! PDDOM    : PROGNOSTIC DOWNDRAFT RELATIVE VELOCITY

!-----------------------------------------------------------------------

! METHOD.
!     --------

! AUTHOR.
!     -------
! 2011-12-12, J.M. PIRIOU AND J.F. GUEREMY.

! MODIFICATIONS.
!     --------------
! 2014-04---, D. SAINT-MARTIN : tracer transport.
! 2015-02---, I. BEAU: bugfix (argument PDDOM)
! 2015-09---, J.M PIRIOU: phasing of NWP and CLimate versions
! 2015-11---, J.F. Gueremy: explicit transport flux for the dry air potential temperature
! 2017-06---, J.M. Piriou: replace NTPLUI by KTDIA.

!-----------------------------------------------------------------------


USE PARKIND1, ONLY : JPIM, JPRB

USE YOMCST   , ONLY : RG, RCPD, RCS, RCW, RALPD, RALPS,RALPW,RBETD,RBETS, &
  & RBETW,RCPV,RDT,RETV,RGAMD,RGAMS,RGAMW,RLSTT,RLVTT,RTT,RV
USE YOMPHY0  , ONLY : YRPHY0
USE YOMPHY2  , ONLY : YRPHY2

USE YOMPHY   , ONLY : YRPHY
USE YOMSCM   , ONLY : NFRSCM
USE YOMCT3   , ONLY : NSTEP

IMPLICIT NONE

!     DUMMY ARGUMENTS.

INTEGER(KIND=JPIM), INTENT(IN) :: KFDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KIDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KLEV
INTEGER(KIND=JPIM), INTENT(IN) :: KLON
INTEGER(KIND=JPIM), INTENT(IN) :: KTDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KTRA

REAL(KIND=JPRB), INTENT(IN)    :: PALPH(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPHI(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPHIF(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPRS(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPRSF(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PCP(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PLH(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PR(KLON,KLEV)

REAL(KIND=JPRB), INTENT(IN)    :: PDELP(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PLNPR(KLON,KLEV)

REAL(KIND=JPRB), INTENT(IN)    :: PQ(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQI(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQL(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PS(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PRR(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQLIS(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQSAT(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQW(KLON,KLEV)

REAL(KIND=JPRB), INTENT(IN)    :: PRDELP(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PCVGQ(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PT(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PTW(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PU(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PV(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PTKE(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PTRA(KLON, KLEV, KTRA)

REAL(KIND=JPRB), INTENT(IN)    :: PQLCONV(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQICONV(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQRCONV(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQSCONV(KLON,KLEV)

REAL(KIND=JPRB), INTENT(IN)    :: PGM(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PTS(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PQS(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PNEIJ(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PLSM(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PVETAF(KLEV)

REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQ(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQI(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQLC(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQIC(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCS(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCTH(KLON,0:KLEV)

REAL(KIND=JPRB), INTENT(INOUT)   :: PFCCQL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFCCQN(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCU(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCV(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PMF_UP(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCTRA(KLON, 0:KLEV, KTRA)

REAL(KIND=JPRB), INTENT(INOUT)   :: PFIMCC(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPEVPCL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPEVPCN(KLON,0:KLEV)

REAL(KIND=JPRB), INTENT(INOUT)   :: PFPLCL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPLCN(KLON,0:KLEV)

REAL(KIND=JPRB), INTENT(INOUT)   :: PFPFPCL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPFPCN(KLON,0:KLEV)

REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEDQLC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEDQIC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEDQRC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFEDQSC(KLON,0:KLEV)

REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQLC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQIC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQRC(KLON,0:KLEV)
REAL(KIND=JPRB)   ,INTENT(INOUT) :: PFCNEGQSC(KLON,0:KLEV)

INTEGER(KIND=JPIM), INTENT(INOUT) :: KNLAB(KLON,KLEV)
INTEGER(KIND=JPIM), INTENT(INOUT) :: KNND(KLON)

REAL(KIND=JPRB), INTENT(OUT)   :: PNEBC(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PQLIC(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PTU(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PQU(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PQC_DET_PCMT(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PCSGC(KLON,KLEV)

REAL(KIND=JPRB), INTENT(OUT)   :: PCAPE(KLON)
REAL(KIND=JPRB), INTENT(OUT)   :: PAIPCMT(KLON)

REAL(KIND=JPRB), INTENT(OUT)   :: PALF_CAPE(KLON)
REAL(KIND=JPRB), INTENT(OUT)   :: PALF_CVGQ(KLON)

REAL(KIND=JPRB), INTENT(INOUT) :: PUDAL(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT) :: PUDOM(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT) :: PDDAL(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT) :: PDDOM(KLON,KLEV)
REAL(KIND=JPRB),   INTENT(OUT)   :: PSTACK (KLON, KPSTSZ)
INTEGER(KIND=JPIM),INTENT(OUT)   :: KSTACK (KLON, KKSTSZ)
INTEGER(KIND=JPIM),INTENT(IN)    :: KPSTSZ, KKSTSZ, KPSTPT, KKSTPT


! LOCALS.

REAL(KIND=JPRB)   :: ZTCVIM
REAL(KIND=JPRB)   :: ZICE

     ! downdraft vertical velocity

! ZENTR_U    : ENTRAINEMENT DANS L'UPDRAFT.
! ZDETR_U    : DETRAINEMENT DE L'UPDRAFT.
! ZENTR_D    : ENTRAINEMENT DANS LE DOWNDRAFT.
! ZDETR_D    : DETRAINEMENT DU DOWNDRAFT.






REAL(KIND=JPRB)   :: ZQLCONVPREC
     ! updraft vertical velocity

INTEGER(KIND=JPIM) :: JLEV,JLON,INEBC,IQLIC,IQLIC_MICRO,JTRA
     ! compensating vertical velocity due to the updraft and downdraft
     ! vertical velocity for cloud transport

! ZFHEVPPC   : FLUX DE CHALEUR DU A L'EVAPORATION DES PREC. CONVECTIVES.
! ZFHMLTSC   : FLUX DE CHALEUR DU A LA FONTE/GEL DES PREC. CONVECTIVES.

! ZQLIC_MICRO: convective condensate, to be used in microphysics (evaporation, etc).
! ZNEBC_MICRO: convective cloudiness, to be used in microphysics (evaporation, etc).


 ! QLC+QIC+QRC+QSC, FOR USE IN THE XU-RANDALL CLOUDINESS.
REAL(KIND=JPRB) :: ZCCHSL,ZCCHSN,ZEPS
!REAL(KIND=JPRB) :: ZMAX(KLON)

#include "abor1.intfb.h"

 ! Temperature for microphysics
 ! Specific moisture for microphysics
 ! Evaporation from previous time step.
 ! Energie statique seche de l'updraft.
 ! Prognostic active surface fraction.
REAL(KIND=JPRB) :: ZFRACP,ZTH

LOGICAL         :: LLADJCLD
INTEGER(KIND=JPIM) :: IPSTPT_ZALF

INTEGER(KIND=JPIM) :: IPSTPT_ZSU

INTEGER(KIND=JPIM) :: IPSTPT_ZEVAPO

INTEGER(KIND=JPIM) :: IPSTPT_ZQMIC

INTEGER(KIND=JPIM) :: IPSTPT_ZTMIC

INTEGER(KIND=JPIM) :: IPSTPT_ZTMPVAR

INTEGER(KIND=JPIM) :: IPSTPT_ZDEPTH

INTEGER(KIND=JPIM) :: IPSTPT_ZQ_COND_XR96

INTEGER(KIND=JPIM) :: IPSTPT_ZQICED

INTEGER(KIND=JPIM) :: IPSTPT_ZQLCED

INTEGER(KIND=JPIM) :: IPSTPT_ZDAL

INTEGER(KIND=JPIM) :: IPSTPT_ZNEBC_MICRO

INTEGER(KIND=JPIM) :: IPSTPT_ZQLIC_MICRO

INTEGER(KIND=JPIM) :: IPSTPT_ZFHMLTSC

INTEGER(KIND=JPIM) :: IPSTPT_ZFHEVPPC

INTEGER(KIND=JPIM) :: IPSTPT_ZFCCQNTMP

INTEGER(KIND=JPIM) :: IPSTPT_ZW_CONV

INTEGER(KIND=JPIM) :: IPSTPT_ZW_COMPENS

INTEGER(KIND=JPIM) :: IPSTPT_ZQLC

INTEGER(KIND=JPIM) :: IPSTPT_ZUDW

INTEGER(KIND=JPIM) :: IPSTPT_ZQIC

INTEGER(KIND=JPIM) :: IPSTPT_ZQSC

INTEGER(KIND=JPIM) :: IPSTPT_ZFCCQLTMP

INTEGER(KIND=JPIM) :: IPSTPT_ZDETR_D

INTEGER(KIND=JPIM) :: IPSTPT_ZENTR_D

INTEGER(KIND=JPIM) :: IPSTPT_ZDETR_D_RS

INTEGER(KIND=JPIM) :: IPSTPT_ZDETR_U_RS

INTEGER(KIND=JPIM) :: IPSTPT_ZDETR_U

INTEGER(KIND=JPIM) :: IPSTPT_ZENTR_U

INTEGER(KIND=JPIM) :: IPSTPT_ZUDQC

INTEGER(KIND=JPIM) :: IPSTPT_ZDDW

INTEGER(KIND=JPIM) :: IPSTPT_ZQRC

INTEGER(KIND=JPIM) :: IPSTPT_ZEROV

INTEGER(KIND=JPIM) :: IPSTPT, IKSTPT


#include "acadvec.intfb.h"
#include "acmtentr.intfb.h"
#include "acmtud.intfb.h"
#include "acpluiz.intfb.h"
#include "acnebxrs.intfb.h"
#include "fcttrm.func.h"
#include "fctdoi.func.h"




IPSTPT = KPSTPT

IKSTPT = KKSTPT

IPSTPT_ZEROV = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQRC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDDW = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZUDQC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZENTR_U = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDETR_U = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDETR_U_RS = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDETR_D_RS = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZENTR_D = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDETR_D = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZFCCQLTMP = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZQSC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQIC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZUDW = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQLC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZW_COMPENS = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZW_CONV = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZFCCQNTMP = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZFHEVPPC = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZFHMLTSC = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZQLIC_MICRO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZNEBC_MICRO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDAL = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZQLCED = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQICED = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQ_COND_XR96 = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDEPTH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTMPVAR = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTMIC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQMIC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZEVAPO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZSU = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZALF = IPSTPT

IPSTPT = IPSTPT + 1

IF (IPSTPT > KPSTSZ) CALL ABOR1 

IF (IKSTPT > KKSTSZ) CALL ABOR1 
ZEPS=1.E-12_JPRB
ZCCHSL=RCW-RCPD
ZCCHSN=RCS-RCPD
DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PFIMCC(JLON,JLEV)= 0._JPRB
ENDDO
ENDDO

DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDAL)= 0._JPRB
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PQC_DET_PCMT(JLON,JLEV)= 0._JPRB
ENDDO
ENDDO


DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZEVAPO+JLEV-(1))= 0._JPRB
ENDDO
ENDDO

IF(YRPHY0%LCVNHD) THEN
  ! Evaporation from previous time step is got from the PDDAL buffer.
  DO JLEV = KTDIA, KLEV
  DO JLON = KIDIA, KFDIA
  PSTACK (JLON, IPSTPT_ZEVAPO+JLEV-(1))=PDDAL(JLON,JLEV)
  ENDDO
  ENDDO
ENDIF

! UDPDRAFT.
CALL ACMTUD ( KIDIA,KFDIA,KLON,KTDIA,KLEV,KTRA, PALPH, PAPHI, PAPHIF, PAPRS,      &
& PAPRSF, PCP,PLH, PR, PDELP, PLNPR, PQ, PQI, PQL, PQLIS, PQSAT, PQW, PRDELP,     &
& PCVGQ,PT, PTW, PU, PV, PTKE, PTRA,PSTACK (1, IPSTPT_ZEVAPO), PGM,PTS,PQS,       &
& PDIFCQ, PDIFCQL, PDIFCQI, PDIFCS, PDIFCTH, PFCCQL, PFCCQN, PSTRCU, PSTRCV,      &
& PSTRCTRA, PSTACK (1, IPSTPT_ZFHMLTSC),PSTACK (1, IPSTPT_ZFHEVPPC),PFPEVPCL,     &
& PFPEVPCN, PFPLCL,PFPLCN,PMF_UP, PNEBC,PQLIC,PTU,PQU,PSTACK (1, IPSTPT_ZSU),     &
& KNLAB,PSTACK (1, IPSTPT_ZENTR_U),PSTACK (1, IPSTPT_ZDETR_U),                    &
& PSTACK (1, IPSTPT_ZENTR_D),PSTACK (1, IPSTPT_ZDETR_D), KNND,PCAPE,              &
& PSTACK (1, IPSTPT_ZALF), PALF_CAPE, PALF_CVGQ, PUDAL,PUDOM,PDDAL,PDDOM, KSTACK, &
& PSTACK, KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)
#ifdef UNDEF


IF(YRPHY0%NCVQLI == 2) THEN
  ! Radiative condensates and cloudiness, due to convection, computed as ql+qi+qr+qs.
  DO JLEV = KTDIA, KLEV
    DO JLON = KIDIA, KFDIA
      PQLIC(JLON,JLEV)=PQLCONV(JLON,JLEV)+PQICONV(JLON,JLEV) &
        & +PQRCONV(JLON,JLEV)+PQSCONV(JLON,JLEV)
      PNEBC(JLON,JLEV)=PUDAL(JLON,JLEV)*YRPHY0%FNEBC
    ENDDO
  ENDDO
ENDIF

! INITIALIZE CONVECTIVE PROFILES: INTRA-TIME-STEP EVOLUTION.
DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))= PQLCONV(JLON,JLEV)
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))= PQICONV(JLON,JLEV)
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZQRC+JLEV-(1))= PQRCONV(JLON,JLEV)
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZQSC+JLEV-(1))= PQSCONV(JLON,JLEV)
ENDDO
ENDDO


!-------------------------------------------------
! ENTRAINMENT AND DETRAINMENT.
!-------------------------------------------------

CALL ACMTENTR(KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PSTACK (1, IPSTPT_ZQLC), &
& PQL, PUDAL, PDDAL, PSTACK (1, IPSTPT_ZENTR_U), PSTACK (1, IPSTPT_ZENTR_D),   &
& PSTACK (1, IPSTPT_ZDETR_U), PSTACK (1, IPSTPT_ZDETR_D), PFEDQLC, KSTACK,     &
& PSTACK, KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)
CALL ACMTENTR(KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PSTACK (1, IPSTPT_ZQIC), &
& PQI, PUDAL, PDDAL, PSTACK (1, IPSTPT_ZENTR_U), PSTACK (1, IPSTPT_ZENTR_D),   &
& PSTACK (1, IPSTPT_ZDETR_U), PSTACK (1, IPSTPT_ZDETR_D), PFEDQIC, KSTACK,     &
& PSTACK, KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)
! Detrainment of rain and snow is smaller from that of lagrangian species (liquid and ice).
DO JLEV = KTDIA-1, KLEV
  DO JLON = KIDIA, KFDIA
    PSTACK (JLON, IPSTPT_ZDETR_U_RS+JLEV-(1))=YRPHY0%GREDDRS*&
    &  PSTACK (JLON, IPSTPT_ZDETR_U+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZDETR_D_RS+JLEV-(1))=YRPHY0%GREDDRS*&
    &  PSTACK (JLON, IPSTPT_ZDETR_D+JLEV-(1))
  ENDDO
ENDDO
CALL ACMTENTR(KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PSTACK (1, IPSTPT_ZQRC),   &
& PRR, PUDAL, PDDAL, PSTACK (1, IPSTPT_ZENTR_U), PSTACK (1, IPSTPT_ZENTR_D),     &
& PSTACK (1, IPSTPT_ZDETR_U_RS), PSTACK (1, IPSTPT_ZDETR_D_RS), PFEDQRC, KSTACK, &
& PSTACK, KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)
CALL ACMTENTR(KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PSTACK (1, IPSTPT_ZQSC),   &
& PS,  PUDAL, PDDAL, PSTACK (1, IPSTPT_ZENTR_U), PSTACK (1, IPSTPT_ZENTR_D),     &
& PSTACK (1, IPSTPT_ZDETR_U_RS), PSTACK (1, IPSTPT_ZDETR_D_RS), PFEDQSC, KSTACK, &
& PSTACK, KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)

DO JLEV = KTDIA, KLEV
  DO JLON = KIDIA, KFDIA
    ! UPDATE INTRA-TIME-STEP VALUES FROM ENTRAINMENT/DETRAINMENT FLUXES.
    PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))=MAX(0._JPRB,                             &
    &  PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))-RG*( +PFEDQLC(JLON,JLEV)-PFEDQLC(JLON,&
    &  JLEV-1) )*PRDELP(JLON,JLEV)*YRPHY2%TSPHY)
    PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))=MAX(0._JPRB,                             &
    &  PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))-RG*( +PFEDQIC(JLON,JLEV)-PFEDQIC(JLON,&
    &  JLEV-1) )*PRDELP(JLON,JLEV)*YRPHY2%TSPHY)
    PSTACK (JLON, IPSTPT_ZQRC+JLEV-(1))=MAX(0._JPRB,                             &
    &  PSTACK (JLON, IPSTPT_ZQRC+JLEV-(1))-RG*( +PFEDQRC(JLON,JLEV)-PFEDQRC(JLON,&
    &  JLEV-1) )*PRDELP(JLON,JLEV)*YRPHY2%TSPHY)
    PSTACK (JLON, IPSTPT_ZQSC+JLEV-(1))=MAX(0._JPRB,                             &
    &  PSTACK (JLON, IPSTPT_ZQSC+JLEV-(1))-RG*( +PFEDQSC(JLON,JLEV)-PFEDQSC(JLON,&
    &  JLEV-1) )*PRDELP(JLON,JLEV)*YRPHY2%TSPHY)
    ! DIAGNOSE CONDENSATE DETRAINED BY PCMT CONVECTION.
    PQC_DET_PCMT(JLON,JLEV)=MAX(0._JPRB,RG*(&
      &+PFEDQLC(JLON,JLEV)-PFEDQLC(JLON,JLEV-1) &
      &+PFEDQIC(JLON,JLEV)-PFEDQIC(JLON,JLEV-1) &
      &)*PRDELP(JLON,JLEV)*YRPHY2%TSPHY)
  ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZQLCED+JLEV-(1))= PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZQICED+JLEV-(1))= PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))
ENDDO
ENDDO

! UPDATE INTRA-TIME-STEP CONVECTIVE VALUES FROM CONDENSATION FLUXES.
DO JLEV = KTDIA, KLEV
  DO JLON = KIDIA, KFDIA
    PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))-RG*&
    &  ( -PFCCQL(JLON,JLEV)+PFCCQL(JLON,JLEV-1) )*PRDELP(JLON,JLEV)*YRPHY2%TSPHY
    PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))-RG*&
    &  ( -PFCCQN(JLON,JLEV)+PFCCQN(JLON,JLEV-1) )*PRDELP(JLON,JLEV)*YRPHY2%TSPHY
  ENDDO
ENDDO

!-------------------------------------------------
! "LOPEZ" MICROPHYSICS: AUTOCONVERSION / COLLECTION / SEDIMENTATION OF PRECIPITATION / EVAPORATION OF PRECIPITATION.
!-------------------------------------------------

! QCCONV = QLCONV + QICONV.
DO JLEV = KTDIA, KLEV
  DO JLON = KIDIA, KFDIA
    PSTACK (JLON, IPSTPT_ZQLIC_MICRO+JLEV-(1))=&
    &  PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))+PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZQ_COND_XR96+JLEV-(1))=                                &
    &  PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))+PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1)) +&
    &  PSTACK (JLON, IPSTPT_ZQRC+JLEV-(1))+PSTACK (JLON, IPSTPT_ZQSC+JLEV-(1))
  ENDDO
ENDDO
DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZFCCQLTMP+JLEV-(0))= 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZFCCQNTMP+JLEV-(0))= 0._JPRB
ENDDO
ENDDO

IF(YRPHY%LNEBNXR) THEN
  ! XU-RANDALL 1996 CLOUDINESS.
  CALL ACNEBXRS ( KIDIA,KFDIA,KLON,KTDIA,KLEV, PQ,                         &
  & PSTACK (1, IPSTPT_ZQ_COND_XR96),PQSAT, PSTACK (1, IPSTPT_ZNEBC_MICRO), &
  & KSTACK, PSTACK, KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)
  DO JLEV = KTDIA, KLEV
    DO JLON = KIDIA, KFDIA
      PQLIC(JLON,JLEV)=PSTACK (JLON, IPSTPT_ZQ_COND_XR96+JLEV-(1))
      PNEBC(JLON,JLEV)=PSTACK (JLON, IPSTPT_ZNEBC_MICRO+JLEV-(1))*YRPHY0%FNEBC
    ENDDO
  ENDDO
ELSE
  IF(YRPHY0%LCVMICC) THEN
    DO JLEV = KTDIA, KLEV
      DO JLON = KIDIA, KFDIA
        PSTACK (JLON, IPSTPT_ZDAL)=MAX(PSTACK (JLON, IPSTPT_ZDAL),PUDAL(JLON, &
        & JLEV)+PDDAL(JLON,JLEV))
      ENDDO
    ENDDO
  ENDIF
  DO JLEV = KTDIA, KLEV
    DO JLON = KIDIA, KFDIA
      ! CONSISTENCY BETWEEN CLOUDINESS AND CLOUD CONDENSATE:
      ! ZNEBC_MICRO=PUDAL+PDDAL WHERE >0, ZQLIC_MICRO/3.E-3 OTHERWISE
      IQLIC_MICRO=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-&
      & PSTACK (JLON, IPSTPT_ZQLIC_MICRO+JLEV-(1))+0.0_JPRB)))
      IQLIC=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-PQLIC(JLON,JLEV)+0.0_JPRB)))
      INEBC=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-(PUDAL(JLON,JLEV)*IQLIC)+0.0_JPRB)))
      IF(YRPHY0%LCVMICC) THEN
        PSTACK (JLON, IPSTPT_ZNEBC_MICRO+JLEV-(1))=(1-IQLIC_MICRO)*ZEPS +       &
        & IQLIC_MICRO*(INEBC*MAX(ZEPS,(PUDAL(JLON,JLEV)+PDDAL(JLON,JLEV))) +(1- &
        & INEBC)*MAX(ZEPS,MIN(PSTACK (JLON, IPSTPT_ZDAL),                       &
        &  PSTACK (JLON, IPSTPT_ZQLIC_MICRO+JLEV-(1))/1.E-2_JPRB)))
      ELSE
        PSTACK (JLON, IPSTPT_ZNEBC_MICRO+JLEV-(1))=(1-IQLIC_MICRO)*ZEPS +       &
        & IQLIC_MICRO*(INEBC*MAX(ZEPS,(PUDAL(JLON,JLEV)+PDDAL(JLON,JLEV))) +(1- &
        & INEBC)*MAX(ZEPS,MIN(0.9999_JPRB,                                      &
        &  PSTACK (JLON, IPSTPT_ZQLIC_MICRO+JLEV-(1))/3.E-3_JPRB)))
      ENDIF
    ENDDO
  ENDDO
ENDIF
DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZEROV+JLEV-(1))= 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PFCCQL(JLON,JLEV)= 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PFCCQN(JLON,JLEV)= 0._JPRB
ENDDO
ENDDO


! Microphysics occurs in a shell between updraft and its resolved environment.
DO JLEV = KTDIA, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTMIC+JLEV-(1))=(1._JPRB-YRPHY0%GSHELL)*PTU(JLON,JLEV) +&
& YRPHY0%GSHELL*PT(JLON,JLEV)
ENDDO
ENDDO
DO JLEV = KTDIA, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZQMIC+JLEV-(1))=(1._JPRB-YRPHY0%GSHELL)*PQU(JLON,JLEV) +&
& YRPHY0%GSHELL*PQ(JLON,JLEV)
ENDDO
ENDDO

! Call microphysics.
LLADJCLD=.FALSE.
CALL ACPLUIZ ( KIDIA,KFDIA,KLON,KTDIA,KLEV, PSTACK (1, IPSTPT_ZTMIC),             &
& PSTACK (1, IPSTPT_ZQMIC), PSTACK (1, IPSTPT_ZQLCED), PSTACK (1, IPSTPT_ZQICED), &
& PSTACK (1, IPSTPT_ZQRC), PSTACK (1, IPSTPT_ZQSC), PDELP, PAPRSF, PCP, PR,       &
& PSTACK (1, IPSTPT_ZNEBC_MICRO), PSTACK (1, IPSTPT_ZQLIC_MICRO),                 &
& PSTACK (1, IPSTPT_ZEROV),PSTACK (1, IPSTPT_ZEROV),PSTACK (1, IPSTPT_ZEROV),     &
& PSTACK (1, IPSTPT_ZEROV), PSTACK (1, IPSTPT_ZEROV), LLADJCLD, PAPHI, PTS,       &
& PNEIJ, PLSM, PGM, PVETAF, PFCCQL,PFCCQN, PFPLCL, PFPLCN, PFPEVPCL, PFPEVPCN,    &
& PFPFPCL, PFPFPCN, PDIFCQLC, PDIFCQIC, KSTACK, PSTACK, KPSTSZ, KKSTSZ, IPSTPT,   &
& IKSTPT )

! UPDATE INTRA-TIME-STEP CONVECTIVE VALUES FROM MICROPHYSICAL FLUXES.
DO JLEV = KTDIA, KLEV
  DO JLON = KIDIA, KFDIA
    PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))-RG*&
    &  ( +PFPFPCL(JLON,JLEV)-PFPFPCL(JLON,JLEV-1) )*PRDELP(JLON,JLEV)*YRPHY2%  &
    & TSPHY
    PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))-RG*&
    &  ( +PFPFPCN(JLON,JLEV)-PFPFPCN(JLON,JLEV-1) )*PRDELP(JLON,JLEV)*YRPHY2%  &
    & TSPHY
    PSTACK (JLON, IPSTPT_ZQRC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZQRC+JLEV-(1))-RG*  &
    &  ( +PFPLCL(JLON,JLEV)-PFPLCL(JLON,JLEV-1) -PFPFPCL(JLON,JLEV)+PFPFPCL(JLON,&
    &  JLEV-1) +PFPEVPCL(JLON,JLEV)-PFPEVPCL(JLON,JLEV-1) )*PRDELP(JLON,JLEV)*   &
    & YRPHY2%TSPHY
    PSTACK (JLON, IPSTPT_ZQSC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZQSC+JLEV-(1))-RG*  &
    &  ( +PFPLCN(JLON,JLEV)-PFPLCN(JLON,JLEV-1) -PFPFPCN(JLON,JLEV)+PFPFPCN(JLON,&
    &  JLEV-1) +PFPEVPCN(JLON,JLEV)-PFPEVPCN(JLON,JLEV-1) )*PRDELP(JLON,JLEV)*   &
    & YRPHY2%TSPHY
  ENDDO
ENDDO

!-------------------------------------------------
! VERTICAL TRANSPORT OF QLCONV AND QICONV.
!-------------------------------------------------

DO JLEV = KTDIA, KLEV
  DO JLON = KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZUDW+JLEV-(1))=-PUDOM(JLON,JLEV)*PR(JLON,JLEV)*PT(JLON,&
    & JLEV)/(PAPRSF(JLON,JLEV)*RG)
    PSTACK (JLON, IPSTPT_ZDDW+JLEV-(1))=-PDDOM(JLON,JLEV)*PR(JLON,JLEV)*PT(JLON,&
    & JLEV)/(PAPRSF(JLON,JLEV)*RG)
    PSTACK (JLON, IPSTPT_ZW_COMPENS+JLEV-(1))=-(PUDAL(JLON,JLEV)*               &
    &  PSTACK (JLON, IPSTPT_ZUDW+JLEV-(1))+PDDAL(JLON,JLEV)*                    &
    &  PSTACK (JLON, IPSTPT_ZDDW+JLEV-(1))) /MAX(1.E-4_JPRB,1._JPRB-PUDAL(JLON, &
    & JLEV)-PDDAL(JLON,JLEV))
    PSTACK (JLON, IPSTPT_ZW_CONV+JLEV-(1))=(PUDAL(JLON,JLEV)*                 &
    &  PSTACK (JLON, IPSTPT_ZUDW+JLEV-(1))+PDDAL(JLON,JLEV)*                  &
    &  PSTACK (JLON, IPSTPT_ZDDW+JLEV-(1))) /MAX(1.E-4_JPRB,PUDAL(JLON,JLEV)+ &
    & PDDAL(JLON,JLEV))
  ENDDO
ENDDO

! CONVECTIVE TRANSPORT OF CONVECTIVE CONDENSATES IN THE UPDRAFT.
CALL ACADVEC (KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PAPHI,                     &
& PSTACK (1, IPSTPT_ZQLC), PSTACK (1, IPSTPT_ZW_CONV), PDIFCQLC, KSTACK, PSTACK, &
& KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)
CALL ACADVEC (KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PAPHI,                     &
& PSTACK (1, IPSTPT_ZQIC), PSTACK (1, IPSTPT_ZW_CONV), PDIFCQIC, KSTACK, PSTACK, &
& KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)

! CONVECTIVE TRANSPORT OF RESOLVED CONDENSATES IN THE ENVIRONMENT.
CALL ACADVEC (KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PAPHI, PQL,                 &
& PSTACK (1, IPSTPT_ZW_COMPENS), PDIFCQL, KSTACK, PSTACK, KPSTSZ, KKSTSZ, IPSTPT, &
& IKSTPT)
CALL ACADVEC (KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PAPHI, PQI,                 &
& PSTACK (1, IPSTPT_ZW_COMPENS), PDIFCQI, KSTACK, PSTACK, KPSTSZ, KKSTSZ, IPSTPT, &
& IKSTPT)

! UPDATE PROFILES FROM TRANSPORT FLUXES.
DO JLEV = KTDIA, KLEV
  DO JLON = KIDIA, KFDIA
    PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))-RG* &
    &  ( +PDIFCQLC(JLON,JLEV)-PDIFCQLC(JLON,JLEV-1) )*PRDELP(JLON,JLEV)*YRPHY2% &
    & TSPHY
    PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))-RG* &
    &  ( +PDIFCQIC(JLON,JLEV)-PDIFCQIC(JLON,JLEV-1) )*PRDELP(JLON,JLEV)*YRPHY2% &
    & TSPHY
  ENDDO
ENDDO

!-------------------------------------------------
! PRODUCE ICING OF CONVECTIVE LIQUID WATER TRANSPORTED BY THE UPDRAFT.
!-------------------------------------------------

DO JLEV = KTDIA, KLEV
  DO JLON = KIDIA, KFDIA
    ZQLCONVPREC=PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZUDQC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))+&
    &  PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))
    ZICE=FONICE(PTU(JLON,JLEV))
    PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZUDQC+JLEV-(1))*(1.0_JPRB&
    &  -ZICE)
    PSTACK (JLON, IPSTPT_ZQIC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZUDQC+JLEV-(1))* &
    & ZICE
    ZTCVIM=(PSTACK (JLON, IPSTPT_ZQLC+JLEV-(1))-ZQLCONVPREC)/YRPHY2%TSPHY
    PFIMCC(JLON,JLEV)=PFIMCC(JLON,JLEV-1)-PDELP(JLON,JLEV)/RG*ZTCVIM
  ENDDO
ENDDO
!
! CUMULATE DEPTH OF LAYERS WHERE VERTICAL VELOCITY IS GREATER THAN A GIVEN THRESHOLD.
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDEPTH)= 0._JPRB
ENDDO

DO JLEV=KTDIA,KLEV
   DO JLON=KIDIA,KFDIA
      ! CONVECTIVE CLOUD DEPTH:
      ! CUMULATE DEPTH OF LAYERS WHERE VERTICAL VELOCITY IS GREATER THAN A GIVEN THRESHOLD.
      PSTACK (JLON, IPSTPT_ZDEPTH)=PSTACK (JLON, IPSTPT_ZDEPTH)+(PAPHI(JLON,JLEV&
      &  -1)-PAPHI(JLON,JLEV))/RG *MAX(0._JPRB,SIGN(1._JPRB,                    &
      &  PSTACK (JLON, IPSTPT_ZUDW+JLEV-(1))-1.0_JPRB))
   ENDDO
ENDDO

!-------------------------------------------------
! The PCMT call above has computed both non-precipitating and precipitating convection fluxes.
! If a separate shallow convection scheme is activated in the current physics,
! one suppresses PCMT fluxes where PCMT convection is non-precipitating.
!-------------------------------------------------
IF(YRPHY%LCVPPKF.OR.YRPHY%LEDKF) THEN
  ! PAIPCMT: Activity Index of PCMT: 1. if PCMT is active, 0. else case.
  DO JLON=KIDIA,KFDIA
    PAIPCMT(JLON)=MAX(0._JPRB,SIGN(1._JPRB,PSTACK (JLON, IPSTPT_ZDEPTH)-YRPHY0%&
    & THPCMT))
  ENDDO
!  ! Is PCMT convection precipitating?
!  ZMAX(:)=0._JPRB
!  DO JLEV=KTDIA,KLEV
!    DO JLON=KIDIA,KFDIA
!      ZMAX(JLON)=MAX(ZMAX(JLON),PQRCONV(JLON,JLEV)+PQSCONV(JLON,JLEV))
!    ENDDO
!  ENDDO
!  ! PAIPCMT: Activity Index of PCMT: 1. if PCMT is active, 0. else case.
!  DO JLON=KIDIA,KFDIA
!    PAIPCMT(JLON)=MAX(0._JPRB,SIGN(1._JPRB,ZMAX(JLON)-THPCMT))
!  ENDDO
  ! One applies the PAIPCMT activity index to the PCMT fluxes.
  DO JLEV=KTDIA-1,KLEV
    DO JLON=KIDIA,KFDIA
      PDIFCQ(JLON,JLEV)=PAIPCMT(JLON)*PDIFCQ(JLON,JLEV)
      PDIFCQL(JLON,JLEV)=PAIPCMT(JLON)*PDIFCQL(JLON,JLEV)
      PDIFCQI(JLON,JLEV)=PAIPCMT(JLON)*PDIFCQI(JLON,JLEV)
      PDIFCQLC(JLON,JLEV)=PAIPCMT(JLON)*PDIFCQLC(JLON,JLEV)
      PDIFCQIC(JLON,JLEV)=PAIPCMT(JLON)*PDIFCQIC(JLON,JLEV)
      PDIFCS(JLON,JLEV)=PAIPCMT(JLON)*PDIFCS(JLON,JLEV)
      PDIFCTH(JLON,JLEV)=PAIPCMT(JLON)*PDIFCTH(JLON,JLEV)
      PFCCQL(JLON,JLEV)=PAIPCMT(JLON)*PFCCQL(JLON,JLEV)
      PFCCQN(JLON,JLEV)=PAIPCMT(JLON)*PFCCQN(JLON,JLEV)
      PSTRCU(JLON,JLEV)=PAIPCMT(JLON)*PSTRCU(JLON,JLEV)
      PSTRCV(JLON,JLEV)=PAIPCMT(JLON)*PSTRCV(JLON,JLEV)
      PFIMCC(JLON,JLEV)=PAIPCMT(JLON)*PFIMCC(JLON,JLEV)
      PFPEVPCL(JLON,JLEV)=PAIPCMT(JLON)*PFPEVPCL(JLON,JLEV)
      PFPEVPCN(JLON,JLEV)=PAIPCMT(JLON)*PFPEVPCN(JLON,JLEV)
      PFPLCL(JLON,JLEV)=PAIPCMT(JLON)*PFPLCL(JLON,JLEV)
      PFPLCN(JLON,JLEV)=PAIPCMT(JLON)*PFPLCN(JLON,JLEV)
      PFPFPCL(JLON,JLEV)=PAIPCMT(JLON)*PFPFPCL(JLON,JLEV)
      PFPFPCN(JLON,JLEV)=PAIPCMT(JLON)*PFPFPCN(JLON,JLEV)
      PFEDQLC(JLON,JLEV)=PAIPCMT(JLON)*PFEDQLC(JLON,JLEV)
      PFEDQIC(JLON,JLEV)=PAIPCMT(JLON)*PFEDQIC(JLON,JLEV)
      PFEDQRC(JLON,JLEV)=PAIPCMT(JLON)*PFEDQRC(JLON,JLEV)
      PFEDQSC(JLON,JLEV)=PAIPCMT(JLON)*PFEDQSC(JLON,JLEV)
      PFCNEGQLC(JLON,JLEV)=PAIPCMT(JLON)*PFCNEGQLC(JLON,JLEV)
      PFCNEGQIC(JLON,JLEV)=PAIPCMT(JLON)*PFCNEGQIC(JLON,JLEV)
      PFCNEGQRC(JLON,JLEV)=PAIPCMT(JLON)*PFCNEGQRC(JLON,JLEV)
      PFCNEGQSC(JLON,JLEV)=PAIPCMT(JLON)*PFCNEGQSC(JLON,JLEV)
    ENDDO
  ENDDO
  DO JTRA = 1, KTRA
    DO JLEV=KTDIA,KLEV
      DO JLON=KIDIA,KFDIA
          PSTRCTRA(JLON,JLEV,JTRA)=PAIPCMT(JLON)*PSTRCTRA(JLON,JLEV,JTRA)
      ENDDO
    ENDDO
  ENDDO
  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      PNEBC(JLON,JLEV)=PAIPCMT(JLON)*PNEBC(JLON,JLEV)
      PQLIC(JLON,JLEV)=PAIPCMT(JLON)*PQLIC(JLON,JLEV)
    ENDDO
  ENDDO
ELSE
  ! One has called the PCMT scheme, and no external shallow convection
  ! is activated. In this case, PCMT is expected to produce both
  ! precipitating and non-precipitating convection fluxes,
  ! the activity index PAIPCMT is set to 1..
  DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDEPTH)= 0._JPRB
ENDDO

  DO JLON = KIDIA, KFDIA
PAIPCMT(JLON)= 1._JPRB
ENDDO

ENDIF

IF(YRPHY0%NCVCLOS == 4) THEN
  !
  !-------------------------------------------------
  ! In case of prognostic surface active fraction, one uses the PUDAL array
  ! to advect ZALF surface active fraction in 3D from one step to the next.
  !-------------------------------------------------
  !
  DO JLEV = KTDIA, KLEV
    DO JLON = KIDIA, KFDIA
      PUDAL(JLON,JLEV) = PSTACK (JLON, IPSTPT_ZALF)
    ENDDO
  ENDDO
ENDIF

!
!-------------------------------------------------
! PCSGC: resolved condensates located Close to SubGrid Convection: 1. if close, 0. if "far".
!-------------------------------------------------
!
DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PCSGC(JLON,JLEV)= 1._JPRB
ENDDO
ENDDO

DO JLEV=KTDIA,KLEV
  DO JLON=KIDIA,KFDIA
    ZFRACP=EXP((PAPRSF(JLON,JLEV)-YRPHY0%GCVFNEP1)/YRPHY0%GCVFNEP2)
    ZTH=(ZFRACP*ZFRACP-1._JPRB)/(ZFRACP*ZFRACP+1._JPRB)
    PCSGC(JLON,JLEV)=YRPHY0%GCVFNER*MAX(0._JPRB,SIGN(1._JPRB,&
    & PSTACK (JLON, IPSTPT_ZDEPTH)-YRPHY0%GCVFNEO)) *0.5_JPRB*(1._JPRB-ZTH)
  ENDDO
ENDDO

#endif

END SUBROUTINE ACPCMT

