SUBROUTINE ACMTUD ( KIDIA,KFDIA,KGPBLKS,KLON,KTDIA,KLEV,KTRA,&
!-----------------------------------------------------------------------
! - INPUT  2D .
& PALPH,PAPHI,PAPHIF,PAPRS,PAPRSF,PCP,PLH,PR,&
& PDELP,PLNPR,&
& PQ,PQI,PQL,PQLIS,PQSAT,PQW,&
& PRDELP,PCVGQ,PT,PTW,PU,PV,PTKE,PTRA,PEVAPO,&
! - INPUT 1D .
& PGM, PTS, PQS,&
! - OUTPUT 2D .
& PDIFCQ,PDIFCQL,PDIFCQI,PDIFCS,PDIFCTH,&
& PFCCQL,PFCCQI,PSTRCU,PSTRCV,PSTRCTRA,&
& PFHMLTS,PFHEVPP,PFPEVPCL,PFPEVPCN,&
& PFPLCL,PFPLCN,PMF_UP,&
& PNEBC,PQLIC,PTU,PQU,PSU,KNLAB,PENTR_U,PDETR_U,PENTR_D,PDETR_D,&
! - OUTPUT 1D .
& KNND,PCAPE,PALF,PALF_CAPE,PALF_CVGQ,&
! - INPUT/OUTPUT 2D .
& PUDAL,PUDOM,PDDAL,PDDOM)

!**** *ACMTUD * - MASS FLUX PROGNOSTIC UPDRAFT OF THE PCMT CONVECTION SCHEME.

! SUJET.
!     ------

!**   INTERFACE.
!     ----------
!        *CALL* *ACMTUD*
!-----------------------------------------------------------------------
! -   INPUT ARGUMENTS.
!     ----------------

! - PHYSICS DIMENSIONNING PARAMETERS

! KIDIA      : INDICE DE DEPART DES BOUCLES VECTORISEES SUR L'HORIZONT..
! KFDIA      : INDICE DE FIN DES BOUCLES VECTORISEES SUR L'HORIZONTALE.
! KLON       : DIMENSION HORIZONTALE DES TABLEAUX.
! KTDIA      : INDICE DE DEPART DES BOUCLES VERTICALES (1 EN GENERAL).
! KLEV       : DIMENSION VERTICALE DES TABLEAUX "FULL LEVEL".
! KTRA       : NUMBER OF TRACERS (PASSIVE VARIABLES)

! - PHYSICS VARIABLES (ALPHABETICALLY IN EACH CATEGORY)

! - 2D (0:KLEV) .

! PAPHI      : HALF LEVEL GEOPOTENTIAL
! PAPRS      : HALF LEVEL PRESSURE

! - 2D (1:KLEV) .

! PALPH      : LOG(PAPRS(JLEV)/PAPRSF(JLEV)) (FOR HYDROSTATIC MODEL).
! PAPHIF     : FULL LEVEL GEOPOTENTIAL
! PAPRSF     : FULL LEVEL PRESSURE
! PCP        : CHALEUR MASSIQUE A PRESSION CONSTANTE DE L'AIR.
! PR         : CONSTANTE DE L'AIR HUMIDE.
! PDELP      : PRESSURE DIFFERENCE OVER THE LAYER
! PLNPR      : LOG(PAPRS(JLEV)/PAPRS(JLEV-1)) (POUR L'HYDROSTATIQUE).
! PQ         : MICROPHYSICAL WATER VAPOUR SPECIFIC HUMIDITY
! PQI        : MICROPHYSICAL RESOLVED CLOUD ICE SPECIFIC CONTENTS
! PQL        : MICROPHYSICAL RESOLVED CLOUD LIQUID SPECIFIC CONTENTS
! PQLIS      : MICROPHYSICAL RESOLVED CLOUD WATER SPECIFIC CONTENTSIN THE TIME-STEP
! PQW        : WET BULB SPECIFIC MOISTURE
! PQSAT      : SATURATION SPECIFIC MOISTURE
! PRDELP     : INVERSE DE L'EPAISSEUR EN PRESSION DE LA COUCHE.
! PCVGQ      : CONVERGENCE D'HUMIDITE.
! PT         : TEMPERATURE.
! PTW        : WET BULB TEMPERATURE.
! PU         : U WIND COMPONENT
! PV         : V WIND COMPONENT
! PTRA       : TRACER CONCENTRATION
! PTKE       : TKE
! PEVAPO     : evaporation from previous time step

! - 2D (0:KLEV) .

! - 1D .

! PGM        : FACTEUR D'ECHELLE.
! PTS        : temperature de surface.
! PQS        : vapeur d'eau de surface.

!-----------------------------------------------------------------------

! -   OUTPUT ARGUMENTS
!     ----------------

! - 2D (0:KLEV) .

! PDIFCQ     : WATER VAPOUR CONVECTIVE SPECIFIC MOISTURE FLUX
! PDIFCQI    : ICE WATER CONVECTIVE SPECIFIC MOISTURE FLUX
! PDIFCQL    : LIQUID WATER CONVECTIVE SPECIFIC MOISTURE FLUX
! PDIFCS     : DRY STATIC ENERGY CONVECTIVE FLUX
! PDIFCTH    : THETA CONVECTIVE FLUX
! PFCCQL     : LIQUID CONDENSATION FLUX FROM THE CONVECTIVE UPDRAFT
! PFCCQI     : SOLID CONDENSATION FLUX FROM THE CONVECTIVE UPDRAFT
! PSTRCU     : U-MOMENTUM CONVECTIVE SPECIFIC MOISTURE FLUX
! PSTRCV     : V-MOMENTUM CONVECTIVE SPECIFIC MOISTURE FLUX
! PSTRCTRA   : TRACER CONVECTIVE FLUX
! PFHMLTS    : FLUX DE CHALEUR DU A LA FONTE/GEL.
! PFHEVPP    : FLUX DE CHALEUR DU A L'EVAPORATION DES PRECIPITATIONS.
! PFPEVPCL    : EVAPORATION DES PRECIPITATIONS LIQUIDES.
! PFPEVPCN    : EVAPORATION DES PRECIPITATIONS NEIGEUSES.
! PFPLCL     : PRECIPITATIONS CONVECTIVES SOUS FORME LIQUIDE.
! PFPLCN     : PRECIPITATIONS CONVECTIVES SOUS FORME NEIGE.

! - 2D (1:KLEV) .

! KNLAB  : CONVECTIVE ACTIVITY INDEX (ACTIVE IF EQUAL TO ONE).
! PTU    : TEMPERATURE OF THE CLOUDY ASCENT.
! PQU    : WATER VAPOUR SPECIFIC HUMIDITY OF THE CLOUDY ASCENT.
! PSU    : DRY STATIC ENERGY OF THE CLOUDY ASCENT.
! PNEBC  : CONVECTIVE CLOUDINESS.
! PQLIC  : CONVECTIVE CONDENSATE.
! PENTR_U    : ENTRAINMENT IN UPDRAFT (IN S**-1).
! PDETR_U    : DETRAINMENT FROM UPDRAFT (IN S**-1).
! PENTR_D    : ENTRAINMENT IN DOWNDRAFT (IN S**-1).
! PDETR_D    : DETRAINMENT FROM DOWNDRAFT (IN S**-1).

! - 1D (DIAGNOSTIQUE) .

! KNND   : ZERO WHENEVER A NON PHYSICAL SITUATION OCCURS, ONE OTHERWISE
! PCAPE  : CAPE (CONDITIONAL AVAILABLE POTENTIAL ENERGY).

!-----------------------------------------------------------------------

! -   INPUT/OUTPUT ARGUMENTS
!     ----------------------

! - 2D (0:KLEV) .

! - 2D (1:KLEV) .

! PUDAL    : PROGNOSTIC UPDRAFT MESH FRACTION
! PUDOM    : PROGNOSTIC UPDRAFT RELATIVE VELOCITY

!-----------------------------------------------------------------------

! METHOD.
!     --------

! AUTHOR.
!     -------
! 2011-04-14, J.F. GUEREMY AND J.M. PIRIOU.

! MODIFICATIONS.
!     --------------
! 2013-02-08, J.M. Piriou: protect the LOG in computing ZSIGMA.
! 2013-06-17, J.M. Piriou: LCVNHD NH effects of downdraft on updraft and conversely.
! 2013-06-17, J.M. Piriou: prognostic closure on PALF.
! 2013-07 - G. Bellon  Modifications for MUSC 
! 2014-04-01, J.M. Piriou: LLSINH: SImple NH effect.
! 2014-05   , J.F. Gueremy:
!             * resolution function for closure condition.
!             * CIN threshold for triggering condition.
! 2014-05   , J.F. Gueremy: use ZDQCA instead of ZBCC to compute condensation,
!             to apply the same "ZAUX" reduction in condensation and in transport.
! 2014-05 - D. Saint-Martin : Transport of tracers
! 2014-06 - J.F. Gueremy condensation flux using the same massflux
!             as for the transport flux
! 2014-07-29, Ryad El Khatib: optimize computation time: replace scalars by arrays, etc.
! 2014-09 - J.F. Gueremy new formulation of the resolution function for closure
!             condition and no more smoothing of dw/dp (ZALFAVEC=1.)
! 2015-02 -  I. Beau: Bugfix + some cleanings consistent with cy38 (NCVENTR options)
! 2015-09- J.M Piriou: Phasing of NWP and Climate versions
! 2015-11 - J.F. Gueremy: bugfix concerning the "mass flux" for implicit formulation
! 2015-11 - J.F. Gueremy: explicit transport flux for the dry air potential temperature
!             smoothing of mass flux for the transport fluxes
! 2015-12 - J.M. Piriou: GCVUV factor for momentum transport.
! 2016-06 - J.F. Gueremy et J.M. Piriou: debug sign when using ZFORD for ZAUX.
! 2017-04-21 - J.M. Piriou: use RNEBCX as a maximum value for convective cloudiness.
! 2017-05 - P. Marquet : NCAPEMOD WCAPEMOD RENTRMOD (YOMPHY0) "model-SBCAPE"

!-----------------------------------------------------------------------


USE PARKIND1, ONLY : JPIM, JPRB

USE YOMPHY   , ONLY : YRPHY
USE YOMCST   , ONLY : RATM       ,RG       ,RKAPPA   ,&
  & RD       ,RV       ,RCPD     ,&
  & RCPV     ,RETV     ,RCW      ,RCS      ,RLVTT    ,&
  & RLSTT    ,RTT      ,RALPW    ,RBETW    ,RGAMW    ,&
  & RALPS    ,RBETS    ,RGAMS    ,RALPD    ,RBETD    ,&
  & RGAMD    ,RPI      ,RA       ,&
  & RDT
USE YOMPHY0  , ONLY : YRPHY0
USE YOMPHY2  , ONLY : YRPHY2

USE YOMCT0   , ONLY : LELAM
USE YOMDIM   , ONLY : YRDIM
USE YEMGEO   , ONLY : YREGEO
USE YOMCT3   , ONLY : NSTEP
USE YOMSCM   , ONLY : NFRSCM
USE YOMRIP   , ONLY : YRRIP
USE YOMGEM   , ONLY : YRGEM

IMPLICIT NONE

!     DUMMY ARGUMENTS.

INTEGER(KIND=JPIM), INTENT(IN) :: KFDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KIDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KLEV
INTEGER(KIND=JPIM), INTENT(IN) :: KGPBLKS,KLON
INTEGER(KIND=JPIM), INTENT(IN) :: KTDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KTRA

REAL(KIND=JPRB), INTENT(IN)    :: PALPH(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PAPHI(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PAPHIF(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PAPRS(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PAPRSF(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PCP(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PLH(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PR(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PDELP(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PLNPR(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PQ(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PQI(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PQL(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PQLIS(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PQSAT(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PQW(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PRDELP(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PCVGQ(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PT(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PTW(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PU(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PV(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PTRA(KLON,KLEV,KTRA,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PTKE(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PEVAPO(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PGM(KLON,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PTS(KLON,KGPBLKS)
REAL(KIND=JPRB), INTENT(IN)    :: PQS(KLON,KGPBLKS)

INTEGER(KIND=JPIM), INTENT(INOUT) :: KNLAB(KLON,KLEV,KGPBLKS)
INTEGER(KIND=JPIM), INTENT(INOUT) :: KNND(KLON,KGPBLKS)
REAL(KIND=JPRB)   , INTENT(INOUT) :: PALF(KLON,KGPBLKS)

REAL(KIND=JPRB), INTENT(OUT)   :: PCAPE(KLON,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQ(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQL(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQI(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCS(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCTH(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFCCQL(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFCCQI(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCU(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCV(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCTRA(KLON,0:KLEV,KTRA,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PMF_UP(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PTU(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PQU(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PSU(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PNEBC(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PQLIC(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFHMLTS(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PENTR_U(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PDETR_U(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PENTR_D(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PDETR_D(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPLCL(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPLCN(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPEVPCL(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPEVPCN(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFHEVPP(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PALF_CAPE(KLON,KGPBLKS)
REAL(KIND=JPRB), INTENT(OUT)   :: PALF_CVGQ(KLON,KGPBLKS)

REAL(KIND=JPRB), INTENT(INOUT) :: PUDAL(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT) :: PUDOM(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT) :: PDDAL(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB), INTENT(INOUT) :: PDDOM(KLON,KLEV,KGPBLKS)

! LOCALS.

REAL(KIND=JPRB) :: ZWU(KLON,KLEV+1,KGPBLKS)
REAL(KIND=JPRB) :: ZWD(KLON,KLEV+1,KGPBLKS)
REAL(KIND=JPRB) :: ZKEDD(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZWD_PLUS_BUO(KLON,KLEV,KGPBLKS)

REAL(KIND=JPRB) :: ZTALF_SCE(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZTALF_SIN(KLON,KGPBLKS)

REAL(KIND=JPRB) :: ZA13(KLON,KLEV,KGPBLKS),ZA14(KLON,KLEV,KGPBLKS)&
  &,ZBET(KLON,KLEV,KGPBLKS)&
  &,ZDSE(KLON,KLEV,KGPBLKS)&
  &,ZIFRAC(KLON,KLEV,KGPBLKS)&
  &,ZLDN(KLON,KLEV,KGPBLKS),ZPOID(KLON,KLEV,KGPBLKS)&
  &,ZRMIX(KLON,KLEV,KGPBLKS),ZSDN(KLON,KLEV,KGPBLKS)&
  &,ZTVE(KLON,KLEV,KGPBLKS),ZTVN(KLON,KLEV,KGPBLKS)&
  &,ZUM(KLON,KLEV,KGPBLKS),ZVM(KLON,KLEV,KGPBLKS),ZQBW(KLON,KGPBLKS),ZTBW(KLON,KGPBLKS)&
  &,ZFORM(KLON,0:KLEV,KGPBLKS),ZDQCA(KLON,0:KLEV,KGPBLKS)

INTEGER(KIND=JPIM) :: JTRA
REAL(KIND=JPRB) :: ZA15(KLON,KLEV,KTRA,KGPBLKS)
REAL(KIND=JPRB) :: ZTRAM(KLON,KLEV,KTRA,KGPBLKS)
REAL(KIND=JPRB) :: ZTRAMD(KLON,KLEV,KTRA,KGPBLKS)
REAL(KIND=JPRB) :: ZSTRCTRAD(KLON,0:KLEV,KTRA,KGPBLKS)

INTEGER(KIND=JPIM) :: INBAS(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZCP(KLON,KGPBLKS)&
  &,ZLB(KLON,KGPBLKS),ZLH(KLON,KGPBLKS),ZQB(KLON,KGPBLKS)&
  &,ZRBB(KLON,KGPBLKS),ZRBH(KLON,KGPBLKS),ZRVH(KLON,KGPBLKS)&
  &,ZS15(KLON,KGPBLKS),ZS16(KLON,KGPBLKS)&
  &,ZTB(KLON,KGPBLKS)


INTEGER(KIND=JPIM) :: ISUM, ITOP, JIT, JLEV, JBLK,JLON

REAL(KIND=JPRB) :: ZARLII,ZBAS, &
  &ZCPSMD, ZCPVMD, &
  &ZCPVMS, ZCPVMW, ZCPWMD, ZDCP, ZDELQ, &
  &ZDELT, ZDELTA, ZDPSGDT, ZDQW, &
  &ZFER, ZEPS16, &
  &ZESP, ZEW, ZEXP, &
  &ZAUX, ZGDT, ZGDTI, &
  &ZLIQ, ZMIX, ZNBA, ZQW, &
  &ZRVMD, ZZ, ZZVAL, &
  &ZB, ZLHTBW, &
  &ZIDT, ZTPHY, &
  &ZINCRQ,ZCPBW, &
  &ZEPSW,ZWEIGHT,ZEPS_BCCS
INTEGER(KIND=JPIM) :: ILEV
REAL(KIND=JPRB) :: ZBETA1RIO,ZA1RIO,ZBRIO,ZCRIO

REAL(KIND=JPRB) :: ZLN(KLON,KGPBLKS),ZTNH(KLON,KGPBLKS),ZQNH(KLON,KGPBLKS),ZVVER(KLON,0:KLEV,KGPBLKS),ZDWNDP(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZCAPE(KLON,KGPBLKS),ZEPS_TUR(KLON,KLEV,KGPBLKS),ZEPS_ORG(KLON,KLEV,KGPBLKS),ZDEL_ORG(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZKD(KLON,KLEV,KGPBLKS),ZSIGMA(KLON,0:KLEV,KGPBLKS),ZTBH(KLON,KGPBLKS),ZQBH(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZRBBS(KLON,KGPBLKS),ZRBHS(KLON,KGPBLKS),ZCPH,ZTNSEC,ZTVNL,ZTVEL,ZCAPEL(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZCIN(KLON,KGPBLKS),ZCINL(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZBUO_W(KLON,KLEV,KGPBLKS),ZFLO_OMEGA,ZDELPF,ZENTR_TUR,ZKDL,ZVVERDEN,ZVVERDM(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZBUO_W_POS(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDELTAP,ZVVERN,ZEPS_TURL,ZKDX,ZMOD(KLON,KLEV,KGPBLKS),ZPPS,ZMOD_MIN,ZMOD_MAX
REAL(KIND=JPRB) :: ZENTRO,ZEPS_ORG0,ZTLN,ZTLE,ZQSTLE,ZQSTLN,ZSN,ZSE,ZCHIS
REAL(KIND=JPRB) :: ZTVLN,ZTVLE,ZNCHI0,ZDCHI0,ZEPS0,ZEPSVVER,ZCHI0,ZCHI02,ZDLOGM,ZFMDQN
REAL(KIND=JPRB) :: ZFMDSN,ZFMDS(KLON,KGPBLKS),ZFMDQ(KLON,KGPBLKS),ZDPLAB,ZS12(KLON,KGPBLKS),ZS11(KLON,KGPBLKS),ZTAU(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZDLON,ZDLONL,ZFDXTAUX(KLON,KGPBLKS),ZFORMV,ZTAU_DIAG(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZTD,ZQDN(KLON,KLEV,KGPBLKS),ZBUOY(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIVERG,ZBIN,ZTKLEV,ZTBASE(KLON,KGPBLKS),ZQBASE(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZFLUXDIAG(KLON,KLEV,KGPBLKS),ZENTR_T_LOC(KLON,KLEV,KGPBLKS),ZEMD_DIAG(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZEPSILON_U(KLON,KLEV,KGPBLKS),ZDELTA_U(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDEPTH(KLON,KGPBLKS),ZVACC(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZASCENT_BASE(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZDIAGFLO(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIAG_ECART_TV(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIAG_ECART_T(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIAGFRICTION(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIAGTRANSP(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIAG_EPS_ORG(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIAG_EPS_TUR(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIAG_WMAX(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZDIAG_TUDAL(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIAG_KNLAB(KLON,KLEV,KGPBLKS)

INTEGER(KIND=JPIM) :: ICDN(KLON,KGPBLKS),INCDN(KLON,KLEV,KGPBLKS),INIVBAC(KLON,KLEV,KGPBLKS),IBAC(KLON,KGPBLKS), ISDELTAP
INTEGER(KIND=JPIM) :: IVVER,IDOMDP,IVVN,IVVX,INUA,ICHIS,IENTR,IKUO6(KLON,KGPBLKS),IQLIC(KLON,KGPBLKS)
INTEGER(KIND=JPIM) :: IKUO5(KLON,KGPBLKS),IE0,ILEVTEN(KLON,KGPBLKS),INLFC(KLON,KLEV,KGPBLKS),ILFC(KLON,KGPBLKS),ICIN

REAL(KIND=JPRB) :: ZSU(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTU(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZQU(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZS5(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZEPS3
REAL(KIND=JPRB) :: ZE,ZR,ZTCOND,ZTEL(KLON,KGPBLKS),ZTEN(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZBETD(KLON,KLEV,KGPBLKS),ZDEL_ORGD(KLON,KLEV,KGPBLKS),ZEPS_ORGD(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZQN2D(KLON,KLEV,KGPBLKS),ZSDND(KLON,KLEV,KGPBLKS),ZSN2D(KLON,KLEV,KGPBLKS),ZTN2D(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZFORU(KLON,0:KLEV,KGPBLKS),ZFORD(KLON,0:KLEV,KGPBLKS),ZQDND(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZBCC_C_HALF(KLON,0:KLEV,KGPBLKS),ZUMD(KLON,KLEV,KGPBLKS),ZVMD(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZBCC_C_FULL(KLON,KLEV,KGPBLKS),ZBCC_CD_FULL(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZBCC(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZCCHSL,ZCCHSN,ZRHO(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZT_DOWN(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIFF_Z_UD(KLON,0:KLEV,KGPBLKS)

REAL(KIND=JPRB) :: ZTWU_ADV(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWU_BUO(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWU_DYP(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWU_NHD(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWU_FRI(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWU_TOT_RAW(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWU_TOT(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWU_STAU(KLON,KLEV,KGPBLKS)

REAL(KIND=JPRB) :: ZTWD_ADV(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWD_BUO(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWD_DYP(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWD_NHD(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWD_FRI(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWD_TOT_RAW(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWD_TOT(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTWD_STAU(KLON,KLEV,KGPBLKS)

REAL(KIND=JPRB) :: ZMEAN_U(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZMEAN_D(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZINTEG(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTARGET_WD(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZPLH(KLON,KGPBLKS),ZRME(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZEPS1,ZEPS4
REAL(KIND=JPRB) :: ZDIFCS_DD_DIAG(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIFCS_UD_NOCORR_DIAG(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIFCS_DD_NOCORR_DIAG(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZRE(KLON,KLEV,KGPBLKS) ! Reduce Entrainment factor, total.
REAL(KIND=JPRB) :: ZRE_SATDEF(KLON,KLEV,KGPBLKS) ! Reduce Entrainment factor, due to saturation deficit.
REAL(KIND=JPRB) :: ZRE_HEIGHT(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZRE_KEDD(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZSATDEF(KLON,KGPBLKS),ZDENO(KLON,KGPBLKS),ZINTE(KLON,KGPBLKS),ZRH(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZBINID(KLON,KLEV,KGPBLKS),ZBINID2(KLON,KLEV,KGPBLKS),ZRT,ZIWGREAT
REAL(KIND=JPRB) :: ZBINTKE,ZBINDEPTH,ZHEIGHT,ZBINBUO(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZDIFCQD(KLON,0:KLEV,KGPBLKS),ZDIFCSD(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZI1(KLON,KLEV,KGPBLKS),ZNND(KLON,KGPBLKS),ZSTRCUD(KLON,0:KLEV,KGPBLKS),ZSTRCVD(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZPHIF_U_EQUIP(KLON,KLEV+1,KGPBLKS) ! geopotential at full levels within updraft, under the equipressure hypothesis.
REAL(KIND=JPRB) :: ZPHIF_U(KLON,KLEV+1,KGPBLKS) ! geopotential at full levels within updraft.
REAL(KIND=JPRB) :: ZEVAPO(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZTMPVAR(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZLISS(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZRHOH(KLON,0:KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZLOGRATIO(KLON,KGPBLKS), ZALFAVEC(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZTLE_ARR(KLON,KGPBLKS), ZTLN_ARR(KLON,KGPBLKS), ZEW_TLE(KLON,KGPBLKS), ZEW_TLN(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZLOGSIGMA(KLON,KGPBLKS), ZDELTA_ARR(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZCVGQ(KLON,KGPBLKS),ZIBCCS(KLON,KGPBLKS),ZALF_CVGQ(KLON,KGPBLKS),ZPREVIOUST(KLON,KGPBLKS),ZT(KLON,KLEV,KGPBLKS)
REAL(KIND=JPRB) :: ZALFX(KLON,KGPBLKS)
REAL(KIND=JPRB) :: ZA,ZA2
REAL(KIND=JPRB) :: ZC
REAL(KIND=JPRB) :: ZD
REAL(KIND=JPRB) :: ZWNEW
REAL(KIND=JPRB) :: ZENTR
REAL(KIND=JPRB) :: ZENTRX
REAL(KIND=JPRB) :: ZRESOL
REAL(KIND=JPRB) :: ZNEBCX
! Dummy setup for CALL FPCINCAPE
INTEGER(KIND=JPIM) :: ILCL(KLON,KGPBLKS),IFCL(KLON,KGPBLKS),IEL(KLON,KGPBLKS)

INTEGER(KIND=JPIM) :: INLABD(KLON,KLEV,KGPBLKS)
LOGICAL :: LLTEXC,LLNHACC,LLCOND1,LLCAPECIN

!-----------------------------------------------------------------------

#include "acmtddd.intfb.h"
#include "fcttrm.func.h"
#include "fctdoi.func.h"
#include "fpcincape.intfb.h"



DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV+1

ZWU(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV+1

ZWD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


LLCAPECIN=.FALSE.
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

  ZPREVIOUST(JLON,JBLK)=PT(JLON,KTDIA,JBLK)

ENDDO
ENDDO

DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV=KTDIA,KLEV
  

    ! Limit T value, so that no instability can be greater than GINSTX Kelvin per level.
    ! This is done in order to prevent temporal instabilities generated by too large time
    ! steps versus vertical resolution, close to orography.
    ZT(JLON,JLEV,JBLK)=MIN(PT(JLON,JLEV,JBLK),ZPREVIOUST(JLON,JBLK)+YRPHY0%GINSTX)
    ZPREVIOUST(JLON,JBLK)=ZT(JLON,JLEV,JBLK)

    ! VERTICAL VELOCITY IN M/S COMPUTED FROM VERTICAL VELOCITY IN PA/S.
    ZWU(JLON,JLEV,JBLK)=-PUDOM(JLON,JLEV,JBLK)*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/(PAPRSF(JLON,JLEV,JBLK)*RG)
    ZWD(JLON,JLEV,JBLK)=-PDDOM(JLON,JLEV,JBLK)*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/(PAPRSF(JLON,JLEV,JBLK)*RG)
  
ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

ZKEDD(JLON,JBLK) = 0._JPRB

ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV=KTDIA,KLEV
  
    ! Kinetic energy of the downdraft.
    ZKEDD(JLON,JBLK)=ZKEDD(JLON,JBLK)+0.5_JPRB*ZWD(JLON,JLEV,JBLK)*ZWD(JLON,JLEV,JBLK)*PDELP(JLON,JLEV,JBLK)/RG
  
ENDDO
ENDDO
ENDDO


!     -------------------
! // INITIALISATIONS

IF(YRPHY0%NCVCLOS == 4) THEN
  !
  !-------------------------------------------------
  ! Surface fraction PALF is prognostic.
  ! In input, PUDAL is the result of 3D advection applied to the uniform in the
  ! vertical PALF field from previous time step.
  ! PUDAL is set in output to ZSIGMA*PALF.
  ! PALF is set in output to the new prognostic value of PALF, and will be set
  ! by the caller of present routine ACMTUD in the array PUDAL, in order to be
  ! advected in 3D.
  ! Here PALF is set to the value of the 3D field PUDAL above PBL.
  ! In 1D, as there is no advection, PUDAL is nothing but the uniform value of PALF from previous time
  ! step.
  !-------------------------------------------------
  !
  ILEV=MAX(KTDIA,INT(YRPHY0%GSIGA*REAL(KLEV)))
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
    PALF(JLON,JBLK)=PUDAL(JLON,ILEV,JBLK)
  
  ENDDO
  ENDDO

ELSE
  !-------------------------------------------------
  ! Surface fraction PALF is diagnostic.
  !-------------------------------------------------
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  PUDAL(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


ENDIF
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

PDDAL(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZEPS_TUR(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZEPS_ORG(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZEMD_DIAG(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZDIFCQD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZDIFCSD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZSTRCUD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZSTRCVD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZVACC(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


ZENTR=YRPHY0%GCVRE*YRPHY0%TENTR
ZENTRX=YRPHY0%GCVRE*YRPHY0%TENTRX
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JTRA = 1, KTRA
DO JLEV = 0, KLEV

ZSTRCTRAD(JLON,JLEV,JTRA,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZEPSILON_U(JLON,JLEV,JBLK) = ZENTRX*RG

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZDELTA_U(JLON,JLEV,JBLK) = ZENTRX*RG

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

PENTR_U(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

PDETR_U(JLON,JLEV,JBLK) = YRPHY0%GCVENTR_MIN

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

PENTR_D(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

PDETR_D(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZBUOY(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZENTR_T_LOC(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZFLUXDIAG(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV+1

ZPHIF_U(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV+1

ZPHIF_U_EQUIP(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZDIFF_Z_UD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZMOD(JLON,JLEV,JBLK) = YRPHY0%GCVEZ

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZSIGMA(JLON,JLEV,JBLK) = 1._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZRE(JLON,JLEV,JBLK) = 1._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZRE_SATDEF(JLON,JLEV,JBLK) = 1._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZRE_HEIGHT(JLON,JLEV,JBLK) = 1._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZRE_KEDD(JLON,JLEV,JBLK) = 1._JPRB

ENDDO
ENDDO
ENDDO


ZTPHY=YRPHY2%TSPHY
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZLISS(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

PMF_UP(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZRHOH(JLON,JLEV,JBLK) = 1.0_JPRB

ENDDO
ENDDO
ENDDO



! Compute convective response time as a function of nominal resolution.
! REFLCAPE should in this case be independant of resolution.

IF(YRPHY0%REFLCAPE > 0._JPRB) THEN
  ! Climate tunings.
  IF (LELAM) THEN
    ZDLON=(2.0_JPRB*RPI*RA)/MIN(YREGEO%EDELX, YREGEO%EDELY)
  ELSE
    ZDLON=REAL(YRDIM%NDLON)
  ENDIF
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
    ZDLONL=MIN(ZDLON*PGM(JLON,JBLK),950._JPRB)
    ZFDXTAUX(JLON,JBLK)=YRPHY0%TEQC*1.E3_JPRB*(2.234E-4_JPRB*ZDLONL**2 &
    & -0.425_JPRB*ZDLONL+252.5_JPRB)
    ZALFX(JLON,JBLK)=YRPHY0%ALFX
  
  ENDDO
  ENDDO

ELSE
  ! NWP tunings.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
    ZFDXTAUX(JLON,JBLK)=ABS(YRPHY0%REFLCAPE)*PGM(JLON,JBLK)
    ! REDLXN is the mean model mesh in meter.
    ! ZRESOL is the local model resolution in 1/meter.
    ZRESOL=PGM(JLON,JBLK)/YRGEM%RDELXN
    ! ZALFX varies from ALFX_LR to ALFX_HR, as resolution goes from GCVRESN to GCVRESX.
    ZALFX(JLON,JBLK)=MAX(YRPHY0%ALFX_LR,MIN(YRPHY0%ALFX_HR,YRPHY0%ALFX_LR+(ZRESOL-YRPHY0%GCVRESN)&
               &/(YRPHY0%GCVRESX-YRPHY0%GCVRESN)*(YRPHY0%ALFX_HR-YRPHY0%ALFX_LR)))
  
  ENDDO
  ENDDO

ENDIF

!--------------------------------------------------

!     SETTING ALL FLUXES TO ZERO (FOR THE CASE WITHOUT CONVECTION)
! THIS IS DONE NOW BY INITAPLPAR

!     ---------------------------
! // AUXILIARY CONSTANTS.

ZEPS0=1.E-12_JPRB
ZEPS3=1.E-01_JPRB
ZEPSVVER=1._JPRB
ZEPS16=1.E-06_JPRB
ZEPS1=1.E-10_JPRB
ZEPS4=1.E-05_JPRB
ZEPSW=0.01_JPRB
ZEPS_BCCS=2.8E-05_JPRB ! Drizzle threshold in mm/s.
ZNEBCX=MIN(1._JPRB-ZEPS0,YRPHY0%RNEBCX)


! UPDRAFT INIT
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZFORM(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZFORU(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZDQCA(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZVVERDM(JLON,JLEV,JBLK) = PUDOM(JLON,JLEV,JBLK)

ENDDO
ENDDO
ENDDO



! DOWNDRAFT INIT
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZFORD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZBETD(JLON,JLEV,JBLK) = 1._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZDEL_ORGD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZEPS_ORGD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZQDND(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZQN2D(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZSN2D(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZTN2D(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZSDND(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZUMD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZVMD(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JTRA = 1, KTRA
DO JLEV = 1, KLEV

ZTRAMD(JLON,JLEV,JTRA,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

INLABD(JLON,JLEV,JBLK) = 0

ENDDO
ENDDO
ENDDO



ZARLII=0.004_JPRB
ZRVMD=RV-RD
ZCPVMD=RCPV-RCPD
ZCPVMW=RCPV-RCW
ZCPVMS=RCPV-RCS
ZCPWMD=RCW-RCPD
ZCPSMD=RCS-RCPD

ZIDT=1.0_JPRB/ZTPHY
ZGDT=RG*ZTPHY
ZGDTI=1.0_JPRB/ZGDT

ZCCHSL=RCW-RCPD
ZCCHSN=RCS-RCPD

ZKDX=YRPHY0%RKDN*ZENTRX/ZENTR
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

ZDEPTH(JLON,JBLK) = 0._JPRB

ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

ZASCENT_BASE(JLON,JBLK) = 100000._JPRB

ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZDIAGFLO(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZDIAG_ECART_TV(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZDIAG_ECART_T(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZDIAGFRICTION(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZDIAGTRANSP(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZDIAG_EPS_ORG(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZDIAG_EPS_TUR(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

ZDIAG_WMAX(JLON,JBLK) = 0._JPRB

ENDDO
ENDDO


ZDIAG_TUDAL=0._JPRB
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZDIAG_KNLAB(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZBCC(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZBCC_C_HALF(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZBCC_C_FULL(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZBCC_CD_FULL(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO



DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

PFHMLTS(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

PFHEVPP(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZDIFCS_DD_DIAG(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZDIFCS_UD_NOCORR_DIAG(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 0, KLEV

ZDIFCS_DD_NOCORR_DIAG(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZBUO_W(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZBUO_W_POS(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO


LLTEXC=YRPHY0%GCVTEXC /= 0._JPRB
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

ZSATDEF(JLON,JBLK) = 0._JPRB

ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

ZRH(JLON,JBLK) = 0._JPRB

ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

ZDENO(JLON,JBLK) = 0._JPRB

ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV = 1, KLEV

ZBINBUO(JLON,JLEV,JBLK) = 0._JPRB

ENDDO
ENDDO
ENDDO



ZMOD_MIN=YRPHY0%GCVEZ
ZMOD_MAX=1.0_JPRB
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

ZCVGQ(JLON,JBLK) = 0._JPRB

ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV=KTDIA,KLEV
!DEC$ VECTOR ALWAYS
  

    ! DIAGNOSTIC OF MAXIMUM VERTICAL VELOCITY IN THE COLUMN.
    ZDIAG_WMAX(JLON,JBLK)=MAX(ZDIAG_WMAX(JLON,JBLK),ZWU(JLON,JLEV,JBLK))

    ! CONVECTIVE CLOUD DEPTH:
    ! CUMULATE DEPTH OF LAYERS WHERE VERTICAL VELOCITY IS GREATER THAN A GIVEN THRESHOLD.
    ZBINID(JLON,JLEV,JBLK)=MAX(0._JPRB,SIGN(1._JPRB,ZWU(JLON,JLEV,JBLK)-YRPHY0%GTDCL))
    ZDEPTH(JLON,JBLK)=ZDEPTH(JLON,JBLK)+(PAPHI(JLON,JLEV-1,JBLK)-PAPHI(JLON,JLEV,JBLK))/RG*ZBINID(JLON,JLEV,JBLK)

    ! ZASCENT_BASE: height (in m above sea level) of the lowest level where w_updraft > 10 m/s.
    ZIWGREAT=MAX(0._JPRB,SIGN(1._JPRB,ZWU(JLON,JLEV,JBLK)-10.0_JPRB))
    ZASCENT_BASE(JLON,JBLK)=ZASCENT_BASE(JLON,JBLK)*(1._JPRB-ZIWGREAT)+PAPHI(JLON,JLEV,JBLK)/RG*ZIWGREAT

    ! ZMOD: MODULATES ENTRAINMENT WITH Z.
    ZPPS=PAPRS(JLON,JLEV,JBLK)/PAPRS(JLON,KLEV,JBLK)
    ZMOD(JLON,JLEV,JBLK)=MAX(ZMOD_MIN,MIN(ZMOD_MAX,ZMOD_MIN+(ZMOD_MAX-ZMOD_MIN) &
      &*MAX(0._JPRB,MIN(1._JPRB,(ZPPS-0.35_JPRB)/(0.85_JPRB-0.35_JPRB)))))

    ! DENSITY.
    ZRHO(JLON,JLEV,JBLK)=PAPRSF(JLON,JLEV,JBLK)/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))
    ZRHOH(JLON,JLEV-1,JBLK) = 0.5_JPRB*(ZRHO(JLON,JLEV-1,JBLK)+ZRHO(JLON,JLEV,JBLK))

    ! SATURATION DEFICIT.
    ZINTE(JLON,JBLK)=PDELP(JLON,JLEV,JBLK)/RG &
      & *MAX(0._JPRB,SIGN(1._JPRB,-(PAPHIF(JLON,JLEV,JBLK)-PAPHI(JLON,KLEV,JBLK)-2500._JPRB*RG) &
      & *(PAPHIF(JLON,JLEV,JBLK)-PAPHI(JLON,KLEV,JBLK)-4500._JPRB*RG)))
    ZSATDEF(JLON,JBLK)=ZSATDEF(JLON,JBLK)+(PQSAT(JLON,JLEV,JBLK)-PQ(JLON,JLEV,JBLK))*ZINTE(JLON,JBLK)
    ZRH(JLON,JBLK)=ZRH(JLON,JBLK)+PQ(JLON,JLEV,JBLK)/PQSAT(JLON,JLEV,JBLK)*ZINTE(JLON,JBLK)
    ZDENO(JLON,JBLK)=ZDENO(JLON,JBLK)+ZINTE(JLON,JBLK)

    ! HUMIDITY CONVERGENCE INTEGRATED VERTICALLY OVER CONVECTIVE LEVELS.
    ZCVGQ(JLON,JBLK)=ZCVGQ(JLON,JBLK)+MIN(YRPHY0%GCVGQX,PCVGQ(JLON,JLEV,JBLK)) &
      & *ZBINID(JLON,JLEV,JBLK)*PDELP(JLON,JLEV,JBLK)/RG
  
ENDDO
ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

  ZRHOH(JLON,KLEV,JBLK) = ZRHO(JLON,KLEV,JBLK) ! Usefull for extra-bound computation !!!!

ENDDO
ENDDO


DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

  ZSATDEF(JLON,JBLK)=ZSATDEF(JLON,JBLK)/MAX(100._JPRB,ZDENO(JLON,JBLK))
  ZRH(JLON,JBLK)=ZRH(JLON,JBLK)/MAX(100._JPRB,ZDENO(JLON,JBLK))

ENDDO
ENDDO


! ------------------------------------------------------------------
! // COMPUTATION OF DERIVED PARAMETERS, SECURITY CONSTANTS
! OTHER PRELIMINARY CALCULATION

! THETAE
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA

  ILEVTEN(JLON,JBLK)=0
  ZE=MAX(ZEPS0,PAPRSF(JLON,KTDIA,JBLK)*PQ(JLON,KTDIA,JBLK)&
    &/((1.0_JPRB-PQ(JLON,KTDIA,JBLK))*RD/RV+PQ(JLON,KTDIA,JBLK)))
  ZR=PQ(JLON,KTDIA,JBLK)/(1.0_JPRB-PQ(JLON,KTDIA,JBLK))*1000._JPRB
  IE0=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,ZEPS0-ZE)))
  ZTCOND=IE0*2840._JPRB/(3.5_JPRB*LOG(ZT(JLON,KTDIA,JBLK))-LOG(ZE/100._JPRB)&
    &-4.805_JPRB)+55._JPRB+(1-IE0)*ZT(JLON,KTDIA,JBLK)
  ZTEN(JLON,JBLK)=ZT(JLON,KTDIA,JBLK)*(100000._JPRB/PAPRSF(JLON,KTDIA,JBLK))&
    &**(0.2854_JPRB*(1.0_JPRB-0.28E-3_JPRB*ZR))&
    &*EXP((3.376_JPRB/ZTCOND-0.00254_JPRB)*ZR*(1.0_JPRB+0.81E-3_JPRB*ZR))

  ZPLH(JLON,JBLK)=0.0_JPRB
  ZRME(JLON,JBLK)=0.0_JPRB

  ZPHIF_U_EQUIP(JLON,KLEV,JBLK)=PAPHIF(JLON,KLEV,JBLK)
  ZPHIF_U_EQUIP(JLON,KLEV+1,JBLK)=PAPHI(JLON,KLEV,JBLK)

  ZPHIF_U(JLON,KLEV,JBLK)=PAPHIF(JLON,KLEV,JBLK)
  ZPHIF_U(JLON,KLEV+1,JBLK)=PAPHI(JLON,KLEV,JBLK)

ENDDO
ENDDO

DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV=KTDIA,KLEV
  
    ZALFAVEC(JLON,JBLK)=MAX(ZEPS0,PAPRSF(JLON,JLEV,JBLK)*PQ(JLON,JLEV,JBLK)&
      &/((1.0_JPRB-PQ(JLON,JLEV,JBLK))*RD/RV+PQ(JLON,JLEV,JBLK)))
    ZDELTA_ARR(JLON,JBLK)=100000._JPRB/PAPRSF(JLON,JLEV,JBLK)
    ZTLE_ARR(JLON,JBLK)=PQ(JLON,JLEV,JBLK)/(1.0_JPRB-PQ(JLON,JLEV,JBLK))*1000._JPRB
    ZLOGSIGMA(JLON,JBLK)=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,ZEPS0-ZALFAVEC(JLON,JBLK))))
  
  
    IE0=ZLOGSIGMA(JLON,JBLK)
    ZR=ZTLE_ARR(JLON,JBLK)
    ZTCOND=IE0*2840._JPRB/(3.5_JPRB*LOG(ZT(JLON,JLEV,JBLK))-LOG(ZALFAVEC(JLON,JBLK)/100._JPRB)-4.805_JPRB) &
     & +55._JPRB+(1-IE0)*ZT(JLON,JLEV,JBLK)
    ZTEL(JLON,JBLK)=ZT(JLON,JLEV,JBLK)*ZDELTA_ARR(JLON,JBLK) &
     &**(0.2854_JPRB*(1.0_JPRB-0.28E-3_JPRB*ZR)) &
     &*EXP((3.376_JPRB/ZTCOND-0.00254_JPRB)*ZR*(1.0_JPRB+0.81E-3_JPRB*ZR))
  
!DEC$ VECTOR ALWAYS
  
    ZTEN(JLON,JBLK)=MIN(ZTEN(JLON,JBLK),ZTEL(JLON,JBLK))
    ILEVTEN(JLON,JBLK)=MAX(JLEV*NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZTEN(JLON,JBLK)&
      &-ZTEL(JLON,JBLK)))),ILEVTEN(JLON,JBLK))
  
ENDDO
ENDDO
ENDDO



LLNHACC=YRPHY0%GNHACC < 0._JPRB
IF(LLNHACC) THEN
  ! In order to maintain convection in the night, where dd activity occurs,
  ! locate maximum of thetav, on the levels where vertical divergency of wd is
  ! larger than the threshold GNHACC.
  ! The result is put in (ZTBASE, ZQBASE): (T, qv) at ascent base.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
    ZTBASE(JLON,JBLK)=ZT(JLON,KLEV,JBLK)
    ZQBASE(JLON,JBLK)=PQ(JLON,KLEV,JBLK)
  
  ENDDO
  ENDDO

  ILEV=MAX(KTDIA,INT(0.95_JPRB*REAL(KLEV)))
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ILEV,KLEV
    
      ZDIVERG=(ZWD(JLON,JLEV-1,JBLK)-ZWD(JLON,JLEV,JBLK)) &
        & /(PAPHIF(JLON,JLEV-1,JBLK)-PAPHIF(JLON,JLEV,JBLK))*RG
      ZBIN=MAX(0._JPRB,SIGN(1._JPRB,YRPHY0%GNHACC-ZDIVERG))
      ZTKLEV=ZT(JLON,JLEV,JBLK)*(PAPRSF(JLON,KLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK))**(RD/RCPD)
      ZBIN=ZBIN*MAX(0._JPRB,SIGN(1._JPRB,ZTKLEV-ZTBASE(JLON,JBLK)))
      ZTBASE(JLON,JBLK)=ZBIN*ZTKLEV+(1._JPRB-ZBIN)*ZTBASE(JLON,JBLK)
      ZQBASE(JLON,JBLK)=ZBIN*PQ(JLON,JLEV,JBLK)+(1._JPRB-ZBIN)*ZQBASE(JLON,JBLK)
    
  ENDDO
  ENDDO
  ENDDO

ENDIF

IF(YRPHY0%GCLOEB > 0._JPRB) THEN
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    
      ! Uniform ZRE, linked to saturation deficit.
      ZRE(JLON,JLEV,JBLK)=YRPHY0%GREMIN+(YRPHY0%GREMAX-YRPHY0%GREMIN) &
        & *MAX(0._JPRB,MIN(1._JPRB,(ZSATDEF(JLON,JBLK)-YRPHY0%GSDMIN)/(YRPHY0%GSDMAX-YRPHY0%GSDMIN)))
    
  ENDDO
  ENDDO
  ENDDO

ENDIF

DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV=KTDIA,KLEV
  
    ! ZPOID     : DP/(RG*DT) FOR A GIVEN LEVEL AND A GIVEN TIME STEP.
    ! ZDSE      : LOCAL ARRAY FOR DRY STATIC ENERGIES.
    ZPOID(JLON,JLEV,JBLK)=PDELP(JLON,JLEV,JBLK)*ZGDTI
    ZDSE(JLON,JLEV,JBLK)=PCP(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)+PAPHIF(JLON,JLEV,JBLK)
    INBAS(JLON,JLEV,JBLK)=0
  
ENDDO
ENDDO
ENDDO


!     ------------------------------------------------------------------
! // INITIALISATION AT THE BOTTOM LAYER TO START THE CLOUD PROFILE

! - TEMPORAIRE(S) 2D (0:KLEV) .

! ZFORM    : PROFILE OF MASS FLUX AND LATER MASS FLUX TIME DT.
! KNLAB    : FINAL LAYER ACTIVITY INDEX
! KNND     : PHYSICAL SOLUTION FLAG

DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA


  ! THERMODYNAMIC CHARACTERISTICS OF THE CLOUD.

  ! ZTDN       : TEMPERATURE OF THE CLOUDY ASCENT.
  ! ZQDN       : WATER VAPOUR SPECIFIC HUMIDITY OF THE CLOUDY ASCENT.
  ! ZLDN       : CONDENSED SPECIFIC HUMIDITY OF THE CLOUDY ASCENT.
  ! ZTVN      : VIRTUAL CLOUD TEMPERATURE
  ! ZTVE      : VIRTUAL ENVIRONMENT TEMPERATURE

  KNLAB(JLON,KLEV,JBLK)=0
  KNND(JLON,JBLK)=0

  IF(LLNHACC) THEN
    ! The profile starts at lowest model level from the (T,qv) value from the
    ! level where both dd diverges and theta is maximum. This (T,qv) value
    ! has been put adiabatically at level KLEV.
    PTU(JLON,KLEV,JBLK)=ZTBASE(JLON,JBLK)
    PQU(JLON,KLEV,JBLK)=ZQBASE(JLON,JBLK)
  ELSEIF(LLTEXC) THEN
    ! THE PROFILE STARTS AT LOWEST MODEL LEVEL FROM THE GRID-SCALE TEMPERATURE PLUS AN EXCESS DEPENDING ON TKE.
    PTU(JLON,KLEV,JBLK)=ZT(JLON,KLEV,JBLK)+MAX(0.1_JPRB,MIN(2.0_JPRB,YRPHY0%GCVTEXC*PTKE(JLON,KLEV,JBLK)/RCPD))
    ! THE PROFILE STARTS AT LOWEST MODEL LEVEL FROM THE GRID-SCALE WATER VAPOUR.
    PQU(JLON,KLEV,JBLK)=PQ(JLON,KLEV,JBLK)
  ELSE
    ! The profile starts at lowest model level from a mean between lowest model level and surface.
    PTU(JLON,KLEV,JBLK)=ZT(JLON,KLEV,JBLK)+MAX(0._JPRB,YRPHY0%GFSURF*(PTS(JLON,JBLK)-ZT(JLON,KLEV,JBLK)))
    ! THE PROFILE STARTS AT LOWEST MODEL LEVEL FROM THE GRID-SCALE WATER VAPOUR.
    PQU(JLON,KLEV,JBLK)=PQ(JLON,KLEV,JBLK)
  ENDIF

  PSU(JLON,KLEV,JBLK)=(RCPD+ZCPVMD*PQU(JLON,KLEV,JBLK))*PTU(JLON,KLEV,JBLK)+ZPHIF_U(JLON,KLEV,JBLK)
  ZSU(JLON,KLEV,JBLK)=PSU(JLON,KLEV,JBLK)
  ZLN(JLON,JBLK)=0.0_JPRB
  ZIFRAC(JLON,KLEV,JBLK)=FONICE(PTU(JLON,KLEV,JBLK))
  ZTVN(JLON,KLEV,JBLK)=PTU(JLON,KLEV,JBLK)*(1.0_JPRB+RETV*PQU(JLON,KLEV,JBLK)-ZLN(JLON,JBLK))
  ZTVE(JLON,KLEV,JBLK)=ZT(JLON,KLEV,JBLK)*(1.0_JPRB+RETV*PQ(JLON,KLEV,JBLK)-PQLIS(JLON,KLEV,JBLK))
  PQLIC(JLON,KLEV,JBLK)=ZLN(JLON,JBLK)
  ZLDN(JLON,KLEV,JBLK)=ZLN(JLON,JBLK)
  ZTNH(JLON,JBLK)=PTW(JLON,KLEV,JBLK)
  ZQNH(JLON,JBLK)=PQW(JLON,KLEV,JBLK)
  ! TEST DE SATURATION DU NIVEAU (NIVEAU DE CONDENSATION ATTEINT).
  ! INCDN     : NIVEAU DU POINT DE CONDENSATION.
  ICDN(JLON,JBLK)=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,PQU(JLON,KLEV,JBLK)-PQSAT(JLON,KLEV,JBLK))))
  INCDN(JLON,KLEV,JBLK)=KLEV*ICDN(JLON,JBLK)
  ! INLFC     : NIVEAU DE CONVECTION LIBRE.
  INLFC(JLON,KLEV,JBLK)=0
  ZTD=ZT(JLON,KLEV,JBLK)*(1.0_JPRB-RETV*(PQSAT(JLON,KLEV,JBLK)-PQ(JLON,KLEV,JBLK))&
    & /(1.0_JPRB+RETV*PLH(JLON,KLEV,JBLK)*PQSAT(JLON,KLEV,JBLK)/(RV*ZT(JLON,KLEV,JBLK))))
  ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTD))
  ZEW=FOEW(ZTD,ZDELTA)
  ZESP=ZEW/PAPRSF(JLON,KLEV,JBLK)
  ZQW=FOQS(ZESP)
  ZTD=ICDN(JLON,JBLK)*(YRPHY0%GCVADET*ZTD+(1.0_JPRB-YRPHY0%GCVADET)*PTU(JLON,KLEV,JBLK))+(1-ICDN(JLON,JBLK))*PTU(JLON,KLEV,JBLK)
  ZQW=ICDN(JLON,JBLK)*(YRPHY0%GCVADET*ZQW+(1.0_JPRB-YRPHY0%GCVADET)*PQU(JLON,KLEV,JBLK))+(1-ICDN(JLON,JBLK))*PQU(JLON,KLEV,JBLK)
  ZQDN(JLON,KLEV,JBLK)=ZQW
  ZSDN(JLON,KLEV,JBLK)=(RCPD+ZCPVMD*ZQW)*ZTD+ZPHIF_U(JLON,KLEV,JBLK)

  ! INIVBAC   : NIVEAU DE LA BASE DE L'ASCENDANCE CONVECTIVE.
  INIVBAC(JLON,KLEV,JBLK)=KLEV
  ! ZVVER     : VITESSE VERT. DE LA COLONNE CONVECTIVE AUX INTERCOUCHES.
  IF (YRPHY0%LGVVEX) THEN
    ZRT=PR(JLON,KLEV,JBLK)*ZT(JLON,KLEV,JBLK)
    ZVVER(JLON,KLEV,JBLK)=-YRPHY0%GCVWEXC*SQRT(MAX(0._JPRB,2._JPRB/3._JPRB*MIN(5.0_JPRB &
      &,PTKE(JLON,KLEV,JBLK))))*RG*PAPRS(JLON,KLEV,JBLK)/ZRT
    ZVVER(JLON,KLEV-1,JBLK)=-YRPHY0%GCVWEXC*SQRT(MAX(0._JPRB,2._JPRB/3._JPRB*MIN(5.0_JPRB &
      &,PTKE(JLON,KLEV-1,JBLK))))*RG*PAPRS(JLON,KLEV-1,JBLK)/ZRT
  ELSE
    ZVVER(JLON,KLEV,JBLK)=0.0_JPRB
    ZVVER(JLON,KLEV-1,JBLK)=0.0_JPRB
  ENDIF
  ZVVERDM(JLON,KLEV,JBLK)=0.5_JPRB*(ZVVER(JLON,KLEV,JBLK)+ZVVER(JLON,KLEV-1,JBLK))
  ! ZDWNDP    : DERIVEE VERT. DE VITESSE VERT.
  ZDWNDP(JLON,KLEV,JBLK)=0.0_JPRB
  ! ZCAPE     : CAPE DU NIVEAU.
  ZCAPE(JLON,JBLK)=0.0_JPRB
  ZCIN(JLON,JBLK)=0.0_JPRB
  IF(YRPHY0%NCVENTR == 1 .OR. YRPHY0%NCVENTR == 15) THEN
    ! ZEPS_TUR    : ENTRAINEMENT TURBULENT.
    ZEPS_TUR(JLON,KLEV,JBLK)=ZRE(JLON,KLEV,JBLK)*ZENTRX
    ! ZEPS_ORG     : ENTRAINEMENT ORGANISE.
    ZEPS_ORG(JLON,KLEV,JBLK)=ZMOD(JLON,KLEV,JBLK)*ZRE(JLON,KLEV,JBLK)*ZENTRX &
      &*PR(JLON,KLEV,JBLK)*ZT(JLON,KLEV,JBLK)/PAPRSF(JLON,KLEV,JBLK)
    ! ZDEL_ORG     : DETRAINEMENT ORGANISE
    ZDEL_ORG(JLON,KLEV,JBLK)=0.0_JPRB
    ZEPSILON_U(JLON,KLEV,JBLK)=(ZMOD(JLON,KLEV,JBLK)*ZRE(JLON,KLEV,JBLK)*ZENTRX+ZEPS_TUR(JLON,KLEV,JBLK))*RG
    ZDELTA_U(JLON,KLEV,JBLK)=ZRE(JLON,KLEV,JBLK)*ZENTRX*RG
  ELSE
    ZEPSILON_U(JLON,KLEV,JBLK)=ZENTRX*RG
  ENDIF
  ! ZKD       : COEFFICIENT DE RESISTANCE.
  IF(YRPHY0%NCVENTR == 1) THEN
    ZKD(JLON,KLEV,JBLK)=ZKDX
  ELSE
    ZKD(JLON,KLEV,JBLK)=YRPHY0%ADOE*ZENTRX*PR(JLON,KLEV,JBLK)*ZT(JLON,KLEV,JBLK)/PAPRSF(JLON,KLEV,JBLK)
  ENDIF
  ! ZSIGMA    : FRACTION DE MAILLE COUVERTE PAR L'ASCENDANCE CONVECTIVE.
  ZSIGMA(JLON,KLEV,JBLK)=1.0_JPRB
  ZSIGMA(JLON,KLEV-1,JBLK)=1.0_JPRB
  ZS11(JLON,JBLK)=0.0_JPRB
  ZS12(JLON,JBLK)=0.0_JPRB
  ZS15(JLON,JBLK)=0.0_JPRB
  ZS16(JLON,JBLK)=0.0_JPRB
  ZS5(JLON,JBLK)=0.0_JPRB
  ZFMDS(JLON,JBLK)=0.0_JPRB
  ZFMDQ(JLON,JBLK)=0.0_JPRB

ENDDO
ENDDO


!     ------------------------------------------------------------------
! // FIRST VERTICAL LOOP (UPWARDS) INCLUDING THE SATURATED
!     ADIABATIC TYPE CALCULATION OF THE CLOUD PROFILE.

!     ITOP MAY HELP AVOIDING UNNECESSARY COMPUTATIONS IN THE UPPER PART OF THE
!     ATMOSPHERE

LLCOND1 = YRPHY0%NCVENTR == 1

ITOP=KLEV+1
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV=KLEV-1,KTDIA,-1

  ! // SATURATED ADIABAT WITH ENTRAINMENT AND LIQUID (OR ICE) WATER SUSTENTATION.


!DEC$ VECTOR ALWAYS
  

    ! ENTRAINMENT AT STARTING LEVEL JLEV+1

    ! ZTB       : "PTU" AT THE BOTTOM OF THE SLAB WITH ENTRAINMENT "IN".
    ! ZQB       : "PQU" AT THE BOTTOM OF THE SLAB WITH ENTRAINMENT "IN".
    ! ZLB       : "ZLDN" AT THE BOTTOM OF THE SLAB WITH ENTRAINMENT "IN".

    ! -------------------------------------------------
    ! // FRACTIONAL ENTRAINMENT RATE ZFER IN (J/KG)**-1.
    ! -------------------------------------------------

    ZFER=ZEPSILON_U(JLON,JLEV+1,JBLK)/RG

    ! TO APPLY WHEN COMPUTING PROFILE AT JLEV

    ZRMIX(JLON,JLEV,JBLK)=ZFER*(PAPHIF(JLON,JLEV,JBLK)-PAPHIF(JLON,JLEV+1,JBLK))
    ZRMIX(JLON,JLEV,JBLK)=ZRMIX(JLON,JLEV,JBLK)/(1.0_JPRB+ZRMIX(JLON,JLEV,JBLK))
    ZTBW(JLON,JBLK)=PTU(JLON,JLEV+1,JBLK)+ZRMIX(JLON,JLEV,JBLK)*(PTW(JLON,JLEV+1,JBLK)-PTU(JLON,JLEV+1,JBLK))
    ZDELTA_ARR(JLON,JBLK)=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTBW(JLON,JBLK)))

  

! Isolate what may not vectorize
  
    ZEW_TLE(JLON,JBLK)= FOEW (ZTBW(JLON,JBLK),ZDELTA_ARR(JLON,JBLK))
  

  

    ZQBW(JLON,JBLK)=PQU(JLON,JLEV+1,JBLK)+ZRMIX(JLON,JLEV,JBLK)*(PQW(JLON,JLEV+1,JBLK)-PQU(JLON,JLEV+1,JBLK))
    ZTB(JLON,JBLK)=PTU(JLON,JLEV+1,JBLK)+ZRMIX(JLON,JLEV,JBLK)*(ZT(JLON,JLEV+1,JBLK)-PTU(JLON,JLEV+1,JBLK))
    ZQB(JLON,JBLK)=PQU(JLON,JLEV+1,JBLK)+ZRMIX(JLON,JLEV,JBLK)*(PQ(JLON,JLEV+1,JBLK)-PQU(JLON,JLEV+1,JBLK))
    ICDN(JLON,JBLK)=MAX(0,-ISIGN(1,-INCDN(JLON,JLEV+1,JBLK)))
    ZLB(JLON,JBLK)=ZLN(JLON,JBLK)+ZRMIX(JLON,JLEV,JBLK)*(PQLIS(JLON,JLEV+1,JBLK)*ICDN(JLON,JBLK)-ZLN(JLON,JBLK))
    ZTBH(JLON,JBLK)=ZTNH(JLON,JBLK)+ZRMIX(JLON,JLEV,JBLK)*(ZT(JLON,JLEV+1,JBLK)-ZTNH(JLON,JBLK))
    ZQBH(JLON,JBLK)=ZQNH(JLON,JBLK)+ZRMIX(JLON,JLEV,JBLK)*(PQ(JLON,JLEV+1,JBLK)-ZQNH(JLON,JBLK))

    ! RE-ESTIMATE SATURATION AFTER MIXING

    ! ICE FRACTION AND LATENT HEAT FOR MIXED AIR TEMPERATURE

    ! ZDELTBW=FONICE(ZTBW(JLON))
    ZLHTBW=FOLH(ZTBW(JLON,JBLK),ZDELTA_ARR(JLON,JBLK))
    ZCPBW=RCPD+ZCPVMD*ZQBW(JLON,JBLK)

    ! COMPUTATION OF NEW EQUILIBRIUM OF MIXED AIR
    ZESP=ZEW_TLE(JLON,JBLK)/PAPRSF(JLON,JLEV+1,JBLK)
    ZQW= FOQS (ZESP)
    ZDQW=FODQS (ZQW,ZESP, FODLEW (ZTBW(JLON,JBLK),ZDELTA_ARR(JLON,JBLK)))
    ZINCRQ=(ZDQW*(ZCPBW*(ZTB(JLON,JBLK)-ZTBW(JLON,JBLK))+ZLHTBW&
      &*(ZQB(JLON,JBLK)-ZQBW(JLON,JBLK)))&
      &+(ZQW-ZQBW(JLON,JBLK))*ZCPBW)/(ZCPBW+ZLHTBW*ZDQW)
    ZQBW(JLON,JBLK)=ZQBW(JLON,JBLK)+ZINCRQ
    ZQBW(JLON,JBLK)=MIN(ZQBW(JLON,JBLK),ZQB(JLON,JBLK)+ZLB(JLON,JBLK))

    ! HYDROSTATIC COEFFICIENTS FOR THE CLOUD PROFILE.

    ! - TEMPORAIRE(S) 1D .

    ! ZRBB      : WEIGHT OF "ZTB" IN THE GEOPOTENTIAL THICKNESS.
    ! ZRBH      : WEIGHT OF "PTU" AT "PQU=ZQB" IN THE SAME THICKNESS.
    ! ZRVH      : FOR THE Q DEPENDENT CORRECTION OF ZRBH.

    ZRBBS(JLON,JBLK)=(PLNPR(JLON,JLEV+1,JBLK)-PALPH(JLON,JLEV+1,JBLK))*(RD*(1.0_JPRB &
      &-ZLB(JLON,JBLK))+ZRVMD*ZQB(JLON,JBLK))
    ZRBHS(JLON,JBLK)=PALPH(JLON,JLEV,JBLK)*(RD*(1.0_JPRB-ZLB(JLON,JBLK))+ZRVMD*ZQB(JLON,JBLK))
    ZRBB(JLON,JBLK)=(PLNPR(JLON,JLEV+1,JBLK)-PALPH(JLON,JLEV+1,JBLK))*(RD*(1.0_JPRB &
      &-ZLB(JLON,JBLK))+ZRVMD*ZQBH(JLON,JBLK))
    ZRBH(JLON,JBLK)=PALPH(JLON,JLEV,JBLK)*(RD*(1.0_JPRB-ZLB(JLON,JBLK))+ZRVMD*ZQBH(JLON,JBLK))
    ZRVH(JLON,JBLK)=PALPH(JLON,JLEV,JBLK)*RV

    ! TO COMPUTE SATURATED ADIABATIC PROFILE, GCVADS ALLOWS TO GO
    ! CONTINUOUSLY FROM EQUIPRESSURE TO EQUIGEOPOTENTIAL APPROACH.

    ZRBB(JLON,JBLK)=(1.0_JPRB-YRPHY0%GCVADS)*ZRBB(JLON,JBLK)+YRPHY0%GCVADS*(PAPHIF(JLON,JLEV,JBLK)&
      & -PAPHIF(JLON,JLEV+1,JBLK))/ZTBH(JLON,JBLK)
    ZRBH(JLON,JBLK)=(1.0_JPRB-YRPHY0%GCVADS)*ZRBH(JLON,JBLK)
    ZRBBS(JLON,JBLK)=(1.0_JPRB-YRPHY0%GCVADS)*ZRBBS(JLON,JBLK)+YRPHY0%GCVADS*(PAPHIF(JLON,JLEV,JBLK)&
      & -PAPHIF(JLON,JLEV+1,JBLK))/ZTB(JLON,JBLK)
    ZRBHS(JLON,JBLK)=(1.0_JPRB-YRPHY0%GCVADS)*ZRBHS(JLON,JBLK)
    ZRVH(JLON,JBLK)=(1.0_JPRB-YRPHY0%GCVADS)*ZRVH(JLON,JBLK)

    ! SNOW OPTION DEPENDENT CALCULATIONS.
    ! DIAGNOSTIC ICE FRACTION
    ! ZDELTA=FONICE(ZTB(JLON))
    ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTBH(JLON,JBLK)))

    ! CALL TO THE DEFINED FUNCTION FOR THE COMPUTATION OF THE PSEUDO
    ! LATENT HEAT AT THE BOTTOM (AMONG THREE CHARACTERISTIC PARAMETERS).

    ! ZLH       : RUNNING VALUE OF THE PSEUDO LH DURING NEWTON'S LOOP.
    ! ZCP       : AS ZLH BUT FOR THE SPECIFIC HEAT CP.

    ZLH(JLON,JBLK)=FOLH(ZTBH(JLON,JBLK),ZDELTA)+ZRVH(JLON,JBLK)*ZTBH(JLON,JBLK)
    ZCP(JLON,JBLK)=RCPD+ZCPVMD*ZQBH(JLON,JBLK)+(ZCPWMD+ZDELTA*(ZCPSMD-&
      &ZCPWMD))*ZLB(JLON,JBLK)+ZRBH(JLON,JBLK)
    ZDCP=ZRVH(JLON,JBLK)+ZCPVMW+ZDELTA*(ZCPVMS-ZCPVMW)

    ! CHANGE OF LEVEL TO OBTAIN A
    ! FIRST GUESS AS STARTING POINT FOR THE NEWTON LOOP.

    ZDELT=ZT(JLON,JLEV,JBLK)-ZT(JLON,JLEV+1,JBLK)
    ZLH(JLON,JBLK)=ZLH(JLON,JBLK)+ZDCP*ZDELT
    ZDELQ=-((ZRBB(JLON,JBLK)+ZRBH(JLON,JBLK))*ZTBH(JLON,JBLK)+ZCP(JLON,JBLK)*ZDELT)/ZLH(JLON,JBLK)
    ZTNH(JLON,JBLK)=ZTBH(JLON,JBLK)+ZDELT
    ZQNH(JLON,JBLK)=ZQBH(JLON,JBLK)+ZDELQ
    ZCP(JLON,JBLK)=ZCP(JLON,JBLK)+ZDCP*ZDELQ
  


  ! // NEWTON LOOP.

  DO JIT=1,YRPHY%NBITER
!   Isolate what may not vectorize
    

      ! SNOW OPTION DEPENDENT COMPUTATIONS.
      ! DIAGNOSTIC ICE FRACTION
      ZDELTA_ARR(JLON,JBLK)=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTNH(JLON,JBLK)))

      ! SATURATION CALCULATIONS USING DEFINED FUNCTIONS.

      ZEW_TLE(JLON,JBLK)= FOEW (ZTNH(JLON,JBLK),ZDELTA_ARR(JLON,JBLK))

    
    
      ZESP=ZEW_TLE(JLON,JBLK)/PAPRSF(JLON,JLEV,JBLK)
      ZQW= FOQS (ZESP)
      ZDQW= FODQS (ZQW,ZESP, FODLEW (ZTNH(JLON,JBLK),ZDELTA_ARR(JLON,JBLK)))

      ! INCREMENTATIONS.

      ZDCP=ZRVH(JLON,JBLK)+ZCPVMW+ZDELTA_ARR(JLON,JBLK)*(ZCPVMS-ZCPVMW)
      ZDELQ=(ZQW-ZQNH(JLON,JBLK))*ZCP(JLON,JBLK)/(ZCP(JLON,JBLK)+ZLH(JLON,JBLK)*ZDQW)
      ZCP(JLON,JBLK)=ZCP(JLON,JBLK)+ZDCP*ZDELQ
      ZDELT=-ZDELQ*ZLH(JLON,JBLK)/ZCP(JLON,JBLK)
      ZLH(JLON,JBLK)=ZLH(JLON,JBLK)+ZDCP*ZDELT
      ZQNH(JLON,JBLK)=ZQNH(JLON,JBLK)+ZDELQ
      ZTNH(JLON,JBLK)=ZTNH(JLON,JBLK)+ZDELT
    
  ENDDO


  ! // STABILITY TEST, OCCASIONAL CORRECTION OF THE BOTTOM LAYER,
  ! COMPUTATION OF THE MASS FLUX PROFILE PARAMETER AND OF THE TWO
  ! INTEGRALS CONNECTED WITH THE "KUO-TYPE" CLOSURE.


! Isolate log (may not vectorize)
  
    ZLOGRATIO(JLON,JBLK)=LOG(PAPRSF(JLON,JLEV+1,JBLK)/PAPRSF(JLON,JLEV,JBLK))
  
  

    ! // DRY ADIABAT.
    ZCPH=RCPD*(1.0_JPRB-ZQB(JLON,JBLK))+RCPV*ZQB(JLON,JBLK)
    ZTNSEC=(ZCPH-ZRBBS(JLON,JBLK))*ZTB(JLON,JBLK)/(ZCPH+ZRBHS(JLON,JBLK))

    ! // TEST IF SATURATED AT TOP OF LAYER, INITIALIZE VARIABLES FOR NEXT LEVEL.
    ICDN(JLON,JBLK)=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZTNH(JLON,JBLK)-ZTNSEC)))
    INCDN(JLON,JLEV,JBLK)=MAX(INCDN(JLON,JLEV+1,JBLK),JLEV*ICDN(JLON,JBLK))
    ICDN(JLON,JBLK)=MAX(0,-ISIGN(1,-INCDN(JLON,JLEV,JBLK)))
    PTU(JLON,JLEV,JBLK)=ICDN(JLON,JBLK)*ZTNH(JLON,JBLK)+(1-ICDN(JLON,JBLK))*ZTNSEC
    PQU(JLON,JLEV,JBLK)=ICDN(JLON,JBLK)*ZQNH(JLON,JBLK)+(1-ICDN(JLON,JBLK))*ZQB(JLON,JBLK)

    ! Buoyant convective condensation.
    ZBCC_C_HALF(JLON,JLEV,JBLK)=MIN(0._JPRB,PQU(JLON,JLEV,JBLK)-ZQB(JLON,JBLK)) &
      &/(PAPRSF(JLON,JLEV,JBLK)-PAPRSF(JLON,JLEV+1,JBLK))

    ! Integrate hydrostatics within the updraft, with the equipressure hypothesis.
    ZPHIF_U_EQUIP(JLON,JLEV,JBLK)=ZPHIF_U_EQUIP(JLON,JLEV+1,JBLK) &
      & +RD*0.5_JPRB*(PTU(JLON,JLEV,JBLK)+PTU(JLON,JLEV+1,JBLK)) &
      & *(1.0_JPRB+RETV*0.5_JPRB*(PQU(JLON,JLEV,JBLK)+PQU(JLON,JLEV+1,JBLK))) &
      & *ZLOGRATIO(JLON,JBLK)

    ! Choose between equipressure and equigeopotential hypothesis.
    ZPHIF_U(JLON,JLEV,JBLK)=(1._JPRB-YRPHY0%GCVADS)*ZPHIF_U_EQUIP(JLON,JLEV,JBLK)+YRPHY0%GCVADS*PAPHIF(JLON,JLEV,JBLK)


    ! PHASE PARTITION IN THE UPDRAFT
    ! SIMPLY STORE THE UPDRAFT ICE FRACTION IN ZIFRAC

    ZDELTA=FONICE(PTU(JLON,JLEV,JBLK))
    ZIFRAC(JLON,JLEV,JBLK)=ZDELTA

    ZLIQ=YRPHY0%ECMNP/(ZRBB(JLON,JBLK)*ZTBH(JLON,JBLK)+(ZRBH(JLON,JBLK)+ZRVH(JLON,JBLK)&
      &*(PQU(JLON,JLEV,JBLK)-ZQBH(JLON,JBLK)))*PTU(JLON,JLEV,JBLK))
    ZEXP=EXP(-1.0_JPRB/MAX(ZARLII,ZLIQ))
    ZLN(JLON,JBLK)=ICDN(JLON,JBLK)*MAX(0.0_JPRB,ZLB(JLON,JBLK)*ZEXP &
      &+(PQU(JLON,JLEV,JBLK)-ZQBH(JLON,JBLK))*ZLIQ*(ZEXP-1.0_JPRB))
    PQLIC(JLON,JLEV,JBLK)=ZLN(JLON,JBLK)
    !ZDQCA(JLON,JLEV)=ZQBW(JLON)-PQU(JLON,JLEV) formule ref
    ZDQCA(JLON,JLEV,JBLK)=ZQB(JLON,JBLK)-PQU(JLON,JLEV,JBLK) ! approche 3MT.

    ZLDN(JLON,JLEV,JBLK)=ZLN(JLON,JBLK)
    ZSDN(JLON,JLEV,JBLK)=(RCPD+ZCPVMD*PQU(JLON,JLEV,JBLK))*PTU(JLON,JLEV,JBLK)&
      &+ZPHIF_U(JLON,JLEV,JBLK)
    ZDQCA(JLON,JLEV,JBLK)=ICDN(JLON,JBLK)*ZDQCA(JLON,JLEV,JBLK)

    ! // TEST IF LFC REACHED AT TOP OF LAYER
    ILFC(JLON,JBLK)=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK) &
      & -(RD*(1.0_JPRB-ZLN(JLON,JBLK))+ZRVMD*ZQNH(JLON,JBLK))*ZTNH(JLON,JBLK))))
    INLFC(JLON,JLEV,JBLK)=MAX(INLFC(JLON,JLEV+1,JBLK),JLEV*ILFC(JLON,JBLK))
    ILFC(JLON,JBLK)=MAX(0,-ISIGN(1,-INLFC(JLON,JLEV,JBLK)))

    ZTVN(JLON,JLEV,JBLK)=PTU(JLON,JLEV,JBLK)*(1.0_JPRB+RETV*PQU(JLON,JLEV,JBLK)-ZLN(JLON,JBLK))
    ZTVE(JLON,JLEV,JBLK)=ZT(JLON,JLEV,JBLK)*(1.0_JPRB+RETV*PQ(JLON,JLEV,JBLK)-PQLIS(JLON,JLEV,JBLK))
    ! // COMPUTE VERTICAL VELOCITY. STEP 1: BUOYANCY.
    ! Buoyancy.
    ZBUO_W(JLON,JLEV,JBLK)=RG*(ZTVN(JLON,JLEV,JBLK)-ZTVE(JLON,JLEV,JBLK))/ZTVE(JLON,JLEV,JBLK)/YRPHY0%GAMAP1

    IBAC(JLON,JBLK)=MAX(0,-ISIGN(1,-INIVBAC(JLON,JLEV+1,JBLK)))
    IF (LLCOND1) THEN
      ZCAPEL(JLON,JBLK)=RD*PDELP(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)*(ZTVN(JLON,JLEV,JBLK)-ZTVE(JLON,JLEV,JBLK))
      ZCINL(JLON,JBLK)=-NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,ZCAPEL(JLON,JBLK)))) &
       & *ZCAPEL(JLON,JBLK)*IBAC(JLON,JBLK)*ICDN(JLON,JBLK)*(1-ILFC(JLON,JBLK))
    ELSE
      ZCAPEL(JLON,JBLK)=RD*PDELP(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)*MAX(0._JPRB,ZTVN(JLON,JLEV,JBLK)-ZTVE(JLON,JLEV,JBLK))
    ENDIF

  
! Loop is slightly reordered and split here because the (Intel) compiler fails to vectorize it.
! More powerful compiler may just fuse the two loops.
! The fused loops could be vectorized easily if certain conditional branches are
! replaced by straightforward calculations of the kind : alfa * X + (1-alfa) * Y
! Shorter loops may also reduce the pressure on the cache.
! REK.
  

    IF(YRPHY0%LSBUO) ZBUO_W(JLON,JLEV,JBLK)=0.5_JPRB*(ZBUO_W(JLON,JLEV,JBLK)+ZBUO_W(JLON,JLEV+1,JBLK))
    ! VERTICAL COORDINATE WITHIN UPDRAFT.
    ZDIFF_Z_UD(JLON,JLEV,JBLK)=ZDIFF_Z_UD(JLON,JLEV+1,JBLK)+PDELP(JLON,JLEV,JBLK) &
      & /PAPRSF(JLON,JLEV,JBLK)*RD*(PTU(JLON,JLEV,JBLK)*(1.0_JPRB+RETV*PQU(JLON,JLEV,JBLK)) &
      & -ZT(JLON,JLEV,JBLK)*(1.0_JPRB+RETV*PQ(JLON,JLEV,JBLK)))/RG

    IF(LLNHACC .OR. YRPHY0%LCVNHD) THEN
      ! If NH effects are taken into account, the vertical extension of updraft is
      ! estimated as levels where updraft vertical velocity is positive
      ! and buoyancy positive, in order not to take into account in the vertical
      ! extension the area above LNB, where vertical motion is due to NH effects only.
      ZBINBUO(JLON,JLEV,JBLK)=MAX(0._JPRB,SIGN(1._JPRB,ZBUO_W(JLON,JLEV,JBLK)))
    ELSE
      ! If NH effects are not taken into account, the vertical extension of updraft is
      ! estimated as levels where updraft vertical velocity is positive.
      ! It does not depend on buoyancy.
      ZBINBUO(JLON,JLEV,JBLK)=1._JPRB
    ENDIF
    ZBUO_W_POS(JLON,JLEV,JBLK)=MAX(0._JPRB,ZBUO_W(JLON,JLEV,JBLK)) ! positive part of the buoyancy.

    ! ZVACC: vertical acceleration in m/s2 due to buoyancy + NH effects.
    ZVACC(JLON,JLEV,JBLK)=ZBUO_W(JLON,JLEV,JBLK)

    ! ZFLO_OMEGA: acceleration in Pa/s2.
    ZFLO_OMEGA=-PAPRSF(JLON,JLEV,JBLK)/RD/ZTVE(JLON,JLEV,JBLK)*RG*ZVACC(JLON,JLEV,JBLK)

    ! Diagnostics.
    ZDIAG_ECART_TV(JLON,JLEV,JBLK)=ZTVN(JLON,JLEV,JBLK)-ZTVE(JLON,JLEV,JBLK)
    ZDIAG_ECART_T(JLON,JLEV,JBLK)=PTU(JLON,JLEV,JBLK)-ZT(JLON,JLEV,JBLK)
    ZDIAGFLO(JLON,JLEV,JBLK)=ZFLO_OMEGA

    ! // COMPUTE VERTICAL VELOCITY. STEP 2: FRICTION.
    ZDELPF=PDELP(JLON,JLEV,JBLK)
    ZFER=ZEPSILON_U(JLON,JLEV+1,JBLK)/RG*PR(JLON,JLEV+1,JBLK)*ZT(JLON,JLEV+1,JBLK)/PAPRSF(JLON,JLEV+1,JBLK)
    ZKDL=ZKD(JLON,JLEV+1,JBLK)
    ZDIAGFRICTION(JLON,JLEV,JBLK)=(ZKDL+ZFER)*ZVVER(JLON,JLEV,JBLK)**2

    ! VERTICAL TRANSPORT DIAGNOSTIC.
    ZDIAGTRANSP(JLON,JLEV,JBLK)=-0.5_JPRB*(ZVVER(JLON,JLEV+1,JBLK)**2-ZVVER(JLON,JLEV,JBLK)**2) &
      &/(PAPRSF(JLON,JLEV+1,JBLK)-PAPRSF(JLON,JLEV,JBLK))


    ! // COMPUTE VERTICAL VELOCITY. STEP 3: IMPLICIT SOLVING OF THE TENDENCY EQUATION.
    ZVVERDM(JLON,JLEV,JBLK)=PUDOM(JLON,JLEV,JBLK)
    ZVVERDEN=2.0_JPRB*YRPHY2%TSPHY*(0.25_JPRB*(ZKDL+ZFER)+0.5_JPRB/ZDELPF)
    ZB=0.5_JPRB*(1.0_JPRB-(ZKDL+ZFER)*YRPHY2%TSPHY*ZVVER(JLON,JLEV,JBLK))
    ZDELTAP=ZB**2 &
      &-2.0_JPRB*ZVVERDEN*((ZFLO_OMEGA+(-0.5_JPRB/ZDELPF+0.25_JPRB*(ZKDL+ZFER))&
      &*ZVVER(JLON,JLEV,JBLK)**2)*YRPHY2%TSPHY-0.5_JPRB*ZVVER(JLON,JLEV,JBLK)&
      &+ZVVERDM(JLON,JLEV,JBLK))
    ISDELTAP=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-ZDELTAP)))
    ZDELTAP=ZDELTAP*ISDELTAP
    ZVVERN=(ZB-SQRT(MAX(0._JPRB,ZDELTAP)))/ZVVERDEN

    ZVVERN=MIN(0.0_JPRB,ZVVERN)*ISDELTAP

    ZS5(JLON,JBLK)=ZS5(JLON,JBLK)+KNLAB(JLON,JLEV+1,JBLK)*ZCIN(JLON,JBLK)
    ZCIN(JLON,JBLK)=ZCINL(JLON,JBLK)
    IVVER=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,(ZVVERN+ZVVER(JLON,JLEV,JBLK))+0.0_JPRB)))
    ICIN=(1-IVVER)*IBAC(JLON,JBLK)*ICDN(JLON,JBLK)*(1-ILFC(JLON,JBLK))&
      &*NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,(ZS5(JLON,JBLK)+ZCINL(JLON,JBLK)-YRPHY0%GCVCINC)+0.0_JPRB)))

    ZVVER(JLON,JLEV-1,JBLK)=(1-ICIN)*ZVVERN+ICIN*ZVVERDM(JLON,JLEV,JBLK)*0.5_JPRB
    ZVVERDM(JLON,JLEV,JBLK)=0.5_JPRB*(ZVVER(JLON,JLEV,JBLK)+ZVVER(JLON,JLEV-1,JBLK))

    ZDELPF=PAPRSF(JLON,JLEV+1,JBLK)-PAPRSF(JLON,JLEV,JBLK)
    ZDWNDP(JLON,JLEV,JBLK)=(ZVVERDM(JLON,JLEV+1,JBLK)-ZVVERDM(JLON,JLEV,JBLK))/ZDELPF

    ! J.F. Gueremy no more smoothing of dw/dp (ZALFAVEC(JLON)=1.).
    !ZALFAVEC(JLON)=MIN(1.0_JPRB,0.50_JPRB/1000._JPRB*ZDELPF+0.50_JPRB) ! smoothing.
    ZALFAVEC(JLON,JBLK)=1.0_JPRB ! no smoothing.
    ZDWNDP(JLON,JLEV,JBLK)=ZALFAVEC(JLON,JBLK)*ZDWNDP(JLON,JLEV,JBLK)+(1.0_JPRB-ZALFAVEC(JLON,JBLK))*ZDWNDP(JLON,JLEV+1,JBLK)
  

  IF(YRPHY0%NCVENTR == 1) THEN
!   Isolate log (may not vectorize)
    
      ZTLE_ARR(JLON,JBLK)=ZT(JLON,JLEV,JBLK)-PLH(JLON,JLEV,JBLK)*PQLIS(JLON,JLEV,JBLK)/PCP(JLON,JLEV,JBLK)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTLE_ARR(JLON,JBLK)))
      ZEW_TLE(JLON,JBLK)=FOEW(ZTLE_ARR(JLON,JBLK),ZDELTA)
      ZTLN_ARR(JLON,JBLK)=PTU(JLON,JLEV,JBLK)-ZLH(JLON,JBLK)*ZLN(JLON,JBLK)/ZCP(JLON,JBLK)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTLN_ARR(JLON,JBLK)))
      ZEW_TLN(JLON,JBLK)=FOEW(ZTLN_ARR(JLON,JBLK),ZDELTA)
    
    

      ! -------------------------------------------------
      ! // ENTRAINMENT AFTER GUEREMY TELLUS 2011.
      ! // DETERMINE ENTRAINED VS DETRAINED PART VIA A BUOYANCY SORTING APPROACH.
      ! -------------------------------------------------

      IDOMDP=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZDWNDP(JLON,JLEV,JBLK))))

      IVVN=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZVVERDM(JLON,JLEV,JBLK)*ZBINBUO(JLON,JLEV,JBLK)-YRPHY0%VVN)))
      IVVX=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZVVERDM(JLON,JLEV,JBLK)*ZBINBUO(JLON,JLEV,JBLK)-YRPHY0%VVX)))

      ! TURBULENT ENTRAINMENT AS A FUNCTION OF VERTICAL VELOCITY AND Z.

      ZEPS_TURL=ZMOD(JLON,JLEV,JBLK)*(ZENTR+(ZENTRX-ZENTR)*SIN(RPI/2.0_JPRB*MAX(0.0_JPRB,MIN(1.0_JPRB&
         &,((YRPHY0%VVX-ZVVERDM(JLON,JLEV,JBLK))/(YRPHY0%VVX-YRPHY0%VVN)))))**2)
      ZEPS_TURL=IVVN*ZENTRX+(1-IVVN)*IVVX*ZEPS_TURL+(1-IVVX)*ZENTR

      INUA=KNLAB(JLON,JLEV+1,JBLK)
      ZEPS_TUR(JLON,JLEV,JBLK)=(1-IDOMDP)*ZEPS_TUR(JLON,JLEV+1,JBLK)&
         &+IDOMDP*(INUA*MIN(ZEPS_TURL,ZEPS_TUR(JLON,JLEV+1,JBLK))&
         &+(1-INUA)*ZEPS_TURL)

      ZKD(JLON,JLEV,JBLK)=ZEPS_TUR(JLON,JLEV,JBLK)*YRPHY0%RKDN/ZENTR

      ZENTR_TUR=ZEPS_TUR(JLON,JLEV,JBLK)*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)
      IVVER=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,ZVVERDM(JLON,JLEV,JBLK)+0.0_JPRB)))
      ZENTRO=-IVVER/MIN(-ZEPS0,ZVVERDM(JLON,JLEV,JBLK))*ZDWNDP(JLON,JLEV,JBLK)&
         &+(1-IVVER)*ZENTR_TUR

      ZEPS_ORG0=MAX(ABS(ZENTRO),ZENTR_TUR)

      ZESP=ZEW_TLE(JLON,JBLK)/PAPRSF(JLON,JLEV,JBLK)
      ZQSTLE=FOQS(ZESP)
      ZESP=ZEW_TLN(JLON,JBLK)/PAPRSF(JLON,JLEV,JBLK)
      ZQSTLN=FOQS(ZESP)
      ZSN=PQU(JLON,JLEV,JBLK)+ZLN(JLON,JBLK)-ZQSTLN
      ZSE=PQ(JLON,JLEV,JBLK)+PQLIS(JLON,JLEV,JBLK)-ZQSTLE
      ZCHIS=ZSN/(ZSN-ZSE)
      ZCHIS=MIN(1.0_JPRB,MAX(0.0_JPRB,ZCHIS))
      ICHIS=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-ZCHIS+0.0_JPRB)))
      ZTVLN=ZTLN_ARR(JLON,JBLK)*(1.0_JPRB+RETV*(PQU(JLON,JLEV,JBLK)+ZLN(JLON,JBLK)))
      ZTVLE=ZTLE_ARR(JLON,JBLK)*(1.0_JPRB+RETV*(PQ(JLON,JLEV,JBLK)+PQLIS(JLON,JLEV,JBLK)))
      ZNCHI0=MAX(0.0_JPRB,ZTVN(JLON,JLEV,JBLK)-ZTVLE)
      ZDCHI0=MAX(ZEPS0,ZTVN(JLON,JLEV,JBLK)-(1.0_JPRB-ZCHIS)*ZTVLN-ZCHIS*ZTVLE)
      ZCHI0=ZCHIS*ZNCHI0/ZDCHI0
      ZCHI0=ICHIS*ZCHI0+(1-ICHIS)*1.0_JPRB
      ZCHI0=IVVER*MIN(1.0_JPRB,MAX(0.0_JPRB,MIN(ZCHI0,0.5_JPRB*(1.0_JPRB+ZENTRO/ &
         &ZEPS_ORG0))))&
         &+(1-IVVER)*1.0_JPRB
      IENTR=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZENTRO-YRPHY0%FENTRT*ZENTR_TUR)))
      ZCHI0=IENTR*1.0_JPRB+(1-IENTR)*ZCHI0

      ZCHI02=ZCHI0**2
      ZEPS_ORG(JLON,JLEV,JBLK)=YRPHY0%GCVRE*ZMOD(JLON,JLEV,JBLK)*MAX(ZEPS_ORG0*ZCHI02,ZEPS0)
      ZDEL_ORG(JLON,JLEV,JBLK)=YRPHY0%GCVRE*ZMOD(JLON,JLEV,JBLK)*MAX(ZEPS_ORG0*(1.0_JPRB-ZCHI0)**2,ZEPS0)

      ! -------------------------------------------------
      ! CHANGE UNIT: ZEPSILON_U AND ZDELTA_U IN M**-1.
      ! -------------------------------------------------

      ZEPSILON_U(JLON,JLEV,JBLK)=(ZEPS_ORG(JLON,JLEV,JBLK)*PAPRSF(JLON,JLEV,JBLK) &
        &/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))+ZEPS_TUR(JLON,JLEV,JBLK))*RG
      ZDELTA_U(JLON,JLEV,JBLK)=(ZDEL_ORG(JLON,JLEV,JBLK)*PAPRSF(JLON,JLEV,JBLK) &
        &/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))+ZEPS_TUR(JLON,JLEV,JBLK))*RG
    

  ELSEIF(YRPHY0%NCVENTR == 3) THEN
    

      ! -------------------------------------------------
      ! // ENTRAINMENT AFTER RIO ET AL. 2010.
      ! -------------------------------------------------

      ZTVNL=PTU(JLON,JLEV,JBLK)*(1.0_JPRB+RETV*PQU(JLON,JLEV,JBLK)-ZLN(JLON,JBLK))
      ZTVEL=ZT(JLON,JLEV,JBLK)*(1.0_JPRB+RETV*PQ(JLON,JLEV,JBLK))
      ZBUOY(JLON,JLEV,JBLK)=RG*(1._JPRB-ZTVEL/ZTVNL)
      ZBETA1RIO=0.9_JPRB
      ZA1RIO=0.67_JPRB
      ZBRIO=0.002_JPRB
      ZCRIO=0.012_JPRB

      ! -------------------------------------------------
      ! ENTRAINMENT IN M**-1 AND AERODYNAMIC DRAG IN Pa**-1
      ! -------------------------------------------------

      ZEPSILON_U(JLON,JLEV,JBLK)=MAX(0._JPRB,(ZA1RIO*ZBUOY(JLON,JLEV,JBLK) &
        &/(MAX(1._JPRB,ZWU(JLON,JLEV,JBLK)))**2-ZBRIO)/(1._JPRB+ZBETA1RIO))
      ZEPSILON_U(JLON,JLEV,JBLK)=MAX(ZENTR*RG,MIN(ZENTRX*RG,ZEPSILON_U(JLON,JLEV,JBLK)))
      ZKD(JLON,JLEV,JBLK)=YRPHY0%ADOE*ZEPSILON_U(JLON,JLEV,JBLK)/RG*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)

      ! -------------------------------------------------
      ! DETRAINMENT.
      ! -------------------------------------------------

      ZDELTA_U(JLON,JLEV,JBLK)=MAX(0._JPRB,-ZA1RIO*ZBETA1RIO/(1._JPRB+ZBETA1RIO) &
        &*ZBUOY(JLON,JLEV,JBLK)/(MAX(1._JPRB,ZWU(JLON,JLEV,JBLK)))**2)
      ZENTR_T_LOC(JLON,JLEV,JBLK)=ZCRIO*SQRT(MAX(0._JPRB,PQU(JLON,JLEV,JBLK)-PQ(JLON,JLEV,JBLK)) &
         &/MAX(1.E-4_JPRB,PQU(JLON,JLEV,JBLK))/(MAX(1._JPRB,ZWU(JLON,JLEV,JBLK)))**2)
      ZDELTA_U(JLON,JLEV,JBLK)=ZDELTA_U(JLON,JLEV,JBLK)+ZENTR_T_LOC(JLON,JLEV,JBLK)
      ZDELTA_U(JLON,JLEV,JBLK)=MAX(ZENTR*RG,MIN(ZENTRX*RG,ZDELTA_U(JLON,JLEV,JBLK)))
    

  ELSEIF(YRPHY0%NCVENTR == 5) THEN
    

      ! -------------------------------------------------
      ! UNIFORM ENTRAINMENT / DETRAINMENT.
      ! -------------------------------------------------


      ! -------------------------------------------------
      ! FRACTIONAL ENTRAINMENT/DETRAINMENT (IN M**-1, TO BE APPLIED DURING A DIAGNOSTIC ASCENT)
      ! AND AERODYNAMIC DRAG IN Pa**-1
      ! -------------------------------------------------

      ZEPSILON_U(JLON,JLEV,JBLK)=ZENTRX
      ZKD(JLON,JLEV,JBLK)=YRPHY0%ADOE*ZEPSILON_U(JLON,JLEV,JBLK)/RG*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)
      ZDELTA_U(JLON,JLEV,JBLK)=ZEPSILON_U(JLON,JLEV,JBLK)
    

  ELSEIF(YRPHY0%NCVENTR == 6) THEN
    

      ! -------------------------------------------------
      ! ENTRAINMENT / DETRAINMENT "V1" AS IN PIRIOU PHD 2005.
      ! -------------------------------------------------


      ! -------------------------------------------------
      ! FRACTIONAL ENTRAINMENT/DETRAINMENT (IN M**-1, TO BE APPLIED DURING A DIAGNOSTIC ASCENT)
      ! AND AERODYNAMIC DRAG IN Pa**-1
      ! -------------------------------------------------

      IF(PAPRSF(JLON,JLEV,JBLK) < 35000.) THEN
         ZEPSILON_U(JLON,JLEV,JBLK)=1.2E-4
      ELSEIF(PAPRSF(JLON,JLEV,JBLK) > 82000. ) THEN
         ZEPSILON_U(JLON,JLEV,JBLK)=6.0E-4
      ELSE
         ZEPSILON_U(JLON,JLEV,JBLK)=1.2E-4+(6.0E-4-1.2E-4)*(PAPRSF(JLON,JLEV,JBLK)-35000.)/(82000.-35000.)
      ENDIF
      ZKD(JLON,JLEV,JBLK)=YRPHY0%ADOE*ZEPSILON_U(JLON,JLEV,JBLK)/RG*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)
      ZDELTA_U(JLON,JLEV,JBLK)=ZEPSILON_U(JLON,JLEV,JBLK)
    

  ELSEIF(YRPHY0%NCVENTR == 7) THEN
    

      ! -------------------------------------------------
      ! ENTRAINMENT / DETRAINMENT "V1DEV", SAME SHAPE AS IN PIRIOU PHD 2005,
      ! BUT DIFFERENT MAGNITUDE.
      ! -------------------------------------------------

      ! -------------------------------------------------
      ! FRACTIONAL ENTRAINMENT/DETRAINMENT (IN M**-1, TO BE APPLIED DURING A DIAGNOSTIC ASCENT).
      ! -------------------------------------------------

      IF(PAPRSF(JLON,JLEV,JBLK) < 35000.) THEN
         ZEPSILON_U(JLON,JLEV,JBLK)=YRPHY0%GCVENTRN
      ELSEIF(PAPRSF(JLON,JLEV,JBLK) > 82000. ) THEN
         ZEPSILON_U(JLON,JLEV,JBLK)=YRPHY0%GCVENTRX
      ELSE
         ZEPSILON_U(JLON,JLEV,JBLK)=YRPHY0%GCVENTRN+(YRPHY0%GCVENTRX-YRPHY0%GCVENTRN)*(PAPRSF(JLON,JLEV,JBLK)-35000.) &
          &/(82000.-35000.)
      ENDIF
      ZKD(JLON,JLEV,JBLK)=YRPHY0%ADOE*ZEPSILON_U(JLON,JLEV,JBLK)/RG*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)
      ZDELTA_U(JLON,JLEV,JBLK)=ZEPSILON_U(JLON,JLEV,JBLK)
    

  ELSEIF(YRPHY0%NCVENTR == 16) THEN
    

      ! -------------------------------------------------
      ! // UNIFORM TURBULENT ENTRAINMENT.
      ! // FRICTION FUNCTION OF ZRE.
      ! // ORGANIZED ENTRAINMENT AFTER GUEREMY TELLUS 2011.
      ! // DETERMINE ENTRAINED VS DETRAINED PART VIA A BUOYANCY SORTING APPROACH.
      ! -------------------------------------------------

      ! TURBULENT ENTRAINMENT.
      ZEPS_TUR(JLON,JLEV,JBLK)=ZENTRX ! ZENTRX and ZEPS_TUR are in (J/kg)**-1.
      ZKD(JLON,JLEV,JBLK)=ZEPS_TUR(JLON,JLEV,JBLK)*YRPHY0%ADOE/ZRE(JLON,JLEV,JBLK)**YRPHY0%GEXPKD &
        & *PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK) ! ZKD is in Pa**-1.
      ZENTR_TUR=ZEPS_TUR(JLON,JLEV,JBLK)*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK) ! ZENTR_TUR is in Pa**-1.

      IVVER=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,ZVVERDM(JLON,JLEV,JBLK)+0.0_JPRB)))
      ZENTRO=-IVVER/MIN(-ZEPS0,ZVVERDM(JLON,JLEV,JBLK))*ZDWNDP(JLON,JLEV,JBLK)&
         &+(1-IVVER)*ZENTR_TUR

      ZEPS_ORG0=MAX(ABS(ZENTRO),ZENTR_TUR)

      ZTLN=PTU(JLON,JLEV,JBLK)-ZLH(JLON,JBLK)*ZLN(JLON,JBLK)/ZCP(JLON,JBLK)
      ZTLE=ZT(JLON,JLEV,JBLK)-PLH(JLON,JLEV,JBLK)*PQLIS(JLON,JLEV,JBLK)/PCP(JLON,JLEV,JBLK)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTLE))
      ZEW=FOEW(ZTLE,ZDELTA)
      ZESP=ZEW/PAPRSF(JLON,JLEV,JBLK)
      ZQSTLE=FOQS(ZESP)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTLN))
      ZEW=FOEW(ZTLN,ZDELTA)
      ZESP=ZEW/PAPRSF(JLON,JLEV,JBLK)
      ZQSTLN=FOQS(ZESP)
      ZSN=PQU(JLON,JLEV,JBLK)+ZLN(JLON,JBLK)-ZQSTLN
      ZSE=PQ(JLON,JLEV,JBLK)+PQLIS(JLON,JLEV,JBLK)-ZQSTLE
      ZCHIS=ZSN/(ZSN-ZSE)
      ZCHIS=MIN(1.0_JPRB,MAX(0.0_JPRB,ZCHIS))
      ICHIS=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-ZCHIS+0.0_JPRB)))
      ZTVLN=ZTLN*(1.0_JPRB+RETV*(PQU(JLON,JLEV,JBLK)+ZLN(JLON,JBLK)))
      ZTVLE=ZTLE*(1.0_JPRB+RETV*(PQ(JLON,JLEV,JBLK)+PQLIS(JLON,JLEV,JBLK)))
      ZNCHI0=MAX(0.0_JPRB,ZTVN(JLON,JLEV,JBLK)-ZTVLE)
      ZDCHI0=MAX(ZEPS0,ZTVN(JLON,JLEV,JBLK)-(1.0_JPRB-ZCHIS)*ZTVLN-ZCHIS*ZTVLE)
      ZCHI0=ZCHIS*ZNCHI0/ZDCHI0
      ZCHI0=ICHIS*ZCHI0+(1-ICHIS)*1.0_JPRB
      ZCHI0=IVVER*MIN(1.0_JPRB,MAX(0.0_JPRB,MIN(ZCHI0,0.5_JPRB*(1.0_JPRB+ZENTRO/ &
         &ZEPS_ORG0))))&
         &+(1-IVVER)*1.0_JPRB
      IENTR=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZENTRO-YRPHY0%FENTRT*ZENTR_TUR)))
      ZCHI0=IENTR*1.0_JPRB+(1-IENTR)*ZCHI0

      ZCHI02=ZCHI0**2
      ZEPS_ORG(JLON,JLEV,JBLK)=YRPHY0%GCVRE*ZMOD(JLON,JLEV,JBLK)*MAX(ZEPS_ORG0*ZCHI02,ZEPS0)
      ZDEL_ORG(JLON,JLEV,JBLK)=YRPHY0%GCVRE*ZMOD(JLON,JLEV,JBLK)*MAX(ZEPS_ORG0*(1.0_JPRB-ZCHI0)**2,ZEPS0)

      ZDIAG_EPS_ORG(JLON,JLEV,JBLK)=ZEPS_ORG(JLON,JLEV,JBLK) &
        &*PAPRSF(JLON,JLEV,JBLK)/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))*RG
      ZDIAG_EPS_TUR(JLON,JLEV,JBLK)=ZEPS_TUR(JLON,JLEV,JBLK)*RG

      ! -------------------------------------------------
      ! CHANGE UNIT: ZEPSILON_U AND ZDELTA_U IN M**-1.
      ! -------------------------------------------------

      ZEPSILON_U(JLON,JLEV,JBLK)=(ZEPS_ORG(JLON,JLEV,JBLK)*PAPRSF(JLON,JLEV,JBLK) &
        &/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))+ZEPS_TUR(JLON,JLEV,JBLK))*RG
      ZDELTA_U(JLON,JLEV,JBLK)=((ZDEL_ORG(JLON,JLEV,JBLK)*PAPRSF(JLON,JLEV,JBLK) &
        &/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))+ZEPS_TUR(JLON,JLEV,JBLK))*RG)*YRPHY0%GCHI0
    

  ELSEIF(YRPHY0%NCVENTR == 17) THEN
   

      ! -------------------------------------------------
      ! UNIFORM ENTRAINMENT / DETRAINMENT.
      ! -------------------------------------------------


      ! -------------------------------------------------
      ! FRACTIONAL ENTRAINMENT/DETRAINMENT (IN M**-1, TO BE APPLIED DURING A DIAGNOSTIC ASCENT)
      ! AND AERODYNAMIC DRAG IN Pa**-1
      ! -------------------------------------------------

      ZEPSILON_U(JLON,JLEV,JBLK)=ZENTRX*RG
      ZKD(JLON,JLEV,JBLK)=YRPHY0%ADOE**(1._JPRB+ZDEPTH(JLON,JBLK)/7000._JPRB*24._JPRB) &
        & *ZEPSILON_U(JLON,JLEV,JBLK)/RG*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)
      ZDELTA_U(JLON,JLEV,JBLK)=ZEPSILON_U(JLON,JLEV,JBLK)
    
  ELSEIF(YRPHY0%NCVENTR == 19) THEN
    

      ! -------------------------------------------------
      ! // Turbulent entrainment depending on
      ! // * height
      ! // * kinetic energy of the downdraft.
      ! // ORGANIZED ENTRAINMENT AFTER GUEREMY TELLUS 2011.
      ! // DETERMINE ENTRAINED VS DETRAINED PART VIA A BUOYANCY SORTING APPROACH.
      ! -------------------------------------------------

      ! Uniform ZRE, linked to saturation deficit integrated in the vertical.
      !ZRE_SATDEF(JLON,JLEV)=GREMIN+(GREMAX-GREMIN) &
      !  & *MAX(0._JPRB,MIN(1._JPRB,(ZSATDEF(JLON)-GSDMIN)/(GSDMAX-GSDMIN)))

      ! Local ZRE, linked to local saturation deficit.
      ZRE_SATDEF(JLON,JLEV,JBLK)=YRPHY0%GREMIN+(YRPHY0%GREMAX-YRPHY0%GREMIN) &
        & *MAX(0._JPRB,MIN(1._JPRB,(PQSAT(JLON,JLEV,JBLK)-PQ(JLON,JLEV,JBLK)-YRPHY0%GSDMIN) &
        & /(YRPHY0%GSDMAX-YRPHY0%GSDMIN)))

      ! Height (above surface) in m.
      ZHEIGHT=(ZPHIF_U(JLON,JLEV,JBLK)-PAPHI(JLON,KLEV,JBLK))/RG

      ! Reduction factor of entrainment, due to height.
      !ZRE_HEIGHT(JLON,JLEV)=1._JPRB/MAX(1._JPRB,ZHEIGHT/1000._JPRB)
      ZRE_HEIGHT(JLON,JLEV,JBLK)=1.

      ! Reduction factor (ZRE_KEDD) of entrainment, due to kinetic energy of the downdraft.
      ZRE_KEDD(JLON,JLEV,JBLK)=1._JPRB/(1._JPRB+YRPHY0%GKEDDRE*ZKEDD(JLON,JBLK))

      ! The reduction factor that will be applied to turbulent and organized
      ! entrainement and detrainement is the product of all reduction factors.
      ZRE(JLON,JLEV,JBLK)=ZRE_SATDEF(JLON,JLEV,JBLK)*ZRE_HEIGHT(JLON,JLEV,JBLK)*ZRE_KEDD(JLON,JLEV,JBLK)

      ! TURBULENT ENTRAINMENT.
      ! ZENTRX and ZEPS_TUR are in (J/kg)**-1.
      ZEPS_TUR(JLON,JLEV,JBLK)=ZENTRX
      ZKD(JLON,JLEV,JBLK)=ZEPS_TUR(JLON,JLEV,JBLK)*YRPHY0%ADOE/ZRE(JLON,JLEV,JBLK)**YRPHY0%GEXPKD &
        & *PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK) ! ZKD is in Pa**-1.
      ZENTR_TUR=ZEPS_TUR(JLON,JLEV,JBLK)*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK) ! ZENTR_TUR is in Pa**-1.

      IVVER=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,PUDOM(JLON,JLEV,JBLK)+0.0_JPRB)))
      ZDELPF=PAPRSF(JLON,JLEV+1,JBLK)-PAPRSF(JLON,JLEV,JBLK)
      ZDWNDP(JLON,JLEV,JBLK)=(PUDOM(JLON,JLEV+1,JBLK)-PUDOM(JLON,JLEV,JBLK))/ZDELPF
      ZENTRO=-IVVER/MIN(-ZEPS0,PUDOM(JLON,JLEV,JBLK))*ZDWNDP(JLON,JLEV,JBLK)&
        &+(1-IVVER)*ZENTR_TUR

      ZEPS_ORG0=MAX(ABS(ZENTRO),ZENTR_TUR)

      ZTLN=PTU(JLON,JLEV,JBLK)-ZLH(JLON,JBLK)*ZLN(JLON,JBLK)/ZCP(JLON,JBLK)
      ZTLE=ZT(JLON,JLEV,JBLK)-PLH(JLON,JLEV,JBLK)*PQLIS(JLON,JLEV,JBLK)/PCP(JLON,JLEV,JBLK)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTLE))
      ZEW=FOEW(ZTLE,ZDELTA)
      ZESP=ZEW/PAPRSF(JLON,JLEV,JBLK)
      ZQSTLE=FOQS(ZESP)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTLN))
      ZEW=FOEW(ZTLN,ZDELTA)
      ZESP=ZEW/PAPRSF(JLON,JLEV,JBLK)
      ZQSTLN=FOQS(ZESP)
      ZSN=PQU(JLON,JLEV,JBLK)+ZLN(JLON,JBLK)-ZQSTLN
      ZSE=PQ(JLON,JLEV,JBLK)+PQLIS(JLON,JLEV,JBLK)-ZQSTLE
      ZCHIS=ZSN/(ZSN-ZSE)
      ZCHIS=MIN(1.0_JPRB,MAX(0.0_JPRB,ZCHIS))
      ICHIS=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-ZCHIS+0.0_JPRB)))
      ZTVLN=ZTLN*(1.0_JPRB+RETV*(PQU(JLON,JLEV,JBLK)+ZLN(JLON,JBLK)))
      ZTVLE=ZTLE*(1.0_JPRB+RETV*(PQ(JLON,JLEV,JBLK)+PQLIS(JLON,JLEV,JBLK)))
      ZNCHI0=MAX(0.0_JPRB,ZTVN(JLON,JLEV,JBLK)-ZTVLE)
      ZDCHI0=MAX(ZEPS0,ZTVN(JLON,JLEV,JBLK)-(1.0_JPRB-ZCHIS)*ZTVLN-ZCHIS*ZTVLE)
      ZCHI0=ZCHIS*ZNCHI0/ZDCHI0
      ZCHI0=ICHIS*ZCHI0+(1-ICHIS)*1.0_JPRB
      ZCHI0=IVVER*MIN(1.0_JPRB,MAX(0.0_JPRB,MIN(ZCHI0,0.5_JPRB*(1.0_JPRB+ZENTRO/ &
        &ZEPS_ORG0))))&
        &+(1-IVVER)*1.0_JPRB
      IENTR=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZENTRO-YRPHY0%FENTRT*ZENTR_TUR)))
      ZCHI0=IENTR*1.0_JPRB+(1-IENTR)*ZCHI0

      ZCHI02=ZCHI0**2
      ZEPS_ORG(JLON,JLEV,JBLK)=YRPHY0%GCVRE*ZMOD(JLON,JLEV,JBLK)*MAX(ZEPS_ORG0*ZCHI02,ZEPS0)
      ZDEL_ORG(JLON,JLEV,JBLK)=YRPHY0%GCVRE*ZMOD(JLON,JLEV,JBLK)*MAX(ZEPS_ORG0*(1.0_JPRB-ZCHI0)**2,ZEPS0)

      ZDIAG_EPS_ORG(JLON,JLEV,JBLK)=ZEPS_ORG(JLON,JLEV,JBLK) &
        &*PAPRSF(JLON,JLEV,JBLK)/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))*RG
      ZDIAG_EPS_TUR(JLON,JLEV,JBLK)=ZEPS_TUR(JLON,JLEV,JBLK)*RG

      ! -------------------------------------------------
      ! CHANGE UNIT: ZEPSILON_U AND ZDELTA_U IN M**-1.
      ! -------------------------------------------------

      ZEPSILON_U(JLON,JLEV,JBLK)=(ZEPS_ORG(JLON,JLEV,JBLK)*PAPRSF(JLON,JLEV,JBLK) &
        &/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))+ZEPS_TUR(JLON,JLEV,JBLK))*RG
      ZDELTA_U(JLON,JLEV,JBLK)=((ZDEL_ORG(JLON,JLEV,JBLK)*PAPRSF(JLON,JLEV,JBLK) &
        &/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))+ZEPS_TUR(JLON,JLEV,JBLK))*RG)*YRPHY0%GCHI0
    

  ELSE

    ! NCVENTR not recognized. Entrainment and detrainment set to 0.
    
      ZEPSILON_U(JLON,JLEV,JBLK)=0._JPRB
      ZKD(JLON,JLEV,JBLK)=0._JPRB
      ZDELTA_U(JLON,JLEV,JBLK)=0._JPRB
    
  ENDIF

  ! -------------------------------------------------
  ! The reducing factor ZRE is applied to the total entrainment and detrainment.
  ! -------------------------------------------------
  
    ZEPSILON_U(JLON,JLEV,JBLK)=ZRE(JLON,JLEV,JBLK)*ZEPSILON_U(JLON,JLEV,JBLK)
    ZKD(JLON,JLEV,JBLK)=ZRE(JLON,JLEV,JBLK)*ZKD(JLON,JLEV,JBLK)
    ZDELTA_U(JLON,JLEV,JBLK)=ZRE(JLON,JLEV,JBLK)*ZDELTA_U(JLON,JLEV,JBLK)
  

  IF(YRPHY0%LCVEOD) THEN

    ! -------------------------------------------------
    ! Entrainment Outside Draft (EOD) is set to a large value.
    ! "Outside Draft" means here "where vertical velocity is below a given threshold".
    ! ZBINID is the binary indicateur of Inside Draft.
    ! -------------------------------------------------
    
      ZEPSILON_U(JLON,JLEV,JBLK)=ZBINID(JLON,JLEV,JBLK)*ZEPSILON_U(JLON,JLEV,JBLK) &
        & +(1._JPRB-ZBINID(JLON,JLEV,JBLK))*ZENTRX*RG
      ZKD(JLON,JLEV,JBLK)=ZBINID(JLON,JLEV,JBLK)*ZKD(JLON,JLEV,JBLK) &
        & +(1._JPRB-ZBINID(JLON,JLEV,JBLK))*ZENTRX &
        & *PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)
      ZDELTA_U(JLON,JLEV,JBLK)=ZBINID(JLON,JLEV,JBLK)*ZDELTA_U(JLON,JLEV,JBLK) &
        & +(1._JPRB-ZBINID(JLON,JLEV,JBLK))*ZENTRX*RG
    

  ENDIF

  ! -------------------------------------------------
  ! In case of NH approach, entrainment above LNB is set to a large value.
  ! -------------------------------------------------
  
    ZEPSILON_U(JLON,JLEV,JBLK)=ZBINBUO(JLON,JLEV,JBLK)*ZEPSILON_U(JLON,JLEV,JBLK) &
      & +(1._JPRB-ZBINBUO(JLON,JLEV,JBLK))*ZENTRX*RG
    ZKD(JLON,JLEV,JBLK)=ZBINBUO(JLON,JLEV,JBLK)*ZKD(JLON,JLEV,JBLK) &
      & +(1._JPRB-ZBINBUO(JLON,JLEV,JBLK))*ZENTRX &
      & *PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)
    ZDELTA_U(JLON,JLEV,JBLK)=ZBINBUO(JLON,JLEV,JBLK)*ZDELTA_U(JLON,JLEV,JBLK) &
      & +(1._JPRB-ZBINBUO(JLON,JLEV,JBLK))*ZENTRX*RG
  

    ! -------------------------------------------------
    ! // INTEGRATE SIGMA IN THE VERTICAL.
    ! -------------------------------------------------

  IF(YRPHY0%NCVSIG == 1 .OR. YRPHY0%NCVSIG == 2) THEN
!   Isolate Log (may not vectorize)
    
      ZLOGSIGMA(JLON,JBLK)=LOG(MAX(1.0E-15_JPRB,ZSIGMA(JLON,JLEV,JBLK)))
    
    
      IVVER=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,ZVVERDM(JLON,JLEV,JBLK)+0.0_JPRB)))
      ZDLOGM=(ZEPS_ORG(JLON,JLEV,JBLK)-ZDEL_ORG(JLON,JLEV,JBLK))/YRPHY0%GCVRE
      ZEMD_DIAG(JLON,JLEV-1,JBLK)=ZEPSILON_U(JLON,JLEV,JBLK)-ZDELTA_U(JLON,JLEV,JBLK)
      ZSIGMA(JLON,JLEV-1,JBLK)=REAL(IVVER)*(EXP(ZLOGSIGMA(JLON,JBLK)&
        &+PDELP(JLON,JLEV,JBLK)*(ZDLOGM+IVVER*ZDWNDP(JLON,JLEV,JBLK)&
        &*ZRE(JLON,JLEV,JBLK)/MIN(-ZEPS0,ZVVERDM(JLON,JLEV,JBLK)))) )&
        &+REAL(1-IVVER)*1.0_JPRB
    
  ENDIF
! Isolate Log (may not vectorize)
  
    ZTD=ZT(JLON,JLEV,JBLK)*(1.0_JPRB+(ZLN(JLON,JBLK)-RETV*(PQSAT(JLON,JLEV,JBLK)&
      & -PQ(JLON,JLEV,JBLK)))/(1.0_JPRB+RETV*PLH(JLON,JLEV,JBLK)*PQSAT(JLON,JLEV,JBLK)&
      & /(RV*ZT(JLON,JLEV,JBLK))))
    ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTD))
    ZEW_TLE(JLON,JBLK)=FOEW (ZTD,ZDELTA)
  

  IF(YRPHY0%NCVSIG == 1) THEN
    
      ZSIGMA(JLON,JLEV-1,JBLK)=MAX(ZEPS0,MIN(ZSIGMA(JLON,JLEV-1,JBLK),ZSIGMA(JLON,JLEV,JBLK)))
    
  ELSEIF(YRPHY0%NCVSIG == 2) THEN
    
      ZSIGMA(JLON,JLEV-1,JBLK)=MAX(ZEPS0,MIN(1.0_JPRB,ZSIGMA(JLON,JLEV-1,JBLK)))
    
  ELSE
    
      ZSIGMA(JLON,JLEV-1,JBLK)=1.
    
  ENDIF

  

    ICDN(JLON,JBLK)=MAX(0,-ISIGN(1,-INCDN(JLON,JLEV,JBLK)))
    IBAC(JLON,JBLK)=MAX(0,-ISIGN(1,-INIVBAC(JLON,JLEV+1,JBLK)))
    IKUO5(JLON,JBLK)=MAX(0,ISIGN(1,&
     & IBAC(JLON,JBLK)*INIVBAC(JLON,JLEV+1,JBLK)+(1-IBAC(JLON,JBLK)) &
     & -ILEVTEN(JLON,JBLK)))
    IKUO6(JLON,JBLK)=MAX(NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,ZVVER(JLON,JLEV-1,JBLK)+0.0_JPRB)))&
      & ,NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,ZVVER(JLON,JLEV,JBLK)+0.0_JPRB))))

    ! KNLAB(JLON,JLEV)=0 IF ASCENT BASE ABOVE THETAE MINIMUM
    KNLAB(JLON,JLEV,JBLK)=IKUO6(JLON,JBLK)*IBAC(JLON,JBLK)*IKUO5(JLON,JBLK)
    PQLIC(JLON,JLEV,JBLK)=PQLIC(JLON,JLEV,JBLK)*KNLAB(JLON,JLEV,JBLK)*ICDN(JLON,JBLK)

    ! // FINAL VALUES OF DETRAINMENT.
    ZESP=ZEW_TLE(JLON,JBLK)/PAPRSF(JLON,JLEV,JBLK)
    ZQW=FOQS(ZESP)
    ZTD=ICDN(JLON,JBLK)*(YRPHY0%GCVADET*ZTD+(1.0_JPRB-YRPHY0%GCVADET)*PTU(JLON,JLEV,JBLK))+(1-ICDN(JLON,JBLK))*PTU(JLON,JLEV,JBLK)
    ZQW=ICDN(JLON,JBLK)*(YRPHY0%GCVADET*ZQW+(1.0_JPRB-YRPHY0%GCVADET)*PQU(JLON,JLEV,JBLK))+(1-ICDN(JLON,JBLK))*PQU(JLON,JLEV,JBLK)

    ZQDN(JLON,JLEV,JBLK)=ZQW
    ZSDN(JLON,JLEV,JBLK)=(RCPD+ZCPVMD*ZQW)*ZTD+ZPHIF_U(JLON,JLEV,JBLK)

    ! // IN CASE OF UNBUOYANT PARCEL ONE SETS THE STATE TO THAT OF THE ENVIRONMENT.
    INUA=KNLAB(JLON,JLEV,JBLK)
    INIVBAC(JLON,JLEV,JBLK)=MAX(INIVBAC(JLON,JLEV+1,JBLK),JLEV)
    INIVBAC(JLON,JLEV,JBLK)=INUA*INIVBAC(JLON,JLEV,JBLK)+(1-INUA)*JLEV
    INIVBAC(JLON,JLEV+1,JBLK)=INUA*INIVBAC(JLON,JLEV+1,JBLK)
    INLFC(JLON,JLEV,JBLK)=INUA*INLFC(JLON,JLEV,JBLK)

    ZEPSILON_U(JLON,JLEV,JBLK)=INUA*ZEPSILON_U(JLON,JLEV,JBLK)+(1-INUA)*ZEPSILON_U(JLON,KLEV,JBLK)
    ZVVER(JLON,JLEV-1,JBLK)=INUA*ZVVER(JLON,JLEV-1,JBLK)
    IF(YRPHY0%LGVVEX) ZVVER(JLON,JLEV-1,JBLK)=ZVVER(JLON,JLEV-1,JBLK)-(1-INUA)*YRPHY0%GCVWEXC &
      &*SQRT(MAX(0._JPRB,2._JPRB/3._JPRB*MIN(5.0_JPRB,PTKE(JLON,JLEV-1,JBLK))))&
      &*RG*PAPRS(JLON,JLEV-1,JBLK)/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))
    ZVVERDM(JLON,JLEV,JBLK)=INUA*ZVVERDM(JLON,JLEV,JBLK)+(1-INUA)*ZVVER(JLON,JLEV-1,JBLK)
    IF(YRPHY0%NCVSIG == 0) THEN
      ZSIGMA(JLON,JLEV-1,JBLK)=1.
    ELSE
      ZSIGMA(JLON,JLEV-1,JBLK)=INUA*ZSIGMA(JLON,JLEV-1,JBLK)+(1-INUA)*1.0_JPRB
    ENDIF
    PTU(JLON,JLEV,JBLK)=INUA*PTU(JLON,JLEV,JBLK)+(1-INUA)*ZT(JLON,JLEV,JBLK)
    PQU(JLON,JLEV,JBLK)=INUA*PQU(JLON,JLEV,JBLK)+(1-INUA)*PQ(JLON,JLEV,JBLK)

    PSU(JLON,JLEV,JBLK)=(RCPD+ZCPVMD*PQU(JLON,JLEV,JBLK))*PTU(JLON,JLEV,JBLK)+ZPHIF_U(JLON,JLEV,JBLK)
    ZSU(JLON,JLEV,JBLK)=PSU(JLON,JLEV,JBLK)

    ZLN(JLON,JBLK)=INUA*ZLN(JLON,JBLK)
    ZQDN(JLON,JLEV,JBLK)=INUA*ZQDN(JLON,JLEV,JBLK)+(1-INUA)*PQ(JLON,JLEV,JBLK)
    ZSDN(JLON,JLEV,JBLK)=INUA*ZSDN(JLON,JLEV,JBLK)+(1-INUA)*ZDSE(JLON,JLEV,JBLK)
    ZTNH(JLON,JBLK)=INUA*ZTNH(JLON,JBLK)+(1-INUA)*PTW(JLON,JLEV,JBLK)
    ZQNH(JLON,JBLK)=INUA*ZQNH(JLON,JBLK)+(1-INUA)*PQW(JLON,JLEV,JBLK)

    ! // SATURATION TEST AT TOP LEVEL.
    ICDN(JLON,JBLK)=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,PQU(JLON,JLEV,JBLK)-PQSAT(JLON,JLEV,JBLK))))
    INCDN(JLON,JLEV,JBLK)=INUA*INCDN(JLON,JLEV,JBLK)+(1-INUA)*JLEV*ICDN(JLON,JBLK)

    ! // MASS FLUX PROFILE.
    ZFORM(JLON,JLEV,JBLK)=-1.0_JPRB*KNLAB(JLON,JLEV,JBLK)*ZVVER(JLON,JLEV,JBLK)&
      & *ZSIGMA(JLON,JLEV,JBLK)

    ! SUMMATIONS.

    ZFORMV=0.5_JPRB*(ZFORM(JLON,JLEV+1,JBLK)+ZFORM(JLON,JLEV,JBLK))
    ZS15(JLON,JBLK)=ZS15(JLON,JBLK)+KNLAB(JLON,JLEV+1,JBLK)*ZBINBUO(JLON,JLEV,JBLK)*ZCAPE(JLON,JBLK)
    ZBCC_C_FULL(JLON,JLEV+1,JBLK)=0.5_JPRB*(ZBCC_C_HALF(JLON,JLEV,JBLK)+ZBCC_C_HALF(JLON,JLEV+1,JBLK))

    ZFMDQN=0.5_JPRB*ZFORM(JLON,JLEV,JBLK)*((PQU(JLON,JLEV,JBLK)+PQU(JLON,JLEV+1,JBLK))&
       &-(PQ(JLON,JLEV,JBLK)+PQ(JLON,JLEV+1,JBLK)))
    ZFMDSN=0.5_JPRB*ZFORM(JLON,JLEV,JBLK)*((ZSU(JLON,JLEV,JBLK)+ZSU(JLON,JLEV+1,JBLK))&
       &-(ZDSE(JLON,JLEV,JBLK)+ZDSE(JLON,JLEV+1,JBLK)))

    ! ZS16 = VERTICAL INTEGRAL OF DP/P FROM (dCAPE/dt) DUE TO CONVECTION.
    ZS16(JLON,JBLK)=ZS16(JLON,JBLK)+KNLAB(JLON,JLEV+1,JBLK)*ZBINBUO(JLON,JLEV,JBLK)&
       &*RD*((1.0_JPRB+RETV*PQ(JLON,JLEV+1,JBLK))/PCP(JLON,JLEV+1,JBLK)&
       &*(ZFMDS(JLON,JBLK)-ZFMDSN+ZFORMV*PLH(JLON,JLEV+1,JBLK)&
       &*PDELP(JLON,JLEV+1,JBLK)*ZBCC_C_FULL(JLON,JLEV+1,JBLK))&
       &+RETV*ZT(JLON,JLEV+1,JBLK)*(ZFMDQ(JLON,JBLK)-ZFMDQN&
       &-ZFORMV*PDELP(JLON,JLEV+1,JBLK)*ZBCC_C_FULL(JLON,JLEV+1,JBLK)))/PAPRSF(JLON,JLEV+1,JBLK)
    ZFMDQ(JLON,JBLK)=ZFMDQN
    ZFMDS(JLON,JBLK)=ZFMDSN
    ZDPLAB=KNLAB(JLON,JLEV+1,JBLK)*PDELP(JLON,JLEV+1,JBLK)*ZBINBUO(JLON,JLEV,JBLK)
    ! ZS12: vertical extension of the updraft (in Pa).
    ZS12(JLON,JBLK)=ZS12(JLON,JBLK)+ZDPLAB
    ! ZS11: mean vertical velocity.
    ZS11(JLON,JBLK)=ZS11(JLON,JBLK)+ZDPLAB*ABS(ZVVERDM(JLON,JLEV+1,JBLK))
    ZCAPE(JLON,JBLK)=ZCAPEL(JLON,JBLK)

    PUDOM(JLON,JLEV,JBLK)=ZVVERDM(JLON,JLEV,JBLK)
    PUDAL(JLON,JLEV,JBLK)=0._JPRB
    PDDAL(JLON,JLEV,JBLK)=0._JPRB
  

  ! VERIFICATION OF THE PRESENCE OF AT LEAST ONE CLOUD ALONG THE
  ! "JLON" VECTOR AND MODIFICATION OF ITOP IF NECESSARY.

  ISUM=0
  
    ISUM=ISUM+KNLAB(JLON,JLEV,JBLK)
  

  IF (ISUM /= 0) THEN
    ITOP=JLEV
  ENDIF
ENDDO
ENDDO
ENDDO


IF(YRPHY0%LCVNHD) THEN

  !-------------------------------------------------
  ! Updraft and downdraft velocities are computed using coupled prognostic
  ! equations, using NH pressure-gradient terms.
  !-------------------------------------------------

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  KNLAB(JLON,JLEV,JBLK) = 1
  
  ENDDO
  ENDDO
  ENDDO



  !-------------------------------------------------
  ! Vertical smoothing of evaporation.
  !-------------------------------------------------

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
    ZMEAN_D(JLON,KTDIA,JBLK)=PEVAPO(JLON,KTDIA,JBLK)
    ZMEAN_U(JLON,KLEV,JBLK)=PEVAPO(JLON,KLEV,JBLK)
    ZINTEG(JLON,KTDIA,JBLK)=1.E-11_JPRB
  
  ENDDO
  ENDDO

  ! DOWNWARD SMOOTHING.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA+1,KLEV
    
      ZMEAN_D(JLON,JLEV,JBLK)=(ZMEAN_D(JLON,JLEV-1,JBLK)*YRPHY0%GNHDSMOS+PEVAPO(JLON,JLEV,JBLK) &
        & *(ZPHIF_U(JLON,JLEV-1,JBLK)-ZPHIF_U(JLON,JLEV,JBLK))) &
        & /(YRPHY0%GNHDSMOS+ZPHIF_U(JLON,JLEV-1,JBLK)-ZPHIF_U(JLON,JLEV,JBLK))
      ZINTEG(JLON,JLEV,JBLK)=ZINTEG(JLON,JLEV-1,JBLK)+(ZPHIF_U(JLON,JLEV-1,JBLK)-ZPHIF_U(JLON,JLEV,JBLK)) &
        & *ABS(PEVAPO(JLON,JLEV,JBLK))
    
  ENDDO
  ENDDO
  ENDDO

  ! UPWARD SMOOTHING.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KLEV-1,KTDIA,-1
    
      ZMEAN_U(JLON,JLEV,JBLK)=(ZMEAN_U(JLON,JLEV+1,JBLK)*YRPHY0%GNHDSMOS+PEVAPO(JLON,JLEV,JBLK) &
         & *(ZPHIF_U(JLON,JLEV,JBLK)-ZPHIF_U(JLON,JLEV+1,JBLK))) &
         & /(YRPHY0%GNHDSMOS+ZPHIF_U(JLON,JLEV,JBLK)-ZPHIF_U(JLON,JLEV+1,JBLK))
    
  ENDDO
  ENDDO
  ENDDO

  ! Average upward and downward smoothings, with a weight depending on altitude.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    
      ZWEIGHT=ZINTEG(JLON,JLEV,JBLK)/ZINTEG(JLON,KLEV,JBLK)
      ZEVAPO(JLON,JLEV,JBLK)=ZWEIGHT*ZMEAN_U(JLON,JLEV,JBLK) &
        & +(1._JPRB-ZWEIGHT)*ZMEAN_D(JLON,JLEV,JBLK)
    
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    

      ! Temperature within the downdraft.
      ZT_DOWN(JLON,JLEV,JBLK)=ZT(JLON,JLEV,JBLK)-YRPHY0%GNHDEV*ZEVAPO(JLON,JLEV,JBLK) &
        & *MAX(0._JPRB,SIGN(1._JPRB,ZDEPTH(JLON,JBLK)-YRPHY0%GDEPTH))
    
  ENDDO
  ENDDO
  ENDDO


  !-------------------------------------------------
  ! Updraft and downdraft prognostic equations.
  !-------------------------------------------------

  ! Tendency due to advection: direct computation.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWU_ADV(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWD_ADV(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    
      ZTWU_ADV(JLON,JLEV,JBLK)=-ZWU(JLON,JLEV,JBLK)*(ZWU(JLON,JLEV,JBLK)-ZWU(JLON,JLEV+1,JBLK)) &
        & /(ZPHIF_U(JLON,JLEV,JBLK)-ZPHIF_U(JLON,JLEV+1,JBLK))*RG
      ZTWD_ADV(JLON,JLEV,JBLK)=-ZWD(JLON,JLEV,JBLK)*(ZWD(JLON,JLEV,JBLK)-ZWD(JLON,JLEV+1,JBLK)) &
        & /(ZPHIF_U(JLON,JLEV,JBLK)-ZPHIF_U(JLON,JLEV+1,JBLK))*RG
    
  ENDDO
  ENDDO
  ENDDO


  ! Buoyancy.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWU_BUO(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWD_BUO(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    
      ! Updraft.
      ZTVNL=PTU(JLON,JLEV,JBLK)*(1.0_JPRB+RETV*PQU(JLON,JLEV,JBLK))
      ZTVEL=ZT(JLON,JLEV,JBLK)*(1.0_JPRB+RETV*PQ(JLON,JLEV,JBLK))
      ZTWU_BUO(JLON,JLEV,JBLK)=MAX(0._JPRB,RG*(ZTVNL/ZTVEL-1._JPRB))
      ! Downdraft.
      ZTVNL=ZT_DOWN(JLON,JLEV,JBLK)*(1.0_JPRB+RETV*PQ(JLON,JLEV,JBLK))
      ZTVEL=ZT(JLON,JLEV,JBLK)*(1.0_JPRB+RETV*PQ(JLON,JLEV,JBLK))
      ZTWD_BUO(JLON,JLEV,JBLK)=MIN(0._JPRB,RG*(ZTVNL/ZTVEL-1._JPRB))
    
  ENDDO
  ENDDO
  ENDDO


  ! Dynamical production.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWU_DYP(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWD_DYP(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    
      ! Updraft.
      ZTWU_DYP(JLON,JLEV,JBLK)=0._JPRB
      ! Downdraft due to precipitation evaporation. The only source term is the negative
      ! buoyancy due to this evaporation. No contribution here from dynamical production.
      ZTWD_DYP(JLON,JLEV,JBLK)=0._JPRB
    
  ENDDO
  ENDDO
  ENDDO


  ! Friction.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWU_FRI(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWD_FRI(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    
      ZTWU_FRI(JLON,JLEV,JBLK)=-YRPHY0%GFRIC*ZWU(JLON,JLEV,JBLK)**2
      ZTWD_FRI(JLON,JLEV,JBLK)= YRPHY0%GFRIC*ZWD(JLON,JLEV,JBLK)**2
    
  ENDDO
  ENDDO
  ENDDO



  ! Target wd: a vertical smoothing of wd + buoyancy effect.
  ! 1. Buoyancy effect.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    
      ZWD_PLUS_BUO(JLON,JLEV,JBLK)=ZWD(JLON,JLEV,JBLK)+YRPHY2%TSPHY*ZTWD_BUO(JLON,JLEV,JBLK)
    
  ENDDO
  ENDDO
  ENDDO

  ! 2. Vertical smoothing.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
    ZMEAN_D(JLON,KTDIA,JBLK)=0._JPRB
    ZMEAN_U(JLON,KLEV,JBLK)=0._JPRB
    ZINTEG(JLON,KTDIA,JBLK)=ZEPSW
  
  ENDDO
  ENDDO

  ! DOWNWARD SMOOTHING.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA+1,KLEV
    
      ZMEAN_D(JLON,JLEV,JBLK)=(ZMEAN_D(JLON,JLEV-1,JBLK)*YRPHY0%GNHDSMOW+ZWD_PLUS_BUO(JLON,JLEV,JBLK) &
        & *(ZPHIF_U(JLON,JLEV-1,JBLK)-ZPHIF_U(JLON,JLEV,JBLK))) &
        & /(YRPHY0%GNHDSMOW+ZPHIF_U(JLON,JLEV-1,JBLK)-ZPHIF_U(JLON,JLEV,JBLK))
      ZINTEG(JLON,JLEV,JBLK)=ZINTEG(JLON,JLEV-1,JBLK)+(ZPHIF_U(JLON,JLEV-1,JBLK)-ZPHIF_U(JLON,JLEV,JBLK)) &
        & *ABS(ZWD_PLUS_BUO(JLON,JLEV,JBLK))
    
  ENDDO
  ENDDO
  ENDDO

  ! UPWARD SMOOTHING.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KLEV-1,KTDIA,-1
    
      ZMEAN_U(JLON,JLEV,JBLK)=(ZMEAN_U(JLON,JLEV+1,JBLK)*YRPHY0%GNHDSMOW+ZWD_PLUS_BUO(JLON,JLEV,JBLK) &
         & *(ZPHIF_U(JLON,JLEV,JBLK)-ZPHIF_U(JLON,JLEV+1,JBLK))) &
         & /(YRPHY0%GNHDSMOW+ZPHIF_U(JLON,JLEV,JBLK)-ZPHIF_U(JLON,JLEV+1,JBLK))
    
  ENDDO
  ENDDO
  ENDDO

  ! Average upward and downward smoothings, with a weight depending on altitude.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTARGET_WD(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWU_NHD(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWD_NHD(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    
      ZWEIGHT=ZINTEG(JLON,JLEV,JBLK)/ZINTEG(JLON,KLEV,JBLK)
      ZTARGET_WD(JLON,JLEV,JBLK)=ZWEIGHT*ZMEAN_U(JLON,JLEV,JBLK) &
        & +(1._JPRB-ZWEIGHT)*ZMEAN_D(JLON,JLEV,JBLK)
      ZTWD_NHD(JLON,JLEV,JBLK)=(ZTARGET_WD(JLON,JLEV,JBLK)-ZWD_PLUS_BUO(JLON,JLEV,JBLK))/YRPHY2%TSPHY
      ZTWU_NHD(JLON,JLEV,JBLK)=ZTWD_NHD(JLON,JLEV,JBLK)
    
  ENDDO
  ENDDO
  ENDDO


  ! Temporal integration.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWU_TOT_RAW(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWD_TOT_RAW(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWU_TOT(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWD_TOT(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWU_STAU(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZTWD_STAU(JLON,JLEV,JBLK) = 0._JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    

      ! Pure diagnostic.

      ! Total tendency (diagnostic).
      ZTWU_TOT_RAW(JLON,JLEV,JBLK)=ZTWU_ADV(JLON,JLEV,JBLK)+ZTWU_BUO(JLON,JLEV,JBLK) &
        & +ZTWU_DYP(JLON,JLEV,JBLK)+ZTWU_FRI(JLON,JLEV,JBLK)+ZTWU_NHD(JLON,JLEV,JBLK)
      ZTWD_TOT_RAW(JLON,JLEV,JBLK)=ZTWD_ADV(JLON,JLEV,JBLK)+ZTWD_BUO(JLON,JLEV,JBLK) &
        & +ZTWD_DYP(JLON,JLEV,JBLK)+ZTWD_FRI(JLON,JLEV,JBLK)+ZTWD_NHD(JLON,JLEV,JBLK)

      ! Solve temporal equation implicitly.
      ! Updraft.
      ZA=0.5_JPRB/(ZPHIF_U(JLON,JLEV,JBLK)-ZPHIF_U(JLON,JLEV+1,JBLK))+YRPHY0%GFRIC
      ZB=1._JPRB/YRPHY2%TSPHY
      ZC=-ZTWU_BUO(JLON,JLEV,JBLK)-ZTWU_DYP(JLON,JLEV,JBLK)-ZTWU_NHD(JLON,JLEV,JBLK)-0.5_JPRB/(ZPHIF_U(JLON,JLEV,JBLK) &
        & -ZPHIF_U(JLON,JLEV+1,JBLK))*ZWU(JLON,JLEV+1,JBLK)**2.-ZWU(JLON,JLEV,JBLK)/YRPHY2%TSPHY
      ZD=ZB*ZB-4._JPRB*ZA*ZC
      ZWNEW=(-ZB+SQRT(MAX(0._JPRB,ZD)))/(2._JPRB*ZA)
      ZTWU_TOT(JLON,JLEV,JBLK)=(ZWNEW-ZWU(JLON,JLEV,JBLK))/YRPHY2%TSPHY
      ZWU(JLON,JLEV,JBLK)=ZWNEW
      ! Downdraft.
      ZA=0.5_JPRB/(ZPHIF_U(JLON,JLEV,JBLK)-ZPHIF_U(JLON,JLEV+1,JBLK))-YRPHY0%GFRIC
      ZC=-ZTWD_BUO(JLON,JLEV,JBLK)-ZTWD_DYP(JLON,JLEV,JBLK)-ZTWD_NHD(JLON,JLEV,JBLK)-0.5_JPRB/(ZPHIF_U(JLON,JLEV,JBLK) &
        & -ZPHIF_U(JLON,JLEV+1,JBLK))*ZWD(JLON,JLEV+1,JBLK)**2.-ZWD(JLON,JLEV,JBLK)/YRPHY2%TSPHY
      ZD=ZB*ZB-4._JPRB*ZA*ZC
      ZWNEW=(-ZB+SQRT(MAX(0._JPRB,ZD)))/(2._JPRB*ZA)
      ZTWD_TOT(JLON,JLEV,JBLK)=(ZWNEW-ZWD(JLON,JLEV,JBLK))/YRPHY2%TSPHY
      ZWD(JLON,JLEV,JBLK)=ZWNEW

      ! Check extrema.
      ZWU(JLON,JLEV,JBLK)=MAX(0._JPRB,ZWU(JLON,JLEV,JBLK))
      ZWD(JLON,JLEV,JBLK)=MIN(0._JPRB,ZWD(JLON,JLEV,JBLK))

      ! VERTICAL VELOCITY IN PA/S COMPUTED FROM VERTICAL VELOCITY IN M/S.
      PUDOM(JLON,JLEV,JBLK)=-ZWU(JLON,JLEV,JBLK)*PAPRSF(JLON,JLEV,JBLK) &
      & *RG/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))
    
  ENDDO
  ENDDO
  ENDDO

ENDIF ! LCVNHD.

!-------------------------------------------------
! CLOSURE: ESTIMATE CONVECTIVE MASSFLUX CLOSER TO EULERIAN EQUATIONS (EUL).
!-------------------------------------------------

!CALL ACMTUDEUL ( KIDIA,KFDIA,KLON,KTDIA,KLEV,&
!   &PDELP,PRDELP,PAPRS,PAPRSF,PAPHI,PAPHIF,PR,ZT, PTU, PQU &
!   &)

! // QUITTING IN CASE OF NO CONVECTION EVERYWHERE.
! THE "IF THEN / ENDIF" ENCOMPASSED SEQUENCE WILL NOT BE INDENTED GIVEN ITS LENGTH
!     AND ITS SPECIAL CHARACTER (PSEUDO "RETURN" STATEMENT).

IF(YRPHY%NPHYREP /= 0 .AND. YRPHY%NPHYREP /= -1) ITOP=KTDIA

IF (ITOP < KLEV+1) THEN

  ! LAST LEVEL SUMMATION (TOP).

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  

    ! PUDOM HAS TO BE ZERO I.E. THE LARGE SCALE VERT VEL. AT LEVEL KTDIA

    PUDOM(JLON,KTDIA,JBLK)=0.0_JPRB
    ZFORMV=ZFORM(JLON,KTDIA,JBLK)
    ZS15(JLON,JBLK)=ZS15(JLON,JBLK)+KNLAB(JLON,KTDIA,JBLK)*ZBINBUO(JLON,KTDIA,JBLK)*ZCAPE(JLON,JBLK)
    ZBCC_C_FULL(JLON,KTDIA,JBLK)=0.5_JPRB*(ZBCC_C_HALF(JLON,KTDIA-1,JBLK)+ZBCC_C_HALF(JLON,KTDIA,JBLK))
    ZFMDQN=0.5_JPRB*ZFORM(JLON,KTDIA,JBLK)*((PQU(JLON,KTDIA,JBLK)+PQU(JLON,KTDIA+1,JBLK))&
       &-(PQ(JLON,KTDIA,JBLK)+PQ(JLON,KTDIA+1,JBLK)))
    ZFMDSN=0.5_JPRB*ZFORM(JLON,KTDIA,JBLK)*((ZSU(JLON,KTDIA,JBLK)+ZSU(JLON,KTDIA+1,JBLK))&
       &-(ZDSE(JLON,KTDIA,JBLK)+ZDSE(JLON,KTDIA+1,JBLK)))

    ZS16(JLON,JBLK)=ZS16(JLON,JBLK)+KNLAB(JLON,KTDIA,JBLK)*ZBINBUO(JLON,KTDIA,JBLK)&
       &*RD*((1.0_JPRB+RETV*PQ(JLON,KTDIA,JBLK))/PCP(JLON,KTDIA,JBLK)&
       &*(ZFMDS(JLON,JBLK)-ZFMDSN+ZFORMV*PLH(JLON,KTDIA,JBLK)&
       &*PDELP(JLON,KTDIA,JBLK)*ZBCC_C_FULL(JLON,KTDIA,JBLK))&
       &+RETV*ZT(JLON,KTDIA,JBLK)*(ZFMDQ(JLON,JBLK)-ZFMDQN&
       &-ZFORMV*PDELP(JLON,KTDIA,JBLK)*ZBCC_C_FULL(JLON,KTDIA,JBLK)))/PAPRSF(JLON,KTDIA,JBLK)
    ZDPLAB=KNLAB(JLON,KTDIA,JBLK)*PDELP(JLON,KTDIA,JBLK)*ZBINBUO(JLON,KTDIA,JBLK)
    ZS12(JLON,JBLK)=ZS12(JLON,JBLK)+ZDPLAB
    ZS11(JLON,JBLK)=ZS11(JLON,JBLK)+ZDPLAB*ABS(ZVVERDM(JLON,KTDIA,JBLK))

  
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ITOP,KLEV-1
    
      INBAS(JLON,JLEV,JBLK)=KNLAB(JLON,JLEV,JBLK)*(1-KNLAB(JLON,JLEV+1,JBLK))
    
  ENDDO
  ENDDO
  ENDDO


  ! ------------------------------------------------------------------
  ! // MESH FRACTION, VERTICAL ENTHALPY BUDGET AND DETRAINMENT
  ! ------------------------------------------------------------------

  ! DIAGNOSTIC OF CAPE (FORECASTER NEED) WHATEVER CLOSURE.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
  PCAPE(JLON,JBLK) = 0.0_JPRB
  
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
  ZIBCCS(JLON,JBLK) = 0.0_JPRB
  
  ENDDO
  ENDDO

 ! Integral of BCC multiplied by Sigma.
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ITOP,KLEV
    
      ZIBCCS(JLON,JBLK)=ZIBCCS(JLON,JBLK)-PUDOM(JLON,JLEV,JBLK) &
        & *ZBCC_C_FULL(JLON,JLEV,JBLK)*ZSIGMA(JLON,JLEV,JBLK) &
        & *ZBINID(JLON,JLEV,JBLK)*PDELP(JLON,JLEV,JBLK)/RG
    
    IF (LLCAPECIN) THEN
      
        PCAPE(JLON,JBLK)=PCAPE(JLON,JBLK) +KNLAB(JLON,JLEV,JBLK)*RD&
          &*PDELP(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)&
          &*(ZTVN(JLON,JLEV,JBLK)-ZTVE(JLON,JLEV,JBLK))
      
    ELSE
      
        PCAPE(JLON,JBLK)=PCAPE(JLON,JBLK) +KNLAB(JLON,JLEV,JBLK)*RD&
          &*PDELP(JLON,JLEV,JBLK)/PAPRSF(JLON,JLEV,JBLK)&
          &*MAX(0._JPRB,ZTVN(JLON,JLEV,JBLK)-ZTVE(JLON,JLEV,JBLK))
      
    ENDIF
  ENDDO
  ENDDO
  ENDDO

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
    ZTAU(JLON,JBLK)=1.0_JPRB/ZFDXTAUX(JLON,JBLK)*ZS12(JLON,JBLK)*ZS12(JLON,JBLK)/MAX(ZS11(JLON,JBLK),ZEPS0)
    ZTAU_DIAG(JLON,JBLK)=ZTAU(JLON,JBLK)
    ! Impose tau (time consumption of CAPE) to be larger than the model time step.
    IF(YRPHY0%LCVCONTAU) ZTAU(JLON,JBLK)=MAX(YRPHY2%TSPHY,ZTAU(JLON,JBLK))
    ZS15(JLON,JBLK)=MAX(0.0_JPRB,ZS15(JLON,JBLK))
    ! ZALF_CVGQ : surface fraction occupied by convection, in case of CVGQ closure.
    ! As CVGQ closure is relevant for precipitating convection only,
    ! the surface computed here will be > 0 only in moist cases, where the vertical integral of
    ! BCC is larger than the drizzle threshold.
    ! In order to avoid instabilities when starting prediction from an
    ! interpolated analysis, one sets the CVGQ to 0 during the first hour of
    ! prediction.
    ZALF_CVGQ(JLON,JBLK)=MAX(0._JPRB,ZCVGQ(JLON,JBLK))/MAX(ZEPS_BCCS,ZIBCCS(JLON,JBLK)) &
      & *MAX(0._JPRB,SIGN(1._JPRB,ZIBCCS(JLON,JBLK)-ZEPS_BCCS)) &
      & *MAX(0._JPRB, SIGN(1._JPRB,YRRIP%RSTATI-3600._JPRB))


    ! EXTRA-DIAGNOSTICS
    PALF_CVGQ(JLON,JBLK)=ZALF_CVGQ(JLON,JBLK)
    PALF_CAPE(JLON,JBLK)=ZS15(JLON,JBLK)/MAX(ZEPS16,ZS16(JLON,JBLK))&
        & *MAX(0.0_JPRB,SIGN(1.0_JPRB,(ZS16(JLON,JBLK)-ZEPS16)))&
        & /MAX(ZTAU(JLON,JBLK),ZEPS0)

    IF(YRPHY0%NCVCLOS == 1) THEN
      ! ALPHA DIAGNOSED FROM d(CAPE)/dt=-CAPE/TAU.
      PALF(JLON,JBLK)=MIN(ZALFX(JLON,JBLK),ZS15(JLON,JBLK)/MAX(ZEPS16,ZS16(JLON,JBLK))&
        & *MAX(0.0_JPRB,SIGN(1.0_JPRB,(ZS16(JLON,JBLK)-ZEPS16)))&
        & /MAX(ZTAU(JLON,JBLK),ZEPS0))

    ELSEIF(YRPHY0%NCVCLOS == 2) THEN
      ! ALPHA AS A FUNCTION OF SATURATION DEFICIT.
      PALF(JLON,JBLK)=YRPHY0%GALMIN+(YRPHY0%GALMAX-YRPHY0%GALMIN) &
      & *MAX(0._JPRB,MIN(1._JPRB,(YRPHY0%GSDAMAX-ZSATDEF(JLON,JBLK)) &
      & /(YRPHY0%GSDAMAX-YRPHY0%GSDAMIN)))

      ! LIMITATION OF ALPHA IN STRATOCUMULUS CONTEXT: WHERE TKE AND CLOUD DEPTH ARE SMALL.
      ZBINTKE=MAX(0._JPRB,SIGN(1._JPRB,0.3_JPRB-PTKE(JLON,KLEV,JBLK)))
      ZBINDEPTH=MAX(0._JPRB,SIGN(1._JPRB,800._JPRB-ZDEPTH(JLON,JBLK)))
      PALF(JLON,JBLK)=PALF(JLON,JBLK)*(1._JPRB-ZBINTKE*ZBINDEPTH)

      ! TAU COMPUTED HERE FOR DIAGNOSTIC PURPOSE ONLY.
      ZTAU(JLON,JBLK)=ZS15(JLON,JBLK)/MAX(ZEPS16,ZS16(JLON,JBLK))/MAX(0.001_JPRB,PALF(JLON,JBLK))

      ! Impose time consumption of CAPE to be larger than the model time step.
      IF(YRPHY0%LCVCONTAU) PALF(JLON,JBLK)=PALF(JLON,JBLK)*MAX(0._JPRB,MIN(1._JPRB,ZTAU(JLON,JBLK)/YRPHY2%TSPHY))

    ELSEIF(YRPHY0%NCVCLOS == 3) THEN
    ! ALPHA AS A FUNCTION OF DOWNDRAFT ACTIVITY.
      PALF(JLON,JBLK)=YRPHY0%GALMIN+(YRPHY0%GALMAX-YRPHY0%GALMIN) &
      & *MAX(0._JPRB,MIN(1._JPRB,ZKEDD(JLON,JBLK)/7500._JPRB))

      ! LIMITATION OF ALPHA IN STRATOCUMULUS CONTEXT: WHERE TKE AND CLOUD DEPTH ARE SMALL.
      ZBINTKE=MAX(0._JPRB,SIGN(1._JPRB,0.3_JPRB-PTKE(JLON,KLEV,JBLK)))
      ZBINDEPTH=MAX(0._JPRB,SIGN(1._JPRB,800._JPRB-ZDEPTH(JLON,JBLK)))
      PALF(JLON,JBLK)=PALF(JLON,JBLK)*(1._JPRB-ZBINTKE*ZBINDEPTH)

      ! TAU COMPUTED HERE FOR DIAGNOSTIC PURPOSE ONLY.
      ZTAU(JLON,JBLK)=ZS15(JLON,JBLK)/MAX(ZEPS16,ZS16(JLON,JBLK))/MAX(0.001_JPRB,PALF(JLON,JBLK))

    ELSEIF(YRPHY0%NCVCLOS == 4) THEN
      ! PALF is prognostic.
      ZTALF_SCE(JLON,JBLK)=PALF(JLON,JBLK)*YRPHY0%GMUKEDD*ZKEDD(JLON,JBLK)
      ZTALF_SIN(JLON,JBLK)=-PALF(JLON,JBLK)*YRPHY0%GALTAU
      PALF(JLON,JBLK)=MAX(YRPHY0%GALMIN,MIN(YRPHY0%GALMAX*ZRH(JLON,JBLK),PALF(JLON,JBLK)&
                     &+YRPHY2%TSPHY*(ZTALF_SCE(JLON,JBLK)+ZTALF_SIN(JLON,JBLK))))
    ELSEIF(YRPHY0%NCVCLOS == 5) THEN
      ! CVGQ closure.
      PALF(JLON,JBLK)=ZALF_CVGQ(JLON,JBLK)
    ELSEIF(YRPHY0%NCVCLOS == 6) THEN
      ! CAPE and CVGQ mixed closure.
      ! 1. ALPHA DIAGNOSED FROM d(CAPE)/dt=-CAPE/TAU.
      PALF(JLON,JBLK)=ZS15(JLON,JBLK)/MAX(ZEPS16,ZS16(JLON,JBLK))&
        & *MAX(0.0_JPRB,SIGN(1.0_JPRB,(ZS16(JLON,JBLK)-ZEPS16)))&
        & /MAX(ZTAU(JLON,JBLK),ZEPS0)
      ! 2. One uses the max value between CAPE and CVGQ approaches.
      PALF(JLON,JBLK)=MIN(ZALFX(JLON,JBLK),MAX(PALF(JLON,JBLK),ZALF_CVGQ(JLON,JBLK)))
    ELSE
      ! Constant PALF.
      PALF(JLON,JBLK)=0.04_JPRB
    ENDIF

    ! FIRST TEST OF PHYSICAL VALIDITY OF THE OBTAINED PALF
    KNND(JLON,JBLK)=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-PALF(JLON,JBLK)+0.0_JPRB)))
  
  ENDDO
  ENDDO


  ! DOWNDROUGHTS GYT2011
  IF (YRPHY0%LGDDD .AND. .NOT.YRPHY0%LCVNHD) THEN
    ! Diagnostic downdrafts.
    CALL ACMTDDD( KIDIA,KFDIA,KGPBLKS,KLON,ITOP,KLEV,KTRA,&
      &INCDN,KNLAB,&
      &PALPH,PAPHIF,PAPRS,PAPRSF,&
      &PDELP,PLH,PLNPR,PQ,PQLIC,PQLIS,PQSAT,PQW,&
      &PR,ZT,PTW,PU,PV,PTRA,ILEVTEN,&
      &ZBETD,ZDEL_ORGD,ZEPS_ORGD,ZFORD,ZQDND,ZQN2D,ZSDND,ZSN2D,ZTN2D,&
      &ZUMD,ZVMD,ZTRAMD,ZBCC_CD_FULL,&
      &INLABD)
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV
      
       PDDAL(JLON,JLEV,JBLK)=PALF(JLON,JBLK)*INLABD(JLON,JLEV,JBLK)*PALF(JLON,JBLK)/YRPHY0%FEVAPC
       PDDOM(JLON,JLEV,JBLK)=0.5_JPRB*(ZFORD(JLON,JLEV,JBLK)+ZFORD(JLON,JLEV-1,JBLK))
      
    ENDDO
    ENDDO
    ENDDO

  ELSEIF (YRPHY0%LCVNHD) THEN
    ! Prognostic downdraft.
    ! A call to the diagnostic downdrafts is done, only to get the profile of dry
    ! static energy and water vapour.
    CALL ACMTDDD( KIDIA,KFDIA,KGPBLKS,KLON,ITOP,KLEV,KTRA,&
      &INCDN,KNLAB,&
      &PALPH,PAPHIF,PAPRS,PAPRSF,&
      &PDELP,PLH,PLNPR,PQ,PQLIC,PQLIS,PQSAT,PQW,&
      &PR,ZT,PTW,PU,PV,PTRA,ILEVTEN,&
      &ZBETD,ZDEL_ORGD,ZEPS_ORGD,ZFORD,ZQDND,ZQN2D,ZSDND,ZSN2D,ZTN2D,&
      &ZUMD,ZVMD,ZTRAMD,ZBCC_CD_FULL,&
      &INLABD)
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV = 1, KLEV
    
    PDDOM(JLON,JLEV,JBLK) = 0._JPRB
    
    ENDDO
    ENDDO
    ENDDO


    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV
      
       PDDOM(JLON,JLEV,JBLK)=-PAPRSF(JLON,JLEV,JBLK)*RG/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))*ZWD(JLON,JLEV,JBLK)
      
    ENDDO
    ENDDO
    ENDDO

  ELSE
    ! No downdrafts.
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV
      
       PDDAL(JLON,JLEV,JBLK)=0._JPRB
       PDDOM(JLON,JLEV,JBLK)=0._JPRB
      
    ENDDO
    ENDDO
    ENDDO

  ENDIF

  ! ------------------------------------------------------------
  ! // ADAPT THE MESH FRACTION PROFILE AND TENDENCY
  ! // AND COMPUTE MASS FLUX AT THE INTERFACE LEVELS
  ! ------------------------------------------------------------

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ITOP,KLEV
    
      KNLAB(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*KNLAB(JLON,JLEV,JBLK)
      INBAS(JLON,JLEV,JBLK)=INBAS(JLON,JLEV,JBLK)*KNND(JLON,JBLK)
      PUDAL(JLON,JLEV,JBLK)=PALF(JLON,JBLK)*0.5_JPRB*(ZSIGMA(JLON,JLEV,JBLK)+ZSIGMA(JLON,JLEV-1,JBLK))*KNLAB(JLON,JLEV,JBLK)
      IF(YRPHY0%LCVNHD) PDDAL(JLON,JLEV,JBLK)=YRPHY0%GUDDD*PUDAL(JLON,JLEV,JBLK)
      ICDN(JLON,JBLK)=MAX(0,-ISIGN(1,-INCDN(JLON,JLEV,JBLK)))
      PQLIC(JLON,JLEV,JBLK)=PQLIC(JLON,JLEV,JBLK)*KNLAB(JLON,JLEV,JBLK)
      PNEBC(JLON,JLEV,JBLK)=MAX(ZEPS0,ICDN(JLON,JBLK)*PALF(JLON,JBLK)&
       &*0.5_JPRB*(ZSIGMA(JLON,JLEV,JBLK)+ZSIGMA(JLON,JLEV-1,JBLK))*KNLAB(JLON,JLEV,JBLK))
    
  ENDDO
  ENDDO
  ENDDO


  ! ------------------------------------------------------------
  ! // PROTECTION AGAINST NL INSTABILITY
  ! // AND COMPUTE THE ENVIRONMENT VALUES AFFECTED Y PSEUDO-SUBSIDENCE
  ! ------------------------------------------------------------
  ! ADITIONAL VERTICAL LOOP (UPWARDS) TO MODIFY THE PREVIOUSLY
  ! COMPUTED MASS FLUX.


  ! ZFORM HAS BEEN COMPLETELY INITIALIZED TO ZERO EARLIER, SO IT IS ZERO
  ! ABOVE ITOP (AND NORMALLY ALSO AT KLEV - BUT SEE VIB...)

  ! cdir unroll=8
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KLEV-1,ITOP,-1
    

      !     NORMALISATION DE "ZFORM" A LA DIMENSION D'UNE PRESSION.
      !     NORMALIZATION OF "ZFORM" TO PRESSURE DIMENSION.
      ZFORU(JLON,JLEV,JBLK)=PALF(JLON,JBLK)*YRPHY2%TSPHY*ZFORM(JLON,JLEV,JBLK)
      ZFORM(JLON,JLEV,JBLK)=MAX(0.0_JPRB,ZFORM(JLON,JLEV,JBLK)-PALF(JLON,JBLK)/YRPHY0%FEVAPC&
        & *ZFORD(JLON,JLEV,JBLK))
      ZFORM(JLON,JLEV,JBLK)=PALF(JLON,JBLK)*YRPHY2%TSPHY*ZFORM(JLON,JLEV,JBLK)
      ZFORD(JLON,JLEV,JBLK)=PALF(JLON,JBLK)*YRPHY2%TSPHY*PALF(JLON,JBLK)/YRPHY0%FEVAPC*ZFORD(JLON,JLEV,JBLK)
    
  ENDDO
  ENDDO
  ENDDO


  IF (YRPHY0%LGPRONI1) THEN
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=KLEV-1,ITOP,-1
            

      ! PROTECTION AGAINST NON-LINEAR INSTABILITY THAT CAN OCCASIONALLY
      ! APPEAR DESPITE THE IMPLICIT ALGORITHM.
      ZFORM(JLON,JLEV,JBLK)=MAX(0.0_JPRB,ZFORM(JLON,JLEV+1,JBLK)+(ZFORM(JLON,JLEV,JBLK)&
        &-ZFORM(JLON,JLEV+1,JBLK))/(1.0_JPRB+PRDELP(JLON,JLEV+1,JBLK)&
        &*MAX(0.0_JPRB,ZFORM(JLON,JLEV,JBLK)-ZFORM(JLON,JLEV+1,JBLK))))
      ZFORU(JLON,JLEV,JBLK)=MAX(0.0_JPRB,ZFORU(JLON,JLEV+1,JBLK)+(ZFORU(JLON,JLEV,JBLK)&
        &-ZFORU(JLON,JLEV+1,JBLK))/(1.0_JPRB+PRDELP(JLON,JLEV+1,JBLK)&
        &*MAX(0.0_JPRB,ZFORU(JLON,JLEV,JBLK)-ZFORU(JLON,JLEV+1,JBLK))))
      
    ENDDO
    ENDDO
    ENDDO

    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV-1
      
      ! PROTECTION AGAINST NON-LINEAR INSTABILITY THAT CAN OCCASIONALLY
      ! APPEAR DESPITE THE IMPLICIT ALGORITHM.
      ZFORD(JLON,JLEV,JBLK)=MAX(0.0_JPRB,ZFORD(JLON,JLEV-1,JBLK)+(ZFORD(JLON,JLEV,JBLK)&
         &-ZFORD(JLON,JLEV-1,JBLK))/(1.0_JPRB+PRDELP(JLON,JLEV,JBLK)&
         &*MAX(0.0_JPRB,ZFORD(JLON,JLEV,JBLK)-ZFORD(JLON,JLEV-1,JBLK))))
      
    ENDDO
    ENDDO
    ENDDO

  ENDIF  



  ! -----------------------------------------------------------------
  ! // WIND RELATED COMPUTATION INCLUDING THE ENTRAINMENT AND
  ! // PRESSURE GRADIENT TERM (KERSHAW & GREGORY SCHEME), CONSIDERING
  ! // THE ACTIVE LAYERS
  ! -----------------------------------------------------------------

  ! INITIALIZE WORK ARRAYS

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZUM(JLON,JLEV,JBLK) = 0.0_JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZVM(JLON,JLEV,JBLK) = 0.0_JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JTRA = 1, KTRA
  DO JLEV = 1, KLEV
  
  ZTRAM(JLON,JLEV,JTRA,JBLK) = 0.0_JPRB
  
  ENDDO
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZBET(JLON,JLEV,JBLK) = 0.0_JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZA13(JLON,JLEV,JBLK) = 0.0_JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV = 1, KLEV
  
  ZA14(JLON,JLEV,JBLK) = 0.0_JPRB
  
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JTRA = 1, KTRA
  DO JLEV = 1, KLEV
  
  ZA15(JLON,JLEV,JTRA,JBLK) = 0.0_JPRB
  
  ENDDO
  ENDDO
  ENDDO
  ENDDO



  ! -------------------------------------------------------------------
  ! // UPWARDS LOOP FOR MOMENTUM ARRAYS (VERTICAL INTEGRALS)
  ! ZA13, ZA14(JLON,JLEV), ZBET, ZUM, ZVM(JLON,JLEV).

  ! TEMPORAIRES 1D.

  ! ZBET      : BETA COEFFICIENT FOR MOMENTUM PROFILE.

  ! TEMPORAIRE 0D.

  ! TEMPORAIRES 2D.

  ! ZA13      : UC0.
  ! ZA14      : VC0.
  ! ZA15      : TRA0.
  ! ZUM       : AVERAGE U VALUE FROM CLOUD BASE.
  ! ZVM       : AVERAGE V VALUE FROM CLOUD BASE.
  ! ZTRAM     : AVERAGE TRACER VALUE FROM CLOUD BASE.

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  

    ! AT BASE: ZBE=1, ZUM=PU, ZVM=PV, ZA13=PU, ZA14=PV
    ! INACTIVE LAYERS AND BASE => ZUM=PU, ZVM=PV

    ZBET(JLON,KLEV,JBLK)=1.0_JPRB
    ZUM(JLON,KLEV,JBLK)=PU(JLON,KLEV,JBLK)
    ZVM(JLON,KLEV,JBLK)=PV(JLON,KLEV,JBLK)

    DO JTRA=1,KTRA
      ZTRAM(JLON,KLEV,JTRA,JBLK) = PTRA(JLON,KLEV,JTRA,JBLK)
    ENDDO
    ! CLOUD BASE VELOCITY=MEAN GRID BOX VELOCITY

    ZA13(JLON,KLEV,JBLK)=PU(JLON,KLEV,JBLK)
    ZA14(JLON,KLEV,JBLK)=PV(JLON,KLEV,JBLK)
  
    DO JTRA=1,KTRA
      ZA15(JLON,KLEV,JTRA,JBLK)=PTRA(JLON,KLEV,JTRA,JBLK)
    ENDDO
    
  
  ENDDO
  ENDDO


  ! cdir unroll=4
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KLEV-1,ITOP,-1
    

      ! ZNBA=1 WHERE ACTIVE AND NOT BASE
      ! ZBAS=1  AT BASE (AND THEN ACTIVE)
      ! BOTH ARE 0 IN INACTIVE LAYERS
      ZBAS=REAL(INBAS(JLON,JLEV,JBLK),JPRB)
      ZNBA=REAL(1-INBAS(JLON,JLEV,JBLK),JPRB)*KNLAB(JLON,JLEV,JBLK)

      ! ZBET, ZUM, ZVM VALUES ARE USED ONLY IN ACTIVE LAYERS.
      ! ZBET IS 0 IN INACTIVE LAYERS
      ! 1 IN THE BASE LAYERS
      ! DECREASE UPWARDS IN THE ACTIVE LAYERS
      ! ZUM = PU IN INACTIVE LAYERS
      ! ZVM = PV IN INACTIVE LAYERS
      ! AND BOTH ARE ACCUMULATED IN ACTIVE LAYERS


      ZMIX=ZRMIX(JLON,JLEV,JBLK)
      ZBET(JLON,JLEV,JBLK)= ZNBA*ZBET(JLON,JLEV+1,JBLK)*(1.0_JPRB-ZMIX)+ZBAS

      ! ZUM BACK TO PU IF  KNLAB=0 OR INBAS=1
      ZUM(JLON,JLEV,JBLK)=(ZUM(JLON,JLEV+1,JBLK)&
         &+(ZMIX*(PU(JLON,JLEV+1,JBLK)-ZUM(JLON,JLEV+1,JBLK))&
         &+YRPHY0%TUDGP*(PU(JLON,JLEV,JBLK)-PU(JLON,JLEV+1,JBLK)))&
         &/ (1.0_JPRB-ZBET(JLON,JLEV,JBLK)+ZBAS) )*ZNBA &
         &+PU(JLON,JLEV,JBLK)*(1.0_JPRB-ZNBA)
      ZVM(JLON,JLEV,JBLK)=(ZVM(JLON,JLEV+1,JBLK)&
         &+(ZMIX*(PV(JLON,JLEV+1,JBLK)-ZVM(JLON,JLEV+1,JBLK))&
         &+YRPHY0%TUDGP*(PV(JLON,JLEV,JBLK)-PV(JLON,JLEV+1,JBLK)))&
         &/ (1.0_JPRB-ZBET(JLON,JLEV,JBLK)+ZBAS) )*ZNBA &
         &+PV(JLON,JLEV,JBLK)*(1.0_JPRB-ZNBA)
      DO JTRA=1,KTRA
        ZTRAM(JLON,JLEV,JTRA,JBLK) = (ZTRAM(JLON,JLEV+1,JTRA,JBLK)&
         &+(ZMIX*(PTRA(JLON,JLEV+1,JTRA,JBLK)-ZTRAM(JLON,JLEV+1,JTRA,JBLK))&
         &+YRPHY0%TUDGP*(PTRA(JLON,JLEV,JTRA,JBLK)-PTRA(JLON,JLEV+1,JTRA,JBLK)))&
         &/ (1.0_JPRB-ZBET(JLON,JLEV,JBLK)+ZBAS) )*ZNBA &
         &+PTRA(JLON,JLEV,JTRA,JBLK)*(1.0_JPRB-ZNBA)
      ENDDO

      ! CLOUD BASE VELOCITY=MEAN GRID BOX VELOCITY

      ! ZA13,ZA14 : WIND AT BASE OF ACTIVE SEGMENT
      ! SAME VALUE UP TO NEXT BASE
      ! (IN INACTIVE LAYERS, MULTIPLIED BY ZBET=0)

      ZA13(JLON,JLEV,JBLK)=ZA13(JLON,JLEV+1,JBLK)*ZNBA+PU(JLON,JLEV,JBLK)*ZBAS
      ZA14(JLON,JLEV,JBLK)=ZA14(JLON,JLEV+1,JBLK)*ZNBA+PV(JLON,JLEV,JBLK)*ZBAS
      
      DO JTRA=1,KTRA    
        ZA15(JLON,JLEV,JTRA,JBLK) = ZA15(JLON,JLEV+1,JTRA,JBLK)*ZNBA+PTRA(JLON,JLEV,JTRA,JBLK)*ZBAS      
      ENDDO

    
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ITOP,KLEV
    
       ZZ=1.0_JPRB-ZBET(JLON,JLEV,JBLK)
       ZUM(JLON,JLEV,JBLK)=ZZ*ZUM(JLON,JLEV,JBLK)+ZBET(JLON,JLEV,JBLK)*ZA13(JLON,JLEV,JBLK)
       ZVM(JLON,JLEV,JBLK)=ZZ*ZVM(JLON,JLEV,JBLK)+ZBET(JLON,JLEV,JBLK)*ZA14(JLON,JLEV,JBLK)
       DO JTRA=1,KTRA
         ZTRAM(JLON,JLEV,JTRA,JBLK)=ZZ*ZTRAM(JLON,JLEV,JTRA,JBLK)+ZBET(JLON,JLEV,JBLK)*ZA15(JLON,JLEV,JTRA,JBLK)           
       ENDDO
    
  ENDDO
  ENDDO
  ENDDO


  ! ------------------------------------------------------------------
  ! // FLUXES COMPUTATION

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
    ZBCC(JLON,ITOP,JBLK)=-PUDAL(JLON,ITOP,JBLK)*PUDOM(JLON,ITOP,JBLK)*ZBCC_C_FULL(JLON,ITOP,JBLK) &
                   &+PDDAL(JLON,ITOP,JBLK)*PDDOM(JLON,ITOP,JBLK)*ZBCC_CD_FULL(JLON,ITOP,JBLK)
    PFCCQL(JLON,ITOP,JBLK)=PFCCQL(JLON,ITOP-1,JBLK)-1._JPRB/RG*(1._JPRB-ZIFRAC(JLON,ITOP,JBLK)) &
      &*(-ZBCC(JLON,ITOP,JBLK))*PDELP(JLON,ITOP,JBLK)
    PFCCQI(JLON,ITOP,JBLK)=PFCCQI(JLON,ITOP-1,JBLK)-1._JPRB/RG*ZIFRAC(JLON,ITOP,JBLK) &
      &*(-ZBCC(JLON,ITOP,JBLK))*PDELP(JLON,ITOP,JBLK)
  
  ENDDO
  ENDDO


  ! cdir unroll=8
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ITOP+1,KLEV-1
    
      ZBCC(JLON,JLEV,JBLK)=-PUDAL(JLON,JLEV,JBLK)*PUDOM(JLON,JLEV,JBLK)*ZBCC_C_FULL(JLON,JLEV,JBLK) &
                     &+PDDAL(JLON,JLEV,JBLK)*PDDOM(JLON,JLEV,JBLK)*ZBCC_CD_FULL(JLON,JLEV,JBLK)
      PFCCQL(JLON,JLEV,JBLK)=PFCCQL(JLON,JLEV-1,JBLK)-1._JPRB/RG*(1._JPRB-ZIFRAC(JLON,JLEV,JBLK)) &
        &*(-ZBCC(JLON,JLEV,JBLK))*PDELP(JLON,JLEV,JBLK)
      PFCCQI(JLON,JLEV,JBLK)=PFCCQI(JLON,JLEV-1,JBLK)-1._JPRB/RG*ZIFRAC(JLON,JLEV,JBLK) &
        &*(-ZBCC(JLON,JLEV,JBLK))*PDELP(JLON,JLEV,JBLK)
    
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
    PFCCQL(JLON,KLEV,JBLK)=PFCCQL(JLON,KLEV-1,JBLK)
    PFCCQI(JLON,KLEV,JBLK)=PFCCQI(JLON,KLEV-1,JBLK)
  
  ENDDO
  ENDDO


  IF(YRPHY0%LCVUVM) THEN
    ! ---------------------------
    ! // CONVECTIVE TRANSPORT FLUXES
    ! ---------------------------
    ! COMPUTE ZUM AND ZVM AS UNIFORM, EQUAL TO THE MEAN VALUE ALONG CONVECTIVE LEVELS.
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV = 1, KLEV
    
    ZUM(JLON,JLEV,JBLK) = 0._JPRB
    
    ENDDO
    ENDDO
    ENDDO


    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV = 1, KLEV
    
    ZVM(JLON,JLEV,JBLK) = 0._JPRB
    
    ENDDO
    ENDDO
    ENDDO


    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    
    ZDENO(JLON,JBLK) = 0._JPRB
    
    ENDDO
    ENDDO


    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV
      
        ZBINID2(JLON,JLEV,JBLK)=MAX(0._JPRB,SIGN(1._JPRB,ZWU(JLON,JLEV,JBLK)-0.1_JPRB))
        ZINTE(JLON,JBLK)=ZBINID2(JLON,JLEV,JBLK)*PDELP(JLON,JLEV,JBLK)/RG
        ZUM(JLON,KLEV,JBLK)=ZUM(JLON,KLEV,JBLK)+PU(JLON,JLEV,JBLK)*ZINTE(JLON,JBLK)
        ZVM(JLON,KLEV,JBLK)=ZVM(JLON,KLEV,JBLK)+PV(JLON,JLEV,JBLK)*ZINTE(JLON,JBLK)
        ZDENO(JLON,JBLK)=ZDENO(JLON,JBLK)+ZINTE(JLON,JBLK)
      
    ENDDO
    ENDDO
    ENDDO

    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV
      
        ZUM(JLON,JLEV,JBLK)=ZBINID2(JLON,JLEV,JBLK)*ZUM(JLON,KLEV,JBLK)/MAX(100._JPRB,ZDENO(JLON,JBLK)) &
          &+(1._JPRB-ZBINID2(JLON,JLEV,JBLK))*PU(JLON,JLEV,JBLK)
        ZVM(JLON,JLEV,JBLK)=ZBINID2(JLON,JLEV,JBLK)*ZVM(JLON,KLEV,JBLK)/MAX(100._JPRB,ZDENO(JLON,JBLK)) &
          &+(1._JPRB-ZBINID2(JLON,JLEV,JBLK))*PV(JLON,JLEV,JBLK)
        DO JTRA=1,KTRA
          ZTRAM(JLON,JLEV,JTRA,JBLK)=ZBINID2(JLON,JLEV,JBLK)*ZTRAM(JLON,KLEV,JTRA,JBLK)/MAX(100._JPRB,ZDENO(JLON,JBLK)) &
            &+(1._JPRB-ZBINID2(JLON,JLEV,JBLK))*PTRA(JLON,JLEV,JTRA,JBLK)
        ENDDO
      
    ENDDO
    ENDDO
    ENDDO

  ENDIF

  IF(YRPHY0%LCVIMPT) THEN

    ! ---------------------------
    ! // CONVECTIVE TRANSPORT FLUXES: IMPLICIT COMPUTATION.
    ! ---------------------------

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ITOP,KLEV
     
        ! REPLACE THE UPDRAFT VALUES BY THE DIFFERENCE (PSI-PSI_U)
        ZQU(JLON,JLEV,JBLK)=(PQ(JLON,JLEV,JBLK)-PQU(JLON,JLEV,JBLK))
        ZSU(JLON,JLEV,JBLK)=(ZDSE(JLON,JLEV,JBLK)-ZSU(JLON,JLEV,JBLK))
        ZUM(JLON,JLEV,JBLK)=PU(JLON,JLEV,JBLK)-ZUM(JLON,JLEV,JBLK)
        ZVM(JLON,JLEV,JBLK)=PV(JLON,JLEV,JBLK)-ZVM(JLON,JLEV,JBLK)
          DO JTRA=1, KTRA
             ZTRAM(JLON,JLEV,JTRA,JBLK) = PTRA(JLON,JLEV,JTRA,JBLK) - ZTRAM(JLON,JLEV,JTRA,JBLK)
          ENDDO
          ! ABOVE ITOP: ALL FLUXES ARE ZERO
          ! LEVEL KLEV: ZFORM=0 THERE, HENCE ALL THE FLUXES ARE ZERO, TOO.
          ! ELSEWHERE WE NEED ZFORM >=0 - AVOID THE ROUNDING ERRORS
          ! REQUIRE AT LEAST THAT PDIFCQ<0
     
  ENDDO
  ENDDO
  ENDDO


    ! cdir unroll=8
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV-1
       
          ZAUX=ZFORU(JLON,JLEV,JBLK)/(PDELP(JLON,JLEV,JBLK)+ZFORU(JLON,JLEV,JBLK))
          ZDPSGDT=PDELP(JLON,JLEV,JBLK)*ZGDTI*0.5_JPRB
          PDIFCQ(JLON,JLEV,JBLK)=ZAUX*( PDIFCQ(JLON,JLEV-1,JBLK)+ &
             & ZDPSGDT*(ZQU(JLON,JLEV,JBLK)+ZQU(JLON,JLEV+1,JBLK)) )
          IF (YRPHY0%NCVENTR == 1) THEN
            PDIFCS(JLON,JLEV,JBLK)=ZAUX*( PDIFCS(JLON,JLEV-1,JBLK)+ &
               & ZDPSGDT*(ZSU(JLON,JLEV,JBLK)+ZSU(JLON,JLEV+1,JBLK)) )
          ELSE
            PDIFCS(JLON,JLEV,JBLK)=MIN(YRPHY0%GCVTRMIN,ZAUX*( PDIFCS(JLON,JLEV-1,JBLK)+ &
               & ZDPSGDT*(ZSU(JLON,JLEV,JBLK)+ZSU(JLON,JLEV+1,JBLK)) ))
          ENDIF
          PSTRCU(JLON,JLEV,JBLK)=ZAUX*( PSTRCU(JLON,JLEV-1,JBLK)+ &
             & ZDPSGDT*(ZUM(JLON,JLEV,JBLK)+ZUM(JLON,JLEV+1,JBLK)) )
          PSTRCV(JLON,JLEV,JBLK)=ZAUX*( PSTRCV(JLON,JLEV-1,JBLK)+ &
             & ZDPSGDT*(ZVM(JLON,JLEV,JBLK)+ZVM(JLON,JLEV+1,JBLK)) )
          DO JTRA=1, KTRA
            PSTRCTRA(JLON,JLEV,JTRA,JBLK)=ZAUX*( PSTRCTRA(JLON,JLEV-1,JTRA,JBLK)+ &
               & ZDPSGDT*(ZTRAM(JLON,JLEV,JTRA,JBLK)+ZTRAM(JLON,JLEV+1,JTRA,JBLK)) )
          ENDDO
       
    ENDDO
    ENDDO
    ENDDO


    IF (YRPHY0%LGDDD) THEN
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV
       
          ! replace the DOWNDRAFT values by the difference (psi-psi_d)
          ZQU(JLON,JLEV,JBLK)=(PQ(JLON,JLEV,JBLK)-ZQN2D(JLON,JLEV,JBLK))
          ZSU(JLON,JLEV,JBLK)=(ZDSE(JLON,JLEV,JBLK)-ZSN2D(JLON,JLEV,JBLK))
          ZUM(JLON,JLEV,JBLK)=(PU(JLON,JLEV,JBLK)-ZUMD(JLON,JLEV,JBLK))
          ZVM(JLON,JLEV,JBLK)=(PV(JLON,JLEV,JBLK)-ZVMD(JLON,JLEV,JBLK))
          DO JTRA=1, KTRA
             ZTRAM(JLON,JLEV,JTRA,JBLK)=(PTRA(JLON,JLEV,JTRA,JBLK)-ZTRAMD(JLON,JLEV,JTRA,JBLK))
          ENDDO
       
    ENDDO
    ENDDO
    ENDDO

    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=KLEV-1,ITOP,-1
       
          ZAUX=ZFORD(JLON,JLEV,JBLK)/(PDELP(JLON,JLEV+1,JBLK)+ZFORD(JLON,JLEV,JBLK))
          ZDPSGDT=PDELP(JLON,JLEV+1,JBLK)*ZGDTI*0.5_JPRB
          ZDIFCQD(JLON,JLEV,JBLK)=ZAUX*( ZDIFCQD(JLON,JLEV+1,JBLK)+ &
             & ZDPSGDT*(ZQU(JLON,JLEV,JBLK)+ZQU(JLON,JLEV+1,JBLK)) )
          IF (YRPHY0%NCVENTR == 1) THEN
            ZDIFCSD(JLON,JLEV,JBLK)=ZAUX*( ZDIFCSD(JLON,JLEV+1,JBLK)+ &
               & ZDPSGDT*(ZSU(JLON,JLEV,JBLK)+ZSU(JLON,JLEV+1,JBLK)) )
          ELSE
            ZDIFCSD(JLON,JLEV,JBLK)=MAX(-YRPHY0%GCVTRMIN,ZAUX*( ZDIFCSD(JLON,JLEV+1,JBLK)+ &
               & ZDPSGDT*(ZSU(JLON,JLEV,JBLK)+ZSU(JLON,JLEV+1,JBLK)) ))
          ENDIF
          ZSTRCUD(JLON,JLEV,JBLK)=ZAUX*( ZSTRCUD(JLON,JLEV+1,JBLK)+ &
             & ZDPSGDT*(ZUM(JLON,JLEV,JBLK)+ZUM(JLON,JLEV+1,JBLK)) )
          ZSTRCVD(JLON,JLEV,JBLK)=ZAUX*( ZSTRCVD(JLON,JLEV+1,JBLK)+ &
             & ZDPSGDT*(ZVM(JLON,JLEV,JBLK)+ZVM(JLON,JLEV+1,JBLK)) )
          DO JTRA=1,KTRA
            ZSTRCTRAD(JLON,JLEV,JTRA,JBLK)=ZAUX*( ZSTRCTRAD(JLON,JLEV+1,JTRA,JBLK)+ &
               & ZDPSGDT*(ZTRAM(JLON,JLEV,JTRA,JBLK)+ZTRAM(JLON,JLEV+1,JTRA,JBLK)) )
          ENDDO
       
    ENDDO
    ENDDO
    ENDDO


    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV-1
       
          ZDIFCQD(JLON,JLEV,JBLK)=-ZDIFCQD(JLON,JLEV,JBLK)
          PDIFCQ(JLON,JLEV,JBLK)=PDIFCQ(JLON,JLEV,JBLK)+ZDIFCQD(JLON,JLEV,JBLK)
          ZDIFCSD(JLON,JLEV,JBLK)=-ZDIFCSD(JLON,JLEV,JBLK)
          PDIFCS(JLON,JLEV,JBLK)=PDIFCS(JLON,JLEV,JBLK)+ZDIFCSD(JLON,JLEV,JBLK)
          ZSTRCUD(JLON,JLEV,JBLK)=-ZSTRCUD(JLON,JLEV,JBLK)
          PSTRCU(JLON,JLEV,JBLK)=PSTRCU(JLON,JLEV,JBLK)+ZSTRCUD(JLON,JLEV,JBLK)
          ZSTRCVD(JLON,JLEV,JBLK)=-ZSTRCVD(JLON,JLEV,JBLK)
          PSTRCV(JLON,JLEV,JBLK)=PSTRCV(JLON,JLEV,JBLK)+ZSTRCVD(JLON,JLEV,JBLK)
          DO JTRA=1,KTRA
            ZSTRCTRAD(JLON,JLEV,JTRA,JBLK)=-ZSTRCTRAD(JLON,JLEV,JTRA,JBLK)
            PSTRCTRA(JLON,JLEV,JTRA,JBLK)=PSTRCTRA(JLON,JLEV,JTRA,JBLK)+ZSTRCTRAD(JLON,JLEV,JTRA,JBLK)
          ENDDO
       
    ENDDO
    ENDDO
    ENDDO

    ENDIF  !LGDDD

  ELSE ! LCVIMPT.

    ! ---------------------------
    ! // CONVECTIVE TRANSPORT FLUXES: EXPLICIT COMPUTATION.
    ! ---------------------------

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ITOP,KLEV
     
        ! REPLACE THE UPDRAFT VALUES BY THE DIFFERENCE (PSI-PSI_U)
        ZQU(JLON,JLEV,JBLK)=(PQ(JLON,JLEV,JBLK)-PQU(JLON,JLEV,JBLK))
        ZSU(JLON,JLEV,JBLK)=(ZDSE(JLON,JLEV,JBLK)-ZSU(JLON,JLEV,JBLK))
        ZTU(JLON,JLEV,JBLK)=(ZT(JLON,JLEV,JBLK)-PTU(JLON,JLEV,JBLK))*(RATM/PAPRSF(JLON,JLEV,JBLK))**RKAPPA
        ZUM(JLON,JLEV,JBLK)=PU(JLON,JLEV,JBLK)-ZUM(JLON,JLEV,JBLK)
        ZVM(JLON,JLEV,JBLK)=PV(JLON,JLEV,JBLK)-ZVM(JLON,JLEV,JBLK)
          DO JTRA=1, KTRA
             ZTRAM(JLON,JLEV,JTRA,JBLK) = PTRA(JLON,JLEV,JTRA,JBLK) - ZTRAM(JLON,JLEV,JTRA,JBLK)
          ENDDO
     
  ENDDO
  ENDDO
  ENDDO


    ! cdir unroll=8
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV-1
       
          ZDIFCS_UD_NOCORR_DIAG(JLON,JLEV,JBLK)=ZGDTI*ZFORU(JLON,JLEV,JBLK) &
            &*0.5_JPRB*(ZSU(JLON,JLEV,JBLK)+ZSU(JLON,JLEV+1,JBLK))
          IF (YRPHY0%NPRONI == 1) THEN  
             ZAUX=ZFORU(JLON,JLEV,JBLK)/(1._JPRB+ZFORU(JLON,JLEV,JBLK)/PDELP(JLON,JLEV,JBLK))
          ELSEIF (YRPHY0%NPRONI == 2) THEN  
             ZAUX=MIN(ZFORU(JLON,JLEV,JBLK),YRPHY0%GPRONI*PDELP(JLON,JLEV,JBLK))
          ELSE   
             ZAUX=ZFORU(JLON,JLEV,JBLK)
          ENDIF   
          PDIFCQ(JLON,JLEV,JBLK)=ZGDTI*ZAUX*0.5_JPRB*(ZQU(JLON,JLEV,JBLK)+ZQU(JLON,JLEV+1,JBLK))
          PDIFCS(JLON,JLEV,JBLK)=ZGDTI*ZAUX*0.5_JPRB*(ZSU(JLON,JLEV,JBLK)+ZSU(JLON,JLEV+1,JBLK))
          PDIFCTH(JLON,JLEV,JBLK)=ZGDTI*ZAUX*0.5_JPRB*(ZTU(JLON,JLEV,JBLK)+ZTU(JLON,JLEV+1,JBLK))
          PSTRCU(JLON,JLEV,JBLK)=ZGDTI*ZAUX*0.5_JPRB*(ZUM(JLON,JLEV,JBLK)+ZUM(JLON,JLEV+1,JBLK))
          PSTRCV(JLON,JLEV,JBLK)=ZGDTI*ZAUX*0.5_JPRB*(ZVM(JLON,JLEV,JBLK)+ZVM(JLON,JLEV+1,JBLK))
          DO JTRA=1,KTRA
            PSTRCTRA(JLON,JLEV,JTRA,JBLK)=ZGDTI*ZAUX*0.5_JPRB*(ZTRAM(JLON,JLEV,JTRA,JBLK)+ZTRAM(JLON,JLEV+1,JTRA,JBLK))
          ENDDO
       
    ENDDO
    ENDDO
    ENDDO


    IF (YRPHY0%LGDDD) THEN
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV
       
          ! REPLACE THE DOWNDRAFT VALUES BY THE DIFFERENCE (PSI-PSI_D)
          ZQU(JLON,JLEV,JBLK)=(PQ(JLON,JLEV,JBLK)-ZQN2D(JLON,JLEV,JBLK))
          ZSU(JLON,JLEV,JBLK)=(ZDSE(JLON,JLEV,JBLK)-ZSN2D(JLON,JLEV,JBLK))
          ZTU(JLON,JLEV,JBLK)=(ZT(JLON,JLEV,JBLK)-ZTN2D(JLON,JLEV,JBLK))*(RATM/PAPRSF(JLON,JLEV,JBLK))**RKAPPA
          ZUM(JLON,JLEV,JBLK)=(PU(JLON,JLEV,JBLK)-ZUMD(JLON,JLEV,JBLK))
          ZVM(JLON,JLEV,JBLK)=(PV(JLON,JLEV,JBLK)-ZVMD(JLON,JLEV,JBLK))
          DO JTRA=1,KTRA
            ZTRAM(JLON,JLEV,JTRA,JBLK)=(PTRA(JLON,JLEV,JTRA,JBLK)-ZTRAMD(JLON,JLEV,JTRA,JBLK))
          ENDDO
       
    ENDDO
    ENDDO
    ENDDO

    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV-1
       
          ZDIFCS_DD_NOCORR_DIAG(JLON,JLEV,JBLK)=ZGDTI*ZFORD(JLON,JLEV,JBLK) &
            &*0.5_JPRB*(ZSU(JLON,JLEV,JBLK)+ZSU(JLON,JLEV+1,JBLK))
          IF (YRPHY0%NPRONI == 1) THEN  
            ZAUX=ZFORD(JLON,JLEV,JBLK)/(1._JPRB+ZFORD(JLON,JLEV,JBLK)/PDELP(JLON,JLEV,JBLK))
          ELSEIF (YRPHY0%NPRONI == 2) THEN  
            ZAUX=MIN(ZFORD(JLON,JLEV,JBLK),YRPHY0%GPRONI*PDELP(JLON,JLEV,JBLK))
          ELSE
            ZAUX=ZFORD(JLON,JLEV,JBLK)
          ENDIF   
          PDIFCQ(JLON,JLEV,JBLK)=PDIFCQ(JLON,JLEV,JBLK)-ZGDTI*ZAUX &
            &*0.5_JPRB*(ZQU(JLON,JLEV,JBLK)+ZQU(JLON,JLEV+1,JBLK))
          PDIFCS(JLON,JLEV,JBLK)=PDIFCS(JLON,JLEV,JBLK)-ZGDTI*ZAUX &
              &*0.5_JPRB*(ZSU(JLON,JLEV,JBLK)+ZSU(JLON,JLEV+1,JBLK))
          PDIFCTH(JLON,JLEV,JBLK)=PDIFCTH(JLON,JLEV,JBLK)-ZGDTI*ZAUX &
            &*0.5_JPRB*(ZTU(JLON,JLEV,JBLK)+ZTU(JLON,JLEV+1,JBLK))
          ZDIFCS_DD_DIAG(JLON,JLEV,JBLK)=-ZGDTI*ZAUX*0.5_JPRB*(ZSU(JLON,JLEV,JBLK)+ZSU(JLON,JLEV+1,JBLK))
          PSTRCU(JLON,JLEV,JBLK)=PSTRCU(JLON,JLEV,JBLK)-ZGDTI*ZAUX*0.5_JPRB*(ZUM(JLON,JLEV,JBLK)+ZUM(JLON,JLEV+1,JBLK))
          PSTRCV(JLON,JLEV,JBLK)=PSTRCV(JLON,JLEV,JBLK)-ZGDTI*ZAUX*0.5_JPRB*(ZVM(JLON,JLEV,JBLK)+ZVM(JLON,JLEV+1,JBLK))
          DO JTRA=1,KTRA
            PSTRCTRA(JLON,JLEV,JTRA,JBLK)= PSTRCTRA(JLON,JLEV,JTRA,JBLK) & 
              & -ZGDTI*ZAUX*0.5_JPRB*(ZTRAM(JLON,JLEV,JTRA,JBLK)+ZTRAM(JLON,JLEV+1,JTRA,JBLK))
          ENDDO
       
    ENDDO
    ENDDO
    ENDDO

    ENDIF  !LGDDD

  ENDIF ! LCVIMPT.

  ! // SETTING ALL RESULTS TO ZERO IN CASE OF NEGATIVE PRECIPITATIONS AT
  ! // THE SURFACE OR OF "KNND" ALREADY ZERO.

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
    ZZVAL=PFCCQL(JLON,KLEV,JBLK)+PFCCQI(JLON,KLEV,JBLK)-YRPHY0%SCO
    KNND(JLON,JBLK)=KNND(JLON,JBLK)*MAX(0.0_JPRB,-SIGN(1.0_JPRB,-ZZVAL))
  
  ENDDO
  ENDDO


  IF(YRPHY0%LCVNAUV) THEN
    ! RECOMPUTE PSTRCU AND PSTRCV FROM AN IDEA INSPIRED BY FRANCOIS BOUYSSEL (2012-08-01) AND 3MT.
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    
     ZNND(JLON,JBLK)=1.0_JPRB-REAL(KNLAB(JLON,KLEV,JBLK))
     ZI1(JLON,KLEV,JBLK)=REAL(KNLAB(JLON,KLEV,JBLK))
     ZUM(JLON,KLEV,JBLK)=PU(JLON,KLEV,JBLK)
     ZVM(JLON,KLEV,JBLK)=PV(JLON,KLEV,JBLK)
     ZBET(JLON,KLEV,JBLK)=REAL(KNLAB(JLON,KLEV,JBLK))
     ZA13(JLON,KLEV,JBLK)=PU(JLON,KLEV,JBLK)
     ZA14(JLON,KLEV,JBLK)=PV(JLON,KLEV,JBLK)
     DO JTRA=1,KTRA
       ZTRAM(JLON,KLEV,JTRA,JBLK)=PTRA(JLON,KLEV,JTRA,JBLK)
       ZA15(JLON,KLEV,JTRA,JBLK)=PTRA(JLON,KLEV,JTRA,JBLK)
     ENDDO
    
    ENDDO
    ENDDO

    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=KLEV-1,ITOP,-1
     
      ZI1(JLON,JLEV,JBLK)=REAL(KNLAB(JLON,JLEV,JBLK)*ZNND(JLON,JBLK))
      ZNND(JLON,JBLK)=MIN(ZNND(JLON,JBLK),1.0_JPRB-REAL(KNLAB(JLON,JLEV,JBLK)))
      ZBAS=REAL(KNLAB(JLON,JLEV,JBLK)*(1.0_JPRB-REAL(KNLAB(JLON,JLEV+1,JBLK))),JPRB)
      ZNBA=REAL(KNLAB(JLON,JLEV,JBLK)*KNLAB(JLON,JLEV+1,JBLK),JPRB)
      ZMIX=ZRMIX(JLON,JLEV,JBLK)
      ZBET(JLON,JLEV,JBLK)= ZNBA*ZBET(JLON,JLEV+1,JBLK)*(1.0_JPRB-ZMIX)+ZBAS
      ZUM(JLON,JLEV,JBLK)=(ZUM(JLON,JLEV+1,JBLK)&
       &+(ZMIX*(PU(JLON,JLEV+1,JBLK)-ZUM(JLON,JLEV+1,JBLK))&
       &+YRPHY0%TUDGP*(PU(JLON,JLEV,JBLK)-PU(JLON,JLEV+1,JBLK)))&
       &/ (1.0_JPRB-ZBET(JLON,JLEV,JBLK)+ZBAS) )*ZNBA &
       &+PU(JLON,JLEV,JBLK)*(1.0_JPRB-ZNBA)
      ZVM(JLON,JLEV,JBLK)=(ZVM(JLON,JLEV+1,JBLK)&
       &+(ZMIX*(PV(JLON,JLEV+1,JBLK)-ZVM(JLON,JLEV+1,JBLK))&
       &+YRPHY0%TUDGP*(PV(JLON,JLEV,JBLK)-PV(JLON,JLEV+1,JBLK)))&
       &/ (1.0_JPRB-ZBET(JLON,JLEV,JBLK)+ZBAS) )*ZNBA &
       &+PV(JLON,JLEV,JBLK)*(1.0_JPRB-ZNBA)
      ZA13(JLON,JLEV,JBLK)=ZA13(JLON,JLEV+1,JBLK)*ZNBA+PU(JLON,JLEV,JBLK)*ZBAS
      ZA14(JLON,JLEV,JBLK)=ZA14(JLON,JLEV+1,JBLK)*ZNBA+PV(JLON,JLEV,JBLK)*ZBAS
      DO JTRA=1,KTRA
        ZTRAM(JLON,JLEV,JTRA,JBLK)=(ZTRAM(JLON,JLEV+1,JTRA,JBLK)&
         &+(ZMIX*(PTRA(JLON,JLEV+1,JTRA,JBLK)-ZTRAM(JLON,JLEV+1,JTRA,JBLK))&
         &+YRPHY0%TUDGP*(PTRA(JLON,JLEV,JTRA,JBLK)-PTRA(JLON,JLEV+1,JTRA,JBLK)))&
         &/ (1.0_JPRB-ZBET(JLON,JLEV,JBLK)+ZBAS) )*ZNBA &
         &+PTRA(JLON,JLEV,JTRA,JBLK)*(1.0_JPRB-ZNBA)
        ZA15(JLON,JLEV,JTRA,JBLK)=ZA15(JLON,JLEV+1,JTRA,JBLK)*ZNBA+PTRA(JLON,JLEV,JTRA,JBLK)*ZBAS
      ENDDO
     
    ENDDO
    ENDDO
    ENDDO

    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV
     
      ZZ=1.0_JPRB-ZBET(JLON,JLEV,JBLK)
      ZUM(JLON,JLEV,JBLK)=ZZ*ZUM(JLON,JLEV,JBLK)+ZBET(JLON,JLEV,JBLK)*ZA13(JLON,JLEV,JBLK)
      ZVM(JLON,JLEV,JBLK)=ZZ*ZVM(JLON,JLEV,JBLK)+ZBET(JLON,JLEV,JBLK)*ZA14(JLON,JLEV,JBLK)
      ZUM(JLON,JLEV,JBLK)=PU(JLON,JLEV,JBLK)-ZUM(JLON,JLEV,JBLK)
      ZVM(JLON,JLEV,JBLK)=PV(JLON,JLEV,JBLK)-ZVM(JLON,JLEV,JBLK)
      DO JTRA=1,KTRA
        ZTRAM(JLON,JLEV,JTRA,JBLK)=ZZ*ZTRAM(JLON,JLEV,JTRA,JBLK)+ZBET(JLON,JLEV,JBLK)*ZA15(JLON,JLEV,JTRA,JBLK)
        ZTRAM(JLON,JLEV,JTRA,JBLK)=PTRA(JLON,JLEV,JTRA,JBLK)-ZTRAM(JLON,JLEV,JTRA,JBLK)
      ENDDO
     
    ENDDO
    ENDDO
    ENDDO

    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    
    ZNND(JLON,JBLK) = 1.0_JPRB
    
    ENDDO
    ENDDO


    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV = 0, KLEV
    
    PSTRCU(JLON,JLEV,JBLK) = 0._JPRB
    
    ENDDO
    ENDDO
    ENDDO


    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV = 0, KLEV
    
    PSTRCV(JLON,JLEV,JBLK) = 0._JPRB
    
    ENDDO
    ENDDO
    ENDDO


    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JTRA = 1, KTRA
    DO JLEV = 0, KLEV
    
    PSTRCTRA(JLON,JLEV,JTRA,JBLK) = 0._JPRB
    
    ENDDO
    ENDDO
    ENDDO
    ENDDO


    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    DO JLEV=ITOP,KLEV-1
     
      ZNND(JLON,JBLK) = MIN(ZNND(JLON,JBLK),1.0_JPRB-ZI1(JLON,JLEV,JBLK))
      ZZ=(PAPRS(JLON,KLEV,JBLK)-PAPRS(JLON,JLEV,JBLK)) &
      & /(PAPRS(JLON,KLEV,JBLK)-PAPRS(JLON,JLEV-1,JBLK))
      ZAUX=YRPHY0%TVFC*ZFORM(JLON,JLEV,JBLK)/(PDELP(JLON,JLEV,JBLK)+YRPHY0%TVFC*ZFORM(JLON,JLEV,JBLK))
      ZDPSGDT=PDELP(JLON,JLEV,JBLK)*ZGDTI*0.5_JPRB
      PSTRCU(JLON,JLEV,JBLK)=ZNND(JLON,JBLK)*ZAUX*( PSTRCU(JLON,JLEV-1,JBLK)+ &
       & ZDPSGDT*(ZUM(JLON,JLEV,JBLK)+ZUM(JLON,JLEV+1,JBLK)) )+ &
       & (1.0_JPRB-ZNND(JLON,JBLK))*PSTRCU(JLON,JLEV-1,JBLK)*ZZ
      PSTRCV(JLON,JLEV,JBLK)=ZNND(JLON,JBLK)*ZAUX*( PSTRCV(JLON,JLEV-1,JBLK)+ &
       & ZDPSGDT*(ZVM(JLON,JLEV,JBLK)+ZVM(JLON,JLEV+1,JBLK)) )+ &
       & (1.0_JPRB-ZNND(JLON,JBLK))*PSTRCV(JLON,JLEV-1,JBLK)*ZZ
      DO JTRA=1,KTRA
        PSTRCTRA(JLON,JLEV,JTRA,JBLK)=ZNND(JLON,JBLK)*ZAUX*( PSTRCTRA(JLON,JLEV-1,JTRA,JBLK)+ &
         & ZDPSGDT*(ZTRAM(JLON,JLEV,JTRA,JBLK)+ZTRAM(JLON,JLEV+1,JTRA,JBLK)) )+ &
         & (1.0_JPRB-ZNND(JLON,JBLK))*PSTRCTRA(JLON,JLEV-1,JTRA,JBLK)*ZZ
      ENDDO
     
    ENDDO
    ENDDO
    ENDDO

  ENDIF

  ! ------------------------------------------------------------------
  ! BEFORE LEAVING
  ! - LEAVE IN PUDOM THE RELATIVE UPDRAFT VELOCITY FOR ADVECTION
  ! - RESET ALL FLUXES TO ZERO WHERE KNND IS
  ! AND ALSO RESET PUDOM AND PUDAL
  ! ------------------------------------------------------------------

  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ITOP,KLEV
    
      PFPLCL(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PFPLCL(JLON,JLEV,JBLK)
      PFPLCN(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PFPLCN(JLON,JLEV,JBLK)
      PDIFCQ(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PDIFCQ(JLON,JLEV,JBLK)
      PDIFCQL(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PDIFCQL(JLON,JLEV,JBLK)
      PDIFCQI(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PDIFCQI(JLON,JLEV,JBLK)
      PDIFCS(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PDIFCS(JLON,JLEV,JBLK)
      PDIFCTH(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PDIFCTH(JLON,JLEV,JBLK)
      PSTRCU(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PSTRCU(JLON,JLEV,JBLK)
      PSTRCV(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PSTRCV(JLON,JLEV,JBLK)
      PFCCQL(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PFCCQL(JLON,JLEV,JBLK)
      PFCCQI(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PFCCQI(JLON,JLEV,JBLK)
      PFPEVPCL(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PFPEVPCL(JLON,JLEV,JBLK)
      PFPEVPCN(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PFPEVPCN(JLON,JLEV,JBLK)
      PFHEVPP(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PFHEVPP(JLON,JLEV,JBLK)
      PFHMLTS(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PFHMLTS(JLON,JLEV,JBLK)
      DO JTRA=1,KTRA
        PSTRCTRA(JLON,JLEV,JTRA,JBLK)=KNND(JLON,JBLK)*PSTRCTRA(JLON,JLEV,JTRA,JBLK)
      ENDDO
    
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KTDIA,KLEV
    
      KNLAB(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*KNLAB(JLON,JLEV,JBLK)
      PQLIC(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PQLIC(JLON,JLEV,JBLK)*YRPHY0%FQLIC*PNEBC(JLON,JLEV,JBLK)*KNLAB(JLON,JLEV,JBLK)
      PNEBC(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*MAX(ZEPS0,MIN(ZNEBCX,PNEBC(JLON,JLEV,JBLK)*YRPHY0%FNEBC&
      &*NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-PQLIC(JLON,JLEV,JBLK)+0.0_JPRB)))))
    
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ITOP,KLEV
!DEC$ IVDEP
    
      PUDAL(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PUDAL(JLON,JLEV,JBLK)
      PDDAL(JLON,JLEV,JBLK)=KNND(JLON,JBLK)*PDDAL(JLON,JLEV,JBLK)

      IF(.NOT.YRPHY0%LCVNHD) THEN
      ! VERTICAL VELOCITY IN M/S COMPUTED FROM VERTICAL VELOCITY IN PA/S.
        ZWU(JLON,JLEV,JBLK)=-PUDOM(JLON,JLEV,JBLK)*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/(PAPRSF(JLON,JLEV,JBLK)*RG)
        ZWD(JLON,JLEV,JBLK)=-PDDOM(JLON,JLEV,JBLK)*PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK)/(PAPRSF(JLON,JLEV,JBLK)*RG)
      ENDIF

      IQLIC(JLON,JBLK)=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-PQLIC(JLON,JLEV,JBLK)+0.0_JPRB)))
      ! ENTRAINMENT/DETRAINMENT (IN S**-1).
      PENTR_U(JLON,JLEV,JBLK)=ZWU(JLON,JLEV,JBLK)*PUDAL(JLON,JLEV,JBLK)*ZEPSILON_U(JLON,JLEV,JBLK)*IQLIC(JLON,JBLK)
      PDETR_U(JLON,JLEV,JBLK)=KNLAB(JLON,JLEV,JBLK)*ZWU(JLON,JLEV,JBLK)*PUDAL(JLON,JLEV,JBLK)*ZDELTA_U(JLON,JLEV,JBLK) &
         &+(1-KNLAB(JLON,JLEV,JBLK))*YRPHY0%GCVENTR_MIN
      PENTR_D(JLON,JLEV,JBLK)=-ZWD(JLON,JLEV,JBLK)*PDDAL(JLON,JLEV,JBLK) &
         &*(ZEPS_ORGD(JLON,JLEV,JBLK)*PAPRSF(JLON,JLEV,JBLK) &
         &/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))+ZENTRX)*RG*IQLIC(JLON,JBLK)*YRPHY0%GCVFRR
      PDETR_D(JLON,JLEV,JBLK)=-ZWD(JLON,JLEV,JBLK)*PDDAL(JLON,JLEV,JBLK) &
         &*(ZDEL_ORGD(JLON,JLEV,JBLK)*PAPRSF(JLON,JLEV,JBLK)/(PR(JLON,JLEV,JBLK)*ZT(JLON,JLEV,JBLK))+ZENTRX)*RG*YRPHY0%GCVFRR
    
  ENDDO
  ENDDO
  ENDDO


  ! -------------------------------------------------
  ! NUMERICAL VERTICAL FILTER OF TRANSPORT FLUXES
  ! TO AVOID 2-VERTICAL-LEVELS INSTABILITY.
  ! -------------------------------------------------

  ZA=0.5_JPRB
  ZA2=ZA*0.5_JPRB
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=KLEV-1,ITOP,-1
    
       PDIFCQ(JLON,JLEV,JBLK)=(1._JPRB-ZA)*PDIFCQ(JLON,JLEV,JBLK)+ZA2*(PDIFCQ(JLON,JLEV-1,JBLK)+PDIFCQ(JLON,JLEV+1,JBLK))
       PDIFCQI(JLON,JLEV,JBLK)=(1._JPRB-ZA)*PDIFCQI(JLON,JLEV,JBLK)+ZA2*(PDIFCQI(JLON,JLEV-1,JBLK)+PDIFCQI(JLON,JLEV+1,JBLK))
       PDIFCQL(JLON,JLEV,JBLK)=(1._JPRB-ZA)*PDIFCQL(JLON,JLEV,JBLK)+ZA2*(PDIFCQL(JLON,JLEV-1,JBLK)+PDIFCQL(JLON,JLEV+1,JBLK))
       PDIFCS(JLON,JLEV,JBLK)=(1._JPRB-ZA)*PDIFCS(JLON,JLEV,JBLK)+ZA2*(PDIFCS(JLON,JLEV-1,JBLK)+PDIFCS(JLON,JLEV+1,JBLK))
       PDIFCTH(JLON,JLEV,JBLK)=(1._JPRB-ZA)*PDIFCTH(JLON,JLEV,JBLK)+ZA2*(PDIFCTH(JLON,JLEV-1,JBLK)+PDIFCTH(JLON,JLEV+1,JBLK))
       PSTRCU(JLON,JLEV,JBLK)=(1._JPRB-ZA)*PSTRCU(JLON,JLEV,JBLK)+ZA2*(PSTRCU(JLON,JLEV-1,JBLK)+PSTRCU(JLON,JLEV+1,JBLK))
       PSTRCV(JLON,JLEV,JBLK)=(1._JPRB-ZA)*PSTRCV(JLON,JLEV,JBLK)+ZA2*(PSTRCV(JLON,JLEV-1,JBLK)+PSTRCV(JLON,JLEV+1,JBLK))
       DO JTRA=1,KTRA
         PSTRCTRA(JLON,JLEV,JTRA,JBLK)=(1._JPRB-ZA)*PSTRCTRA(JLON,JLEV,JTRA,JBLK)+ZA2*(PSTRCTRA(JLON,JLEV-1,JTRA,JBLK)+&
                                 & PSTRCTRA(JLON,JLEV+1,JTRA,JBLK))
       ENDDO
    
  ENDDO
  ENDDO
  ENDDO


  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  DO JLEV=ITOP,KLEV-1
    
       PMF_UP(JLON,JLEV,JBLK)=ZGDTI*ZFORM(JLON,JLEV,JBLK)  ! "mass flux" for implicit formulation
    
  ENDDO
  ENDDO
  ENDDO

ENDIF ! IF ITOP < KLEV+1

!
!-------------------------------------------------
! Momentum is not transported as thermodynamic variables (theta, qt).
!-------------------------------------------------
!
DO JBLK = 1, KGPBLKS
DO JLON = KIDIA, KFDIA
DO JLEV=KTDIA,KLEV
  
    PSTRCU(JLON,JLEV,JBLK)=YRPHY0%GCVUV*PSTRCU(JLON,JLEV,JBLK)
    PSTRCV(JLON,JLEV,JBLK)=YRPHY0%GCVUV*PSTRCV(JLON,JLEV,JBLK)
  
ENDDO
ENDDO
ENDDO



!----------------------------------------------------------------
! ERASE PCAPE COMPUTED PREVIOUSLY IF NCAPEMOD DIFFERENT FROM 0 :
!----------------------------------------------------------------
! NCAPEMOD.EQ.0 : the previous value of PCAPE is retained
! NCAPEMOD.EQ.1 : call FPCINCAPE  with the mask "KNND(JLON)=1"
! NCAPEMOD.EQ.2 : call FPCINCAPE  with the mask "ZDIAG_WMAX>WCAPEMOD"
!
IF (YRPHY0%NCAPEMOD /= 0) THEN
  !
  !- - - - - - - - - - - - - - -
  ! Set the "SBCAPE" to zero :
  !- - - - - - - - - - - - - - -
  DO JBLK = 1, KGPBLKS
  DO JLON = KIDIA, KFDIA
  
  PCAPE(JLON,JBLK)=0.0_JPRB
  
  ENDDO
  ENDDO

  !
  !- - - - - - - - - - - - - - - - - - - - -
  ! Compute the "SBCAPE" for the parcel at 
  ! the lowest atmospheric model level :
  !- - - - - - - - - - - - - - - - - - - - -
  CALL FPCINCAPE(KIDIA,KFDIA,KGPBLKS,KLON,KLEV,KLEV, &
      & PT,PAPRSF,PQ,PCAPE,ZCIN,ILCL,IFCL,IEL)
  !
  !- - - - - - - - - - - - - - - - - - - - - - -
  ! This "SBCAPE" is set to zero where PCMT is 
  ! "inactive" :
  !- - - - - - - - - - - - - - - - - - - - - - -
  IF (YRPHY0%NCAPEMOD == 1) THEN
    ! "inactive" if : KNND(JLON)=0.0
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    
      PCAPE(JLON,JBLK)=MAX(0._JPRB,PCAPE(JLON,JBLK)) * &
      &           FLOAT(KNND(JLON,JBLK))
    
    ENDDO
    ENDDO

  ELSEIF (YRPHY0%NCAPEMOD == 2) THEN
    ! "inactive" if : ZDIAG_WMAX(JLON) < WCAPEMOD
    DO JBLK = 1, KGPBLKS
    DO JLON = KIDIA, KFDIA
    
      PCAPE(JLON,JBLK)=MAX(0._JPRB,PCAPE(JLON,JBLK)) * &
      &           MAX(0._JPRB,SIGN(1._JPRB, &
      &           ZDIAG_WMAX(JLON,JBLK)-YRPHY0%WCAPEMOD))
    
    ENDDO
    ENDDO

  ENDIF
  !
ENDIF ! NCAPEMOD



END SUBROUTINE ACMTUD

