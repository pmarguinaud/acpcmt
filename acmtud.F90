#include "attr.h"
SUBROUTINE ACMTUD ( KIDIA,KFDIA,KLON,KTDIA,KLEV,KTRA,&
!-----------------------------------------------------------------------
! - INPUT  2D .
& PALPH,PAPHI,PAPHIF,PAPRS,PAPRSF,PCP,PLH,PR,&
& PDELP,PLNPR,&
& PQ,PQI,PQL,PQLIS,PQSAT,PQW,&
& PRDELP,PCVGQ,PT,PTW,PU,PV,PTKE,PTRA,PEVAPO,&
! - INPUT 1D .
& PGM, PTS, PQS,&
! - OUTPUT 2D .
& PDIFCQ,PDIFCQL,PDIFCQI,PDIFCS,PDIFCTH,&
& PFCCQL,PFCCQI,PSTRCU,PSTRCV,PSTRCTRA,&
& PFHMLTS,PFHEVPP,PFPEVPCL,PFPEVPCN,&
& PFPLCL,PFPLCN,PMF_UP,&
& PNEBC,PQLIC,PTU,PQU,PSU,KNLAB,PENTR_U,PDETR_U,PENTR_D,PDETR_D,&
! - OUTPUT 1D .
& KNND,PCAPE,PALF,PALF_CAPE,PALF_CVGQ,&
! - INPUT/OUTPUT 2D .
& PUDAL,PUDOM,PDDAL,PDDOM, KSTACK, PSTACK, KPSTSZ, KKSTSZ, KPSTPT, KKSTPT)

!**** *ACMTUD * - MASS FLUX PROGNOSTIC UPDRAFT OF THE PCMT CONVECTION SCHEME.

! SUJET.
!     ------

!**   INTERFACE.
!     ----------
!        *CALL* *ACMTUD*
!-----------------------------------------------------------------------
! -   INPUT ARGUMENTS.
!     ----------------

! - PHYSICS DIMENSIONNING PARAMETERS

! KIDIA      : INDICE DE DEPART DES BOUCLES VECTORISEES SUR L'HORIZONT..
! KFDIA      : INDICE DE FIN DES BOUCLES VECTORISEES SUR L'HORIZONTALE.
! KLON       : DIMENSION HORIZONTALE DES TABLEAUX.
! KTDIA      : INDICE DE DEPART DES BOUCLES VERTICALES (1 EN GENERAL).
! KLEV       : DIMENSION VERTICALE DES TABLEAUX "FULL LEVEL".
! KTRA       : NUMBER OF TRACERS (PASSIVE VARIABLES)

! - PHYSICS VARIABLES (ALPHABETICALLY IN EACH CATEGORY)

! - 2D (0:KLEV) .

! PAPHI      : HALF LEVEL GEOPOTENTIAL
! PAPRS      : HALF LEVEL PRESSURE

! - 2D (1:KLEV) .

! PALPH      : LOG(PAPRS(JLEV)/PAPRSF(JLEV)) (FOR HYDROSTATIC MODEL).
! PAPHIF     : FULL LEVEL GEOPOTENTIAL
! PAPRSF     : FULL LEVEL PRESSURE
! PCP        : CHALEUR MASSIQUE A PRESSION CONSTANTE DE L'AIR.
! PR         : CONSTANTE DE L'AIR HUMIDE.
! PDELP      : PRESSURE DIFFERENCE OVER THE LAYER
! PLNPR      : LOG(PAPRS(JLEV)/PAPRS(JLEV-1)) (POUR L'HYDROSTATIQUE).
! PQ         : MICROPHYSICAL WATER VAPOUR SPECIFIC HUMIDITY
! PQI        : MICROPHYSICAL RESOLVED CLOUD ICE SPECIFIC CONTENTS
! PQL        : MICROPHYSICAL RESOLVED CLOUD LIQUID SPECIFIC CONTENTS
! PQLIS      : MICROPHYSICAL RESOLVED CLOUD WATER SPECIFIC CONTENTSIN THE TIME-STEP
! PQW        : WET BULB SPECIFIC MOISTURE
! PQSAT      : SATURATION SPECIFIC MOISTURE
! PRDELP     : INVERSE DE L'EPAISSEUR EN PRESSION DE LA COUCHE.
! PCVGQ      : CONVERGENCE D'HUMIDITE.
! PT         : TEMPERATURE.
! PTW        : WET BULB TEMPERATURE.
! PU         : U WIND COMPONENT
! PV         : V WIND COMPONENT
! PTRA       : TRACER CONCENTRATION
! PTKE       : TKE
! PEVAPO     : evaporation from previous time step

! - 2D (0:KLEV) .

! - 1D .

! PGM        : FACTEUR D'ECHELLE.
! PTS        : temperature de surface.
! PQS        : vapeur d'eau de surface.

!-----------------------------------------------------------------------

! -   OUTPUT ARGUMENTS
!     ----------------

! - 2D (0:KLEV) .

! PDIFCQ     : WATER VAPOUR CONVECTIVE SPECIFIC MOISTURE FLUX
! PDIFCQI    : ICE WATER CONVECTIVE SPECIFIC MOISTURE FLUX
! PDIFCQL    : LIQUID WATER CONVECTIVE SPECIFIC MOISTURE FLUX
! PDIFCS     : DRY STATIC ENERGY CONVECTIVE FLUX
! PDIFCTH    : THETA CONVECTIVE FLUX
! PFCCQL     : LIQUID CONDENSATION FLUX FROM THE CONVECTIVE UPDRAFT
! PFCCQI     : SOLID CONDENSATION FLUX FROM THE CONVECTIVE UPDRAFT
! PSTRCU     : U-MOMENTUM CONVECTIVE SPECIFIC MOISTURE FLUX
! PSTRCV     : V-MOMENTUM CONVECTIVE SPECIFIC MOISTURE FLUX
! PSTRCTRA   : TRACER CONVECTIVE FLUX
! PFHMLTS    : FLUX DE CHALEUR DU A LA FONTE/GEL.
! PFHEVPP    : FLUX DE CHALEUR DU A L'EVAPORATION DES PRECIPITATIONS.
! PFPEVPCL    : EVAPORATION DES PRECIPITATIONS LIQUIDES.
! PFPEVPCN    : EVAPORATION DES PRECIPITATIONS NEIGEUSES.
! PFPLCL     : PRECIPITATIONS CONVECTIVES SOUS FORME LIQUIDE.
! PFPLCN     : PRECIPITATIONS CONVECTIVES SOUS FORME NEIGE.

! - 2D (1:KLEV) .

! KNLAB  : CONVECTIVE ACTIVITY INDEX (ACTIVE IF EQUAL TO ONE).
! PTU    : TEMPERATURE OF THE CLOUDY ASCENT.
! PQU    : WATER VAPOUR SPECIFIC HUMIDITY OF THE CLOUDY ASCENT.
! PSU    : DRY STATIC ENERGY OF THE CLOUDY ASCENT.
! PNEBC  : CONVECTIVE CLOUDINESS.
! PQLIC  : CONVECTIVE CONDENSATE.
! PENTR_U    : ENTRAINMENT IN UPDRAFT (IN S**-1).
! PDETR_U    : DETRAINMENT FROM UPDRAFT (IN S**-1).
! PENTR_D    : ENTRAINMENT IN DOWNDRAFT (IN S**-1).
! PDETR_D    : DETRAINMENT FROM DOWNDRAFT (IN S**-1).

! - 1D (DIAGNOSTIQUE) .

! KNND   : ZERO WHENEVER A NON PHYSICAL SITUATION OCCURS, ONE OTHERWISE
! PCAPE  : CAPE (CONDITIONAL AVAILABLE POTENTIAL ENERGY).

!-----------------------------------------------------------------------

! -   INPUT/OUTPUT ARGUMENTS
!     ----------------------

! - 2D (0:KLEV) .

! - 2D (1:KLEV) .

! PUDAL    : PROGNOSTIC UPDRAFT MESH FRACTION
! PUDOM    : PROGNOSTIC UPDRAFT RELATIVE VELOCITY

!-----------------------------------------------------------------------

! METHOD.
!     --------

! AUTHOR.
!     -------
! 2011-04-14, J.F. GUEREMY AND J.M. PIRIOU.

! MODIFICATIONS.
!     --------------
! 2013-02-08, J.M. Piriou: protect the LOG in computing ZSIGMA.
! 2013-06-17, J.M. Piriou: LCVNHD NH effects of downdraft on updraft and conversely.
! 2013-06-17, J.M. Piriou: prognostic closure on PALF.
! 2013-07 - G. Bellon  Modifications for MUSC 
! 2014-04-01, J.M. Piriou: LLSINH: SImple NH effect.
! 2014-05   , J.F. Gueremy:
!             * resolution function for closure condition.
!             * CIN threshold for triggering condition.
! 2014-05   , J.F. Gueremy: use ZDQCA instead of ZBCC to compute condensation,
!             to apply the same "ZAUX" reduction in condensation and in transport.
! 2014-05 - D. Saint-Martin : Transport of tracers
! 2014-06 - J.F. Gueremy condensation flux using the same massflux
!             as for the transport flux
! 2014-07-29, Ryad El Khatib: optimize computation time: replace scalars by arrays, etc.
! 2014-09 - J.F. Gueremy new formulation of the resolution function for closure
!             condition and no more smoothing of dw/dp (ZALFAVEC=1.)
! 2015-02 -  I. Beau: Bugfix + some cleanings consistent with cy38 (NCVENTR options)
! 2015-09- J.M Piriou: Phasing of NWP and Climate versions
! 2015-11 - J.F. Gueremy: bugfix concerning the "mass flux" for implicit formulation
! 2015-11 - J.F. Gueremy: explicit transport flux for the dry air potential temperature
!             smoothing of mass flux for the transport fluxes
! 2015-12 - J.M. Piriou: GCVUV factor for momentum transport.
! 2016-06 - J.F. Gueremy et J.M. Piriou: debug sign when using ZFORD for ZAUX.
! 2017-04-21 - J.M. Piriou: use RNEBCX as a maximum value for convective cloudiness.
! 2017-05 - P. Marquet : NCAPEMOD WCAPEMOD RENTRMOD (YOMPHY0) "model-SBCAPE"

!-----------------------------------------------------------------------


USE PARKIND1, ONLY : JPIM, JPRB

USE YOMPHY   , ONLY : YRPHY
USE YOMCST   , ONLY : RATM       ,RG       ,RKAPPA   ,&
  & RD       ,RV       ,RCPD     ,&
  & RCPV     ,RETV     ,RCW      ,RCS      ,RLVTT    ,&
  & RLSTT    ,RTT      ,RALPW    ,RBETW    ,RGAMW    ,&
  & RALPS    ,RBETS    ,RGAMS    ,RALPD    ,RBETD    ,&
  & RGAMD    ,RPI      ,RA       ,&
  & RDT
USE YOMPHY0  , ONLY : YRPHY0
USE YOMPHY2  , ONLY : YRPHY2

USE YOMCT0   , ONLY : LELAM
USE YOMDIM   , ONLY : YRDIM
USE YEMGEO   , ONLY : YREGEO
USE YOMCT3   , ONLY : NSTEP
USE YOMSCM   , ONLY : NFRSCM
USE YOMRIP   , ONLY : YRRIP
USE YOMGEM   , ONLY : YRGEM

IMPLICIT NONE

!     DUMMY ARGUMENTS.

INTEGER(KIND=JPIM), INTENT(IN) :: KFDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KIDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KLEV
INTEGER(KIND=JPIM), INTENT(IN) :: KLON
INTEGER(KIND=JPIM), INTENT(IN) :: KTDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KTRA

REAL(KIND=JPRB), INTENT(IN)    :: PALPH(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPHI(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPHIF(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPRS(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PAPRSF(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PCP(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PLH(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PR(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PDELP(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PLNPR(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQ(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQI(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQL(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQLIS(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQSAT(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PQW(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PRDELP(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PCVGQ(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PT(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PTW(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PU(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PV(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PTRA(KLON,KLEV,KTRA)
REAL(KIND=JPRB), INTENT(IN)    :: PTKE(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PEVAPO(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PGM(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PTS(KLON)
REAL(KIND=JPRB), INTENT(IN)    :: PQS(KLON)

INTEGER(KIND=JPIM), INTENT(INOUT) :: KNLAB(KLON,KLEV)
INTEGER(KIND=JPIM), INTENT(INOUT) :: KNND(KLON)
REAL(KIND=JPRB)   , INTENT(INOUT) :: PALF(KLON)

REAL(KIND=JPRB), INTENT(OUT)   :: PCAPE(KLON)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQ(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCQI(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCS(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PDIFCTH(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFCCQL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFCCQI(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCU(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCV(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PSTRCTRA(KLON,0:KLEV,KTRA)
REAL(KIND=JPRB), INTENT(OUT)   :: PMF_UP(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PTU(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PQU(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PSU(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PNEBC(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PQLIC(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFHMLTS(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PENTR_U(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PDETR_U(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PENTR_D(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PDETR_D(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPLCL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPLCN(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPEVPCL(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFPEVPCN(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(INOUT)   :: PFHEVPP(KLON,0:KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PALF_CAPE(KLON)
REAL(KIND=JPRB), INTENT(OUT)   :: PALF_CVGQ(KLON)

REAL(KIND=JPRB), INTENT(INOUT) :: PUDAL(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT) :: PUDOM(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT) :: PDDAL(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT) :: PDDOM(KLON,KLEV)
REAL(KIND=JPRB),   INTENT(OUT)   :: PSTACK (KLON, KPSTSZ)
INTEGER(KIND=JPIM),INTENT(OUT)   :: KSTACK (KLON, KKSTSZ)
INTEGER(KIND=JPIM),INTENT(IN)    :: KPSTSZ, KKSTSZ, KPSTPT, KKSTPT

! LOCALS.

INTEGER(KIND=JPIM) :: JTRA
INTEGER(KIND=JPIM) :: ISUM, ITOP, JIT, JLEV, JLON

REAL(KIND=JPRB) :: ZARLII,ZBAS, &
  &ZCPSMD, ZCPVMD, &
  &ZCPVMS, ZCPVMW, ZCPWMD, ZDCP, ZDELQ, &
  &ZDELT, ZDELTA, ZDPSGDT, ZDQW, &
  &ZFER, ZEPS16, &
  &ZESP, ZEW, ZEXP, &
  &ZAUX, ZGDT, ZGDTI, &
  &ZLIQ, ZMIX, ZNBA, ZQW, &
  &ZRVMD, ZZ, ZZVAL, &
  &ZB, ZLHTBW, &
  &ZIDT, ZTPHY, &
  &ZINCRQ,ZCPBW, &
  &ZEPSW,ZWEIGHT,ZEPS_BCCS
INTEGER(KIND=JPIM) :: ILEV
REAL(KIND=JPRB) :: ZBETA1RIO,ZA1RIO,ZBRIO,ZCRIO

REAL(KIND=JPRB) :: ZCPH,ZTNSEC,ZTVNL,ZTVEL

REAL(KIND=JPRB) :: ZFLO_OMEGA,ZDELPF,ZENTR_TUR,ZKDL,ZVVERDEN

REAL(KIND=JPRB) :: ZDELTAP,ZVVERN,ZEPS_TURL,ZKDX,ZPPS,ZMOD_MIN,ZMOD_MAX
REAL(KIND=JPRB) :: ZENTRO,ZEPS_ORG0,ZTLN,ZTLE,ZQSTLE,ZQSTLN,ZSN,ZSE,ZCHIS
REAL(KIND=JPRB) :: ZTVLN,ZTVLE,ZNCHI0,ZDCHI0,ZEPS0,ZEPSVVER,ZCHI0,ZCHI02,ZDLOGM,ZFMDQN
REAL(KIND=JPRB) :: ZFMDSN,ZDPLAB
REAL(KIND=JPRB) :: ZDLON,ZDLONL,ZFORMV
REAL(KIND=JPRB) :: ZTD
REAL(KIND=JPRB) :: ZDIVERG,ZBIN,ZTKLEV
INTEGER(KIND=JPIM) :: ISDELTAP
INTEGER(KIND=JPIM) :: IVVER,IDOMDP,IVVN,IVVX,INUA,ICHIS,IENTR
INTEGER(KIND=JPIM) :: IE0,ICIN
REAL(KIND=JPRB) :: ZEPS3
REAL(KIND=JPRB) :: ZE,ZR,ZTCOND
REAL(KIND=JPRB) :: ZCCHSL,ZCCHSN
REAL(KIND=JPRB) :: ZEPS1,ZEPS4

 ! Reduce Entrainment factor, total.
 ! Reduce Entrainment factor, due to saturation deficit.

REAL(KIND=JPRB) :: ZRT,ZIWGREAT
REAL(KIND=JPRB) :: ZBINTKE,ZBINDEPTH,ZHEIGHT

 ! geopotential at full levels within updraft, under the equipressure hypothesis.
 ! geopotential at full levels within updraft.

REAL(KIND=JPRB) :: ZA,ZA2
REAL(KIND=JPRB) :: ZC
REAL(KIND=JPRB) :: ZD
REAL(KIND=JPRB) :: ZWNEW
REAL(KIND=JPRB) :: ZENTR
REAL(KIND=JPRB) :: ZENTRX
REAL(KIND=JPRB) :: ZRESOL
REAL(KIND=JPRB) :: ZNEBCX
! Dummy setup for CALL FPCINCAPE

#include "abor1.intfb.h"


LOGICAL :: LLTEXC,LLNHACC,LLCOND1,LLCAPECIN
INTEGER(KIND=JPIM) :: IKSTPT_INLABD

INTEGER(KIND=JPIM) :: IKSTPT_IEL

INTEGER(KIND=JPIM) :: IKSTPT_IFCL

INTEGER(KIND=JPIM) :: IKSTPT_ILCL

INTEGER(KIND=JPIM) :: IPSTPT_ZALFX

INTEGER(KIND=JPIM) :: IPSTPT_ZT

INTEGER(KIND=JPIM) :: IPSTPT_ZPREVIOUST

INTEGER(KIND=JPIM) :: IPSTPT_ZALF_CVGQ

INTEGER(KIND=JPIM) :: IPSTPT_ZIBCCS

INTEGER(KIND=JPIM) :: IPSTPT_ZCVGQ

INTEGER(KIND=JPIM) :: IPSTPT_ZDELTA_ARR

INTEGER(KIND=JPIM) :: IPSTPT_ZLOGSIGMA

INTEGER(KIND=JPIM) :: IPSTPT_ZEW_TLN

INTEGER(KIND=JPIM) :: IPSTPT_ZEW_TLE

INTEGER(KIND=JPIM) :: IPSTPT_ZTLN_ARR

INTEGER(KIND=JPIM) :: IPSTPT_ZTLE_ARR

INTEGER(KIND=JPIM) :: IPSTPT_ZALFAVEC

INTEGER(KIND=JPIM) :: IPSTPT_ZLOGRATIO

INTEGER(KIND=JPIM) :: IPSTPT_ZRHOH

INTEGER(KIND=JPIM) :: IPSTPT_ZLISS

INTEGER(KIND=JPIM) :: IPSTPT_ZTMPVAR

INTEGER(KIND=JPIM) :: IPSTPT_ZEVAPO

INTEGER(KIND=JPIM) :: IPSTPT_ZPHIF_U

INTEGER(KIND=JPIM) :: IPSTPT_ZPHIF_U_EQUIP

INTEGER(KIND=JPIM) :: IPSTPT_ZSTRCVD

INTEGER(KIND=JPIM) :: IPSTPT_ZSTRCUD

INTEGER(KIND=JPIM) :: IPSTPT_ZNND

INTEGER(KIND=JPIM) :: IPSTPT_ZI1

INTEGER(KIND=JPIM) :: IPSTPT_ZDIFCSD

INTEGER(KIND=JPIM) :: IPSTPT_ZDIFCQD

INTEGER(KIND=JPIM) :: IPSTPT_ZBINBUO

INTEGER(KIND=JPIM) :: IPSTPT_ZBINID2

INTEGER(KIND=JPIM) :: IPSTPT_ZBINID

INTEGER(KIND=JPIM) :: IPSTPT_ZRH

INTEGER(KIND=JPIM) :: IPSTPT_ZINTE

INTEGER(KIND=JPIM) :: IPSTPT_ZDENO

INTEGER(KIND=JPIM) :: IPSTPT_ZSATDEF

INTEGER(KIND=JPIM) :: IPSTPT_ZRE_KEDD

INTEGER(KIND=JPIM) :: IPSTPT_ZRE_HEIGHT

INTEGER(KIND=JPIM) :: IPSTPT_ZRE_SATDEF

INTEGER(KIND=JPIM) :: IPSTPT_ZRE

INTEGER(KIND=JPIM) :: IPSTPT_ZDIFCS_DD_NOCORR_DIAG

INTEGER(KIND=JPIM) :: IPSTPT_ZDIFCS_UD_NOCORR_DIAG

INTEGER(KIND=JPIM) :: IPSTPT_ZDIFCS_DD_DIAG

INTEGER(KIND=JPIM) :: IPSTPT_ZRME

INTEGER(KIND=JPIM) :: IPSTPT_ZPLH

INTEGER(KIND=JPIM) :: IPSTPT_ZTARGET_WD

INTEGER(KIND=JPIM) :: IPSTPT_ZINTEG

INTEGER(KIND=JPIM) :: IPSTPT_ZMEAN_D

INTEGER(KIND=JPIM) :: IPSTPT_ZMEAN_U

INTEGER(KIND=JPIM) :: IPSTPT_ZTWD_STAU

INTEGER(KIND=JPIM) :: IPSTPT_ZTWD_TOT

INTEGER(KIND=JPIM) :: IPSTPT_ZTWD_TOT_RAW

INTEGER(KIND=JPIM) :: IPSTPT_ZTWD_FRI

INTEGER(KIND=JPIM) :: IPSTPT_ZTWD_NHD

INTEGER(KIND=JPIM) :: IPSTPT_ZTWD_DYP

INTEGER(KIND=JPIM) :: IPSTPT_ZTWD_BUO

INTEGER(KIND=JPIM) :: IPSTPT_ZTWD_ADV

INTEGER(KIND=JPIM) :: IPSTPT_ZTWU_STAU

INTEGER(KIND=JPIM) :: IPSTPT_ZTWU_TOT

INTEGER(KIND=JPIM) :: IPSTPT_ZTWU_TOT_RAW

INTEGER(KIND=JPIM) :: IPSTPT_ZTWU_FRI

INTEGER(KIND=JPIM) :: IPSTPT_ZTWU_NHD

INTEGER(KIND=JPIM) :: IPSTPT_ZTWU_DYP

INTEGER(KIND=JPIM) :: IPSTPT_ZTWU_BUO

INTEGER(KIND=JPIM) :: IPSTPT_ZTWU_ADV

INTEGER(KIND=JPIM) :: IPSTPT_ZDIFF_Z_UD

INTEGER(KIND=JPIM) :: IPSTPT_ZT_DOWN

INTEGER(KIND=JPIM) :: IPSTPT_ZRHO

INTEGER(KIND=JPIM) :: IPSTPT_ZBCC

INTEGER(KIND=JPIM) :: IPSTPT_ZBCC_CD_FULL

INTEGER(KIND=JPIM) :: IPSTPT_ZBCC_C_FULL

INTEGER(KIND=JPIM) :: IPSTPT_ZVMD

INTEGER(KIND=JPIM) :: IPSTPT_ZUMD

INTEGER(KIND=JPIM) :: IPSTPT_ZBCC_C_HALF

INTEGER(KIND=JPIM) :: IPSTPT_ZQDND

INTEGER(KIND=JPIM) :: IPSTPT_ZFORD

INTEGER(KIND=JPIM) :: IPSTPT_ZFORU

INTEGER(KIND=JPIM) :: IPSTPT_ZTN2D

INTEGER(KIND=JPIM) :: IPSTPT_ZSN2D

INTEGER(KIND=JPIM) :: IPSTPT_ZSDND

INTEGER(KIND=JPIM) :: IPSTPT_ZQN2D

INTEGER(KIND=JPIM) :: IPSTPT_ZEPS_ORGD

INTEGER(KIND=JPIM) :: IPSTPT_ZDEL_ORGD

INTEGER(KIND=JPIM) :: IPSTPT_ZBETD

INTEGER(KIND=JPIM) :: IPSTPT_ZTEN

INTEGER(KIND=JPIM) :: IPSTPT_ZTEL

INTEGER(KIND=JPIM) :: IPSTPT_ZS5

INTEGER(KIND=JPIM) :: IPSTPT_ZQU

INTEGER(KIND=JPIM) :: IPSTPT_ZTU

INTEGER(KIND=JPIM) :: IPSTPT_ZSU

INTEGER(KIND=JPIM) :: IKSTPT_ILFC

INTEGER(KIND=JPIM) :: IKSTPT_INLFC

INTEGER(KIND=JPIM) :: IKSTPT_ILEVTEN

INTEGER(KIND=JPIM) :: IKSTPT_IKUO5

INTEGER(KIND=JPIM) :: IKSTPT_IQLIC

INTEGER(KIND=JPIM) :: IKSTPT_IKUO6

INTEGER(KIND=JPIM) :: IKSTPT_IBAC

INTEGER(KIND=JPIM) :: IKSTPT_INIVBAC

INTEGER(KIND=JPIM) :: IKSTPT_INCDN

INTEGER(KIND=JPIM) :: IKSTPT_ICDN

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAG_KNLAB

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAG_TUDAL

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAG_WMAX

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAG_EPS_TUR

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAG_EPS_ORG

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAGTRANSP

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAGFRICTION

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAG_ECART_T

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAG_ECART_TV

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAGFLO

INTEGER(KIND=JPIM) :: IPSTPT_ZASCENT_BASE

INTEGER(KIND=JPIM) :: IPSTPT_ZVACC

INTEGER(KIND=JPIM) :: IPSTPT_ZDEPTH

INTEGER(KIND=JPIM) :: IPSTPT_ZDELTA_U

INTEGER(KIND=JPIM) :: IPSTPT_ZEPSILON_U

INTEGER(KIND=JPIM) :: IPSTPT_ZEMD_DIAG

INTEGER(KIND=JPIM) :: IPSTPT_ZENTR_T_LOC

INTEGER(KIND=JPIM) :: IPSTPT_ZFLUXDIAG

INTEGER(KIND=JPIM) :: IPSTPT_ZQBASE

INTEGER(KIND=JPIM) :: IPSTPT_ZTBASE

INTEGER(KIND=JPIM) :: IPSTPT_ZBUOY

INTEGER(KIND=JPIM) :: IPSTPT_ZQDN

INTEGER(KIND=JPIM) :: IPSTPT_ZTAU_DIAG

INTEGER(KIND=JPIM) :: IPSTPT_ZFDXTAUX

INTEGER(KIND=JPIM) :: IPSTPT_ZTAU

INTEGER(KIND=JPIM) :: IPSTPT_ZS11

INTEGER(KIND=JPIM) :: IPSTPT_ZS12

INTEGER(KIND=JPIM) :: IPSTPT_ZFMDQ

INTEGER(KIND=JPIM) :: IPSTPT_ZFMDS

INTEGER(KIND=JPIM) :: IPSTPT_ZMOD

INTEGER(KIND=JPIM) :: IPSTPT_ZBUO_W_POS

INTEGER(KIND=JPIM) :: IPSTPT_ZVVERDM

INTEGER(KIND=JPIM) :: IPSTPT_ZBUO_W

INTEGER(KIND=JPIM) :: IPSTPT_ZCINL

INTEGER(KIND=JPIM) :: IPSTPT_ZCIN

INTEGER(KIND=JPIM) :: IPSTPT_ZCAPEL

INTEGER(KIND=JPIM) :: IPSTPT_ZRBHS

INTEGER(KIND=JPIM) :: IPSTPT_ZRBBS

INTEGER(KIND=JPIM) :: IPSTPT_ZQBH

INTEGER(KIND=JPIM) :: IPSTPT_ZTBH

INTEGER(KIND=JPIM) :: IPSTPT_ZSIGMA

INTEGER(KIND=JPIM) :: IPSTPT_ZKD

INTEGER(KIND=JPIM) :: IPSTPT_ZDEL_ORG

INTEGER(KIND=JPIM) :: IPSTPT_ZEPS_ORG

INTEGER(KIND=JPIM) :: IPSTPT_ZEPS_TUR

INTEGER(KIND=JPIM) :: IPSTPT_ZCAPE

INTEGER(KIND=JPIM) :: IPSTPT_ZDWNDP

INTEGER(KIND=JPIM) :: IPSTPT_ZVVER

INTEGER(KIND=JPIM) :: IPSTPT_ZQNH

INTEGER(KIND=JPIM) :: IPSTPT_ZTNH

INTEGER(KIND=JPIM) :: IPSTPT_ZLN

INTEGER(KIND=JPIM) :: IPSTPT_ZTB

INTEGER(KIND=JPIM) :: IPSTPT_ZS16

INTEGER(KIND=JPIM) :: IPSTPT_ZS15

INTEGER(KIND=JPIM) :: IPSTPT_ZRVH

INTEGER(KIND=JPIM) :: IPSTPT_ZRBH

INTEGER(KIND=JPIM) :: IPSTPT_ZRBB

INTEGER(KIND=JPIM) :: IPSTPT_ZQB

INTEGER(KIND=JPIM) :: IPSTPT_ZLH

INTEGER(KIND=JPIM) :: IPSTPT_ZLB

INTEGER(KIND=JPIM) :: IPSTPT_ZCP

INTEGER(KIND=JPIM) :: IKSTPT_INBAS

INTEGER(KIND=JPIM) :: IPSTPT_ZSTRCTRAD

INTEGER(KIND=JPIM) :: IPSTPT_ZTRAMD

INTEGER(KIND=JPIM) :: IPSTPT_ZTRAM

INTEGER(KIND=JPIM) :: IPSTPT_ZA15

INTEGER(KIND=JPIM) :: IPSTPT_ZDQCA

INTEGER(KIND=JPIM) :: IPSTPT_ZFORM

INTEGER(KIND=JPIM) :: IPSTPT_ZTBW

INTEGER(KIND=JPIM) :: IPSTPT_ZQBW

INTEGER(KIND=JPIM) :: IPSTPT_ZVM

INTEGER(KIND=JPIM) :: IPSTPT_ZUM

INTEGER(KIND=JPIM) :: IPSTPT_ZTVN

INTEGER(KIND=JPIM) :: IPSTPT_ZTVE

INTEGER(KIND=JPIM) :: IPSTPT_ZSDN

INTEGER(KIND=JPIM) :: IPSTPT_ZRMIX

INTEGER(KIND=JPIM) :: IPSTPT_ZPOID

INTEGER(KIND=JPIM) :: IPSTPT_ZLDN

INTEGER(KIND=JPIM) :: IPSTPT_ZIFRAC

INTEGER(KIND=JPIM) :: IPSTPT_ZDSE

INTEGER(KIND=JPIM) :: IPSTPT_ZBET

INTEGER(KIND=JPIM) :: IPSTPT_ZA14

INTEGER(KIND=JPIM) :: IPSTPT_ZA13

INTEGER(KIND=JPIM) :: IPSTPT_ZTALF_SIN

INTEGER(KIND=JPIM) :: IPSTPT_ZTALF_SCE

INTEGER(KIND=JPIM) :: IPSTPT_ZWD_PLUS_BUO

INTEGER(KIND=JPIM) :: IPSTPT_ZKEDD

INTEGER(KIND=JPIM) :: IPSTPT_ZWD

INTEGER(KIND=JPIM) :: IPSTPT_ZWU

INTEGER(KIND=JPIM) :: IPSTPT, IKSTPT


!-----------------------------------------------------------------------

#include "acmtddd.intfb.h"
#include "fcttrm.func.h"
#include "fctdoi.func.h"
#include "fpcincape.intfb.h"




IPSTPT = KPSTPT

IKSTPT = KKSTPT

IPSTPT_ZWU = IPSTPT

IPSTPT = IPSTPT + KLEV+1

IPSTPT_ZWD = IPSTPT

IPSTPT = IPSTPT + KLEV+1

IPSTPT_ZKEDD = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZWD_PLUS_BUO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTALF_SCE = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTALF_SIN = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZA13 = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZA14 = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZBET = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDSE = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZIFRAC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZLDN = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZPOID = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZRMIX = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZSDN = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTVE = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTVN = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZUM = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZVM = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQBW = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTBW = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZFORM = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZDQCA = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZA15 = IPSTPT

IPSTPT = IPSTPT + (KLEV) * (KTRA)

IPSTPT_ZTRAM = IPSTPT

IPSTPT = IPSTPT + (KLEV) * (KTRA)

IPSTPT_ZTRAMD = IPSTPT

IPSTPT = IPSTPT + (KLEV) * (KTRA)

IPSTPT_ZSTRCTRAD = IPSTPT

IPSTPT = IPSTPT + (KLEV-0+1) * (KTRA)

IKSTPT_INBAS = IKSTPT

IKSTPT = IKSTPT + KLEV

IPSTPT_ZCP = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZLB = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZLH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZQB = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZRBB = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZRBH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZRVH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZS15 = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZS16 = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTB = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZLN = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTNH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZQNH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZVVER = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZDWNDP = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZCAPE = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZEPS_TUR = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZEPS_ORG = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDEL_ORG = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZKD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZSIGMA = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZTBH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZQBH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZRBBS = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZRBHS = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZCAPEL = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZCIN = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZCINL = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZBUO_W = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZVVERDM = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZBUO_W_POS = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZMOD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZFMDS = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZFMDQ = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZS12 = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZS11 = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTAU = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZFDXTAUX = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTAU_DIAG = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZQDN = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZBUOY = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTBASE = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZQBASE = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZFLUXDIAG = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZENTR_T_LOC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZEMD_DIAG = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZEPSILON_U = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDELTA_U = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDEPTH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZVACC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZASCENT_BASE = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZDIAGFLO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDIAG_ECART_TV = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDIAG_ECART_T = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDIAGFRICTION = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDIAGTRANSP = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDIAG_EPS_ORG = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDIAG_EPS_TUR = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDIAG_WMAX = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZDIAG_TUDAL = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDIAG_KNLAB = IPSTPT

IPSTPT = IPSTPT + KLEV

IKSTPT_ICDN = IKSTPT

IKSTPT = IKSTPT + 1

IKSTPT_INCDN = IKSTPT

IKSTPT = IKSTPT + KLEV

IKSTPT_INIVBAC = IKSTPT

IKSTPT = IKSTPT + KLEV

IKSTPT_IBAC = IKSTPT

IKSTPT = IKSTPT + 1

IKSTPT_IKUO6 = IKSTPT

IKSTPT = IKSTPT + 1

IKSTPT_IQLIC = IKSTPT

IKSTPT = IKSTPT + 1

IKSTPT_IKUO5 = IKSTPT

IKSTPT = IKSTPT + 1

IKSTPT_ILEVTEN = IKSTPT

IKSTPT = IKSTPT + 1

IKSTPT_INLFC = IKSTPT

IKSTPT = IKSTPT + KLEV

IKSTPT_ILFC = IKSTPT

IKSTPT = IKSTPT + 1

IPSTPT_ZSU = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTU = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQU = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZS5 = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTEL = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTEN = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZBETD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDEL_ORGD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZEPS_ORGD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZQN2D = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZSDND = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZSN2D = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTN2D = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZFORU = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZFORD = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZQDND = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZBCC_C_HALF = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZUMD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZVMD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZBCC_C_FULL = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZBCC_CD_FULL = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZBCC = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZRHO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZT_DOWN = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDIFF_Z_UD = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZTWU_ADV = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWU_BUO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWU_DYP = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWU_NHD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWU_FRI = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWU_TOT_RAW = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWU_TOT = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWU_STAU = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWD_ADV = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWD_BUO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWD_DYP = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWD_NHD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWD_FRI = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWD_TOT_RAW = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWD_TOT = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTWD_STAU = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZMEAN_U = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZMEAN_D = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZINTEG = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTARGET_WD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZPLH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZRME = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZDIFCS_DD_DIAG = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZDIFCS_UD_NOCORR_DIAG = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZDIFCS_DD_NOCORR_DIAG = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZRE = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZRE_SATDEF = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZRE_HEIGHT = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZRE_KEDD = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZSATDEF = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZDENO = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZINTE = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZRH = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZBINID = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZBINID2 = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZBINBUO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZDIFCQD = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZDIFCSD = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZI1 = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZNND = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZSTRCUD = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZSTRCVD = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZPHIF_U_EQUIP = IPSTPT

IPSTPT = IPSTPT + KLEV+1

IPSTPT_ZPHIF_U = IPSTPT

IPSTPT = IPSTPT + KLEV+1

IPSTPT_ZEVAPO = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZTMPVAR = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZLISS = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZRHOH = IPSTPT

IPSTPT = IPSTPT + KLEV-0+1

IPSTPT_ZLOGRATIO = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZALFAVEC = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTLE_ARR = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZTLN_ARR = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZEW_TLE = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZEW_TLN = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZLOGSIGMA = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZDELTA_ARR = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZCVGQ = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZIBCCS = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZALF_CVGQ = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZPREVIOUST = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZT = IPSTPT

IPSTPT = IPSTPT + KLEV

IPSTPT_ZALFX = IPSTPT

IPSTPT = IPSTPT + 1

IKSTPT_ILCL = IKSTPT

IKSTPT = IKSTPT + 1

IKSTPT_IFCL = IKSTPT

IKSTPT = IKSTPT + 1

IKSTPT_IEL = IKSTPT

IKSTPT = IKSTPT + 1

IKSTPT_INLABD = IKSTPT

IKSTPT = IKSTPT + KLEV

IF (IPSTPT > KPSTSZ) CALL ABOR1 (' ')

IF (IKSTPT > KKSTSZ) CALL ABOR1 (' ')
DO JLEV = 1, KLEV+1
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZWU+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV+1
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZWD+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

LLCAPECIN=.FALSE.
DO JLON=KIDIA,KFDIA
  PSTACK (JLON, IPSTPT_ZPREVIOUST)=PT(JLON,KTDIA)
ENDDO
DO JLEV=KTDIA,KLEV
  DO JLON=KIDIA,KFDIA

    ! Limit T value, so that no instability can be greater than GINSTX Kelvin per level.
    ! This is done in order to prevent temporal instabilities generated by too large time
    ! steps versus vertical resolution, close to orography.
    PSTACK (JLON, IPSTPT_ZT+JLEV-(1))=MIN(PT(JLON,JLEV),&
    &  PSTACK (JLON, IPSTPT_ZPREVIOUST)+YRPHY0%GINSTX)
    PSTACK (JLON, IPSTPT_ZPREVIOUST)=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))

    ! VERTICAL VELOCITY IN M/S COMPUTED FROM VERTICAL VELOCITY IN PA/S.
    PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))=-PUDOM(JLON,JLEV)*PR(JLON,JLEV)*&
    &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/(PAPRSF(JLON,JLEV)*RG)
    PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))=-PDDOM(JLON,JLEV)*PR(JLON,JLEV)*&
    &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/(PAPRSF(JLON,JLEV)*RG)
  ENDDO
ENDDO

DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZKEDD) = 0._JPRB
ENDDO

DO JLEV=KTDIA,KLEV
  DO JLON=KIDIA,KFDIA
    ! Kinetic energy of the downdraft.
    PSTACK (JLON, IPSTPT_ZKEDD)=PSTACK (JLON, IPSTPT_ZKEDD)+0.5_JPRB*         &
    &  PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))*PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))* &
    & PDELP(JLON,JLEV)/RG
  ENDDO
ENDDO

!     -------------------
! // INITIALISATIONS

IF(YRPHY0%NCVCLOS == 4) THEN
  !
  !-------------------------------------------------
  ! Surface fraction PALF is prognostic.
  ! In input, PUDAL is the result of 3D advection applied to the uniform in the
  ! vertical PALF field from previous time step.
  ! PUDAL is set in output to ZSIGMA*PALF.
  ! PALF is set in output to the new prognostic value of PALF, and will be set
  ! by the caller of present routine ACMTUD in the array PUDAL, in order to be
  ! advected in 3D.
  ! Here PALF is set to the value of the 3D field PUDAL above PBL.
  ! In 1D, as there is no advection, PUDAL is nothing but the uniform value of PALF from previous time
  ! step.
  !-------------------------------------------------
  !
  ILEV=MAX(KTDIA,INT(YRPHY0%GSIGA*REAL(KLEV)))
  DO JLON=KIDIA,KFDIA
    PALF(JLON)=PUDAL(JLON,ILEV)
  ENDDO
ELSE
  !-------------------------------------------------
  ! Surface fraction PALF is diagnostic.
  !-------------------------------------------------
  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PUDAL(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

ENDIF
DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PDDAL(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZEPS_ORG+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZEMD_DIAG+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIFCQD+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIFCSD+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZSTRCUD+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZSTRCVD+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZVACC+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

ZENTR=YRPHY0%GCVRE*YRPHY0%TENTR
ZENTRX=YRPHY0%GCVRE*YRPHY0%TENTRX
DO JTRA = 1, KTRA
DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZSTRCTRAD+JLEV-(0)+(KLEV-0+1)*(JTRA-(1))) = 0._JPRB
ENDDO
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1)) = ZENTRX*RG
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1)) = ZENTRX*RG
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PENTR_U(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PDETR_U(JLON,JLEV) = YRPHY0%GCVENTR_MIN
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PENTR_D(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PDETR_D(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZBUOY+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZENTR_T_LOC+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZFLUXDIAG+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV+1
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV+1
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZPHIF_U_EQUIP+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIFF_Z_UD+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZMOD+JLEV-(1)) = YRPHY0%GCVEZ
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-(0)) = 1._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZRE+JLEV-(1)) = 1._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZRE_SATDEF+JLEV-(1)) = 1._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZRE_HEIGHT+JLEV-(1)) = 1._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZRE_KEDD+JLEV-(1)) = 1._JPRB
ENDDO
ENDDO

ZTPHY=YRPHY2%TSPHY
DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZLISS+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PMF_UP(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZRHOH+JLEV-(0)) = 1.0_JPRB
ENDDO
ENDDO


! Compute convective response time as a function of nominal resolution.
! REFLCAPE should in this case be independant of resolution.

IF(YRPHY0%REFLCAPE > 0._JPRB) THEN
  ! Climate tunings.
  IF (LELAM) THEN
    ZDLON=(2.0_JPRB*RPI*RA)/MIN(YREGEO%EDELX, YREGEO%EDELY)
  ELSE
    ZDLON=REAL(YRDIM%NDLON)
  ENDIF
  DO JLON=KIDIA,KFDIA
    ZDLONL=MIN(ZDLON*PGM(JLON),950._JPRB)
    PSTACK (JLON, IPSTPT_ZFDXTAUX)=YRPHY0%TEQC*1.E3_JPRB*(2.234E-4_JPRB*ZDLONL**&
    & 2 -0.425_JPRB*ZDLONL+252.5_JPRB)
    PSTACK (JLON, IPSTPT_ZALFX)=YRPHY0%ALFX
  ENDDO
ELSE
  ! NWP tunings.
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZFDXTAUX)=ABS(YRPHY0%REFLCAPE)*PGM(JLON)
    ! REDLXN is the mean model mesh in meter.
    ! ZRESOL is the local model resolution in 1/meter.
    ZRESOL=PGM(JLON)/YRGEM%RDELXN
    ! ZALFX varies from ALFX_LR to ALFX_HR, as resolution goes from GCVRESN to GCVRESX.
    PSTACK (JLON, IPSTPT_ZALFX)=MAX(YRPHY0%ALFX_LR,MIN(YRPHY0%ALFX_HR,YRPHY0%  &
    & ALFX_LR+(ZRESOL-YRPHY0%GCVRESN) /(YRPHY0%GCVRESX-YRPHY0%GCVRESN)*(YRPHY0%&
    & ALFX_HR-YRPHY0%ALFX_LR)))
  ENDDO
ENDIF

!--------------------------------------------------

!     SETTING ALL FLUXES TO ZERO (FOR THE CASE WITHOUT CONVECTION)
! THIS IS DONE NOW BY INITAPLPAR

!     ---------------------------
! // AUXILIARY CONSTANTS.

ZEPS0=1.E-12_JPRB
ZEPS3=1.E-01_JPRB
ZEPSVVER=1._JPRB
ZEPS16=1.E-06_JPRB
ZEPS1=1.E-10_JPRB
ZEPS4=1.E-05_JPRB
ZEPSW=0.01_JPRB
ZEPS_BCCS=2.8E-05_JPRB ! Drizzle threshold in mm/s.
ZNEBCX=MIN(1._JPRB-ZEPS0,YRPHY0%RNEBCX)


! UPDRAFT INIT
DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDQCA+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1)) = PUDOM(JLON,JLEV)
ENDDO
ENDDO


! DOWNDRAFT INIT
DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZBETD+JLEV-(1)) = 1._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDEL_ORGD+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZEPS_ORGD+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZQDND+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZQN2D+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZSN2D+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTN2D+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZSDND+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZUMD+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZVMD+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JTRA = 1, KTRA
DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTRAMD+JLEV-(1)+(KLEV)*(JTRA-(1))) = 0._JPRB
ENDDO
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
KSTACK (JLON, IKSTPT_INLABD+JLEV-(1)) = 0
ENDDO
ENDDO


ZARLII=0.004_JPRB
ZRVMD=RV-RD
ZCPVMD=RCPV-RCPD
ZCPVMW=RCPV-RCW
ZCPVMS=RCPV-RCS
ZCPWMD=RCW-RCPD
ZCPSMD=RCS-RCPD

ZIDT=1.0_JPRB/ZTPHY
ZGDT=RG*ZTPHY
ZGDTI=1.0_JPRB/ZGDT

ZCCHSL=RCW-RCPD
ZCCHSN=RCS-RCPD

ZKDX=YRPHY0%RKDN*ZENTRX/ZENTR
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDEPTH) = 0._JPRB
ENDDO

DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZASCENT_BASE) = 100000._JPRB
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIAGFLO+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIAG_ECART_TV+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIAG_ECART_T+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIAGFRICTION+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIAGTRANSP+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIAG_EPS_ORG+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIAG_EPS_TUR+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIAG_WMAX) = 0._JPRB
ENDDO

PSTACK (1, IPSTPT_ZDIAG_TUDAL)=0._JPRB
DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIAG_KNLAB+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZBCC+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZBCC_C_HALF+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZBCC_C_FULL+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZBCC_CD_FULL+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO


DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PFHMLTS(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PFHEVPP(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIFCS_DD_DIAG+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIFCS_UD_NOCORR_DIAG+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDIFCS_DD_NOCORR_DIAG+JLEV-(0)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZBUO_W+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZBUO_W_POS+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

LLTEXC=YRPHY0%GCVTEXC /= 0._JPRB
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZSATDEF) = 0._JPRB
ENDDO

DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZRH) = 0._JPRB
ENDDO

DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDENO) = 0._JPRB
ENDDO

DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO


ZMOD_MIN=YRPHY0%GCVEZ
ZMOD_MAX=1.0_JPRB
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZCVGQ) = 0._JPRB
ENDDO

DO JLEV=KTDIA,KLEV
!DEC$ VECTOR ALWAYS
  DO JLON=KIDIA,KFDIA

    ! DIAGNOSTIC OF MAXIMUM VERTICAL VELOCITY IN THE COLUMN.
    PSTACK (JLON, IPSTPT_ZDIAG_WMAX)=MAX(PSTACK (JLON, IPSTPT_ZDIAG_WMAX), &
    & PSTACK (JLON, IPSTPT_ZWU+JLEV-(1)))

    ! CONVECTIVE CLOUD DEPTH:
    ! CUMULATE DEPTH OF LAYERS WHERE VERTICAL VELOCITY IS GREATER THAN A GIVEN THRESHOLD.
    PSTACK (JLON, IPSTPT_ZBINID+JLEV-(1))=MAX(0._JPRB,SIGN(1._JPRB,&
    &  PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))-YRPHY0%GTDCL))
    PSTACK (JLON, IPSTPT_ZDEPTH)=PSTACK (JLON, IPSTPT_ZDEPTH)+(PAPHI(JLON,JLEV-1&
    &  )-PAPHI(JLON,JLEV))/RG*PSTACK (JLON, IPSTPT_ZBINID+JLEV-(1))

    ! ZASCENT_BASE: height (in m above sea level) of the lowest level where w_updraft > 10 m/s.
    ZIWGREAT=MAX(0._JPRB,SIGN(1._JPRB,PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))-10.0_JPRB&
    & ))
    PSTACK (JLON, IPSTPT_ZASCENT_BASE)=PSTACK (JLON, IPSTPT_ZASCENT_BASE)*(1._JPRB&
    &  -ZIWGREAT)+PAPHI(JLON,JLEV)/RG*ZIWGREAT

    ! ZMOD: MODULATES ENTRAINMENT WITH Z.
    ZPPS=PAPRS(JLON,JLEV)/PAPRS(JLON,KLEV)
    PSTACK (JLON, IPSTPT_ZMOD+JLEV-(1))=MAX(ZMOD_MIN,MIN(ZMOD_MAX,ZMOD_MIN+(           &
    & ZMOD_MAX-ZMOD_MIN) *MAX(0._JPRB,MIN(1._JPRB,(ZPPS-0.35_JPRB)/(0.85_JPRB-0.35_JPRB&
    & )))))

    ! DENSITY.
    PSTACK (JLON, IPSTPT_ZRHO+JLEV-(1))=PAPRSF(JLON,JLEV)/(PR(JLON,JLEV)*&
    &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))
    PSTACK (JLON, IPSTPT_ZRHOH+JLEV-1-(0)) = 0.5_JPRB*(                         &
    &  PSTACK (JLON, IPSTPT_ZRHO+JLEV-1-(1))+PSTACK (JLON, IPSTPT_ZRHO+JLEV-(1))&
    &  )

    ! SATURATION DEFICIT.
    PSTACK (JLON, IPSTPT_ZINTE)=PDELP(JLON,JLEV)/RG *MAX(0._JPRB,SIGN(1._JPRB,-(&
    & PAPHIF(JLON,JLEV)-PAPHI(JLON,KLEV)-2500._JPRB*RG) *(PAPHIF(JLON,JLEV)-    &
    & PAPHI(JLON,KLEV)-4500._JPRB*RG)))
    PSTACK (JLON, IPSTPT_ZSATDEF)=PSTACK (JLON, IPSTPT_ZSATDEF)+(PQSAT(JLON,JLEV&
    &  )-PQ(JLON,JLEV))*PSTACK (JLON, IPSTPT_ZINTE)
    PSTACK (JLON, IPSTPT_ZRH)=PSTACK (JLON, IPSTPT_ZRH)+PQ(JLON,JLEV)/PQSAT(JLON, &
    & JLEV)*PSTACK (JLON, IPSTPT_ZINTE)
    PSTACK (JLON, IPSTPT_ZDENO)=PSTACK (JLON, IPSTPT_ZDENO)+&
    &  PSTACK (JLON, IPSTPT_ZINTE)

    ! HUMIDITY CONVERGENCE INTEGRATED VERTICALLY OVER CONVECTIVE LEVELS.
    PSTACK (JLON, IPSTPT_ZCVGQ)=PSTACK (JLON, IPSTPT_ZCVGQ)+MIN(YRPHY0%GCVGQX,  &
    & PCVGQ(JLON,JLEV)) *PSTACK (JLON, IPSTPT_ZBINID+JLEV-(1))*PDELP(JLON,JLEV)/&
    &  RG
  ENDDO
ENDDO

DO JLON=KIDIA,KFDIA
  PSTACK (JLON, IPSTPT_ZRHOH+KLEV-(0)) = PSTACK (JLON, IPSTPT_ZRHO+KLEV-(1)) ! Usefull for extra-bound computation !!!!
ENDDO

DO JLON=KIDIA,KFDIA
  PSTACK (JLON, IPSTPT_ZSATDEF)=PSTACK (JLON, IPSTPT_ZSATDEF)/MAX(100._JPRB, &
  & PSTACK (JLON, IPSTPT_ZDENO))
  PSTACK (JLON, IPSTPT_ZRH)=PSTACK (JLON, IPSTPT_ZRH)/MAX(100._JPRB, &
  & PSTACK (JLON, IPSTPT_ZDENO))
ENDDO

! ------------------------------------------------------------------
! // COMPUTATION OF DERIVED PARAMETERS, SECURITY CONSTANTS
! OTHER PRELIMINARY CALCULATION

! THETAE
DO JLON=KIDIA,KFDIA
  KSTACK (JLON, IKSTPT_ILEVTEN)=0
  ZE=MAX(ZEPS0,PAPRSF(JLON,KTDIA)*PQ(JLON,KTDIA)&
    &/((1.0_JPRB-PQ(JLON,KTDIA))*RD/RV+PQ(JLON,KTDIA)))
  ZR=PQ(JLON,KTDIA)/(1.0_JPRB-PQ(JLON,KTDIA))*1000._JPRB
  IE0=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,ZEPS0-ZE)))
  ZTCOND=IE0*2840._JPRB/(3.5_JPRB*LOG(PSTACK (JLON, IPSTPT_ZT+KTDIA-(1)))-LOG(ZE&
  &  /100._JPRB) -4.805_JPRB)+55._JPRB+(1-IE0)*                                 &
  & PSTACK (JLON, IPSTPT_ZT+KTDIA-(1))
  PSTACK (JLON, IPSTPT_ZTEN)=PSTACK (JLON, IPSTPT_ZT+KTDIA-(1))*(100000._JPRB/     &
  & PAPRSF(JLON,KTDIA)) **(0.2854_JPRB*(1.0_JPRB-0.28E-3_JPRB*ZR)) *EXP((3.376_JPRB&
  &  /ZTCOND-0.00254_JPRB)*ZR*(1.0_JPRB+0.81E-3_JPRB*ZR))

  PSTACK (JLON, IPSTPT_ZPLH)=0.0_JPRB
  PSTACK (JLON, IPSTPT_ZRME)=0.0_JPRB

  PSTACK (JLON, IPSTPT_ZPHIF_U_EQUIP+KLEV-(1))=PAPHIF(JLON,KLEV)
  PSTACK (JLON, IPSTPT_ZPHIF_U_EQUIP+KLEV+1-(1))=PAPHI(JLON,KLEV)

  PSTACK (JLON, IPSTPT_ZPHIF_U+KLEV-(1))=PAPHIF(JLON,KLEV)
  PSTACK (JLON, IPSTPT_ZPHIF_U+KLEV+1-(1))=PAPHI(JLON,KLEV)
ENDDO
DO JLEV=KTDIA,KLEV
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZALFAVEC)=MAX(ZEPS0,PAPRSF(JLON,JLEV)*PQ(JLON,JLEV) /((1.0_JPRB&
    & -PQ(JLON,JLEV))*RD/RV+PQ(JLON,JLEV)))
    PSTACK (JLON, IPSTPT_ZDELTA_ARR)=100000._JPRB/PAPRSF(JLON,JLEV)
    PSTACK (JLON, IPSTPT_ZTLE_ARR)=PQ(JLON,JLEV)/(1.0_JPRB-PQ(JLON,JLEV))*1000._JPRB
    PSTACK (JLON, IPSTPT_ZLOGSIGMA)=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,ZEPS0-&
    &  PSTACK (JLON, IPSTPT_ZALFAVEC))))
  ENDDO
  DO JLON=KIDIA,KFDIA
    IE0=PSTACK (JLON, IPSTPT_ZLOGSIGMA)
    ZR=PSTACK (JLON, IPSTPT_ZTLE_ARR)
    ZTCOND=IE0*2840._JPRB/(3.5_JPRB*LOG(PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))-LOG(&
    &  PSTACK (JLON, IPSTPT_ZALFAVEC)/100._JPRB)-4.805_JPRB) +55._JPRB+(1-IE0)*&
    &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZTEL)=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))*               &
    &  PSTACK (JLON, IPSTPT_ZDELTA_ARR) **(0.2854_JPRB*(1.0_JPRB-0.28E-3_JPRB*ZR&
    &  ) ) *EXP((3.376_JPRB/ZTCOND-0.00254_JPRB)*ZR*(1.0_JPRB+0.81E-3_JPRB*ZR))
  ENDDO
!DEC$ VECTOR ALWAYS
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZTEN)=MIN(PSTACK (JLON, IPSTPT_ZTEN), &
    & PSTACK (JLON, IPSTPT_ZTEL))
    KSTACK (JLON, IKSTPT_ILEVTEN)=MAX(JLEV*NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,&
    &  PSTACK (JLON, IPSTPT_ZTEN) -PSTACK (JLON, IPSTPT_ZTEL)))),          &
    & KSTACK (JLON, IKSTPT_ILEVTEN))
  ENDDO
ENDDO


LLNHACC=YRPHY0%GNHACC < 0._JPRB
IF(LLNHACC) THEN
  ! In order to maintain convection in the night, where dd activity occurs,
  ! locate maximum of thetav, on the levels where vertical divergency of wd is
  ! larger than the threshold GNHACC.
  ! The result is put in (ZTBASE, ZQBASE): (T, qv) at ascent base.
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZTBASE)=PSTACK (JLON, IPSTPT_ZT+KLEV-(1))
    PSTACK (JLON, IPSTPT_ZQBASE)=PQ(JLON,KLEV)
  ENDDO
  ILEV=MAX(KTDIA,INT(0.95_JPRB*REAL(KLEV)))
  DO JLEV=ILEV,KLEV
    DO JLON=KIDIA,KFDIA
      ZDIVERG=(PSTACK (JLON, IPSTPT_ZWD+JLEV-1-(1))-                            &
      &  PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))) /(PAPHIF(JLON,JLEV-1)-PAPHIF(JLON, &
      & JLEV))*RG
      ZBIN=MAX(0._JPRB,SIGN(1._JPRB,YRPHY0%GNHACC-ZDIVERG))
      ZTKLEV=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))*(PAPRSF(JLON,KLEV)/PAPRSF(JLON,&
      & JLEV))**(RD/RCPD)
      ZBIN=ZBIN*MAX(0._JPRB,SIGN(1._JPRB,ZTKLEV-PSTACK (JLON, IPSTPT_ZTBASE)))
      PSTACK (JLON, IPSTPT_ZTBASE)=ZBIN*ZTKLEV+(1._JPRB-ZBIN)*&
      &  PSTACK (JLON, IPSTPT_ZTBASE)
      PSTACK (JLON, IPSTPT_ZQBASE)=ZBIN*PQ(JLON,JLEV)+(1._JPRB-ZBIN)*&
      &  PSTACK (JLON, IPSTPT_ZQBASE)
    ENDDO
  ENDDO
ENDIF

IF(YRPHY0%GCLOEB > 0._JPRB) THEN
  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      ! Uniform ZRE, linked to saturation deficit.
      PSTACK (JLON, IPSTPT_ZRE+JLEV-(1))=YRPHY0%GREMIN+(YRPHY0%GREMAX-YRPHY0%   &
      & GREMIN) *MAX(0._JPRB,MIN(1._JPRB,(PSTACK (JLON, IPSTPT_ZSATDEF)-YRPHY0% &
      & GSDMIN)/(YRPHY0%GSDMAX-YRPHY0%GSDMIN)))
    ENDDO
  ENDDO
ENDIF

DO JLEV=KTDIA,KLEV
  DO JLON=KIDIA,KFDIA
    ! ZPOID     : DP/(RG*DT) FOR A GIVEN LEVEL AND A GIVEN TIME STEP.
    ! ZDSE      : LOCAL ARRAY FOR DRY STATIC ENERGIES.
    PSTACK (JLON, IPSTPT_ZPOID+JLEV-(1))=PDELP(JLON,JLEV)*ZGDTI
    PSTACK (JLON, IPSTPT_ZDSE+JLEV-(1))=PCP(JLON,JLEV)*&
    &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))+PAPHIF(JLON,JLEV)
    KSTACK (JLON, IKSTPT_INBAS+JLEV-(1))=0
  ENDDO
ENDDO

!     ------------------------------------------------------------------
! // INITIALISATION AT THE BOTTOM LAYER TO START THE CLOUD PROFILE

! - TEMPORAIRE(S) 2D (0:KLEV) .

! ZFORM    : PROFILE OF MASS FLUX AND LATER MASS FLUX TIME DT.
! KNLAB    : FINAL LAYER ACTIVITY INDEX
! KNND     : PHYSICAL SOLUTION FLAG

DO JLON=KIDIA,KFDIA

  ! THERMODYNAMIC CHARACTERISTICS OF THE CLOUD.

  ! ZTDN       : TEMPERATURE OF THE CLOUDY ASCENT.
  ! ZQDN       : WATER VAPOUR SPECIFIC HUMIDITY OF THE CLOUDY ASCENT.
  ! ZLDN       : CONDENSED SPECIFIC HUMIDITY OF THE CLOUDY ASCENT.
  ! ZTVN      : VIRTUAL CLOUD TEMPERATURE
  ! ZTVE      : VIRTUAL ENVIRONMENT TEMPERATURE

  KNLAB(JLON,KLEV)=0
  KNND(JLON)=0

  IF(LLNHACC) THEN
    ! The profile starts at lowest model level from the (T,qv) value from the
    ! level where both dd diverges and theta is maximum. This (T,qv) value
    ! has been put adiabatically at level KLEV.
    PTU(JLON,KLEV)=PSTACK (JLON, IPSTPT_ZTBASE)
    PQU(JLON,KLEV)=PSTACK (JLON, IPSTPT_ZQBASE)
  ELSEIF(LLTEXC) THEN
    ! THE PROFILE STARTS AT LOWEST MODEL LEVEL FROM THE GRID-SCALE TEMPERATURE PLUS AN EXCESS DEPENDING ON TKE.
    PTU(JLON,KLEV)=PSTACK (JLON, IPSTPT_ZT+KLEV-(1))+MAX(0.1_JPRB,MIN(2.0_JPRB,&
    & YRPHY0%GCVTEXC*PTKE(JLON,KLEV)/RCPD))
    ! THE PROFILE STARTS AT LOWEST MODEL LEVEL FROM THE GRID-SCALE WATER VAPOUR.
    PQU(JLON,KLEV)=PQ(JLON,KLEV)
  ELSE
    ! The profile starts at lowest model level from a mean between lowest model level and surface.
    PTU(JLON,KLEV)=PSTACK (JLON, IPSTPT_ZT+KLEV-(1))+MAX(0._JPRB,YRPHY0%GFSURF*(&
    &  PTS(JLON)-PSTACK (JLON, IPSTPT_ZT+KLEV-(1))))
    ! THE PROFILE STARTS AT LOWEST MODEL LEVEL FROM THE GRID-SCALE WATER VAPOUR.
    PQU(JLON,KLEV)=PQ(JLON,KLEV)
  ENDIF

  PSU(JLON,KLEV)=(RCPD+ZCPVMD*PQU(JLON,KLEV))*PTU(JLON,KLEV)+&
  & PSTACK (JLON, IPSTPT_ZPHIF_U+KLEV-(1))
  PSTACK (JLON, IPSTPT_ZSU+KLEV-(1))=PSU(JLON,KLEV)
  PSTACK (JLON, IPSTPT_ZLN)=0.0_JPRB
  PSTACK (JLON, IPSTPT_ZIFRAC+KLEV-(1))=FONICE(PTU(JLON,KLEV))
  PSTACK (JLON, IPSTPT_ZTVN+KLEV-(1))=PTU(JLON,KLEV)*(1.0_JPRB+RETV*PQU(JLON, &
  & KLEV)-PSTACK (JLON, IPSTPT_ZLN))
  PSTACK (JLON, IPSTPT_ZTVE+KLEV-(1))=PSTACK (JLON, IPSTPT_ZT+KLEV-(1))*(1.0_JPRB&
  &  +RETV*PQ(JLON,KLEV)-PQLIS(JLON,KLEV))
  PQLIC(JLON,KLEV)=PSTACK (JLON, IPSTPT_ZLN)
  PSTACK (JLON, IPSTPT_ZLDN+KLEV-(1))=PSTACK (JLON, IPSTPT_ZLN)
  PSTACK (JLON, IPSTPT_ZTNH)=PTW(JLON,KLEV)
  PSTACK (JLON, IPSTPT_ZQNH)=PQW(JLON,KLEV)
  ! TEST DE SATURATION DU NIVEAU (NIVEAU DE CONDENSATION ATTEINT).
  ! INCDN     : NIVEAU DU POINT DE CONDENSATION.
  KSTACK (JLON, IKSTPT_ICDN)=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,PQU(JLON,KLEV)-&
  & PQSAT(JLON,KLEV))))
  KSTACK (JLON, IKSTPT_INCDN+KLEV-(1))=KLEV*KSTACK (JLON, IKSTPT_ICDN)
  ! INLFC     : NIVEAU DE CONVECTION LIBRE.
  KSTACK (JLON, IKSTPT_INLFC+KLEV-(1))=0
  ZTD=PSTACK (JLON, IPSTPT_ZT+KLEV-(1))*(1.0_JPRB-RETV*(PQSAT(JLON,KLEV)-PQ(JLON, &
  & KLEV)) /(1.0_JPRB+RETV*PLH(JLON,KLEV)*PQSAT(JLON,KLEV)/(RV*                   &
  &  PSTACK (JLON, IPSTPT_ZT+KLEV-(1)))))
  ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTD))
  ZEW=FOEW(ZTD,ZDELTA)
  ZESP=ZEW/PAPRSF(JLON,KLEV)
  ZQW=FOQS(ZESP)
  ZTD=KSTACK (JLON, IKSTPT_ICDN)*(YRPHY0%GCVADET*ZTD+(1.0_JPRB-YRPHY0%GCVADET)* &
  & PTU(JLON,KLEV))+(1-KSTACK (JLON, IKSTPT_ICDN))*PTU(JLON,KLEV)
  ZQW=KSTACK (JLON, IKSTPT_ICDN)*(YRPHY0%GCVADET*ZQW+(1.0_JPRB-YRPHY0%GCVADET)* &
  & PQU(JLON,KLEV))+(1-KSTACK (JLON, IKSTPT_ICDN))*PQU(JLON,KLEV)
  PSTACK (JLON, IPSTPT_ZQDN+KLEV-(1))=ZQW
  PSTACK (JLON, IPSTPT_ZSDN+KLEV-(1))=(RCPD+ZCPVMD*ZQW)*ZTD+&
  &  PSTACK (JLON, IPSTPT_ZPHIF_U+KLEV-(1))

  ! INIVBAC   : NIVEAU DE LA BASE DE L'ASCENDANCE CONVECTIVE.
  KSTACK (JLON, IKSTPT_INIVBAC+KLEV-(1))=KLEV
  ! ZVVER     : VITESSE VERT. DE LA COLONNE CONVECTIVE AUX INTERCOUCHES.
  IF (YRPHY0%LGVVEX) THEN
    ZRT=PR(JLON,KLEV)*PSTACK (JLON, IPSTPT_ZT+KLEV-(1))
    PSTACK (JLON, IPSTPT_ZVVER+KLEV-(0))=-YRPHY0%GCVWEXC*SQRT(MAX(0._JPRB,2._JPRB&
    & /3._JPRB*MIN(5.0_JPRB ,PTKE(JLON,KLEV))))*RG*PAPRS(JLON,KLEV)/ZRT
    PSTACK (JLON, IPSTPT_ZVVER+KLEV-1-(0))=-YRPHY0%GCVWEXC*SQRT(MAX(0._JPRB,2._JPRB&
    & /3._JPRB*MIN(5.0_JPRB ,PTKE(JLON,KLEV-1))))*RG*PAPRS(JLON,KLEV-1)/ZRT
  ELSE
    PSTACK (JLON, IPSTPT_ZVVER+KLEV-(0))=0.0_JPRB
    PSTACK (JLON, IPSTPT_ZVVER+KLEV-1-(0))=0.0_JPRB
  ENDIF
  PSTACK (JLON, IPSTPT_ZVVERDM+KLEV-(1))=0.5_JPRB*(                             &
  &  PSTACK (JLON, IPSTPT_ZVVER+KLEV-(0))+PSTACK (JLON, IPSTPT_ZVVER+KLEV-1-(0))&
  &  )
  ! ZDWNDP    : DERIVEE VERT. DE VITESSE VERT.
  PSTACK (JLON, IPSTPT_ZDWNDP+KLEV-(1))=0.0_JPRB
  ! ZCAPE     : CAPE DU NIVEAU.
  PSTACK (JLON, IPSTPT_ZCAPE)=0.0_JPRB
  PSTACK (JLON, IPSTPT_ZCIN)=0.0_JPRB
  IF(YRPHY0%NCVENTR == 1 .OR. YRPHY0%NCVENTR == 15) THEN
    ! ZEPS_TUR    : ENTRAINEMENT TURBULENT.
    PSTACK (JLON, IPSTPT_ZEPS_TUR+KLEV-(1))=PSTACK (JLON, IPSTPT_ZRE+KLEV-(1))* &
    & ZENTRX
    ! ZEPS_ORG     : ENTRAINEMENT ORGANISE.
    PSTACK (JLON, IPSTPT_ZEPS_ORG+KLEV-(1))=PSTACK (JLON, IPSTPT_ZMOD+KLEV-(1))*&
    &  PSTACK (JLON, IPSTPT_ZRE+KLEV-(1))*ZENTRX *PR(JLON,KLEV)*                &
    &  PSTACK (JLON, IPSTPT_ZT+KLEV-(1))/PAPRSF(JLON,KLEV)
    ! ZDEL_ORG     : DETRAINEMENT ORGANISE
    PSTACK (JLON, IPSTPT_ZDEL_ORG+KLEV-(1))=0.0_JPRB
    PSTACK (JLON, IPSTPT_ZEPSILON_U+KLEV-(1))=(                                &
    &  PSTACK (JLON, IPSTPT_ZMOD+KLEV-(1))*PSTACK (JLON, IPSTPT_ZRE+KLEV-(1))* &
    & ZENTRX+PSTACK (JLON, IPSTPT_ZEPS_TUR+KLEV-(1)))*RG
    PSTACK (JLON, IPSTPT_ZDELTA_U+KLEV-(1))=PSTACK (JLON, IPSTPT_ZRE+KLEV-(1))* &
    & ZENTRX*RG
  ELSE
    PSTACK (JLON, IPSTPT_ZEPSILON_U+KLEV-(1))=ZENTRX*RG
  ENDIF
  ! ZKD       : COEFFICIENT DE RESISTANCE.
  IF(YRPHY0%NCVENTR == 1) THEN
    PSTACK (JLON, IPSTPT_ZKD+KLEV-(1))=ZKDX
  ELSE
    PSTACK (JLON, IPSTPT_ZKD+KLEV-(1))=YRPHY0%ADOE*ZENTRX*PR(JLON,KLEV)*&
    &  PSTACK (JLON, IPSTPT_ZT+KLEV-(1))/PAPRSF(JLON,KLEV)
  ENDIF
  ! ZSIGMA    : FRACTION DE MAILLE COUVERTE PAR L'ASCENDANCE CONVECTIVE.
  PSTACK (JLON, IPSTPT_ZSIGMA+KLEV-(0))=1.0_JPRB
  PSTACK (JLON, IPSTPT_ZSIGMA+KLEV-1-(0))=1.0_JPRB
  PSTACK (JLON, IPSTPT_ZS11)=0.0_JPRB
  PSTACK (JLON, IPSTPT_ZS12)=0.0_JPRB
  PSTACK (JLON, IPSTPT_ZS15)=0.0_JPRB
  PSTACK (JLON, IPSTPT_ZS16)=0.0_JPRB
  PSTACK (JLON, IPSTPT_ZS5)=0.0_JPRB
  PSTACK (JLON, IPSTPT_ZFMDS)=0.0_JPRB
  PSTACK (JLON, IPSTPT_ZFMDQ)=0.0_JPRB
ENDDO

!     ------------------------------------------------------------------
! // FIRST VERTICAL LOOP (UPWARDS) INCLUDING THE SATURATED
!     ADIABATIC TYPE CALCULATION OF THE CLOUD PROFILE.

!     ITOP MAY HELP AVOIDING UNNECESSARY COMPUTATIONS IN THE UPPER PART OF THE
!     ATMOSPHERE

LLCOND1 = YRPHY0%NCVENTR == 1

ITOP=KLEV+1
DO JLEV=KLEV-1,KTDIA,-1

  ! // SATURATED ADIABAT WITH ENTRAINMENT AND LIQUID (OR ICE) WATER SUSTENTATION.


!DEC$ VECTOR ALWAYS
  DO JLON=KIDIA,KFDIA

    ! ENTRAINMENT AT STARTING LEVEL JLEV+1

    ! ZTB       : "PTU" AT THE BOTTOM OF THE SLAB WITH ENTRAINMENT "IN".
    ! ZQB       : "PQU" AT THE BOTTOM OF THE SLAB WITH ENTRAINMENT "IN".
    ! ZLB       : "ZLDN" AT THE BOTTOM OF THE SLAB WITH ENTRAINMENT "IN".

    ! -------------------------------------------------
    ! // FRACTIONAL ENTRAINMENT RATE ZFER IN (J/KG)**-1.
    ! -------------------------------------------------

    ZFER=PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV+1-(1))/RG

    ! TO APPLY WHEN COMPUTING PROFILE AT JLEV

    PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))=ZFER*(PAPHIF(JLON,JLEV)-PAPHIF(JLON,&
    & JLEV+1))
    PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))=PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))/(1.0_JPRB&
    &  +PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1)))
    PSTACK (JLON, IPSTPT_ZTBW)=PTU(JLON,JLEV+1)+&
    &  PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))*(PTW(JLON,JLEV+1)-PTU(JLON,JLEV+1))
    PSTACK (JLON, IPSTPT_ZDELTA_ARR)=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-&
    &  PSTACK (JLON, IPSTPT_ZTBW)))

  ENDDO

! Isolate what may not vectorize
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZEW_TLE)= FOEW (PSTACK (JLON, IPSTPT_ZTBW), &
    & PSTACK (JLON, IPSTPT_ZDELTA_ARR))
  ENDDO

  DO JLON=KIDIA,KFDIA

    PSTACK (JLON, IPSTPT_ZQBW)=PQU(JLON,JLEV+1)+&
    &  PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))*(PQW(JLON,JLEV+1)-PQU(JLON,JLEV+1))
    PSTACK (JLON, IPSTPT_ZTB)=PTU(JLON,JLEV+1)+&
    &  PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))*(  &
    & PSTACK (JLON, IPSTPT_ZT+JLEV+1-(1)) - PTU(JLON,JLEV+1))
    PSTACK (JLON, IPSTPT_ZQB)=PQU(JLON,JLEV+1)+&
    &  PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))*(PQ(JLON,JLEV+1)-PQU(JLON,JLEV+1))
    KSTACK (JLON, IKSTPT_ICDN)=MAX(0,-ISIGN(1,-&
    &  KSTACK (JLON, IKSTPT_INCDN+JLEV+1-(1))))
    PSTACK (JLON, IPSTPT_ZLB)=PSTACK (JLON, IPSTPT_ZLN)+        &
    &  PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))*(PQLIS(JLON,JLEV+1)*&
    &  KSTACK (JLON, IKSTPT_ICDN)-PSTACK (JLON, IPSTPT_ZLN))
    PSTACK (JLON, IPSTPT_ZTBH)=PSTACK (JLON, IPSTPT_ZTNH)+&
    &  PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))*(             &
    &  PSTACK (JLON, IPSTPT_ZT+JLEV+1-(1)) - PSTACK (JLON, IPSTPT_ZTNH))
    PSTACK (JLON, IPSTPT_ZQBH)=PSTACK (JLON, IPSTPT_ZQNH)+   &
    &  PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))*(PQ(JLON,JLEV+1)-&
    &  PSTACK (JLON, IPSTPT_ZQNH))

    ! RE-ESTIMATE SATURATION AFTER MIXING

    ! ICE FRACTION AND LATENT HEAT FOR MIXED AIR TEMPERATURE

    ! ZDELTBW=FONICE(ZTBW(JLON))
    ZLHTBW=FOLH(PSTACK (JLON, IPSTPT_ZTBW),PSTACK (JLON, IPSTPT_ZDELTA_ARR))
    ZCPBW=RCPD+ZCPVMD*PSTACK (JLON, IPSTPT_ZQBW)

    ! COMPUTATION OF NEW EQUILIBRIUM OF MIXED AIR
    ZESP=PSTACK (JLON, IPSTPT_ZEW_TLE)/PAPRSF(JLON,JLEV+1)
    ZQW= FOQS (ZESP)
    ZDQW=FODQS (ZQW,ZESP, FODLEW (PSTACK (JLON, IPSTPT_ZTBW), &
    & PSTACK (JLON, IPSTPT_ZDELTA_ARR)))
    ZINCRQ=(ZDQW*(ZCPBW*(PSTACK (JLON, IPSTPT_ZTB)-PSTACK (JLON, IPSTPT_ZTBW))+ &
    & ZLHTBW *(PSTACK (JLON, IPSTPT_ZQB)-PSTACK (JLON, IPSTPT_ZQBW))) +(ZQW-    &
    &  PSTACK (JLON, IPSTPT_ZQBW))*ZCPBW)/(ZCPBW+ZLHTBW*ZDQW)
    PSTACK (JLON, IPSTPT_ZQBW)=PSTACK (JLON, IPSTPT_ZQBW)+ZINCRQ
    PSTACK (JLON, IPSTPT_ZQBW)=MIN(PSTACK (JLON, IPSTPT_ZQBW),&
    &  PSTACK (JLON, IPSTPT_ZQB)+PSTACK (JLON, IPSTPT_ZLB))

    ! HYDROSTATIC COEFFICIENTS FOR THE CLOUD PROFILE.

    ! - TEMPORAIRE(S) 1D .

    ! ZRBB      : WEIGHT OF "ZTB" IN THE GEOPOTENTIAL THICKNESS.
    ! ZRBH      : WEIGHT OF "PTU" AT "PQU=ZQB" IN THE SAME THICKNESS.
    ! ZRVH      : FOR THE Q DEPENDENT CORRECTION OF ZRBH.

    PSTACK (JLON, IPSTPT_ZRBBS)=(PLNPR(JLON,JLEV+1)-PALPH(JLON,JLEV+1))*(RD*(1.0_JPRB&
    &  -PSTACK (JLON, IPSTPT_ZLB))+ZRVMD*PSTACK (JLON, IPSTPT_ZQB))
    PSTACK (JLON, IPSTPT_ZRBHS)=PALPH(JLON,JLEV)*(RD*(1.0_JPRB-&
    &  PSTACK (JLON, IPSTPT_ZLB))+ZRVMD*PSTACK (JLON, IPSTPT_ZQB))
    PSTACK (JLON, IPSTPT_ZRBB)=(PLNPR(JLON,JLEV+1)-PALPH(JLON,JLEV+1))*(RD*(1.0_JPRB&
    &  -PSTACK (JLON, IPSTPT_ZLB))+ZRVMD*PSTACK (JLON, IPSTPT_ZQBH))
    PSTACK (JLON, IPSTPT_ZRBH)=PALPH(JLON,JLEV)*(RD*(1.0_JPRB-&
    &  PSTACK (JLON, IPSTPT_ZLB))+ZRVMD*PSTACK (JLON, IPSTPT_ZQBH))
    PSTACK (JLON, IPSTPT_ZRVH)=PALPH(JLON,JLEV)*RV

    ! TO COMPUTE SATURATED ADIABATIC PROFILE, GCVADS ALLOWS TO GO
    ! CONTINUOUSLY FROM EQUIPRESSURE TO EQUIGEOPOTENTIAL APPROACH.

    PSTACK (JLON, IPSTPT_ZRBB)=(1.0_JPRB-YRPHY0%GCVADS)*                        &
    &  PSTACK (JLON, IPSTPT_ZRBB)+YRPHY0%GCVADS*(PAPHIF(JLON,JLEV) -PAPHIF(JLON,&
    &  JLEV+1))/PSTACK (JLON, IPSTPT_ZTBH)
    PSTACK (JLON, IPSTPT_ZRBH)=(1.0_JPRB-YRPHY0%GCVADS)*&
    &  PSTACK (JLON, IPSTPT_ZRBH)
    PSTACK (JLON, IPSTPT_ZRBBS)=(1.0_JPRB-YRPHY0%GCVADS)*                         &
    &  PSTACK (JLON, IPSTPT_ZRBBS)+YRPHY0%GCVADS*(PAPHIF(JLON,JLEV) -PAPHIF(JLON, &
    &  JLEV+1))/PSTACK (JLON, IPSTPT_ZTB)
    PSTACK (JLON, IPSTPT_ZRBHS)=(1.0_JPRB-YRPHY0%GCVADS)*&
    &  PSTACK (JLON, IPSTPT_ZRBHS)
    PSTACK (JLON, IPSTPT_ZRVH)=(1.0_JPRB-YRPHY0%GCVADS)*&
    &  PSTACK (JLON, IPSTPT_ZRVH)

    ! SNOW OPTION DEPENDENT CALCULATIONS.
    ! DIAGNOSTIC ICE FRACTION
    ! ZDELTA=FONICE(ZTB(JLON))
    ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-PSTACK (JLON, IPSTPT_ZTBH)))

    ! CALL TO THE DEFINED FUNCTION FOR THE COMPUTATION OF THE PSEUDO
    ! LATENT HEAT AT THE BOTTOM (AMONG THREE CHARACTERISTIC PARAMETERS).

    ! ZLH       : RUNNING VALUE OF THE PSEUDO LH DURING NEWTON'S LOOP.
    ! ZCP       : AS ZLH BUT FOR THE SPECIFIC HEAT CP.

    PSTACK (JLON, IPSTPT_ZLH)=FOLH(PSTACK (JLON, IPSTPT_ZTBH),ZDELTA)+&
    &  PSTACK (JLON, IPSTPT_ZRVH)*PSTACK (JLON, IPSTPT_ZTBH)
    PSTACK (JLON, IPSTPT_ZCP)=RCPD+ZCPVMD*PSTACK (JLON, IPSTPT_ZQBH)+(ZCPWMD+ &
    & ZDELTA*(ZCPSMD- ZCPWMD))*PSTACK (JLON, IPSTPT_ZLB)+                     &
    &  PSTACK (JLON, IPSTPT_ZRBH)
    ZDCP=PSTACK (JLON, IPSTPT_ZRVH)+ZCPVMW+ZDELTA*(ZCPVMS-ZCPVMW)

    ! CHANGE OF LEVEL TO OBTAIN A
    ! FIRST GUESS AS STARTING POINT FOR THE NEWTON LOOP.

    ZDELT=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))-PSTACK (JLON, IPSTPT_ZT+JLEV+1-(1))
    PSTACK (JLON, IPSTPT_ZLH)=PSTACK (JLON, IPSTPT_ZLH)+ZDCP*ZDELT
    ZDELQ=-((PSTACK (JLON, IPSTPT_ZRBB)+PSTACK (JLON, IPSTPT_ZRBH))*&
    &  PSTACK (JLON, IPSTPT_ZTBH)+PSTACK (JLON, IPSTPT_ZCP)*ZDELT)/ &
    &  PSTACK (JLON, IPSTPT_ZLH)
    PSTACK (JLON, IPSTPT_ZTNH)=PSTACK (JLON, IPSTPT_ZTBH)+ZDELT
    PSTACK (JLON, IPSTPT_ZQNH)=PSTACK (JLON, IPSTPT_ZQBH)+ZDELQ
    PSTACK (JLON, IPSTPT_ZCP)=PSTACK (JLON, IPSTPT_ZCP)+ZDCP*ZDELQ
  ENDDO


  ! // NEWTON LOOP.

  DO JIT=1,YRPHY%NBITER
!   Isolate what may not vectorize
    DO JLON=KIDIA,KFDIA

      ! SNOW OPTION DEPENDENT COMPUTATIONS.
      ! DIAGNOSTIC ICE FRACTION
      PSTACK (JLON, IPSTPT_ZDELTA_ARR)=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-&
      &  PSTACK (JLON, IPSTPT_ZTNH)))

      ! SATURATION CALCULATIONS USING DEFINED FUNCTIONS.

      PSTACK (JLON, IPSTPT_ZEW_TLE)= FOEW (PSTACK (JLON, IPSTPT_ZTNH), &
      & PSTACK (JLON, IPSTPT_ZDELTA_ARR))

    ENDDO
    DO JLON=KIDIA,KFDIA
      ZESP=PSTACK (JLON, IPSTPT_ZEW_TLE)/PAPRSF(JLON,JLEV)
      ZQW= FOQS (ZESP)
      ZDQW= FODQS (ZQW,ZESP, FODLEW (PSTACK (JLON, IPSTPT_ZTNH), &
      & PSTACK (JLON, IPSTPT_ZDELTA_ARR)))

      ! INCREMENTATIONS.

      ZDCP=PSTACK (JLON, IPSTPT_ZRVH)+ZCPVMW+PSTACK (JLON, IPSTPT_ZDELTA_ARR)*( &
      & ZCPVMS-ZCPVMW)
      ZDELQ=(ZQW-PSTACK (JLON, IPSTPT_ZQNH))*PSTACK (JLON, IPSTPT_ZCP)/(&
      &  PSTACK (JLON, IPSTPT_ZCP)+PSTACK (JLON, IPSTPT_ZLH)*ZDQW)
      PSTACK (JLON, IPSTPT_ZCP)=PSTACK (JLON, IPSTPT_ZCP)+ZDCP*ZDELQ
      ZDELT=-ZDELQ*PSTACK (JLON, IPSTPT_ZLH)/PSTACK (JLON, IPSTPT_ZCP)
      PSTACK (JLON, IPSTPT_ZLH)=PSTACK (JLON, IPSTPT_ZLH)+ZDCP*ZDELT
      PSTACK (JLON, IPSTPT_ZQNH)=PSTACK (JLON, IPSTPT_ZQNH)+ZDELQ
      PSTACK (JLON, IPSTPT_ZTNH)=PSTACK (JLON, IPSTPT_ZTNH)+ZDELT
    ENDDO
  ENDDO


  ! // STABILITY TEST, OCCASIONAL CORRECTION OF THE BOTTOM LAYER,
  ! COMPUTATION OF THE MASS FLUX PROFILE PARAMETER AND OF THE TWO
  ! INTEGRALS CONNECTED WITH THE "KUO-TYPE" CLOSURE.


! Isolate log (may not vectorize)
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZLOGRATIO)=LOG(PAPRSF(JLON,JLEV+1)/PAPRSF(JLON,JLEV))
  ENDDO
  DO JLON=KIDIA,KFDIA

    ! // DRY ADIABAT.
    ZCPH=RCPD*(1.0_JPRB-PSTACK (JLON, IPSTPT_ZQB))+RCPV*&
    &  PSTACK (JLON, IPSTPT_ZQB)
    ZTNSEC=(ZCPH-PSTACK (JLON, IPSTPT_ZRBBS))*PSTACK (JLON, IPSTPT_ZTB)/(ZCPH+&
    &  PSTACK (JLON, IPSTPT_ZRBHS))

    ! // TEST IF SATURATED AT TOP OF LAYER, INITIALIZE VARIABLES FOR NEXT LEVEL.
    KSTACK (JLON, IKSTPT_ICDN)=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,&
    &  PSTACK (JLON, IPSTPT_ZTNH)-ZTNSEC)))
    KSTACK (JLON, IKSTPT_INCDN+JLEV-(1))=MAX( &
    & KSTACK (JLON, IKSTPT_INCDN+JLEV+1-(1)),JLEV*KSTACK (JLON, IKSTPT_ICDN))
    KSTACK (JLON, IKSTPT_ICDN)=MAX(0,-ISIGN(1,-&
    &  KSTACK (JLON, IKSTPT_INCDN+JLEV-(1))))
    PTU(JLON,JLEV)=KSTACK (JLON, IKSTPT_ICDN)*PSTACK (JLON, IPSTPT_ZTNH)+(1-&
    &  KSTACK (JLON, IKSTPT_ICDN))*ZTNSEC
    PQU(JLON,JLEV)=KSTACK (JLON, IKSTPT_ICDN)*PSTACK (JLON, IPSTPT_ZQNH)+(1-&
    &  KSTACK (JLON, IKSTPT_ICDN))*PSTACK (JLON, IPSTPT_ZQB)

    ! Buoyant convective condensation.
    PSTACK (JLON, IPSTPT_ZBCC_C_HALF+JLEV-(0))=MIN(0._JPRB,PQU(JLON,JLEV)-&
    &  PSTACK (JLON, IPSTPT_ZQB)) /(PAPRSF(JLON,JLEV)-PAPRSF(JLON,JLEV+1))

    ! Integrate hydrostatics within the updraft, with the equipressure hypothesis.
    PSTACK (JLON, IPSTPT_ZPHIF_U_EQUIP+JLEV-(1))=                                 &
    &  PSTACK (JLON, IPSTPT_ZPHIF_U_EQUIP+JLEV+1-(1)) +RD*0.5_JPRB*(PTU(JLON,     &
    & JLEV )+PTU(JLON,JLEV+1)) *(1.0_JPRB+RETV*0.5_JPRB*(PQU(JLON,JLEV)+PQU(JLON, &
    & JLEV +1))) *PSTACK (JLON, IPSTPT_ZLOGRATIO)

    ! Choose between equipressure and equigeopotential hypothesis.
    PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))=(1._JPRB-YRPHY0%GCVADS)*            &
    &  PSTACK (JLON, IPSTPT_ZPHIF_U_EQUIP+JLEV-(1))+YRPHY0%GCVADS*PAPHIF(JLON, &
    & JLEV)


    ! PHASE PARTITION IN THE UPDRAFT
    ! SIMPLY STORE THE UPDRAFT ICE FRACTION IN ZIFRAC

    ZDELTA=FONICE(PTU(JLON,JLEV))
    PSTACK (JLON, IPSTPT_ZIFRAC+JLEV-(1))=ZDELTA

    ZLIQ=YRPHY0%ECMNP/(PSTACK (JLON, IPSTPT_ZRBB)*PSTACK (JLON, IPSTPT_ZTBH)+(&
    &  PSTACK (JLON, IPSTPT_ZRBH)+PSTACK (JLON, IPSTPT_ZRVH) *(PQU(JLON,JLEV)-&
    &  PSTACK (JLON, IPSTPT_ZQBH)))*PTU(JLON,JLEV))
    ZEXP=EXP(-1.0_JPRB/MAX(ZARLII,ZLIQ))
    PSTACK (JLON, IPSTPT_ZLN)=KSTACK (JLON, IKSTPT_ICDN)*MAX(0.0_JPRB,&
    &  PSTACK (JLON, IPSTPT_ZLB)*ZEXP +(PQU(JLON,JLEV)-               &
    &  PSTACK (JLON, IPSTPT_ZQBH) )*ZLIQ*(ZEXP-1.0_JPRB))
    PQLIC(JLON,JLEV)=PSTACK (JLON, IPSTPT_ZLN)
    !ZDQCA(JLON,JLEV)=ZQBW(JLON)-PQU(JLON,JLEV) formule ref
    PSTACK (JLON, IPSTPT_ZDQCA+JLEV-(0))=PSTACK (JLON, IPSTPT_ZQB)-PQU(JLON,JLEV&
    &  ) ! approche 3MT.

    PSTACK (JLON, IPSTPT_ZLDN+JLEV-(1))=PSTACK (JLON, IPSTPT_ZLN)
    PSTACK (JLON, IPSTPT_ZSDN+JLEV-(1))=(RCPD+ZCPVMD*PQU(JLON,JLEV))*PTU(JLON, &
    & JLEV) +PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZDQCA+JLEV-(0))=KSTACK (JLON, IKSTPT_ICDN)*&
    &  PSTACK (JLON, IPSTPT_ZDQCA+JLEV-(0))

    ! // TEST IF LFC REACHED AT TOP OF LAYER
    KSTACK (JLON, IKSTPT_ILFC)=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,PR(JLON,JLEV)*&
    &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1)) -(RD*(1.0_JPRB-                      &
    &  PSTACK (JLON, IPSTPT_ZLN) )+ZRVMD*PSTACK (JLON, IPSTPT_ZQNH))*         &
    &  PSTACK (JLON, IPSTPT_ZTNH))))
    KSTACK (JLON, IKSTPT_INLFC+JLEV-(1))=MAX( &
    & KSTACK (JLON, IKSTPT_INLFC+JLEV+1-(1)),JLEV*KSTACK (JLON, IKSTPT_ILFC))
    KSTACK (JLON, IKSTPT_ILFC)=MAX(0,-ISIGN(1,-&
    &  KSTACK (JLON, IKSTPT_INLFC+JLEV-(1))))

    PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))=PTU(JLON,JLEV)*(1.0_JPRB+RETV*PQU(JLON, &
    & JLEV)-PSTACK (JLON, IPSTPT_ZLN))
    PSTACK (JLON, IPSTPT_ZTVE+JLEV-(1))=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))*(1.0_JPRB&
    &  +RETV*PQ(JLON,JLEV)-PQLIS(JLON,JLEV))
    ! // COMPUTE VERTICAL VELOCITY. STEP 1: BUOYANCY.
    ! Buoyancy.
    PSTACK (JLON, IPSTPT_ZBUO_W+JLEV-(1))=RG*(                                  &
    &  PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-PSTACK (JLON, IPSTPT_ZTVE+JLEV-(1)))/&
    &  PSTACK (JLON, IPSTPT_ZTVE+JLEV-(1))/YRPHY0%GAMAP1

    KSTACK (JLON, IKSTPT_IBAC)=MAX(0,-ISIGN(1,-&
    &  KSTACK (JLON, IKSTPT_INIVBAC+JLEV+1-(1))))
    IF (LLCOND1) THEN
      PSTACK (JLON, IPSTPT_ZCAPEL)=RD*PDELP(JLON,JLEV)/PAPRSF(JLON,JLEV)*(      &
      &  PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-PSTACK (JLON, IPSTPT_ZTVE+JLEV-(1))&
      &  )
      PSTACK (JLON, IPSTPT_ZCINL)=-NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,  &
      & PSTACK (JLON, IPSTPT_ZCAPEL)))) *PSTACK (JLON, IPSTPT_ZCAPEL)*&
      &  KSTACK (JLON, IKSTPT_IBAC)*KSTACK (JLON, IKSTPT_ICDN)*(1-    &
      &  KSTACK (JLON, IKSTPT_ILFC))
    ELSE
      PSTACK (JLON, IPSTPT_ZCAPEL)=RD*PDELP(JLON,JLEV)/PAPRSF(JLON,JLEV)*MAX(0._JPRB, &
      & PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-PSTACK (JLON, IPSTPT_ZTVE+JLEV-(1)))
    ENDIF

  ENDDO
! Loop is slightly reordered and split here because the (Intel) compiler fails to vectorize it.
! More powerful compiler may just fuse the two loops.
! The fused loops could be vectorized easily if certain conditional branches are
! replaced by straightforward calculations of the kind : alfa * X + (1-alfa) * Y
! Shorter loops may also reduce the pressure on the cache.
! REK.
  DO JLON=KIDIA,KFDIA

    IF(YRPHY0%LSBUO) PSTACK (JLON, IPSTPT_ZBUO_W+JLEV-(1))=0.5_JPRB*(&
                     &  PSTACK (JLON, IPSTPT_ZBUO_W+JLEV-(1))+       &
                     &  PSTACK (JLON, IPSTPT_ZBUO_W+JLEV+1-(1)))
    ! VERTICAL COORDINATE WITHIN UPDRAFT.
    PSTACK (JLON, IPSTPT_ZDIFF_Z_UD+JLEV-(0))=                                    &
    &  PSTACK (JLON, IPSTPT_ZDIFF_Z_UD+JLEV+1-(0))+PDELP(JLON,JLEV) /PAPRSF(JLON, &
    & JLEV)*RD*(PTU(JLON,JLEV)*(1.0_JPRB+RETV*PQU(JLON,JLEV)) -                   &
    &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))*(1.0_JPRB+RETV*PQ(JLON,JLEV)))/RG

    IF(LLNHACC .OR. YRPHY0%LCVNHD) THEN
      ! If NH effects are taken into account, the vertical extension of updraft is
      ! estimated as levels where updraft vertical velocity is positive
      ! and buoyancy positive, in order not to take into account in the vertical
      ! extension the area above LNB, where vertical motion is due to NH effects only.
      PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1))=MAX(0._JPRB,SIGN(1._JPRB, &
      & PSTACK (JLON, IPSTPT_ZBUO_W+JLEV-(1))))
    ELSE
      ! If NH effects are not taken into account, the vertical extension of updraft is
      ! estimated as levels where updraft vertical velocity is positive.
      ! It does not depend on buoyancy.
      PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1))=1._JPRB
    ENDIF
    PSTACK (JLON, IPSTPT_ZBUO_W_POS+JLEV-(1))=MAX(0._JPRB, &
    & PSTACK (JLON, IPSTPT_ZBUO_W+JLEV-(1))) ! positive part of the buoyancy.

    ! ZVACC: vertical acceleration in m/s2 due to buoyancy + NH effects.
    PSTACK (JLON, IPSTPT_ZVACC+JLEV-(1))=PSTACK (JLON, IPSTPT_ZBUO_W+JLEV-(1))

    ! ZFLO_OMEGA: acceleration in Pa/s2.
    ZFLO_OMEGA=-PAPRSF(JLON,JLEV)/RD/PSTACK (JLON, IPSTPT_ZTVE+JLEV-(1))*RG*&
    &  PSTACK (JLON, IPSTPT_ZVACC+JLEV-(1))

    ! Diagnostics.
    PSTACK (JLON, IPSTPT_ZDIAG_ECART_TV+JLEV-(1))=&
    &  PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-PSTACK (JLON, IPSTPT_ZTVE+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZDIAG_ECART_T+JLEV-(1))=PTU(JLON,JLEV)-&
    &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZDIAGFLO+JLEV-(1))=ZFLO_OMEGA

    ! // COMPUTE VERTICAL VELOCITY. STEP 2: FRICTION.
    ZDELPF=PDELP(JLON,JLEV)
    ZFER=PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV+1-(1))/RG*PR(JLON,JLEV+1)*&
    &  PSTACK (JLON, IPSTPT_ZT+JLEV+1-(1))/PAPRSF(JLON,JLEV+1)
    ZKDL=PSTACK (JLON, IPSTPT_ZKD+JLEV+1-(1))
    PSTACK (JLON, IPSTPT_ZDIAGFRICTION+JLEV-(1))=(ZKDL+ZFER)*&
    &  PSTACK (JLON, IPSTPT_ZVVER+JLEV-(0))**2

    ! VERTICAL TRANSPORT DIAGNOSTIC.
    PSTACK (JLON, IPSTPT_ZDIAGTRANSP+JLEV-(1))=-0.5_JPRB*(                    &
    &  PSTACK (JLON, IPSTPT_ZVVER+JLEV+1-(0))**2-                             &
    &  PSTACK (JLON, IPSTPT_ZVVER+JLEV-(0))**2) /(PAPRSF(JLON,JLEV+1)-PAPRSF( &
    & JLON, JLEV))


    ! // COMPUTE VERTICAL VELOCITY. STEP 3: IMPLICIT SOLVING OF THE TENDENCY EQUATION.
    PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))=PUDOM(JLON,JLEV)
    ZVVERDEN=2.0_JPRB*YRPHY2%TSPHY*(0.25_JPRB*(ZKDL+ZFER)+0.5_JPRB/ZDELPF)
    ZB=0.5_JPRB*(1.0_JPRB-(ZKDL+ZFER)*YRPHY2%TSPHY*&
    & PSTACK (JLON, IPSTPT_ZVVER+JLEV-(0)))
    ZDELTAP=ZB**2 -2.0_JPRB*ZVVERDEN*((ZFLO_OMEGA+(-0.5_JPRB/ZDELPF+0.25_JPRB*(  &
    & ZKDL+ZFER)) *PSTACK (JLON, IPSTPT_ZVVER+JLEV-(0))**2)*YRPHY2%TSPHY-0.5_JPRB&
    &  *PSTACK (JLON, IPSTPT_ZVVER+JLEV-(0)) +                                   &
    &  PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1)))
    ISDELTAP=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-ZDELTAP)))
    ZDELTAP=ZDELTAP*ISDELTAP
    ZVVERN=(ZB-SQRT(MAX(0._JPRB,ZDELTAP)))/ZVVERDEN

    ZVVERN=MIN(0.0_JPRB,ZVVERN)*ISDELTAP

    PSTACK (JLON, IPSTPT_ZS5)=PSTACK (JLON, IPSTPT_ZS5)+KNLAB(JLON,JLEV+1)*&
    &  PSTACK (JLON, IPSTPT_ZCIN)
    PSTACK (JLON, IPSTPT_ZCIN)=PSTACK (JLON, IPSTPT_ZCINL)
    IVVER=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,(ZVVERN+&
    & PSTACK (JLON, IPSTPT_ZVVER+JLEV-(0)))+0.0_JPRB)))
    ICIN=(1-IVVER)*KSTACK (JLON, IKSTPT_IBAC)*KSTACK (JLON, IKSTPT_ICDN)*(1-         &
    &  KSTACK (JLON, IKSTPT_ILFC)) *NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,(               &
    &  PSTACK (JLON, IPSTPT_ZS5)+PSTACK (JLON, IPSTPT_ZCINL)-YRPHY0%GCVCINC)+0.0_JPRB&
    &  )))

    PSTACK (JLON, IPSTPT_ZVVER+JLEV-1-(0))=(1-ICIN)*ZVVERN+ICIN*&
    &  PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))*0.5_JPRB
    PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))=0.5_JPRB*(&
    &  PSTACK (JLON, IPSTPT_ZVVER+JLEV-(0))+         &
    &  PSTACK (JLON, IPSTPT_ZVVER+JLEV-1-(0)))

    ZDELPF=PAPRSF(JLON,JLEV+1)-PAPRSF(JLON,JLEV)
    PSTACK (JLON, IPSTPT_ZDWNDP+JLEV-(1))=(     &
    &  PSTACK (JLON, IPSTPT_ZVVERDM+JLEV+1-(1))-&
    &  PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1)))/ZDELPF

    ! J.F. Gueremy no more smoothing of dw/dp (ZALFAVEC(JLON)=1.).
    !ZALFAVEC(JLON)=MIN(1.0_JPRB,0.50_JPRB/1000._JPRB*ZDELPF+0.50_JPRB) ! smoothing.
    PSTACK (JLON, IPSTPT_ZALFAVEC)=1.0_JPRB ! no smoothing.
    PSTACK (JLON, IPSTPT_ZDWNDP+JLEV-(1))=PSTACK (JLON, IPSTPT_ZALFAVEC)*&
    &  PSTACK (JLON, IPSTPT_ZDWNDP+JLEV-(1))+(1.0_JPRB-                  &
    &  PSTACK (JLON, IPSTPT_ZALFAVEC))*PSTACK (JLON, IPSTPT_ZDWNDP+JLEV+1-(1))
  ENDDO

  IF(YRPHY0%NCVENTR == 1) THEN
!   Isolate log (may not vectorize)
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZTLE_ARR)=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))-PLH(JLON, &
      & JLEV)*PQLIS(JLON,JLEV)/PCP(JLON,JLEV)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-PSTACK (JLON, IPSTPT_ZTLE_ARR)))
      PSTACK (JLON, IPSTPT_ZEW_TLE)=FOEW(PSTACK (JLON, IPSTPT_ZTLE_ARR),ZDELTA)
      PSTACK (JLON, IPSTPT_ZTLN_ARR)=PTU(JLON,JLEV)-PSTACK (JLON, IPSTPT_ZLH)*&
      &  PSTACK (JLON, IPSTPT_ZLN)/PSTACK (JLON, IPSTPT_ZCP)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-PSTACK (JLON, IPSTPT_ZTLN_ARR)))
      PSTACK (JLON, IPSTPT_ZEW_TLN)=FOEW(PSTACK (JLON, IPSTPT_ZTLN_ARR),ZDELTA)
    ENDDO
    DO JLON=KIDIA,KFDIA

      ! -------------------------------------------------
      ! // ENTRAINMENT AFTER GUEREMY TELLUS 2011.
      ! // DETERMINE ENTRAINED VS DETRAINED PART VIA A BUOYANCY SORTING APPROACH.
      ! -------------------------------------------------

      IDOMDP=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,&
      & PSTACK (JLON, IPSTPT_ZDWNDP+JLEV-(1)))))

      IVVN=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,     &
      &  PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))*&
      &  PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1))-YRPHY0%VVN)))
      IVVX=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,     &
      &  PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))*&
      &  PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1))-YRPHY0%VVX)))

      ! TURBULENT ENTRAINMENT AS A FUNCTION OF VERTICAL VELOCITY AND Z.

      ZEPS_TURL=PSTACK (JLON, IPSTPT_ZMOD+JLEV-(1))*(ZENTR+(ZENTRX-ZENTR)*SIN( &
      & RPI/2.0_JPRB*MAX(0.0_JPRB,MIN(1.0_JPRB ,((YRPHY0%VVX-                  &
      &  PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1)))/(YRPHY0%VVX-YRPHY0%VVN)))))**2)
      ZEPS_TURL=IVVN*ZENTRX+(1-IVVN)*IVVX*ZEPS_TURL+(1-IVVX)*ZENTR

      INUA=KNLAB(JLON,JLEV+1)
      PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1))=(1-IDOMDP)*                       &
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV+1-(1)) +IDOMDP*(INUA*MIN(ZEPS_TURL, &
      & PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV+1-(1))) +(1-INUA)*ZEPS_TURL)

      PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=&
      & PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1)) *YRPHY0%RKDN/ZENTR

      ZENTR_TUR=PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1))*PR(JLON,JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV)
      IVVER=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,&
      & PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))+0.0_JPRB)))
      ZENTRO=-IVVER/MIN(-ZEPS0,PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1)))*&
      &  PSTACK (JLON, IPSTPT_ZDWNDP+JLEV-(1)) +(1-IVVER)*ZENTR_TUR

      ZEPS_ORG0=MAX(ABS(ZENTRO),ZENTR_TUR)

      ZESP=PSTACK (JLON, IPSTPT_ZEW_TLE)/PAPRSF(JLON,JLEV)
      ZQSTLE=FOQS(ZESP)
      ZESP=PSTACK (JLON, IPSTPT_ZEW_TLN)/PAPRSF(JLON,JLEV)
      ZQSTLN=FOQS(ZESP)
      ZSN=PQU(JLON,JLEV)+PSTACK (JLON, IPSTPT_ZLN)-ZQSTLN
      ZSE=PQ(JLON,JLEV)+PQLIS(JLON,JLEV)-ZQSTLE
      ZCHIS=ZSN/(ZSN-ZSE)
      ZCHIS=MIN(1.0_JPRB,MAX(0.0_JPRB,ZCHIS))
      ICHIS=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-ZCHIS+0.0_JPRB)))
      ZTVLN=PSTACK (JLON, IPSTPT_ZTLN_ARR)*(1.0_JPRB+RETV*(PQU(JLON,JLEV)+&
      &  PSTACK (JLON, IPSTPT_ZLN)))
      ZTVLE=PSTACK (JLON, IPSTPT_ZTLE_ARR)*(1.0_JPRB+RETV*(PQ(JLON,JLEV)+PQLIS(&
      & JLON,JLEV)))
      ZNCHI0=MAX(0.0_JPRB,PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-ZTVLE)
      ZDCHI0=MAX(ZEPS0,PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-(1.0_JPRB-ZCHIS)*&
      & ZTVLN-ZCHIS*ZTVLE)
      ZCHI0=ZCHIS*ZNCHI0/ZDCHI0
      ZCHI0=ICHIS*ZCHI0+(1-ICHIS)*1.0_JPRB
      ZCHI0=IVVER*MIN(1.0_JPRB,MAX(0.0_JPRB,MIN(ZCHI0,0.5_JPRB*(1.0_JPRB+ZENTRO/ &
         &ZEPS_ORG0))))&
         &+(1-IVVER)*1.0_JPRB
      IENTR=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZENTRO-YRPHY0%FENTRT*ZENTR_TUR)))
      ZCHI0=IENTR*1.0_JPRB+(1-IENTR)*ZCHI0

      ZCHI02=ZCHI0**2
      PSTACK (JLON, IPSTPT_ZEPS_ORG+JLEV-(1))=YRPHY0%GCVRE*&
      &  PSTACK (JLON, IPSTPT_ZMOD+JLEV-(1))*MAX(ZEPS_ORG0*ZCHI02,ZEPS0)
      PSTACK (JLON, IPSTPT_ZDEL_ORG+JLEV-(1))=YRPHY0%GCVRE*                     &
      &  PSTACK (JLON, IPSTPT_ZMOD+JLEV-(1))*MAX(ZEPS_ORG0*(1.0_JPRB-ZCHI0)**2, &
      & ZEPS0)

      ! -------------------------------------------------
      ! CHANGE UNIT: ZEPSILON_U AND ZDELTA_U IN M**-1.
      ! -------------------------------------------------

      PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=(                             &
      &  PSTACK (JLON, IPSTPT_ZEPS_ORG+JLEV-(1))*PAPRSF(JLON,JLEV) /(PR(JLON, &
      & JLEV )*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))+                            &
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1)))*RG
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))=(                               &
      &  PSTACK (JLON, IPSTPT_ZDEL_ORG+JLEV-(1))*PAPRSF(JLON,JLEV) /(PR(JLON, &
      & JLEV )*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))+                            &
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1)))*RG
    ENDDO

  ELSEIF(YRPHY0%NCVENTR == 3) THEN
    DO JLON=KIDIA,KFDIA

      ! -------------------------------------------------
      ! // ENTRAINMENT AFTER RIO ET AL. 2010.
      ! -------------------------------------------------

      ZTVNL=PTU(JLON,JLEV)*(1.0_JPRB+RETV*PQU(JLON,JLEV)-&
      & PSTACK (JLON, IPSTPT_ZLN))
      ZTVEL=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))*(1.0_JPRB+RETV*PQ(JLON,JLEV))
      PSTACK (JLON, IPSTPT_ZBUOY+JLEV-(1))=RG*(1._JPRB-ZTVEL/ZTVNL)
      ZBETA1RIO=0.9_JPRB
      ZA1RIO=0.67_JPRB
      ZBRIO=0.002_JPRB
      ZCRIO=0.012_JPRB

      ! -------------------------------------------------
      ! ENTRAINMENT IN M**-1 AND AERODYNAMIC DRAG IN Pa**-1
      ! -------------------------------------------------

      PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=MAX(0._JPRB,(ZA1RIO*&
      &  PSTACK (JLON, IPSTPT_ZBUOY+JLEV-(1)) /(MAX(1._JPRB,        &
      & PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))))**2-ZBRIO)/(1._JPRB+ZBETA1RIO))
      PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=MAX(ZENTR*RG,MIN(ZENTRX*RG, &
      & PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))))
      PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=YRPHY0%ADOE*               &
      &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))/RG*PR(JLON,JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV)

      ! -------------------------------------------------
      ! DETRAINMENT.
      ! -------------------------------------------------

      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))=MAX(0._JPRB,-ZA1RIO*ZBETA1RIO/(1._JPRB&
      &  +ZBETA1RIO) *PSTACK (JLON, IPSTPT_ZBUOY+JLEV-(1))/(MAX(1._JPRB,            &
      & PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))))**2)
      PSTACK (JLON, IPSTPT_ZENTR_T_LOC+JLEV-(1))=ZCRIO*SQRT(MAX(0._JPRB,PQU(JLON, &
      & JLEV)-PQ(JLON,JLEV)) /MAX(1.E-4_JPRB,PQU(JLON,JLEV))/(MAX(1._JPRB,        &
      & PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))))**2)
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))=   &
      &  PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))+&
      &  PSTACK (JLON, IPSTPT_ZENTR_T_LOC+JLEV-(1))
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))=MAX(ZENTR*RG,MIN(ZENTRX*RG, &
      & PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))))
    ENDDO

  ELSEIF(YRPHY0%NCVENTR == 5) THEN
    DO JLON=KIDIA,KFDIA

      ! -------------------------------------------------
      ! UNIFORM ENTRAINMENT / DETRAINMENT.
      ! -------------------------------------------------


      ! -------------------------------------------------
      ! FRACTIONAL ENTRAINMENT/DETRAINMENT (IN M**-1, TO BE APPLIED DURING A DIAGNOSTIC ASCENT)
      ! AND AERODYNAMIC DRAG IN Pa**-1
      ! -------------------------------------------------

      PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=ZENTRX
      PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=YRPHY0%ADOE*               &
      &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))/RG*PR(JLON,JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV)
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))= &
      & PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))
    ENDDO

  ELSEIF(YRPHY0%NCVENTR == 6) THEN
    DO JLON=KIDIA,KFDIA

      ! -------------------------------------------------
      ! ENTRAINMENT / DETRAINMENT "V1" AS IN PIRIOU PHD 2005.
      ! -------------------------------------------------


      ! -------------------------------------------------
      ! FRACTIONAL ENTRAINMENT/DETRAINMENT (IN M**-1, TO BE APPLIED DURING A DIAGNOSTIC ASCENT)
      ! AND AERODYNAMIC DRAG IN Pa**-1
      ! -------------------------------------------------

      IF(PAPRSF(JLON,JLEV) < 35000.) THEN
         PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=1.2E-4
      ELSEIF(PAPRSF(JLON,JLEV) > 82000. ) THEN
         PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=6.0E-4
      ELSE
         PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=1.2E-4+(6.0E-4-1.2E-4)*(&
         & PAPRSF(JLON,JLEV)-35000.)/(82000.-35000.)
      ENDIF
      PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=YRPHY0%ADOE*               &
      &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))/RG*PR(JLON,JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV)
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))= &
      & PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))
    ENDDO

  ELSEIF(YRPHY0%NCVENTR == 7) THEN
    DO JLON=KIDIA,KFDIA

      ! -------------------------------------------------
      ! ENTRAINMENT / DETRAINMENT "V1DEV", SAME SHAPE AS IN PIRIOU PHD 2005,
      ! BUT DIFFERENT MAGNITUDE.
      ! -------------------------------------------------

      ! -------------------------------------------------
      ! FRACTIONAL ENTRAINMENT/DETRAINMENT (IN M**-1, TO BE APPLIED DURING A DIAGNOSTIC ASCENT).
      ! -------------------------------------------------

      IF(PAPRSF(JLON,JLEV) < 35000.) THEN
         PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=YRPHY0%GCVENTRN
      ELSEIF(PAPRSF(JLON,JLEV) > 82000. ) THEN
         PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=YRPHY0%GCVENTRX
      ELSE
         PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=YRPHY0%GCVENTRN+(YRPHY0%&
         & GCVENTRX-YRPHY0%GCVENTRN)*(PAPRSF(JLON,JLEV)-35000.) /(82000.-35000.)
      ENDIF
      PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=YRPHY0%ADOE*               &
      &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))/RG*PR(JLON,JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV)
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))= &
      & PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))
    ENDDO

  ELSEIF(YRPHY0%NCVENTR == 16) THEN
    DO JLON=KIDIA,KFDIA

      ! -------------------------------------------------
      ! // UNIFORM TURBULENT ENTRAINMENT.
      ! // FRICTION FUNCTION OF ZRE.
      ! // ORGANIZED ENTRAINMENT AFTER GUEREMY TELLUS 2011.
      ! // DETERMINE ENTRAINED VS DETRAINED PART VIA A BUOYANCY SORTING APPROACH.
      ! -------------------------------------------------

      ! TURBULENT ENTRAINMENT.
      PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1))=ZENTRX ! ZENTRX and ZEPS_TUR are in (J/kg)**-1.
      PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=                                  &
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1)) *YRPHY0%ADOE/             &
      &  PSTACK (JLON, IPSTPT_ZRE+JLEV-(1))**YRPHY0%GEXPKD *PR(JLON, JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV) ! ZKD is in Pa**-1.
      ZENTR_TUR=PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1))*PR(JLON,JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV) ! ZENTR_TUR is in Pa**-1.

      IVVER=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,&
      & PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))+0.0_JPRB)))
      ZENTRO=-IVVER/MIN(-ZEPS0,PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1)))*&
      &  PSTACK (JLON, IPSTPT_ZDWNDP+JLEV-(1)) +(1-IVVER)*ZENTR_TUR

      ZEPS_ORG0=MAX(ABS(ZENTRO),ZENTR_TUR)

      ZTLN=PTU(JLON,JLEV)-PSTACK (JLON, IPSTPT_ZLH)*PSTACK (JLON, IPSTPT_ZLN)/&
      &  PSTACK (JLON, IPSTPT_ZCP)
      ZTLE=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))-PLH(JLON,JLEV)*PQLIS(JLON,JLEV)/PCP&
      & (JLON,JLEV)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTLE))
      ZEW=FOEW(ZTLE,ZDELTA)
      ZESP=ZEW/PAPRSF(JLON,JLEV)
      ZQSTLE=FOQS(ZESP)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTLN))
      ZEW=FOEW(ZTLN,ZDELTA)
      ZESP=ZEW/PAPRSF(JLON,JLEV)
      ZQSTLN=FOQS(ZESP)
      ZSN=PQU(JLON,JLEV)+PSTACK (JLON, IPSTPT_ZLN)-ZQSTLN
      ZSE=PQ(JLON,JLEV)+PQLIS(JLON,JLEV)-ZQSTLE
      ZCHIS=ZSN/(ZSN-ZSE)
      ZCHIS=MIN(1.0_JPRB,MAX(0.0_JPRB,ZCHIS))
      ICHIS=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-ZCHIS+0.0_JPRB)))
      ZTVLN=ZTLN*(1.0_JPRB+RETV*(PQU(JLON,JLEV)+PSTACK (JLON, IPSTPT_ZLN)))
      ZTVLE=ZTLE*(1.0_JPRB+RETV*(PQ(JLON,JLEV)+PQLIS(JLON,JLEV)))
      ZNCHI0=MAX(0.0_JPRB,PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-ZTVLE)
      ZDCHI0=MAX(ZEPS0,PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-(1.0_JPRB-ZCHIS)*&
      & ZTVLN-ZCHIS*ZTVLE)
      ZCHI0=ZCHIS*ZNCHI0/ZDCHI0
      ZCHI0=ICHIS*ZCHI0+(1-ICHIS)*1.0_JPRB
      ZCHI0=IVVER*MIN(1.0_JPRB,MAX(0.0_JPRB,MIN(ZCHI0,0.5_JPRB*(1.0_JPRB+ZENTRO/ &
         &ZEPS_ORG0))))&
         &+(1-IVVER)*1.0_JPRB
      IENTR=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZENTRO-YRPHY0%FENTRT*ZENTR_TUR)))
      ZCHI0=IENTR*1.0_JPRB+(1-IENTR)*ZCHI0

      ZCHI02=ZCHI0**2
      PSTACK (JLON, IPSTPT_ZEPS_ORG+JLEV-(1))=YRPHY0%GCVRE*&
      &  PSTACK (JLON, IPSTPT_ZMOD+JLEV-(1))*MAX(ZEPS_ORG0*ZCHI02,ZEPS0)
      PSTACK (JLON, IPSTPT_ZDEL_ORG+JLEV-(1))=YRPHY0%GCVRE*                     &
      &  PSTACK (JLON, IPSTPT_ZMOD+JLEV-(1))*MAX(ZEPS_ORG0*(1.0_JPRB-ZCHI0)**2, &
      & ZEPS0)

      PSTACK (JLON, IPSTPT_ZDIAG_EPS_ORG+JLEV-(1))=                           &
      &  PSTACK (JLON, IPSTPT_ZEPS_ORG+JLEV-(1)) *PAPRSF(JLON,JLEV)/(PR(JLON, &
      & JLEV )*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))*RG
      PSTACK (JLON, IPSTPT_ZDIAG_EPS_TUR+JLEV-(1))=&
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1))*RG

      ! -------------------------------------------------
      ! CHANGE UNIT: ZEPSILON_U AND ZDELTA_U IN M**-1.
      ! -------------------------------------------------

      PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=(                             &
      &  PSTACK (JLON, IPSTPT_ZEPS_ORG+JLEV-(1))*PAPRSF(JLON,JLEV) /(PR(JLON, &
      & JLEV )*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))+                            &
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1)))*RG
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))=((                              &
      &  PSTACK (JLON, IPSTPT_ZDEL_ORG+JLEV-(1))*PAPRSF(JLON,JLEV) /(PR(JLON, &
      & JLEV )*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))+                            &
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1)))*RG)*YRPHY0%GCHI0
    ENDDO

  ELSEIF(YRPHY0%NCVENTR == 17) THEN
   DO JLON=KIDIA,KFDIA

      ! -------------------------------------------------
      ! UNIFORM ENTRAINMENT / DETRAINMENT.
      ! -------------------------------------------------


      ! -------------------------------------------------
      ! FRACTIONAL ENTRAINMENT/DETRAINMENT (IN M**-1, TO BE APPLIED DURING A DIAGNOSTIC ASCENT)
      ! AND AERODYNAMIC DRAG IN Pa**-1
      ! -------------------------------------------------

      PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=ZENTRX*RG
      PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=YRPHY0%ADOE**(1._JPRB+     &
      &  PSTACK (JLON, IPSTPT_ZDEPTH)/7000._JPRB*24._JPRB) *        &
      &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))/RG*PR(JLON,JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV)
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))= &
      & PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))
    ENDDO
  ELSEIF(YRPHY0%NCVENTR == 19) THEN
    DO JLON=KIDIA,KFDIA

      ! -------------------------------------------------
      ! // Turbulent entrainment depending on
      ! // * height
      ! // * kinetic energy of the downdraft.
      ! // ORGANIZED ENTRAINMENT AFTER GUEREMY TELLUS 2011.
      ! // DETERMINE ENTRAINED VS DETRAINED PART VIA A BUOYANCY SORTING APPROACH.
      ! -------------------------------------------------

      ! Uniform ZRE, linked to saturation deficit integrated in the vertical.
      !ZRE_SATDEF(JLON,JLEV)=GREMIN+(GREMAX-GREMIN) &
      !  & *MAX(0._JPRB,MIN(1._JPRB,(ZSATDEF(JLON)-GSDMIN)/(GSDMAX-GSDMIN)))

      ! Local ZRE, linked to local saturation deficit.
      PSTACK (JLON, IPSTPT_ZRE_SATDEF+JLEV-(1))=YRPHY0%GREMIN+(YRPHY0%GREMAX-   &
      & YRPHY0%GREMIN) *MAX(0._JPRB,MIN(1._JPRB,(PQSAT(JLON,JLEV)-PQ(JLON,JLEV)-&
      & YRPHY0%GSDMIN) /(YRPHY0%GSDMAX-YRPHY0%GSDMIN)))

      ! Height (above surface) in m.
      ZHEIGHT=(PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))-PAPHI(JLON,KLEV))/RG

      ! Reduction factor of entrainment, due to height.
      !ZRE_HEIGHT(JLON,JLEV)=1._JPRB/MAX(1._JPRB,ZHEIGHT/1000._JPRB)
      PSTACK (JLON, IPSTPT_ZRE_HEIGHT+JLEV-(1))=1.

      ! Reduction factor (ZRE_KEDD) of entrainment, due to kinetic energy of the downdraft.
      PSTACK (JLON, IPSTPT_ZRE_KEDD+JLEV-(1))=1._JPRB/(1._JPRB+YRPHY0%GKEDDRE*&
      &  PSTACK (JLON, IPSTPT_ZKEDD))

      ! The reduction factor that will be applied to turbulent and organized
      ! entrainement and detrainement is the product of all reduction factors.
      PSTACK (JLON, IPSTPT_ZRE+JLEV-(1))=          &
      &  PSTACK (JLON, IPSTPT_ZRE_SATDEF+JLEV-(1))*&
      &  PSTACK (JLON, IPSTPT_ZRE_HEIGHT+JLEV-(1))*&
      &  PSTACK (JLON, IPSTPT_ZRE_KEDD+JLEV-(1))

      ! TURBULENT ENTRAINMENT.
      ! ZENTRX and ZEPS_TUR are in (J/kg)**-1.
      PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1))=ZENTRX
      PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=                                  &
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1)) *YRPHY0%ADOE/             &
      &  PSTACK (JLON, IPSTPT_ZRE+JLEV-(1))**YRPHY0%GEXPKD *PR(JLON, JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV) ! ZKD is in Pa**-1.
      ZENTR_TUR=PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1))*PR(JLON,JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV) ! ZENTR_TUR is in Pa**-1.

      IVVER=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,PUDOM(JLON,JLEV)+0.0_JPRB)))
      ZDELPF=PAPRSF(JLON,JLEV+1)-PAPRSF(JLON,JLEV)
      PSTACK (JLON, IPSTPT_ZDWNDP+JLEV-(1))=(PUDOM(JLON,JLEV+1)-PUDOM(JLON,JLEV)&
      & )/ZDELPF
      ZENTRO=-IVVER/MIN(-ZEPS0,PUDOM(JLON,JLEV))*&
      & PSTACK (JLON, IPSTPT_ZDWNDP+JLEV-(1)) +(1-IVVER)*ZENTR_TUR

      ZEPS_ORG0=MAX(ABS(ZENTRO),ZENTR_TUR)

      ZTLN=PTU(JLON,JLEV)-PSTACK (JLON, IPSTPT_ZLH)*PSTACK (JLON, IPSTPT_ZLN)/&
      &  PSTACK (JLON, IPSTPT_ZCP)
      ZTLE=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))-PLH(JLON,JLEV)*PQLIS(JLON,JLEV)/PCP&
      & (JLON,JLEV)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTLE))
      ZEW=FOEW(ZTLE,ZDELTA)
      ZESP=ZEW/PAPRSF(JLON,JLEV)
      ZQSTLE=FOQS(ZESP)
      ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTLN))
      ZEW=FOEW(ZTLN,ZDELTA)
      ZESP=ZEW/PAPRSF(JLON,JLEV)
      ZQSTLN=FOQS(ZESP)
      ZSN=PQU(JLON,JLEV)+PSTACK (JLON, IPSTPT_ZLN)-ZQSTLN
      ZSE=PQ(JLON,JLEV)+PQLIS(JLON,JLEV)-ZQSTLE
      ZCHIS=ZSN/(ZSN-ZSE)
      ZCHIS=MIN(1.0_JPRB,MAX(0.0_JPRB,ZCHIS))
      ICHIS=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-ZCHIS+0.0_JPRB)))
      ZTVLN=ZTLN*(1.0_JPRB+RETV*(PQU(JLON,JLEV)+PSTACK (JLON, IPSTPT_ZLN)))
      ZTVLE=ZTLE*(1.0_JPRB+RETV*(PQ(JLON,JLEV)+PQLIS(JLON,JLEV)))
      ZNCHI0=MAX(0.0_JPRB,PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-ZTVLE)
      ZDCHI0=MAX(ZEPS0,PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-(1.0_JPRB-ZCHIS)*&
      & ZTVLN-ZCHIS*ZTVLE)
      ZCHI0=ZCHIS*ZNCHI0/ZDCHI0
      ZCHI0=ICHIS*ZCHI0+(1-ICHIS)*1.0_JPRB
      ZCHI0=IVVER*MIN(1.0_JPRB,MAX(0.0_JPRB,MIN(ZCHI0,0.5_JPRB*(1.0_JPRB+ZENTRO/ &
        &ZEPS_ORG0))))&
        &+(1-IVVER)*1.0_JPRB
      IENTR=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,ZENTRO-YRPHY0%FENTRT*ZENTR_TUR)))
      ZCHI0=IENTR*1.0_JPRB+(1-IENTR)*ZCHI0

      ZCHI02=ZCHI0**2
      PSTACK (JLON, IPSTPT_ZEPS_ORG+JLEV-(1))=YRPHY0%GCVRE*&
      &  PSTACK (JLON, IPSTPT_ZMOD+JLEV-(1))*MAX(ZEPS_ORG0*ZCHI02,ZEPS0)
      PSTACK (JLON, IPSTPT_ZDEL_ORG+JLEV-(1))=YRPHY0%GCVRE*                     &
      &  PSTACK (JLON, IPSTPT_ZMOD+JLEV-(1))*MAX(ZEPS_ORG0*(1.0_JPRB-ZCHI0)**2, &
      & ZEPS0)

      PSTACK (JLON, IPSTPT_ZDIAG_EPS_ORG+JLEV-(1))=                           &
      &  PSTACK (JLON, IPSTPT_ZEPS_ORG+JLEV-(1)) *PAPRSF(JLON,JLEV)/(PR(JLON, &
      & JLEV )*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))*RG
      PSTACK (JLON, IPSTPT_ZDIAG_EPS_TUR+JLEV-(1))=&
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1))*RG

      ! -------------------------------------------------
      ! CHANGE UNIT: ZEPSILON_U AND ZDELTA_U IN M**-1.
      ! -------------------------------------------------

      PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=(                             &
      &  PSTACK (JLON, IPSTPT_ZEPS_ORG+JLEV-(1))*PAPRSF(JLON,JLEV) /(PR(JLON, &
      & JLEV )*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))+                            &
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1)))*RG
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))=((                              &
      &  PSTACK (JLON, IPSTPT_ZDEL_ORG+JLEV-(1))*PAPRSF(JLON,JLEV) /(PR(JLON, &
      & JLEV )*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))+                            &
      &  PSTACK (JLON, IPSTPT_ZEPS_TUR+JLEV-(1)))*RG)*YRPHY0%GCHI0
    ENDDO

  ELSE

    ! NCVENTR not recognized. Entrainment and detrainment set to 0.
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=0._JPRB
      PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=0._JPRB
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))=0._JPRB
    ENDDO
  ENDIF

  ! -------------------------------------------------
  ! The reducing factor ZRE is applied to the total entrainment and detrainment.
  ! -------------------------------------------------
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=&
    &  PSTACK (JLON, IPSTPT_ZRE+JLEV-(1)) *   &
    &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=PSTACK (JLON, IPSTPT_ZRE+JLEV-(1))*&
    &  PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))=PSTACK (JLON, IPSTPT_ZRE+JLEV-(1))*&
    &  PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))
  ENDDO

  IF(YRPHY0%LCVEOD) THEN

    ! -------------------------------------------------
    ! Entrainment Outside Draft (EOD) is set to a large value.
    ! "Outside Draft" means here "where vertical velocity is below a given threshold".
    ! ZBINID is the binary indicateur of Inside Draft.
    ! -------------------------------------------------
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=             &
      &  PSTACK (JLON, IPSTPT_ZBINID+JLEV-(1))*              &
      &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1)) +(1._JPRB-&
      &  PSTACK (JLON, IPSTPT_ZBINID+JLEV-(1)))*ZENTRX*RG
      PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=PSTACK (JLON, IPSTPT_ZBINID+JLEV-(1))*&
      &  PSTACK (JLON, IPSTPT_ZKD+JLEV-(1)) +(1._JPRB-                         &
      &  PSTACK (JLON, IPSTPT_ZBINID+JLEV-(1)))*ZENTRX *PR(JLON,JLEV)*         &
      &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV)
      PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))=             &
      &  PSTACK (JLON, IPSTPT_ZBINID+JLEV-(1))*            &
      &  PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1)) +(1._JPRB-&
      &  PSTACK (JLON, IPSTPT_ZBINID+JLEV-(1)))*ZENTRX*RG
    ENDDO

  ENDIF

  ! -------------------------------------------------
  ! In case of NH approach, entrainment above LNB is set to a large value.
  ! -------------------------------------------------
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=             &
    &  PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1))*             &
    &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1)) +(1._JPRB-&
    &  PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1)))*ZENTRX*RG
    PSTACK (JLON, IPSTPT_ZKD+JLEV-(1))=PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1))*&
    &  PSTACK (JLON, IPSTPT_ZKD+JLEV-(1)) +(1._JPRB-                          &
    &  PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1)))*ZENTRX *PR(JLON,JLEV)*         &
    &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/PAPRSF(JLON,JLEV)
    PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))=             &
    &  PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1))*           &
    &  PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1)) +(1._JPRB-&
    &  PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1)))*ZENTRX*RG
  ENDDO

    ! -------------------------------------------------
    ! // INTEGRATE SIGMA IN THE VERTICAL.
    ! -------------------------------------------------

  IF(YRPHY0%NCVSIG == 1 .OR. YRPHY0%NCVSIG == 2) THEN
!   Isolate Log (may not vectorize)
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZLOGSIGMA)=LOG(MAX(1.0E-15_JPRB, &
      & PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-(0))))
    ENDDO
    DO JLON=KIDIA,KFDIA
      IVVER=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,&
      & PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))+0.0_JPRB)))
      ZDLOGM=(PSTACK (JLON, IPSTPT_ZEPS_ORG+JLEV-(1))-&
      &  PSTACK (JLON, IPSTPT_ZDEL_ORG+JLEV-(1)))/YRPHY0%GCVRE
      PSTACK (JLON, IPSTPT_ZEMD_DIAG+JLEV-1-(1))=  &
      &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))-&
      &  PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1))
      PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0))=REAL(IVVER)*(EXP(          &
      &  PSTACK (JLON, IPSTPT_ZLOGSIGMA) +PDELP(JLON,JLEV)*(ZDLOGM+IVVER*&
      &  PSTACK (JLON, IPSTPT_ZDWNDP+JLEV-(1)) *                         &
      &  PSTACK (JLON, IPSTPT_ZRE+JLEV-(1))/MIN(-ZEPS0,                  &
      & PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))))) ) +REAL(1-IVVER)*1.0_JPRB
    ENDDO
  ENDIF
! Isolate Log (may not vectorize)
  DO JLON=KIDIA,KFDIA
    ZTD=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))*(1.0_JPRB+(PSTACK (JLON, IPSTPT_ZLN)- &
    & RETV*(PQSAT(JLON,JLEV) -PQ(JLON,JLEV)))/(1.0_JPRB+RETV*PLH(JLON,JLEV)*    &
    & PQSAT(JLON,JLEV) /(RV*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))))
    ZDELTA=MAX(0.0_JPRB,SIGN(1.0_JPRB,RTT-ZTD))
    PSTACK (JLON, IPSTPT_ZEW_TLE)=FOEW (ZTD,ZDELTA)
  ENDDO

  IF(YRPHY0%NCVSIG == 1) THEN
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0))=MAX(ZEPS0,MIN( &
      & PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0)),             &
      & PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-(0))))
    ENDDO
  ELSEIF(YRPHY0%NCVSIG == 2) THEN
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0))=MAX(ZEPS0,MIN(1.0_JPRB, &
      & PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0))))
    ENDDO
  ELSE
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0))=1.
    ENDDO
  ENDIF

  DO JLON=KIDIA,KFDIA

    KSTACK (JLON, IKSTPT_ICDN)=MAX(0,-ISIGN(1,-&
    &  KSTACK (JLON, IKSTPT_INCDN+JLEV-(1))))
    KSTACK (JLON, IKSTPT_IBAC)=MAX(0,-ISIGN(1,-&
    &  KSTACK (JLON, IKSTPT_INIVBAC+JLEV+1-(1))))
    KSTACK (JLON, IKSTPT_IKUO5)=MAX(0,ISIGN(1, KSTACK (JLON, IKSTPT_IBAC)*      &
    &  KSTACK (JLON, IKSTPT_INIVBAC+JLEV+1-(1))+(1-KSTACK (JLON, IKSTPT_IBAC)) -&
    &  KSTACK (JLON, IKSTPT_ILEVTEN)))
    KSTACK (JLON, IKSTPT_IKUO6)=MAX(NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,          &
    &  PSTACK (JLON, IPSTPT_ZVVER+JLEV-1-(0))+0.0_JPRB))) ,NINT(MAX(0.0_JPRB,- &
    & SIGN(1.0_JPRB,PSTACK (JLON, IPSTPT_ZVVER+JLEV-(0))+0.0_JPRB))))

    ! KNLAB(JLON,JLEV)=0 IF ASCENT BASE ABOVE THETAE MINIMUM
    KNLAB(JLON,JLEV)=KSTACK (JLON, IKSTPT_IKUO6)*KSTACK (JLON, IKSTPT_IBAC)*&
    &  KSTACK (JLON, IKSTPT_IKUO5)
    PQLIC(JLON,JLEV)=PQLIC(JLON,JLEV)*KNLAB(JLON,JLEV)*&
    & KSTACK (JLON, IKSTPT_ICDN)

    ! // FINAL VALUES OF DETRAINMENT.
    ZESP=PSTACK (JLON, IPSTPT_ZEW_TLE)/PAPRSF(JLON,JLEV)
    ZQW=FOQS(ZESP)
    ZTD=KSTACK (JLON, IKSTPT_ICDN)*(YRPHY0%GCVADET*ZTD+(1.0_JPRB-YRPHY0%GCVADET)&
    &  *PTU(JLON,JLEV))+(1-KSTACK (JLON, IKSTPT_ICDN))*PTU(JLON,JLEV)
    ZQW=KSTACK (JLON, IKSTPT_ICDN)*(YRPHY0%GCVADET*ZQW+(1.0_JPRB-YRPHY0%GCVADET)&
    &  *PQU(JLON,JLEV))+(1-KSTACK (JLON, IKSTPT_ICDN))*PQU(JLON,JLEV)

    PSTACK (JLON, IPSTPT_ZQDN+JLEV-(1))=ZQW
    PSTACK (JLON, IPSTPT_ZSDN+JLEV-(1))=(RCPD+ZCPVMD*ZQW)*ZTD+&
    &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))

    ! // IN CASE OF UNBUOYANT PARCEL ONE SETS THE STATE TO THAT OF THE ENVIRONMENT.
    INUA=KNLAB(JLON,JLEV)
    KSTACK (JLON, IKSTPT_INIVBAC+JLEV-(1))=MAX( &
    & KSTACK (JLON, IKSTPT_INIVBAC+JLEV+1-(1)),JLEV)
    KSTACK (JLON, IKSTPT_INIVBAC+JLEV-(1))=INUA*&
    &  KSTACK (JLON, IKSTPT_INIVBAC+JLEV-(1))+(1-INUA)*JLEV
    KSTACK (JLON, IKSTPT_INIVBAC+JLEV+1-(1))=INUA*&
    &  KSTACK (JLON, IKSTPT_INIVBAC+JLEV+1-(1))
    KSTACK (JLON, IKSTPT_INLFC+JLEV-(1))=INUA*&
    &  KSTACK (JLON, IKSTPT_INLFC+JLEV-(1))

    PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))=INUA*       &
    &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))+(1-INUA)*&
    &  PSTACK (JLON, IPSTPT_ZEPSILON_U+KLEV-(1))
    PSTACK (JLON, IPSTPT_ZVVER+JLEV-1-(0))=INUA*&
    &  PSTACK (JLON, IPSTPT_ZVVER+JLEV-1-(0))
    IF(YRPHY0%LGVVEX) PSTACK (JLON, IPSTPT_ZVVER+JLEV-1-(0))=                      &
                      &  PSTACK (JLON, IPSTPT_ZVVER+JLEV-1-(0))-(1-INUA)*YRPHY0    &
                      &  % GCVWEXC *SQRT(MAX(0._JPRB,2._JPRB/3._JPRB*MIN(5.0_JPRB, &
                      &  PTKE(JLON,JLEV-1)))) *RG*PAPRS(JLON,JLEV-1)/(PR(JLON,     &
                      & JLEV)*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))
    PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))=INUA*       &
    &  PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))+(1-INUA)*&
    &  PSTACK (JLON, IPSTPT_ZVVER+JLEV-1-(0))
    IF(YRPHY0%NCVSIG == 0) THEN
      PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0))=1.
    ELSE
      PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0))=INUA*&
      &  PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0))+(1-INUA)*1.0_JPRB
    ENDIF
    PTU(JLON,JLEV)=INUA*PTU(JLON,JLEV)+(1-INUA)*&
    & PSTACK (JLON, IPSTPT_ZT+JLEV-(1))
    PQU(JLON,JLEV)=INUA*PQU(JLON,JLEV)+(1-INUA)*PQ(JLON,JLEV)

    PSU(JLON,JLEV)=(RCPD+ZCPVMD*PQU(JLON,JLEV))*PTU(JLON,JLEV)+&
    & PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))=PSU(JLON,JLEV)

    PSTACK (JLON, IPSTPT_ZLN)=INUA*PSTACK (JLON, IPSTPT_ZLN)
    PSTACK (JLON, IPSTPT_ZQDN+JLEV-(1))=INUA*PSTACK (JLON, IPSTPT_ZQDN+JLEV-(1))&
    &  +(1-INUA)*PQ(JLON,JLEV)
    PSTACK (JLON, IPSTPT_ZSDN+JLEV-(1))=INUA*PSTACK (JLON, IPSTPT_ZSDN+JLEV-(1))&
    &  +(1-INUA)*PSTACK (JLON, IPSTPT_ZDSE+JLEV-(1))
    PSTACK (JLON, IPSTPT_ZTNH)=INUA*PSTACK (JLON, IPSTPT_ZTNH)+(1-INUA)*PTW(JLON, &
    & JLEV)
    PSTACK (JLON, IPSTPT_ZQNH)=INUA*PSTACK (JLON, IPSTPT_ZQNH)+(1-INUA)*PQW(JLON, &
    & JLEV)

    ! // SATURATION TEST AT TOP LEVEL.
    KSTACK (JLON, IKSTPT_ICDN)=NINT(MAX(0.0_JPRB,SIGN(1.0_JPRB,PQU(JLON,JLEV)-&
    & PQSAT(JLON,JLEV))))
    KSTACK (JLON, IKSTPT_INCDN+JLEV-(1))=INUA*            &
    &  KSTACK (JLON, IKSTPT_INCDN+JLEV-(1))+(1-INUA)*JLEV*&
    &  KSTACK (JLON, IKSTPT_ICDN)

    ! // MASS FLUX PROFILE.
    PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))=-1.0_JPRB*KNLAB(JLON,JLEV)*&
    &  PSTACK (JLON, IPSTPT_ZVVER+JLEV-(0)) *                       &
    &  PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-(0))

    ! SUMMATIONS.

    ZFORMV=0.5_JPRB*(PSTACK (JLON, IPSTPT_ZFORM+JLEV+1-(0))+&
    &  PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0)))
    PSTACK (JLON, IPSTPT_ZS15)=PSTACK (JLON, IPSTPT_ZS15)+KNLAB(JLON,JLEV+1)*&
    &  PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1))*PSTACK (JLON, IPSTPT_ZCAPE)
    PSTACK (JLON, IPSTPT_ZBCC_C_FULL+JLEV+1-(1))=0.5_JPRB*(&
    &  PSTACK (JLON, IPSTPT_ZBCC_C_HALF+JLEV-(0))+         &
    &  PSTACK (JLON, IPSTPT_ZBCC_C_HALF+JLEV+1-(0)))

    ZFMDQN=0.5_JPRB*PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))*((PQU(JLON,JLEV)+PQU(&
    & JLON,JLEV+1)) -(PQ(JLON,JLEV)+PQ(JLON,JLEV+1)))
    ZFMDSN=0.5_JPRB*PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))*((                     &
    &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))+PSTACK (JLON, IPSTPT_ZSU+JLEV+1-(1))) &
    & - (PSTACK (JLON, IPSTPT_ZDSE+JLEV-(1))+                                   &
    &  PSTACK (JLON, IPSTPT_ZDSE+JLEV+1-(1)) ))

    ! ZS16 = VERTICAL INTEGRAL OF DP/P FROM (dCAPE/dt) DUE TO CONVECTION.
    PSTACK (JLON, IPSTPT_ZS16)=PSTACK (JLON, IPSTPT_ZS16)+KNLAB(JLON,JLEV+1)*     &
    &  PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1)) *RD*((1.0_JPRB+RETV*PQ(JLON,JLEV+1  &
    &  ) )/PCP(JLON,JLEV+1) *(PSTACK (JLON, IPSTPT_ZFMDS)-ZFMDSN+ZFORMV*PLH(JLON, &
    &  JLEV+1) *PDELP(JLON,JLEV+1)*PSTACK (JLON, IPSTPT_ZBCC_C_FULL+JLEV+1-(1)))  &
    &  +RETV*PSTACK (JLON, IPSTPT_ZT+JLEV+1-(1))*(PSTACK (JLON, IPSTPT_ZFMDQ)-    &
    & ZFMDQN -ZFORMV*PDELP(JLON,JLEV+1)*                                          &
    &  PSTACK (JLON, IPSTPT_ZBCC_C_FULL+JLEV+1-(1))))/PAPRSF(JLON,JLEV+1)
    PSTACK (JLON, IPSTPT_ZFMDQ)=ZFMDQN
    PSTACK (JLON, IPSTPT_ZFMDS)=ZFMDSN
    ZDPLAB=KNLAB(JLON,JLEV+1)*PDELP(JLON,JLEV+1)*&
    & PSTACK (JLON, IPSTPT_ZBINBUO+JLEV-(1))
    ! ZS12: vertical extension of the updraft (in Pa).
    PSTACK (JLON, IPSTPT_ZS12)=PSTACK (JLON, IPSTPT_ZS12)+ZDPLAB
    ! ZS11: mean vertical velocity.
    PSTACK (JLON, IPSTPT_ZS11)=PSTACK (JLON, IPSTPT_ZS11)+ZDPLAB*ABS( &
    & PSTACK (JLON, IPSTPT_ZVVERDM+JLEV+1-(1)))
    PSTACK (JLON, IPSTPT_ZCAPE)=PSTACK (JLON, IPSTPT_ZCAPEL)

    PUDOM(JLON,JLEV)=PSTACK (JLON, IPSTPT_ZVVERDM+JLEV-(1))
    PUDAL(JLON,JLEV)=0._JPRB
    PDDAL(JLON,JLEV)=0._JPRB
  ENDDO

  ! VERIFICATION OF THE PRESENCE OF AT LEAST ONE CLOUD ALONG THE
  ! "JLON" VECTOR AND MODIFICATION OF ITOP IF NECESSARY.

  ISUM=0
  DO JLON=KIDIA,KFDIA
    ISUM=ISUM+KNLAB(JLON,JLEV)
  ENDDO

  IF (ISUM /= 0) THEN
    ITOP=JLEV
  ENDIF
ENDDO

IF(YRPHY0%LCVNHD) THEN

  !-------------------------------------------------
  ! Updraft and downdraft velocities are computed using coupled prognostic
  ! equations, using NH pressure-gradient terms.
  !-------------------------------------------------

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
KNLAB(JLON,JLEV) = 1
ENDDO
ENDDO


  !-------------------------------------------------
  ! Vertical smoothing of evaporation.
  !-------------------------------------------------

  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZMEAN_D+KTDIA-(1))=PEVAPO(JLON,KTDIA)
    PSTACK (JLON, IPSTPT_ZMEAN_U+KLEV-(1))=PEVAPO(JLON,KLEV)
    PSTACK (JLON, IPSTPT_ZINTEG+KTDIA-(1))=1.E-11_JPRB
  ENDDO
  ! DOWNWARD SMOOTHING.
  DO JLEV=KTDIA+1,KLEV
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZMEAN_D+JLEV-(1))=(                                 &
      &  PSTACK (JLON, IPSTPT_ZMEAN_D+JLEV-1-(1))*YRPHY0%GNHDSMOS+PEVAPO(JLON, &
      & JLEV) *(PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-1-(1))-                      &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1)))) /(YRPHY0%GNHDSMOS+           &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-1-(1))-                             &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1)))
      PSTACK (JLON, IPSTPT_ZINTEG+JLEV-(1))=      &
      &  PSTACK (JLON, IPSTPT_ZINTEG+JLEV-1-(1))+(&
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-1-(1))-&
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))) *ABS(PEVAPO(JLON,JLEV))
    ENDDO
  ENDDO
  ! UPWARD SMOOTHING.
  DO JLEV=KLEV-1,KTDIA,-1
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZMEAN_U+JLEV-(1))=(                                 &
      &  PSTACK (JLON, IPSTPT_ZMEAN_U+JLEV+1-(1))*YRPHY0%GNHDSMOS+PEVAPO(JLON, &
      & JLEV) *(PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))-                        &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV+1-(1)))) /(YRPHY0%GNHDSMOS+         &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))-                               &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV+1-(1)))
    ENDDO
  ENDDO
  ! Average upward and downward smoothings, with a weight depending on altitude.
  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      ZWEIGHT=PSTACK (JLON, IPSTPT_ZINTEG+JLEV-(1))/&
      &  PSTACK (JLON, IPSTPT_ZINTEG+KLEV-(1))
      PSTACK (JLON, IPSTPT_ZEVAPO+JLEV-(1))=ZWEIGHT*               &
      &  PSTACK (JLON, IPSTPT_ZMEAN_U+JLEV-(1)) +(1._JPRB-ZWEIGHT)*&
      &  PSTACK (JLON, IPSTPT_ZMEAN_D+JLEV-(1))
    ENDDO
  ENDDO

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA

      ! Temperature within the downdraft.
      PSTACK (JLON, IPSTPT_ZT_DOWN+JLEV-(1))=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))-        &
      & YRPHY0%GNHDEV*PSTACK (JLON, IPSTPT_ZEVAPO+JLEV-(1)) *MAX(0._JPRB,SIGN(1._JPRB, &
      & PSTACK (JLON, IPSTPT_ZDEPTH)-YRPHY0%GDEPTH))
    ENDDO
  ENDDO

  !-------------------------------------------------
  ! Updraft and downdraft prognostic equations.
  !-------------------------------------------------

  ! Tendency due to advection: direct computation.
  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWU_ADV+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWD_ADV+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZTWU_ADV+JLEV-(1))=-                                 &
      &  PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))*(PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))-&
      &  PSTACK (JLON, IPSTPT_ZWU+JLEV+1-(1))) /(                               &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))-                                &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV+1-(1)))*RG
      PSTACK (JLON, IPSTPT_ZTWD_ADV+JLEV-(1))=-                                 &
      &  PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))*(PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))-&
      &  PSTACK (JLON, IPSTPT_ZWD+JLEV+1-(1))) /(                               &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))-                                &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV+1-(1)))*RG
    ENDDO
  ENDDO

  ! Buoyancy.
  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWU_BUO+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWD_BUO+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      ! Updraft.
      ZTVNL=PTU(JLON,JLEV)*(1.0_JPRB+RETV*PQU(JLON,JLEV))
      ZTVEL=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))*(1.0_JPRB+RETV*PQ(JLON,JLEV))
      PSTACK (JLON, IPSTPT_ZTWU_BUO+JLEV-(1))=MAX(0._JPRB,RG*(ZTVNL/ZTVEL-1._JPRB&
      & ))
      ! Downdraft.
      ZTVNL=PSTACK (JLON, IPSTPT_ZT_DOWN+JLEV-(1))*(1.0_JPRB+RETV*PQ(JLON,JLEV))
      ZTVEL=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))*(1.0_JPRB+RETV*PQ(JLON,JLEV))
      PSTACK (JLON, IPSTPT_ZTWD_BUO+JLEV-(1))=MIN(0._JPRB,RG*(ZTVNL/ZTVEL-1._JPRB&
      & ))
    ENDDO
  ENDDO

  ! Dynamical production.
  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWU_DYP+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWD_DYP+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      ! Updraft.
      PSTACK (JLON, IPSTPT_ZTWU_DYP+JLEV-(1))=0._JPRB
      ! Downdraft due to precipitation evaporation. The only source term is the negative
      ! buoyancy due to this evaporation. No contribution here from dynamical production.
      PSTACK (JLON, IPSTPT_ZTWD_DYP+JLEV-(1))=0._JPRB
    ENDDO
  ENDDO

  ! Friction.
  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWU_FRI+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWD_FRI+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZTWU_FRI+JLEV-(1))=-YRPHY0%GFRIC*&
      &  PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))**2
      PSTACK (JLON, IPSTPT_ZTWD_FRI+JLEV-(1))= YRPHY0%GFRIC*&
      &  PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))**2
    ENDDO
  ENDDO


  ! Target wd: a vertical smoothing of wd + buoyancy effect.
  ! 1. Buoyancy effect.
  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZWD_PLUS_BUO+JLEV-(1))=       &
      &  PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))+YRPHY2%TSPHY*&
      &  PSTACK (JLON, IPSTPT_ZTWD_BUO+JLEV-(1))
    ENDDO
  ENDDO
  ! 2. Vertical smoothing.
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZMEAN_D+KTDIA-(1))=0._JPRB
    PSTACK (JLON, IPSTPT_ZMEAN_U+KLEV-(1))=0._JPRB
    PSTACK (JLON, IPSTPT_ZINTEG+KTDIA-(1))=ZEPSW
  ENDDO
  ! DOWNWARD SMOOTHING.
  DO JLEV=KTDIA+1,KLEV
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZMEAN_D+JLEV-(1))=(                      &
      &  PSTACK (JLON, IPSTPT_ZMEAN_D+JLEV-1-(1))*YRPHY0%GNHDSMOW+  &
      &  PSTACK (JLON, IPSTPT_ZWD_PLUS_BUO+JLEV-(1)) *(             &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-1-(1))-                  &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1)))) /(YRPHY0%GNHDSMOW+&
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-1-(1))-                  &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1)))
      PSTACK (JLON, IPSTPT_ZINTEG+JLEV-(1))=           &
      &  PSTACK (JLON, IPSTPT_ZINTEG+JLEV-1-(1))+(     &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-1-(1))-     &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))) *ABS( &
      & PSTACK (JLON, IPSTPT_ZWD_PLUS_BUO+JLEV-(1)))
    ENDDO
  ENDDO
  ! UPWARD SMOOTHING.
  DO JLEV=KLEV-1,KTDIA,-1
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZMEAN_U+JLEV-(1))=(                        &
      &  PSTACK (JLON, IPSTPT_ZMEAN_U+JLEV+1-(1))*YRPHY0%GNHDSMOW+    &
      &  PSTACK (JLON, IPSTPT_ZWD_PLUS_BUO+JLEV-(1)) *(               &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))-                      &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV+1-(1)))) /(YRPHY0%GNHDSMOW+&
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))-                      &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV+1-(1)))
    ENDDO
  ENDDO
  ! Average upward and downward smoothings, with a weight depending on altitude.
  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTARGET_WD+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWU_NHD+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWD_NHD+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      ZWEIGHT=PSTACK (JLON, IPSTPT_ZINTEG+JLEV-(1))/&
      &  PSTACK (JLON, IPSTPT_ZINTEG+KLEV-(1))
      PSTACK (JLON, IPSTPT_ZTARGET_WD+JLEV-(1))=ZWEIGHT*           &
      &  PSTACK (JLON, IPSTPT_ZMEAN_U+JLEV-(1)) +(1._JPRB-ZWEIGHT)*&
      &  PSTACK (JLON, IPSTPT_ZMEAN_D+JLEV-(1))
      PSTACK (JLON, IPSTPT_ZTWD_NHD+JLEV-(1))=(    &
      &  PSTACK (JLON, IPSTPT_ZTARGET_WD+JLEV-(1))-&
      &  PSTACK (JLON, IPSTPT_ZWD_PLUS_BUO+JLEV-(1)))/YRPHY2%TSPHY
      PSTACK (JLON, IPSTPT_ZTWU_NHD+JLEV-(1))= &
      & PSTACK (JLON, IPSTPT_ZTWD_NHD+JLEV-(1))
    ENDDO
  ENDDO

  ! Temporal integration.
  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWU_TOT_RAW+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWD_TOT_RAW+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWU_TOT+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWD_TOT+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWU_STAU+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTWD_STAU+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA

      ! Pure diagnostic.

      ! Total tendency (diagnostic).
      PSTACK (JLON, IPSTPT_ZTWU_TOT_RAW+JLEV-(1))=&
      &  PSTACK (JLON, IPSTPT_ZTWU_ADV+JLEV-(1))+ &
      &  PSTACK (JLON, IPSTPT_ZTWU_BUO+JLEV-(1)) +&
      &  PSTACK (JLON, IPSTPT_ZTWU_DYP+JLEV-(1))+ &
      &  PSTACK (JLON, IPSTPT_ZTWU_FRI+JLEV-(1))+ &
      &  PSTACK (JLON, IPSTPT_ZTWU_NHD+JLEV-(1))
      PSTACK (JLON, IPSTPT_ZTWD_TOT_RAW+JLEV-(1))=&
      &  PSTACK (JLON, IPSTPT_ZTWD_ADV+JLEV-(1))+ &
      &  PSTACK (JLON, IPSTPT_ZTWD_BUO+JLEV-(1)) +&
      &  PSTACK (JLON, IPSTPT_ZTWD_DYP+JLEV-(1))+ &
      &  PSTACK (JLON, IPSTPT_ZTWD_FRI+JLEV-(1))+ &
      &  PSTACK (JLON, IPSTPT_ZTWD_NHD+JLEV-(1))

      ! Solve temporal equation implicitly.
      ! Updraft.
      ZA=0.5_JPRB/(PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))-&
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV+1-(1)))+YRPHY0%GFRIC
      ZB=1._JPRB/YRPHY2%TSPHY
      ZC=-PSTACK (JLON, IPSTPT_ZTWU_BUO+JLEV-(1))-         &
      &  PSTACK (JLON, IPSTPT_ZTWU_DYP+JLEV-(1))-          &
      &  PSTACK (JLON, IPSTPT_ZTWU_NHD+JLEV-(1))-0.5_JPRB/(&
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1)) -          &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV+1-(1)))*        &
      &  PSTACK (JLON, IPSTPT_ZWU+JLEV+1-(1))**2.-         &
      &  PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))/YRPHY2%TSPHY
      ZD=ZB*ZB-4._JPRB*ZA*ZC
      ZWNEW=(-ZB+SQRT(MAX(0._JPRB,ZD)))/(2._JPRB*ZA)
      PSTACK (JLON, IPSTPT_ZTWU_TOT+JLEV-(1))=(ZWNEW-&
      &  PSTACK (JLON, IPSTPT_ZWU+JLEV-(1)))/YRPHY2%TSPHY
      PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))=ZWNEW
      ! Downdraft.
      ZA=0.5_JPRB/(PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1))-&
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV+1-(1)))-YRPHY0%GFRIC
      ZC=-PSTACK (JLON, IPSTPT_ZTWD_BUO+JLEV-(1))-         &
      &  PSTACK (JLON, IPSTPT_ZTWD_DYP+JLEV-(1))-          &
      &  PSTACK (JLON, IPSTPT_ZTWD_NHD+JLEV-(1))-0.5_JPRB/(&
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV-(1)) -          &
      &  PSTACK (JLON, IPSTPT_ZPHIF_U+JLEV+1-(1)))*        &
      &  PSTACK (JLON, IPSTPT_ZWD+JLEV+1-(1))**2.-         &
      &  PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))/YRPHY2%TSPHY
      ZD=ZB*ZB-4._JPRB*ZA*ZC
      ZWNEW=(-ZB+SQRT(MAX(0._JPRB,ZD)))/(2._JPRB*ZA)
      PSTACK (JLON, IPSTPT_ZTWD_TOT+JLEV-(1))=(ZWNEW-&
      &  PSTACK (JLON, IPSTPT_ZWD+JLEV-(1)))/YRPHY2%TSPHY
      PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))=ZWNEW

      ! Check extrema.
      PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))=MAX(0._JPRB, &
      & PSTACK (JLON, IPSTPT_ZWU+JLEV-(1)))
      PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))=MIN(0._JPRB, &
      & PSTACK (JLON, IPSTPT_ZWD+JLEV-(1)))

      ! VERTICAL VELOCITY IN PA/S COMPUTED FROM VERTICAL VELOCITY IN M/S.
      PUDOM(JLON,JLEV)=-PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))*PAPRSF(JLON,JLEV) *RG&
      &  /(PR(JLON,JLEV)*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))
    ENDDO
  ENDDO
ENDIF ! LCVNHD.

!-------------------------------------------------
! CLOSURE: ESTIMATE CONVECTIVE MASSFLUX CLOSER TO EULERIAN EQUATIONS (EUL).
!-------------------------------------------------

!CALL ACMTUDEUL ( KIDIA,KFDIA,KLON,KTDIA,KLEV,&
!   &PDELP,PRDELP,PAPRS,PAPRSF,PAPHI,PAPHIF,PR,ZT, PTU, PQU &
!   &)

! // QUITTING IN CASE OF NO CONVECTION EVERYWHERE.
! THE "IF THEN / ENDIF" ENCOMPASSED SEQUENCE WILL NOT BE INDENTED GIVEN ITS LENGTH
!     AND ITS SPECIAL CHARACTER (PSEUDO "RETURN" STATEMENT).

IF(YRPHY%NPHYREP /= 0 .AND. YRPHY%NPHYREP /= -1) ITOP=KTDIA

IF (ITOP < KLEV+1) THEN

  ! LAST LEVEL SUMMATION (TOP).

  DO JLON=KIDIA,KFDIA

    ! PUDOM HAS TO BE ZERO I.E. THE LARGE SCALE VERT VEL. AT LEVEL KTDIA

    PUDOM(JLON,KTDIA)=0.0_JPRB
    ZFORMV=PSTACK (JLON, IPSTPT_ZFORM+KTDIA-(0))
    PSTACK (JLON, IPSTPT_ZS15)=PSTACK (JLON, IPSTPT_ZS15)+KNLAB(JLON,KTDIA)*&
    &  PSTACK (JLON, IPSTPT_ZBINBUO+KTDIA-(1))*PSTACK (JLON, IPSTPT_ZCAPE)
    PSTACK (JLON, IPSTPT_ZBCC_C_FULL+KTDIA-(1))=0.5_JPRB*(&
    &  PSTACK (JLON, IPSTPT_ZBCC_C_HALF+KTDIA-1-(0))+     &
    &  PSTACK (JLON, IPSTPT_ZBCC_C_HALF+KTDIA-(0)))
    ZFMDQN=0.5_JPRB*PSTACK (JLON, IPSTPT_ZFORM+KTDIA-(0))*((PQU(JLON,KTDIA)+PQU(&
    & JLON,KTDIA+1)) -(PQ(JLON,KTDIA)+PQ(JLON,KTDIA+1)))
    ZFMDSN=0.5_JPRB*PSTACK (JLON, IPSTPT_ZFORM+KTDIA-(0))*((                    &
    &  PSTACK (JLON, IPSTPT_ZSU+KTDIA-(1))+PSTACK (JLON, IPSTPT_ZSU+KTDIA+1-(1))&
    &  ) -(PSTACK (JLON, IPSTPT_ZDSE+KTDIA-(1))+                                &
    &  PSTACK (JLON, IPSTPT_ZDSE+KTDIA+1-(1))))

    PSTACK (JLON, IPSTPT_ZS16)=PSTACK (JLON, IPSTPT_ZS16)+KNLAB(JLON,KTDIA)*     &
    &  PSTACK (JLON, IPSTPT_ZBINBUO+KTDIA-(1)) *RD*((1.0_JPRB+RETV*PQ(JLON,KTDIA &
    &  ) )/PCP(JLON,KTDIA) *(PSTACK (JLON, IPSTPT_ZFMDS)-ZFMDSN+ZFORMV*PLH(JLON, &
    & KTDIA) *PDELP(JLON,KTDIA)*PSTACK (JLON, IPSTPT_ZBCC_C_FULL+KTDIA-(1))) +   &
    & RETV*PSTACK (JLON, IPSTPT_ZT+KTDIA-(1))*(PSTACK (JLON, IPSTPT_ZFMDQ)-      &
    & ZFMDQN -ZFORMV*PDELP(JLON,KTDIA)*                                          &
    &  PSTACK (JLON, IPSTPT_ZBCC_C_FULL+KTDIA-(1))))/PAPRSF(JLON,KTDIA)
    ZDPLAB=KNLAB(JLON,KTDIA)*PDELP(JLON,KTDIA)*&
    & PSTACK (JLON, IPSTPT_ZBINBUO+KTDIA-(1))
    PSTACK (JLON, IPSTPT_ZS12)=PSTACK (JLON, IPSTPT_ZS12)+ZDPLAB
    PSTACK (JLON, IPSTPT_ZS11)=PSTACK (JLON, IPSTPT_ZS11)+ZDPLAB*ABS( &
    & PSTACK (JLON, IPSTPT_ZVVERDM+KTDIA-(1)))

  ENDDO

  DO JLEV=ITOP,KLEV-1
    DO JLON=KIDIA,KFDIA
      KSTACK (JLON, IKSTPT_INBAS+JLEV-(1))=KNLAB(JLON,JLEV)*(1-KNLAB(JLON,JLEV+1&
      & ))
    ENDDO
  ENDDO

  ! ------------------------------------------------------------------
  ! // MESH FRACTION, VERTICAL ENTHALPY BUDGET AND DETRAINMENT
  ! ------------------------------------------------------------------

  ! DIAGNOSTIC OF CAPE (FORECASTER NEED) WHATEVER CLOSURE.
  DO JLON = KIDIA, KFDIA
PCAPE(JLON) = 0.0_JPRB
ENDDO

  DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZIBCCS) = 0.0_JPRB
ENDDO
 ! Integral of BCC multiplied by Sigma.
  DO JLEV=ITOP,KLEV
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZIBCCS)=PSTACK (JLON, IPSTPT_ZIBCCS)-PUDOM(JLON,JLEV)&
      &  *PSTACK (JLON, IPSTPT_ZBCC_C_FULL+JLEV-(1))*                           &
      &  PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-(0)) *                                &
      &  PSTACK (JLON, IPSTPT_ZBINID+JLEV-(1))*PDELP(JLON,JLEV)/RG
    ENDDO
    IF (LLCAPECIN) THEN
      DO JLON=KIDIA,KFDIA
        PCAPE(JLON)=PCAPE(JLON) +KNLAB(JLON,JLEV)*RD *PDELP(JLON,JLEV)/PAPRSF( &
        & JLON,JLEV) *(PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-                    &
        &  PSTACK (JLON, IPSTPT_ZTVE+JLEV-(1)))
      ENDDO
    ELSE
      DO JLON=KIDIA,KFDIA
        PCAPE(JLON)=PCAPE(JLON) +KNLAB(JLON,JLEV)*RD *PDELP(JLON,JLEV)/PAPRSF( &
        & JLON,JLEV) *MAX(0._JPRB,PSTACK (JLON, IPSTPT_ZTVN+JLEV-(1))-         &
        &  PSTACK (JLON, IPSTPT_ZTVE+JLEV-(1)))
      ENDDO
    ENDIF
  ENDDO
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZTAU)=1.0_JPRB/PSTACK (JLON, IPSTPT_ZFDXTAUX)*&
    &  PSTACK (JLON, IPSTPT_ZS12)*PSTACK (JLON, IPSTPT_ZS12)/MAX(      &
    & PSTACK (JLON, IPSTPT_ZS11),ZEPS0)
    PSTACK (JLON, IPSTPT_ZTAU_DIAG)=PSTACK (JLON, IPSTPT_ZTAU)
    ! Impose tau (time consumption of CAPE) to be larger than the model time step.
    IF(YRPHY0%LCVCONTAU) PSTACK (JLON, IPSTPT_ZTAU)=MAX(YRPHY2%TSPHY, &
                         & PSTACK (JLON, IPSTPT_ZTAU))
    PSTACK (JLON, IPSTPT_ZS15)=MAX(0.0_JPRB,PSTACK (JLON, IPSTPT_ZS15))
    ! ZALF_CVGQ : surface fraction occupied by convection, in case of CVGQ closure.
    ! As CVGQ closure is relevant for precipitating convection only,
    ! the surface computed here will be > 0 only in moist cases, where the vertical integral of
    ! BCC is larger than the drizzle threshold.
    ! In order to avoid instabilities when starting prediction from an
    ! interpolated analysis, one sets the CVGQ to 0 during the first hour of
    ! prediction.
    PSTACK (JLON, IPSTPT_ZALF_CVGQ)=MAX(0._JPRB,PSTACK (JLON, IPSTPT_ZCVGQ))/MAX&
    &  (ZEPS_BCCS,PSTACK (JLON, IPSTPT_ZIBCCS)) *MAX(0._JPRB,SIGN(1._JPRB,      &
    &  PSTACK (JLON, IPSTPT_ZIBCCS)-ZEPS_BCCS)) *MAX(0._JPRB, SIGN(1._JPRB,YRRIP&
    &  % RSTATI-3600._JPRB))


    ! EXTRA-DIAGNOSTICS
    PALF_CVGQ(JLON)=PSTACK (JLON, IPSTPT_ZALF_CVGQ)
    PALF_CAPE(JLON)=PSTACK (JLON, IPSTPT_ZS15)/MAX(ZEPS16,                   &
    & PSTACK (JLON, IPSTPT_ZS16)) *MAX(0.0_JPRB,SIGN(1.0_JPRB,(              &
    &  PSTACK (JLON, IPSTPT_ZS16)-ZEPS16))) /MAX(PSTACK (JLON, IPSTPT_ZTAU), &
    & ZEPS0 )

    IF(YRPHY0%NCVCLOS == 1) THEN
      ! ALPHA DIAGNOSED FROM d(CAPE)/dt=-CAPE/TAU.
      PALF(JLON)=MIN(PSTACK (JLON, IPSTPT_ZALFX),PSTACK (JLON, IPSTPT_ZS15)/MAX(&
      &  ZEPS16,PSTACK (JLON, IPSTPT_ZS16)) *MAX(0.0_JPRB,SIGN(1.0_JPRB,(       &
      &  PSTACK (JLON, IPSTPT_ZS16)-ZEPS16))) /MAX(PSTACK (JLON, IPSTPT_ZTAU),  &
      & ZEPS0))

    ELSEIF(YRPHY0%NCVCLOS == 2) THEN
      ! ALPHA AS A FUNCTION OF SATURATION DEFICIT.
      PALF(JLON)=YRPHY0%GALMIN+(YRPHY0%GALMAX-YRPHY0%GALMIN) *MAX(0._JPRB,MIN(1._JPRB, &
      & (YRPHY0%GSDAMAX-PSTACK (JLON, IPSTPT_ZSATDEF)) /(YRPHY0%GSDAMAX-YRPHY0%GSDAMIN)&
      & ))

      ! LIMITATION OF ALPHA IN STRATOCUMULUS CONTEXT: WHERE TKE AND CLOUD DEPTH ARE SMALL.
      ZBINTKE=MAX(0._JPRB,SIGN(1._JPRB,0.3_JPRB-PTKE(JLON,KLEV)))
      ZBINDEPTH=MAX(0._JPRB,SIGN(1._JPRB,800._JPRB-PSTACK (JLON, IPSTPT_ZDEPTH))&
      & )
      PALF(JLON)=PALF(JLON)*(1._JPRB-ZBINTKE*ZBINDEPTH)

      ! TAU COMPUTED HERE FOR DIAGNOSTIC PURPOSE ONLY.
      PSTACK (JLON, IPSTPT_ZTAU)=PSTACK (JLON, IPSTPT_ZS15)/MAX(ZEPS16, &
      & PSTACK (JLON, IPSTPT_ZS16))/MAX(0.001_JPRB,PALF(JLON))

      ! Impose time consumption of CAPE to be larger than the model time step.
      IF(YRPHY0%LCVCONTAU) PALF(JLON)=PALF(JLON)*MAX(0._JPRB,MIN(1._JPRB,&
                           & PSTACK (JLON, IPSTPT_ZTAU)/YRPHY2%TSPHY))

    ELSEIF(YRPHY0%NCVCLOS == 3) THEN
    ! ALPHA AS A FUNCTION OF DOWNDRAFT ACTIVITY.
      PALF(JLON)=YRPHY0%GALMIN+(YRPHY0%GALMAX-YRPHY0%GALMIN) *MAX(0._JPRB,MIN(1._JPRB,&
      & PSTACK (JLON, IPSTPT_ZKEDD)/7500._JPRB))

      ! LIMITATION OF ALPHA IN STRATOCUMULUS CONTEXT: WHERE TKE AND CLOUD DEPTH ARE SMALL.
      ZBINTKE=MAX(0._JPRB,SIGN(1._JPRB,0.3_JPRB-PTKE(JLON,KLEV)))
      ZBINDEPTH=MAX(0._JPRB,SIGN(1._JPRB,800._JPRB-PSTACK (JLON, IPSTPT_ZDEPTH))&
      & )
      PALF(JLON)=PALF(JLON)*(1._JPRB-ZBINTKE*ZBINDEPTH)

      ! TAU COMPUTED HERE FOR DIAGNOSTIC PURPOSE ONLY.
      PSTACK (JLON, IPSTPT_ZTAU)=PSTACK (JLON, IPSTPT_ZS15)/MAX(ZEPS16, &
      & PSTACK (JLON, IPSTPT_ZS16))/MAX(0.001_JPRB,PALF(JLON))

    ELSEIF(YRPHY0%NCVCLOS == 4) THEN
      ! PALF is prognostic.
      PSTACK (JLON, IPSTPT_ZTALF_SCE)=PALF(JLON)*YRPHY0%GMUKEDD*&
      &  PSTACK (JLON, IPSTPT_ZKEDD)
      PSTACK (JLON, IPSTPT_ZTALF_SIN)=-PALF(JLON)*YRPHY0%GALTAU
      PALF(JLON)=MAX(YRPHY0%GALMIN,MIN(YRPHY0%GALMAX*PSTACK (JLON, IPSTPT_ZRH), &
      & PALF(JLON)+YRPHY2%TSPHY*(PSTACK (JLON, IPSTPT_ZTALF_SCE)+               &
      &  PSTACK (JLON, IPSTPT_ZTALF_SIN))))
    ELSEIF(YRPHY0%NCVCLOS == 5) THEN
      ! CVGQ closure.
      PALF(JLON)=PSTACK (JLON, IPSTPT_ZALF_CVGQ)
    ELSEIF(YRPHY0%NCVCLOS == 6) THEN
      ! CAPE and CVGQ mixed closure.
      ! 1. ALPHA DIAGNOSED FROM d(CAPE)/dt=-CAPE/TAU.
      PALF(JLON)=PSTACK (JLON, IPSTPT_ZS15)/MAX(ZEPS16,                        &
      & PSTACK (JLON, IPSTPT_ZS16)) *MAX(0.0_JPRB,SIGN(1.0_JPRB,(              &
      &  PSTACK (JLON, IPSTPT_ZS16)-ZEPS16))) /MAX(PSTACK (JLON, IPSTPT_ZTAU), &
      & ZEPS0)
      ! 2. One uses the max value between CAPE and CVGQ approaches.
      PALF(JLON)=MIN(PSTACK (JLON, IPSTPT_ZALFX),MAX(PALF(JLON), &
      & PSTACK (JLON, IPSTPT_ZALF_CVGQ)))
    ELSE
      ! Constant PALF.
      PALF(JLON)=0.04_JPRB
    ENDIF

    ! FIRST TEST OF PHYSICAL VALIDITY OF THE OBTAINED PALF
    KNND(JLON)=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-PALF(JLON)+0.0_JPRB)))
  ENDDO

  ! DOWNDROUGHTS GYT2011
  IF (YRPHY0%LGDDD .AND. .NOT.YRPHY0%LCVNHD) THEN
    ! Diagnostic downdrafts.
    CALL ACMTDDD( KIDIA,KFDIA,KLON,ITOP,KLEV,KTRA, KSTACK (1, IKSTPT_INCDN),      &
    & KNLAB, PALPH,PAPHIF,PAPRS,PAPRSF, PDELP,PLH,PLNPR,PQ,PQLIC,PQLIS,PQSAT,PQW, &
    & PR,PSTACK (1, IPSTPT_ZT),PTW,PU,PV,PTRA,KSTACK (1, IKSTPT_ILEVTEN),         &
    & PSTACK (1, IPSTPT_ZBETD),PSTACK (1, IPSTPT_ZDEL_ORGD),                      &
    & PSTACK (1, IPSTPT_ZEPS_ORGD),PSTACK (1, IPSTPT_ZFORD),                      &
    & PSTACK (1, IPSTPT_ZQDND),PSTACK (1, IPSTPT_ZQN2D),PSTACK (1, IPSTPT_ZSDND), &
    & PSTACK (1, IPSTPT_ZSN2D),PSTACK (1, IPSTPT_ZTN2D), PSTACK (1, IPSTPT_ZUMD), &
    & PSTACK (1, IPSTPT_ZVMD),PSTACK (1, IPSTPT_ZTRAMD),                          &
    & PSTACK (1, IPSTPT_ZBCC_CD_FULL), KSTACK (1, IKSTPT_INLABD), KSTACK, PSTACK, &
    & KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)
    DO JLEV=ITOP,KLEV
      DO JLON=KIDIA,KFDIA
       PDDAL(JLON,JLEV)=PALF(JLON)*KSTACK (JLON, IKSTPT_INLABD+JLEV-(1))*PALF(&
       & JLON)/YRPHY0%FEVAPC
       PDDOM(JLON,JLEV)=0.5_JPRB*(PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0))+&
       &  PSTACK (JLON, IPSTPT_ZFORD+JLEV-1-(0)))
      ENDDO
    ENDDO
  ELSEIF (YRPHY0%LCVNHD) THEN
    ! Prognostic downdraft.
    ! A call to the diagnostic downdrafts is done, only to get the profile of dry
    ! static energy and water vapour.
    CALL ACMTDDD( KIDIA,KFDIA,KLON,ITOP,KLEV,KTRA, KSTACK (1, IKSTPT_INCDN),      &
    & KNLAB, PALPH,PAPHIF,PAPRS,PAPRSF, PDELP,PLH,PLNPR,PQ,PQLIC,PQLIS,PQSAT,PQW, &
    & PR,PSTACK (1, IPSTPT_ZT),PTW,PU,PV,PTRA,KSTACK (1, IKSTPT_ILEVTEN),         &
    & PSTACK (1, IPSTPT_ZBETD),PSTACK (1, IPSTPT_ZDEL_ORGD),                      &
    & PSTACK (1, IPSTPT_ZEPS_ORGD),PSTACK (1, IPSTPT_ZFORD),                      &
    & PSTACK (1, IPSTPT_ZQDND),PSTACK (1, IPSTPT_ZQN2D),PSTACK (1, IPSTPT_ZSDND), &
    & PSTACK (1, IPSTPT_ZSN2D),PSTACK (1, IPSTPT_ZTN2D), PSTACK (1, IPSTPT_ZUMD), &
    & PSTACK (1, IPSTPT_ZVMD),PSTACK (1, IPSTPT_ZTRAMD),                          &
    & PSTACK (1, IPSTPT_ZBCC_CD_FULL), KSTACK (1, IKSTPT_INLABD), KSTACK, PSTACK, &
    & KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)
    DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PDDOM(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

    DO JLEV=ITOP,KLEV
      DO JLON=KIDIA,KFDIA
       PDDOM(JLON,JLEV)=-PAPRSF(JLON,JLEV)*RG/(PR(JLON,JLEV)*&
       &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))*PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))
      ENDDO
    ENDDO
  ELSE
    ! No downdrafts.
    DO JLEV=ITOP,KLEV
      DO JLON=KIDIA,KFDIA
       PDDAL(JLON,JLEV)=0._JPRB
       PDDOM(JLON,JLEV)=0._JPRB
      ENDDO
    ENDDO
  ENDIF

  ! ------------------------------------------------------------
  ! // ADAPT THE MESH FRACTION PROFILE AND TENDENCY
  ! // AND COMPUTE MASS FLUX AT THE INTERFACE LEVELS
  ! ------------------------------------------------------------

  DO JLEV=ITOP,KLEV
    DO JLON=KIDIA,KFDIA
      KNLAB(JLON,JLEV)=KNND(JLON)*KNLAB(JLON,JLEV)
      KSTACK (JLON, IKSTPT_INBAS+JLEV-(1))=KSTACK (JLON, IKSTPT_INBAS+JLEV-(1))*&
      &  KNND(JLON)
      PUDAL(JLON,JLEV)=PALF(JLON)*0.5_JPRB*(   &
      &  PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-(0))+&
      &  PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0)))*KNLAB(JLON,JLEV)
      IF(YRPHY0%LCVNHD) PDDAL(JLON,JLEV)=YRPHY0%GUDDD*PUDAL(JLON,JLEV)
      KSTACK (JLON, IKSTPT_ICDN)=MAX(0,-ISIGN(1,-&
      &  KSTACK (JLON, IKSTPT_INCDN+JLEV-(1))))
      PQLIC(JLON,JLEV)=PQLIC(JLON,JLEV)*KNLAB(JLON,JLEV)
      PNEBC(JLON,JLEV)=MAX(ZEPS0,KSTACK (JLON, IKSTPT_ICDN)*PALF(JLON) *0.5_JPRB&
      &  *(PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-(0))+                               &
      &  PSTACK (JLON, IPSTPT_ZSIGMA+JLEV-1-(0)))*KNLAB(JLON,JLEV))
    ENDDO
  ENDDO

  ! ------------------------------------------------------------
  ! // PROTECTION AGAINST NL INSTABILITY
  ! // AND COMPUTE THE ENVIRONMENT VALUES AFFECTED Y PSEUDO-SUBSIDENCE
  ! ------------------------------------------------------------
  ! ADITIONAL VERTICAL LOOP (UPWARDS) TO MODIFY THE PREVIOUSLY
  ! COMPUTED MASS FLUX.


  ! ZFORM HAS BEEN COMPLETELY INITIALIZED TO ZERO EARLIER, SO IT IS ZERO
  ! ABOVE ITOP (AND NORMALLY ALSO AT KLEV - BUT SEE VIB...)

  ! cdir unroll=8
  DO JLEV=KLEV-1,ITOP,-1
    DO JLON=KIDIA,KFDIA

      !     NORMALISATION DE "ZFORM" A LA DIMENSION D'UNE PRESSION.
      !     NORMALIZATION OF "ZFORM" TO PRESSURE DIMENSION.
      PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0))=PALF(JLON)*YRPHY2%TSPHY*&
      &  PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))
      PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))=MAX(0.0_JPRB,                &
      &  PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))-PALF(JLON)/YRPHY0%FEVAPC *&
      &  PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0)))
      PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))=PALF(JLON)*YRPHY2%TSPHY*&
      &  PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))
      PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0))=PALF(JLON)*YRPHY2%TSPHY*PALF(JLON)/ &
      & YRPHY0%FEVAPC*PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0))
    ENDDO
  ENDDO

  IF (YRPHY0%LGPRONI1) THEN
    DO JLEV=KLEV-1,ITOP,-1
      DO JLON=KIDIA,KFDIA      

      ! PROTECTION AGAINST NON-LINEAR INSTABILITY THAT CAN OCCASIONALLY
      ! APPEAR DESPITE THE IMPLICIT ALGORITHM.
      PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))=MAX(0.0_JPRB,                        &
      &  PSTACK (JLON, IPSTPT_ZFORM+JLEV+1-(0))+(                               &
      &  PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0)) -                                 &
      &  PSTACK (JLON, IPSTPT_ZFORM+JLEV+1-(0)))/(1.0_JPRB+PRDELP(JLON,JLEV+1) *&
      &  MAX(0.0_JPRB,PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))-                     &
      &  PSTACK (JLON, IPSTPT_ZFORM+JLEV+1-(0)))))
      PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0))=MAX(0.0_JPRB,                        &
      &  PSTACK (JLON, IPSTPT_ZFORU+JLEV+1-(0))+(                               &
      &  PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0)) -                                 &
      &  PSTACK (JLON, IPSTPT_ZFORU+JLEV+1-(0)))/(1.0_JPRB+PRDELP(JLON,JLEV+1) *&
      &  MAX(0.0_JPRB,PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0))-                     &
      &  PSTACK (JLON, IPSTPT_ZFORU+JLEV+1-(0)))))
      ENDDO
    ENDDO
    DO JLEV=ITOP,KLEV-1
      DO JLON=KIDIA,KFDIA
      ! PROTECTION AGAINST NON-LINEAR INSTABILITY THAT CAN OCCASIONALLY
      ! APPEAR DESPITE THE IMPLICIT ALGORITHM.
      PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0))=MAX(0.0_JPRB,                       &
      &  PSTACK (JLON, IPSTPT_ZFORD+JLEV-1-(0))+(                              &
      &  PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0)) -                                &
      &  PSTACK (JLON, IPSTPT_ZFORD+JLEV-1-(0)))/(1.0_JPRB+PRDELP(JLON,JLEV) * &
      & MAX (0.0_JPRB,PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0))-                    &
      &  PSTACK (JLON, IPSTPT_ZFORD+JLEV-1-(0)))))
      ENDDO
    ENDDO
  ENDIF  



  ! -----------------------------------------------------------------
  ! // WIND RELATED COMPUTATION INCLUDING THE ENTRAINMENT AND
  ! // PRESSURE GRADIENT TERM (KERSHAW & GREGORY SCHEME), CONSIDERING
  ! // THE ACTIVE LAYERS
  ! -----------------------------------------------------------------

  ! INITIALIZE WORK ARRAYS

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZUM+JLEV-(1)) = 0.0_JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZVM+JLEV-(1)) = 0.0_JPRB
ENDDO
ENDDO

  DO JTRA = 1, KTRA
DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1))) = 0.0_JPRB
ENDDO
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZBET+JLEV-(1)) = 0.0_JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZA13+JLEV-(1)) = 0.0_JPRB
ENDDO
ENDDO

  DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZA14+JLEV-(1)) = 0.0_JPRB
ENDDO
ENDDO

  DO JTRA = 1, KTRA
DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZA15+JLEV-(1)+(KLEV)*(JTRA-(1))) = 0.0_JPRB
ENDDO
ENDDO
ENDDO


  ! -------------------------------------------------------------------
  ! // UPWARDS LOOP FOR MOMENTUM ARRAYS (VERTICAL INTEGRALS)
  ! ZA13, ZA14(JLON,JLEV), ZBET, ZUM, ZVM(JLON,JLEV).

  ! TEMPORAIRES 1D.

  ! ZBET      : BETA COEFFICIENT FOR MOMENTUM PROFILE.

  ! TEMPORAIRE 0D.

  ! TEMPORAIRES 2D.

  ! ZA13      : UC0.
  ! ZA14      : VC0.
  ! ZA15      : TRA0.
  ! ZUM       : AVERAGE U VALUE FROM CLOUD BASE.
  ! ZVM       : AVERAGE V VALUE FROM CLOUD BASE.
  ! ZTRAM     : AVERAGE TRACER VALUE FROM CLOUD BASE.

  DO JLON=KIDIA,KFDIA

    ! AT BASE: ZBE=1, ZUM=PU, ZVM=PV, ZA13=PU, ZA14=PV
    ! INACTIVE LAYERS AND BASE => ZUM=PU, ZVM=PV

    PSTACK (JLON, IPSTPT_ZBET+KLEV-(1))=1.0_JPRB
    PSTACK (JLON, IPSTPT_ZUM+KLEV-(1))=PU(JLON,KLEV)
    PSTACK (JLON, IPSTPT_ZVM+KLEV-(1))=PV(JLON,KLEV)

    DO JTRA=1,KTRA
      PSTACK (JLON, IPSTPT_ZTRAM+KLEV-(1)+(KLEV)*(JTRA-(1))) = PTRA(JLON,KLEV,&
      & JTRA)
    ENDDO
    ! CLOUD BASE VELOCITY=MEAN GRID BOX VELOCITY

    PSTACK (JLON, IPSTPT_ZA13+KLEV-(1))=PU(JLON,KLEV)
    PSTACK (JLON, IPSTPT_ZA14+KLEV-(1))=PV(JLON,KLEV)
  
    DO JTRA=1,KTRA
      PSTACK (JLON, IPSTPT_ZA15+KLEV-(1)+(KLEV)*(JTRA-(1)))=PTRA(JLON,KLEV,JTRA)
    ENDDO
    
  ENDDO

  ! cdir unroll=4
  DO JLEV=KLEV-1,ITOP,-1
    DO JLON=KIDIA,KFDIA

      ! ZNBA=1 WHERE ACTIVE AND NOT BASE
      ! ZBAS=1  AT BASE (AND THEN ACTIVE)
      ! BOTH ARE 0 IN INACTIVE LAYERS
      ZBAS=REAL(KSTACK (JLON, IKSTPT_INBAS+JLEV-(1)),JPRB)
      ZNBA=REAL(1-KSTACK (JLON, IKSTPT_INBAS+JLEV-(1)),JPRB)*KNLAB(JLON,JLEV)

      ! ZBET, ZUM, ZVM VALUES ARE USED ONLY IN ACTIVE LAYERS.
      ! ZBET IS 0 IN INACTIVE LAYERS
      ! 1 IN THE BASE LAYERS
      ! DECREASE UPWARDS IN THE ACTIVE LAYERS
      ! ZUM = PU IN INACTIVE LAYERS
      ! ZVM = PV IN INACTIVE LAYERS
      ! AND BOTH ARE ACCUMULATED IN ACTIVE LAYERS


      ZMIX=PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))
      PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))= ZNBA*&
      &  PSTACK (JLON, IPSTPT_ZBET+JLEV+1-(1))*(1.0_JPRB-ZMIX)+ZBAS

      ! ZUM BACK TO PU IF  KNLAB=0 OR INBAS=1
      PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))=(PSTACK (JLON, IPSTPT_ZUM+JLEV+1-(1)) +  &
      &  (ZMIX*(PU(JLON,JLEV+1)-PSTACK (JLON, IPSTPT_ZUM+JLEV+1-(1))) +YRPHY0%    &
      & TUDGP*(PU(JLON,JLEV)-PU(JLON,JLEV+1))) / (1.0_JPRB-                       &
      &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))+ZBAS) )*ZNBA +PU(JLON,JLEV)*(1.0_JPRB&
      &  -ZNBA)
      PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))=(PSTACK (JLON, IPSTPT_ZVM+JLEV+1-(1)) +  &
      &  (ZMIX*(PV(JLON,JLEV+1)-PSTACK (JLON, IPSTPT_ZVM+JLEV+1-(1))) +YRPHY0%    &
      & TUDGP*(PV(JLON,JLEV)-PV(JLON,JLEV+1))) / (1.0_JPRB-                       &
      &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))+ZBAS) )*ZNBA +PV(JLON,JLEV)*(1.0_JPRB&
      &  -ZNBA)
      DO JTRA=1,KTRA
        PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1))) = (              &
        &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV+1-(1)+(KLEV)*(JTRA-(1))) +(ZMIX*(PTRA&
        &  ( JLON,JLEV+1,JTRA)-                                                 &
        &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV+1-(1)+(KLEV)*(JTRA-(1)))) +YRPHY0%   &
        & TUDGP*(PTRA(JLON,JLEV,JTRA)-PTRA(JLON,JLEV+1,JTRA))) / (1.0_JPRB-     &
        &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))+ZBAS) )*ZNBA +PTRA(JLON,JLEV,JTRA&
        &  ) *(1.0_JPRB-ZNBA)
      ENDDO

      ! CLOUD BASE VELOCITY=MEAN GRID BOX VELOCITY

      ! ZA13,ZA14 : WIND AT BASE OF ACTIVE SEGMENT
      ! SAME VALUE UP TO NEXT BASE
      ! (IN INACTIVE LAYERS, MULTIPLIED BY ZBET=0)

      PSTACK (JLON, IPSTPT_ZA13+JLEV-(1))=PSTACK (JLON, IPSTPT_ZA13+JLEV+1-(1))*&
      &  ZNBA+PU(JLON,JLEV)*ZBAS
      PSTACK (JLON, IPSTPT_ZA14+JLEV-(1))=PSTACK (JLON, IPSTPT_ZA14+JLEV+1-(1))*&
      &  ZNBA+PV(JLON,JLEV)*ZBAS
      
      DO JTRA=1,KTRA    
        PSTACK (JLON, IPSTPT_ZA15+JLEV-(1)+(KLEV)*(JTRA-(1))) =              &
        &  PSTACK (JLON, IPSTPT_ZA15+JLEV+1-(1)+(KLEV)*(JTRA-(1)))*ZNBA+PTRA(&
        & JLON, JLEV,JTRA)*ZBAS      
      ENDDO

    ENDDO
  ENDDO

  DO JLEV=ITOP,KLEV
    DO JLON=KIDIA,KFDIA
       ZZ=1.0_JPRB-PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))
       PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))=ZZ*PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))+&
       &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))*                                  &
       &  PSTACK (JLON, IPSTPT_ZA13+JLEV-(1))
       PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))=ZZ*PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))+&
       &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))*                                  &
       &  PSTACK (JLON, IPSTPT_ZA14+JLEV-(1))
       DO JTRA=1,KTRA
         PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))=ZZ*&
         &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))+&
         &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))*                   &
         &  PSTACK (JLON, IPSTPT_ZA15+JLEV-(1)+(KLEV)*(JTRA-(1)))           
       ENDDO
    ENDDO
  ENDDO

  ! ------------------------------------------------------------------
  ! // FLUXES COMPUTATION

  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZBCC+ITOP-(1))=-PUDAL(JLON,ITOP)*PUDOM(JLON,ITOP)*     &
    &  PSTACK (JLON, IPSTPT_ZBCC_C_FULL+ITOP-(1)) +PDDAL(JLON,ITOP)*PDDOM(JLON, &
    & ITOP)*PSTACK (JLON, IPSTPT_ZBCC_CD_FULL+ITOP-(1))
    PFCCQL(JLON,ITOP)=PFCCQL(JLON,ITOP-1)-1._JPRB/RG*(1._JPRB-&
    &  PSTACK (JLON, IPSTPT_ZIFRAC+ITOP-(1))) *(-             &
    &  PSTACK (JLON, IPSTPT_ZBCC+ITOP-(1)))*PDELP(JLON,ITOP)
    PFCCQI(JLON,ITOP)=PFCCQI(JLON,ITOP-1)-1._JPRB/RG*&
    &  PSTACK (JLON, IPSTPT_ZIFRAC+ITOP-(1)) *(-     &
    &  PSTACK (JLON, IPSTPT_ZBCC+ITOP-(1)))*PDELP(JLON,ITOP)
  ENDDO

  ! cdir unroll=8
  DO JLEV=ITOP+1,KLEV-1
    DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZBCC+JLEV-(1))=-PUDAL(JLON,JLEV)*PUDOM(JLON,JLEV)*     &
      &  PSTACK (JLON, IPSTPT_ZBCC_C_FULL+JLEV-(1)) +PDDAL(JLON,JLEV)*PDDOM(JLON, &
      & JLEV)*PSTACK (JLON, IPSTPT_ZBCC_CD_FULL+JLEV-(1))
      PFCCQL(JLON,JLEV)=PFCCQL(JLON,JLEV-1)-1._JPRB/RG*(1._JPRB-&
      &  PSTACK (JLON, IPSTPT_ZIFRAC+JLEV-(1))) *(-             &
      &  PSTACK (JLON, IPSTPT_ZBCC+JLEV-(1)))*PDELP(JLON,JLEV)
      PFCCQI(JLON,JLEV)=PFCCQI(JLON,JLEV-1)-1._JPRB/RG*&
      &  PSTACK (JLON, IPSTPT_ZIFRAC+JLEV-(1)) *(-     &
      &  PSTACK (JLON, IPSTPT_ZBCC+JLEV-(1)))*PDELP(JLON,JLEV)
    ENDDO
  ENDDO

  DO JLON=KIDIA,KFDIA
    PFCCQL(JLON,KLEV)=PFCCQL(JLON,KLEV-1)
    PFCCQI(JLON,KLEV)=PFCCQI(JLON,KLEV-1)
  ENDDO

  IF(YRPHY0%LCVUVM) THEN
    ! ---------------------------
    ! // CONVECTIVE TRANSPORT FLUXES
    ! ---------------------------
    ! COMPUTE ZUM AND ZVM AS UNIFORM, EQUAL TO THE MEAN VALUE ALONG CONVECTIVE LEVELS.
    DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZUM+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

    DO JLEV = 1, KLEV
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZVM+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

    DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZDENO) = 0._JPRB
ENDDO

    DO JLEV=ITOP,KLEV
      DO JLON=KIDIA,KFDIA
        PSTACK (JLON, IPSTPT_ZBINID2+JLEV-(1))=MAX(0._JPRB,SIGN(1._JPRB,&
        &  PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))-0.1_JPRB))
        PSTACK (JLON, IPSTPT_ZINTE)=PSTACK (JLON, IPSTPT_ZBINID2+JLEV-(1))*PDELP&
        &  (JLON,JLEV)/RG
        PSTACK (JLON, IPSTPT_ZUM+KLEV-(1))=PSTACK (JLON, IPSTPT_ZUM+KLEV-(1))+PU&
        &  (JLON,JLEV)*PSTACK (JLON, IPSTPT_ZINTE)
        PSTACK (JLON, IPSTPT_ZVM+KLEV-(1))=PSTACK (JLON, IPSTPT_ZVM+KLEV-(1))+PV&
        &  (JLON,JLEV)*PSTACK (JLON, IPSTPT_ZINTE)
        PSTACK (JLON, IPSTPT_ZDENO)=PSTACK (JLON, IPSTPT_ZDENO)+&
        &  PSTACK (JLON, IPSTPT_ZINTE)
      ENDDO
    ENDDO
    DO JLEV=ITOP,KLEV
      DO JLON=KIDIA,KFDIA
        PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))=                  &
        &  PSTACK (JLON, IPSTPT_ZBINID2+JLEV-(1))*           &
        &  PSTACK (JLON, IPSTPT_ZUM+KLEV-(1))/MAX(100._JPRB, &
        & PSTACK (JLON, IPSTPT_ZDENO)) +(1._JPRB-            &
        &  PSTACK (JLON, IPSTPT_ZBINID2+JLEV-(1)))*PU(JLON,JLEV)
        PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))=                  &
        &  PSTACK (JLON, IPSTPT_ZBINID2+JLEV-(1))*           &
        &  PSTACK (JLON, IPSTPT_ZVM+KLEV-(1))/MAX(100._JPRB, &
        & PSTACK (JLON, IPSTPT_ZDENO)) +(1._JPRB-            &
        &  PSTACK (JLON, IPSTPT_ZBINID2+JLEV-(1)))*PV(JLON,JLEV)
        DO JTRA=1,KTRA
          PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))=                  &
          &  PSTACK (JLON, IPSTPT_ZBINID2+JLEV-(1))*                               &
          &  PSTACK (JLON, IPSTPT_ZTRAM+KLEV-(1)+(KLEV)*(JTRA-(1)))/MAX(100._JPRB, &
          & PSTACK (JLON, IPSTPT_ZDENO)) +(1._JPRB-                                &
          &  PSTACK (JLON, IPSTPT_ZBINID2+JLEV-(1)))*PTRA(JLON,JLEV,JTRA)
        ENDDO
      ENDDO
    ENDDO
  ENDIF

  IF(YRPHY0%LCVIMPT) THEN

    ! ---------------------------
    ! // CONVECTIVE TRANSPORT FLUXES: IMPLICIT COMPUTATION.
    ! ---------------------------

  DO JLEV=ITOP,KLEV
     DO JLON=KIDIA,KFDIA
        ! REPLACE THE UPDRAFT VALUES BY THE DIFFERENCE (PSI-PSI_U)
        PSTACK (JLON, IPSTPT_ZQU+JLEV-(1))=(PQ(JLON,JLEV)-PQU(JLON,JLEV))
        PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))=(PSTACK (JLON, IPSTPT_ZDSE+JLEV-(1))-&
        &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1)))
        PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))=PU(JLON,JLEV)-&
        &  PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))
        PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))=PV(JLON,JLEV)-&
        &  PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))
          DO JTRA=1, KTRA
             PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1))) = PTRA(JLON, &
             & JLEV,JTRA) -                                                      &
             &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))
          ENDDO
          ! ABOVE ITOP: ALL FLUXES ARE ZERO
          ! LEVEL KLEV: ZFORM=0 THERE, HENCE ALL THE FLUXES ARE ZERO, TOO.
          ! ELSEWHERE WE NEED ZFORM >=0 - AVOID THE ROUNDING ERRORS
          ! REQUIRE AT LEAST THAT PDIFCQ<0
     ENDDO
  ENDDO

    ! cdir unroll=8
    DO JLEV=ITOP,KLEV-1
       DO JLON=KIDIA,KFDIA
          ZAUX=PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0))/(PDELP(JLON,JLEV)+&
          &  PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0)))
          ZDPSGDT=PDELP(JLON,JLEV)*ZGDTI*0.5_JPRB
          PDIFCQ(JLON,JLEV)=ZAUX*( PDIFCQ(JLON,JLEV-1)+ ZDPSGDT*(&
          &  PSTACK (JLON, IPSTPT_ZQU+JLEV-(1))+                 &
          &  PSTACK (JLON, IPSTPT_ZQU+JLEV+1-(1))) )
          IF (YRPHY0%NCVENTR == 1) THEN
            PDIFCS(JLON,JLEV)=ZAUX*( PDIFCS(JLON,JLEV-1)+ ZDPSGDT*(&
            &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))+                 &
            &  PSTACK (JLON, IPSTPT_ZSU+JLEV+1-(1))) )
          ELSE
            PDIFCS(JLON,JLEV)=MIN(YRPHY0%GCVTRMIN,ZAUX*( PDIFCS(JLON,JLEV-1)+  &
            & ZDPSGDT*(PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))+                     &
            &  PSTACK (JLON, IPSTPT_ZSU+JLEV+1-(1))) ))
          ENDIF
          PSTRCU(JLON,JLEV)=ZAUX*( PSTRCU(JLON,JLEV-1)+ ZDPSGDT*(&
          &  PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))+                 &
          &  PSTACK (JLON, IPSTPT_ZUM+JLEV+1-(1))) )
          PSTRCV(JLON,JLEV)=ZAUX*( PSTRCV(JLON,JLEV-1)+ ZDPSGDT*(&
          &  PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))+                 &
          &  PSTACK (JLON, IPSTPT_ZVM+JLEV+1-(1))) )
          DO JTRA=1, KTRA
            PSTRCTRA(JLON,JLEV,JTRA)=ZAUX*( PSTRCTRA(JLON,JLEV-1,JTRA)+ ZDPSGDT*&
            &  (PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))+         &
            &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV+1-(1)+(KLEV)*(JTRA-(1)))) )
          ENDDO
       ENDDO
    ENDDO

    IF (YRPHY0%LGDDD) THEN
    DO JLEV=ITOP,KLEV
       DO JLON=KIDIA,KFDIA
          ! replace the DOWNDRAFT values by the difference (psi-psi_d)
          PSTACK (JLON, IPSTPT_ZQU+JLEV-(1))=(PQ(JLON,JLEV)-&
          &  PSTACK (JLON, IPSTPT_ZQN2D+JLEV-(1)))
          PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))=(   &
          &  PSTACK (JLON, IPSTPT_ZDSE+JLEV-(1))-&
          &  PSTACK (JLON, IPSTPT_ZSN2D+JLEV-(1)))
          PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))=(PU(JLON,JLEV)-&
          &  PSTACK (JLON, IPSTPT_ZUMD+JLEV-(1)))
          PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))=(PV(JLON,JLEV)-&
          &  PSTACK (JLON, IPSTPT_ZVMD+JLEV-(1)))
          DO JTRA=1, KTRA
             PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))=(PTRA(JLON, &
             & JLEV,JTRA)-                                                      &
             &  PSTACK (JLON, IPSTPT_ZTRAMD+JLEV-(1)+(KLEV)*(JTRA-(1))))
          ENDDO
       ENDDO
    ENDDO
    DO JLEV=KLEV-1,ITOP,-1
       DO JLON=KIDIA,KFDIA
          ZAUX=PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0))/(PDELP(JLON,JLEV+1)+&
          &  PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0)))
          ZDPSGDT=PDELP(JLON,JLEV+1)*ZGDTI*0.5_JPRB
          PSTACK (JLON, IPSTPT_ZDIFCQD+JLEV-(0))=ZAUX*(         &
          &  PSTACK (JLON, IPSTPT_ZDIFCQD+JLEV+1-(0))+ ZDPSGDT*(&
          &  PSTACK (JLON, IPSTPT_ZQU+JLEV-(1))+                &
          &  PSTACK (JLON, IPSTPT_ZQU+JLEV+1-(1))) )
          IF (YRPHY0%NCVENTR == 1) THEN
            PSTACK (JLON, IPSTPT_ZDIFCSD+JLEV-(0))=ZAUX*(         &
            &  PSTACK (JLON, IPSTPT_ZDIFCSD+JLEV+1-(0))+ ZDPSGDT*(&
            &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))+                &
            &  PSTACK (JLON, IPSTPT_ZSU+JLEV+1-(1))) )
          ELSE
            PSTACK (JLON, IPSTPT_ZDIFCSD+JLEV-(0))=MAX(-YRPHY0%GCVTRMIN,ZAUX*( &
            &  PSTACK (JLON, IPSTPT_ZDIFCSD+JLEV+1-(0))+ ZDPSGDT*(             &
            &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))+                             &
            &  PSTACK (JLON, IPSTPT_ZSU+JLEV+1-(1))) ))
          ENDIF
          PSTACK (JLON, IPSTPT_ZSTRCUD+JLEV-(0))=ZAUX*(         &
          &  PSTACK (JLON, IPSTPT_ZSTRCUD+JLEV+1-(0))+ ZDPSGDT*(&
          &  PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))+                &
          &  PSTACK (JLON, IPSTPT_ZUM+JLEV+1-(1))) )
          PSTACK (JLON, IPSTPT_ZSTRCVD+JLEV-(0))=ZAUX*(         &
          &  PSTACK (JLON, IPSTPT_ZSTRCVD+JLEV+1-(0))+ ZDPSGDT*(&
          &  PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))+                &
          &  PSTACK (JLON, IPSTPT_ZVM+JLEV+1-(1))) )
          DO JTRA=1,KTRA
            PSTACK (JLON, IPSTPT_ZSTRCTRAD+JLEV-(0)+(KLEV-0+1)*(JTRA-(1)))=ZAUX*&
            &  (                                                                &
            &  PSTACK (JLON, IPSTPT_ZSTRCTRAD+JLEV+1-(0)+(KLEV-0+1)*(JTRA-(1))) &
            & + ZDPSGDT*(PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))+&
            &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV+1-(1)+(KLEV)*(JTRA-(1)))) )
          ENDDO
       ENDDO
    ENDDO

    DO JLEV=ITOP,KLEV-1
       DO JLON=KIDIA,KFDIA
          PSTACK (JLON, IPSTPT_ZDIFCQD+JLEV-(0))=-&
          &  PSTACK (JLON, IPSTPT_ZDIFCQD+JLEV-(0))
          PDIFCQ(JLON,JLEV)=PDIFCQ(JLON,JLEV)+&
          & PSTACK (JLON, IPSTPT_ZDIFCQD+JLEV-(0))
          PSTACK (JLON, IPSTPT_ZDIFCSD+JLEV-(0))=-&
          &  PSTACK (JLON, IPSTPT_ZDIFCSD+JLEV-(0))
          PDIFCS(JLON,JLEV)=PDIFCS(JLON,JLEV)+&
          & PSTACK (JLON, IPSTPT_ZDIFCSD+JLEV-(0))
          PSTACK (JLON, IPSTPT_ZSTRCUD+JLEV-(0))=-&
          &  PSTACK (JLON, IPSTPT_ZSTRCUD+JLEV-(0))
          PSTRCU(JLON,JLEV)=PSTRCU(JLON,JLEV)+&
          & PSTACK (JLON, IPSTPT_ZSTRCUD+JLEV-(0))
          PSTACK (JLON, IPSTPT_ZSTRCVD+JLEV-(0))=-&
          &  PSTACK (JLON, IPSTPT_ZSTRCVD+JLEV-(0))
          PSTRCV(JLON,JLEV)=PSTRCV(JLON,JLEV)+&
          & PSTACK (JLON, IPSTPT_ZSTRCVD+JLEV-(0))
          DO JTRA=1,KTRA
            PSTACK (JLON, IPSTPT_ZSTRCTRAD+JLEV-(0)+(KLEV-0+1)*(JTRA-(1)))=-&
            &  PSTACK (JLON, IPSTPT_ZSTRCTRAD+JLEV-(0)+(KLEV-0+1)*(JTRA-(1)))
            PSTRCTRA(JLON,JLEV,JTRA)=PSTRCTRA(JLON,JLEV,JTRA)+&
            & PSTACK (JLON, IPSTPT_ZSTRCTRAD+JLEV-(0)+(KLEV-0+1)*(JTRA-(1)))
          ENDDO
       ENDDO
    ENDDO
    ENDIF  !LGDDD

  ELSE ! LCVIMPT.

    ! ---------------------------
    ! // CONVECTIVE TRANSPORT FLUXES: EXPLICIT COMPUTATION.
    ! ---------------------------

  DO JLEV=ITOP,KLEV
     DO JLON=KIDIA,KFDIA
        ! REPLACE THE UPDRAFT VALUES BY THE DIFFERENCE (PSI-PSI_U)
        PSTACK (JLON, IPSTPT_ZQU+JLEV-(1))=(PQ(JLON,JLEV)-PQU(JLON,JLEV))
        PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))=(PSTACK (JLON, IPSTPT_ZDSE+JLEV-(1))-&
        &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1)))
        PSTACK (JLON, IPSTPT_ZTU+JLEV-(1))=(PSTACK (JLON, IPSTPT_ZT+JLEV-(1))- &
        & PTU(JLON,JLEV))*(RATM/PAPRSF(JLON,JLEV))**RKAPPA
        PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))=PU(JLON,JLEV)-&
        &  PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))
        PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))=PV(JLON,JLEV)-&
        &  PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))
          DO JTRA=1, KTRA
             PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1))) = PTRA(JLON, &
             & JLEV,JTRA) -                                                      &
             &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))
          ENDDO
     ENDDO
  ENDDO

    ! cdir unroll=8
    DO JLEV=ITOP,KLEV-1
       DO JLON=KIDIA,KFDIA
          PSTACK (JLON, IPSTPT_ZDIFCS_UD_NOCORR_DIAG+JLEV-(0))=ZGDTI*&
          &  PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0)) *0.5_JPRB*(        &
          &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))+                     &
          &  PSTACK (JLON, IPSTPT_ZSU+JLEV+1-(1)))
          IF (YRPHY0%NPRONI == 1) THEN  
             ZAUX=PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0))/(1._JPRB+&
             &  PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0))/PDELP(JLON,JLEV))
          ELSEIF (YRPHY0%NPRONI == 2) THEN  
             ZAUX=MIN(PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0)),YRPHY0%GPRONI*PDELP(&
             & JLON,JLEV))
          ELSE   
             ZAUX=PSTACK (JLON, IPSTPT_ZFORU+JLEV-(0))
          ENDIF   
          PDIFCQ(JLON,JLEV)=ZGDTI*ZAUX*0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZQU+JLEV-(1))+ &
          &  PSTACK (JLON, IPSTPT_ZQU+JLEV+1-(1)))
          PDIFCS(JLON,JLEV)=ZGDTI*ZAUX*0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))+ &
          &  PSTACK (JLON, IPSTPT_ZSU+JLEV+1-(1)))
          PDIFCTH(JLON,JLEV)=ZGDTI*ZAUX*0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZTU+JLEV-(1))+  &
          &  PSTACK (JLON, IPSTPT_ZTU+JLEV+1-(1)))
          PSTRCU(JLON,JLEV)=ZGDTI*ZAUX*0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))+ &
          &  PSTACK (JLON, IPSTPT_ZUM+JLEV+1-(1)))
          PSTRCV(JLON,JLEV)=ZGDTI*ZAUX*0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))+ &
          &  PSTACK (JLON, IPSTPT_ZVM+JLEV+1-(1)))
          DO JTRA=1,KTRA
            PSTRCTRA(JLON,JLEV,JTRA)=ZGDTI*ZAUX*0.5_JPRB*(            &
            &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))+&
            &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV+1-(1)+(KLEV)*(JTRA-(1))))
          ENDDO
       ENDDO
    ENDDO

    IF (YRPHY0%LGDDD) THEN
    DO JLEV=ITOP,KLEV
       DO JLON=KIDIA,KFDIA
          ! REPLACE THE DOWNDRAFT VALUES BY THE DIFFERENCE (PSI-PSI_D)
          PSTACK (JLON, IPSTPT_ZQU+JLEV-(1))=(PQ(JLON,JLEV)-&
          &  PSTACK (JLON, IPSTPT_ZQN2D+JLEV-(1)))
          PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))=(   &
          &  PSTACK (JLON, IPSTPT_ZDSE+JLEV-(1))-&
          &  PSTACK (JLON, IPSTPT_ZSN2D+JLEV-(1)))
          PSTACK (JLON, IPSTPT_ZTU+JLEV-(1))=(PSTACK (JLON, IPSTPT_ZT+JLEV-(1))-&
          &  PSTACK (JLON, IPSTPT_ZTN2D+JLEV-(1)))*(RATM/PAPRSF(JLON,JLEV))**   &
          & RKAPPA
          PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))=(PU(JLON,JLEV)-&
          &  PSTACK (JLON, IPSTPT_ZUMD+JLEV-(1)))
          PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))=(PV(JLON,JLEV)-&
          &  PSTACK (JLON, IPSTPT_ZVMD+JLEV-(1)))
          DO JTRA=1,KTRA
            PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))=(PTRA(JLON,  &
            & JLEV,JTRA)-PSTACK (JLON, IPSTPT_ZTRAMD+JLEV-(1)+(KLEV)*(JTRA-(1)))&
            &  )
          ENDDO
       ENDDO
    ENDDO
    DO JLEV=ITOP,KLEV-1
       DO JLON=KIDIA,KFDIA
          PSTACK (JLON, IPSTPT_ZDIFCS_DD_NOCORR_DIAG+JLEV-(0))=ZGDTI*&
          &  PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0)) *0.5_JPRB*(        &
          &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))+                     &
          &  PSTACK (JLON, IPSTPT_ZSU+JLEV+1-(1)))
          IF (YRPHY0%NPRONI == 1) THEN  
            ZAUX=PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0))/(1._JPRB+&
            &  PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0))/PDELP(JLON,JLEV))
          ELSEIF (YRPHY0%NPRONI == 2) THEN  
            ZAUX=MIN(PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0)),YRPHY0%GPRONI*PDELP(&
            & JLON,JLEV))
          ELSE
            ZAUX=PSTACK (JLON, IPSTPT_ZFORD+JLEV-(0))
          ENDIF   
          PDIFCQ(JLON,JLEV)=PDIFCQ(JLON,JLEV)-ZGDTI*ZAUX *0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZQU+JLEV-(1))+                    &
          &  PSTACK (JLON, IPSTPT_ZQU+JLEV+1-(1)))
          PDIFCS(JLON,JLEV)=PDIFCS(JLON,JLEV)-ZGDTI*ZAUX *0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))+                    &
          &  PSTACK (JLON, IPSTPT_ZSU+JLEV+1-(1)))
          PDIFCTH(JLON,JLEV)=PDIFCTH(JLON,JLEV)-ZGDTI*ZAUX *0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZTU+JLEV-(1))+                      &
          &  PSTACK (JLON, IPSTPT_ZTU+JLEV+1-(1)))
          PSTACK (JLON, IPSTPT_ZDIFCS_DD_DIAG+JLEV-(0))=-ZGDTI*ZAUX*0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZSU+JLEV-(1))+                              &
          &  PSTACK (JLON, IPSTPT_ZSU+JLEV+1-(1)))
          PSTRCU(JLON,JLEV)=PSTRCU(JLON,JLEV)-ZGDTI*ZAUX*0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))+                   &
          &  PSTACK (JLON, IPSTPT_ZUM+JLEV+1-(1)))
          PSTRCV(JLON,JLEV)=PSTRCV(JLON,JLEV)-ZGDTI*ZAUX*0.5_JPRB*(&
          &  PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))+                   &
          &  PSTACK (JLON, IPSTPT_ZVM+JLEV+1-(1)))
          DO JTRA=1,KTRA
            PSTRCTRA(JLON,JLEV,JTRA)= PSTRCTRA(JLON,JLEV,JTRA) -ZGDTI*ZAUX*0.5_JPRB&
            &  *(PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))+           &
            &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV+1-(1)+(KLEV)*(JTRA-(1))))
          ENDDO
       ENDDO
    ENDDO
    ENDIF  !LGDDD

  ENDIF ! LCVIMPT.

  ! // SETTING ALL RESULTS TO ZERO IN CASE OF NEGATIVE PRECIPITATIONS AT
  ! // THE SURFACE OR OF "KNND" ALREADY ZERO.

  DO JLON=KIDIA,KFDIA
    ZZVAL=PFCCQL(JLON,KLEV)+PFCCQI(JLON,KLEV)-YRPHY0%SCO
    KNND(JLON)=KNND(JLON)*MAX(0.0_JPRB,-SIGN(1.0_JPRB,-ZZVAL))
  ENDDO

  IF(YRPHY0%LCVNAUV) THEN
    ! RECOMPUTE PSTRCU AND PSTRCV FROM AN IDEA INSPIRED BY FRANCOIS BOUYSSEL (2012-08-01) AND 3MT.
    DO JLON=KIDIA,KFDIA
     PSTACK (JLON, IPSTPT_ZNND)=1.0_JPRB-REAL(KNLAB(JLON,KLEV))
     PSTACK (JLON, IPSTPT_ZI1+KLEV-(1))=REAL(KNLAB(JLON,KLEV))
     PSTACK (JLON, IPSTPT_ZUM+KLEV-(1))=PU(JLON,KLEV)
     PSTACK (JLON, IPSTPT_ZVM+KLEV-(1))=PV(JLON,KLEV)
     PSTACK (JLON, IPSTPT_ZBET+KLEV-(1))=REAL(KNLAB(JLON,KLEV))
     PSTACK (JLON, IPSTPT_ZA13+KLEV-(1))=PU(JLON,KLEV)
     PSTACK (JLON, IPSTPT_ZA14+KLEV-(1))=PV(JLON,KLEV)
     DO JTRA=1,KTRA
       PSTACK (JLON, IPSTPT_ZTRAM+KLEV-(1)+(KLEV)*(JTRA-(1)))=PTRA(JLON,KLEV,&
       & JTRA)
       PSTACK (JLON, IPSTPT_ZA15+KLEV-(1)+(KLEV)*(JTRA-(1)))=PTRA(JLON,KLEV,JTRA&
       & )
     ENDDO
    ENDDO
    DO JLEV=KLEV-1,ITOP,-1
     DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZI1+JLEV-(1))=REAL(KNLAB(JLON,JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZNND))
      PSTACK (JLON, IPSTPT_ZNND)=MIN(PSTACK (JLON, IPSTPT_ZNND),1.0_JPRB-REAL( &
      & KNLAB(JLON,JLEV)))
      ZBAS=REAL(KNLAB(JLON,JLEV)*(1.0_JPRB-REAL(KNLAB(JLON,JLEV+1))),JPRB)
      ZNBA=REAL(KNLAB(JLON,JLEV)*KNLAB(JLON,JLEV+1),JPRB)
      ZMIX=PSTACK (JLON, IPSTPT_ZRMIX+JLEV-(1))
      PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))= ZNBA*&
      &  PSTACK (JLON, IPSTPT_ZBET+JLEV+1-(1))*(1.0_JPRB-ZMIX)+ZBAS
      PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))=(PSTACK (JLON, IPSTPT_ZUM+JLEV+1-(1)) +  &
      &  (ZMIX*(PU(JLON,JLEV+1)-PSTACK (JLON, IPSTPT_ZUM+JLEV+1-(1))) +YRPHY0%    &
      & TUDGP*(PU(JLON,JLEV)-PU(JLON,JLEV+1))) / (1.0_JPRB-                       &
      &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))+ZBAS) )*ZNBA +PU(JLON,JLEV)*(1.0_JPRB&
      &  -ZNBA)
      PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))=(PSTACK (JLON, IPSTPT_ZVM+JLEV+1-(1)) +  &
      &  (ZMIX*(PV(JLON,JLEV+1)-PSTACK (JLON, IPSTPT_ZVM+JLEV+1-(1))) +YRPHY0%    &
      & TUDGP*(PV(JLON,JLEV)-PV(JLON,JLEV+1))) / (1.0_JPRB-                       &
      &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))+ZBAS) )*ZNBA +PV(JLON,JLEV)*(1.0_JPRB&
      &  -ZNBA)
      PSTACK (JLON, IPSTPT_ZA13+JLEV-(1))=PSTACK (JLON, IPSTPT_ZA13+JLEV+1-(1))*&
      &  ZNBA+PU(JLON,JLEV)*ZBAS
      PSTACK (JLON, IPSTPT_ZA14+JLEV-(1))=PSTACK (JLON, IPSTPT_ZA14+JLEV+1-(1))*&
      &  ZNBA+PV(JLON,JLEV)*ZBAS
      DO JTRA=1,KTRA
        PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))=(                &
        &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV+1-(1)+(KLEV)*(JTRA-(1))) +(ZMIX*(PTRA&
        &  ( JLON,JLEV+1,JTRA)-                                                 &
        &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV+1-(1)+(KLEV)*(JTRA-(1)))) +YRPHY0%   &
        & TUDGP*(PTRA(JLON,JLEV,JTRA)-PTRA(JLON,JLEV+1,JTRA))) / (1.0_JPRB-     &
        &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))+ZBAS) )*ZNBA +PTRA(JLON,JLEV,JTRA&
        &  ) *(1.0_JPRB-ZNBA)
        PSTACK (JLON, IPSTPT_ZA15+JLEV-(1)+(KLEV)*(JTRA-(1)))=               &
        &  PSTACK (JLON, IPSTPT_ZA15+JLEV+1-(1)+(KLEV)*(JTRA-(1)))*ZNBA+PTRA(&
        & JLON, JLEV,JTRA)*ZBAS
      ENDDO
     ENDDO
    ENDDO
    DO JLEV=ITOP,KLEV
     DO JLON=KIDIA,KFDIA
      ZZ=1.0_JPRB-PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))
      PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))=ZZ*PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))+&
      &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))*PSTACK (JLON, IPSTPT_ZA13+JLEV-(1))
      PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))=ZZ*PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))+&
      &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))*PSTACK (JLON, IPSTPT_ZA14+JLEV-(1))
      PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))=PU(JLON,JLEV)-&
      &  PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))
      PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))=PV(JLON,JLEV)-&
      &  PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))
      DO JTRA=1,KTRA
        PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))=ZZ*&
        &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))+&
        &  PSTACK (JLON, IPSTPT_ZBET+JLEV-(1))*                   &
        &  PSTACK (JLON, IPSTPT_ZA15+JLEV-(1)+(KLEV)*(JTRA-(1)))
        PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))=PTRA(JLON,JLEV, &
        & JTRA)-PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))
      ENDDO
     ENDDO
    ENDDO
    DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZNND) = 1.0_JPRB
ENDDO

    DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTRCU(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

    DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTRCV(JLON,JLEV) = 0._JPRB
ENDDO
ENDDO

    DO JTRA = 1, KTRA
DO JLEV = 0, KLEV
DO JLON = KIDIA, KFDIA
PSTRCTRA(JLON,JLEV,JTRA) = 0._JPRB
ENDDO
ENDDO
ENDDO

    DO JLEV=ITOP,KLEV-1
     DO JLON=KIDIA,KFDIA
      PSTACK (JLON, IPSTPT_ZNND) = MIN(PSTACK (JLON, IPSTPT_ZNND),1.0_JPRB-&
      &  PSTACK (JLON, IPSTPT_ZI1+JLEV-(1)))
      ZZ=(PAPRS(JLON,KLEV)-PAPRS(JLON,JLEV)) &
      & /(PAPRS(JLON,KLEV)-PAPRS(JLON,JLEV-1))
      ZAUX=YRPHY0%TVFC*PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))/(PDELP(JLON,JLEV)+ &
      & YRPHY0%TVFC*PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0)))
      ZDPSGDT=PDELP(JLON,JLEV)*ZGDTI*0.5_JPRB
      PSTRCU(JLON,JLEV)=PSTACK (JLON, IPSTPT_ZNND)*ZAUX*( PSTRCU(JLON,JLEV-1)+  &
      & ZDPSGDT*(PSTACK (JLON, IPSTPT_ZUM+JLEV-(1))+                            &
      &  PSTACK (JLON, IPSTPT_ZUM+JLEV+1-(1))) )+ (1.0_JPRB-                    &
      &  PSTACK (JLON, IPSTPT_ZNND))*PSTRCU(JLON,JLEV-1)*ZZ
      PSTRCV(JLON,JLEV)=PSTACK (JLON, IPSTPT_ZNND)*ZAUX*( PSTRCV(JLON,JLEV-1)+  &
      & ZDPSGDT*(PSTACK (JLON, IPSTPT_ZVM+JLEV-(1))+                            &
      &  PSTACK (JLON, IPSTPT_ZVM+JLEV+1-(1))) )+ (1.0_JPRB-                    &
      &  PSTACK (JLON, IPSTPT_ZNND))*PSTRCV(JLON,JLEV-1)*ZZ
      DO JTRA=1,KTRA
        PSTRCTRA(JLON,JLEV,JTRA)=PSTACK (JLON, IPSTPT_ZNND)*ZAUX*( PSTRCTRA(JLON, &
        & JLEV-1,JTRA)+ ZDPSGDT*(                                                 &
        &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV-(1)+(KLEV)*(JTRA-(1)))+                &
        &  PSTACK (JLON, IPSTPT_ZTRAM+JLEV+1-(1)+(KLEV)*(JTRA-(1)))) )+ (1.0_JPRB &
        &  -PSTACK (JLON, IPSTPT_ZNND))*PSTRCTRA(JLON,JLEV-1,JTRA)*ZZ
      ENDDO
     ENDDO
    ENDDO
  ENDIF

  ! ------------------------------------------------------------------
  ! BEFORE LEAVING
  ! - LEAVE IN PUDOM THE RELATIVE UPDRAFT VELOCITY FOR ADVECTION
  ! - RESET ALL FLUXES TO ZERO WHERE KNND IS
  ! AND ALSO RESET PUDOM AND PUDAL
  ! ------------------------------------------------------------------

  DO JLEV=ITOP,KLEV
    DO JLON=KIDIA,KFDIA
      PFPLCL(JLON,JLEV)=KNND(JLON)*PFPLCL(JLON,JLEV)
      PFPLCN(JLON,JLEV)=KNND(JLON)*PFPLCN(JLON,JLEV)
      PDIFCQ(JLON,JLEV)=KNND(JLON)*PDIFCQ(JLON,JLEV)
      PDIFCQL(JLON,JLEV)=KNND(JLON)*PDIFCQL(JLON,JLEV)
      PDIFCQI(JLON,JLEV)=KNND(JLON)*PDIFCQI(JLON,JLEV)
      PDIFCS(JLON,JLEV)=KNND(JLON)*PDIFCS(JLON,JLEV)
      PDIFCTH(JLON,JLEV)=KNND(JLON)*PDIFCTH(JLON,JLEV)
      PSTRCU(JLON,JLEV)=KNND(JLON)*PSTRCU(JLON,JLEV)
      PSTRCV(JLON,JLEV)=KNND(JLON)*PSTRCV(JLON,JLEV)
      PFCCQL(JLON,JLEV)=KNND(JLON)*PFCCQL(JLON,JLEV)
      PFCCQI(JLON,JLEV)=KNND(JLON)*PFCCQI(JLON,JLEV)
      PFPEVPCL(JLON,JLEV)=KNND(JLON)*PFPEVPCL(JLON,JLEV)
      PFPEVPCN(JLON,JLEV)=KNND(JLON)*PFPEVPCN(JLON,JLEV)
      PFHEVPP(JLON,JLEV)=KNND(JLON)*PFHEVPP(JLON,JLEV)
      PFHMLTS(JLON,JLEV)=KNND(JLON)*PFHMLTS(JLON,JLEV)
      DO JTRA=1,KTRA
        PSTRCTRA(JLON,JLEV,JTRA)=KNND(JLON)*PSTRCTRA(JLON,JLEV,JTRA)
      ENDDO
    ENDDO
  ENDDO

  DO JLEV=KTDIA,KLEV
    DO JLON=KIDIA,KFDIA
      KNLAB(JLON,JLEV)=KNND(JLON)*KNLAB(JLON,JLEV)
      PQLIC(JLON,JLEV)=KNND(JLON)*PQLIC(JLON,JLEV)*YRPHY0%FQLIC*PNEBC(JLON,JLEV)*KNLAB(JLON,JLEV)
      PNEBC(JLON,JLEV)=KNND(JLON)*MAX(ZEPS0,MIN(ZNEBCX,PNEBC(JLON,JLEV)*YRPHY0%FNEBC&
      &*NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-PQLIC(JLON,JLEV)+0.0_JPRB)))))
    ENDDO
  ENDDO

  DO JLEV=ITOP,KLEV
!DEC$ IVDEP
    DO JLON=KIDIA,KFDIA
      PUDAL(JLON,JLEV)=KNND(JLON)*PUDAL(JLON,JLEV)
      PDDAL(JLON,JLEV)=KNND(JLON)*PDDAL(JLON,JLEV)

      IF(.NOT.YRPHY0%LCVNHD) THEN
      ! VERTICAL VELOCITY IN M/S COMPUTED FROM VERTICAL VELOCITY IN PA/S.
        PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))=-PUDOM(JLON,JLEV)*PR(JLON,JLEV)*&
        &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/(PAPRSF(JLON,JLEV)*RG)
        PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))=-PDDOM(JLON,JLEV)*PR(JLON,JLEV)*&
        &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/(PAPRSF(JLON,JLEV)*RG)
      ENDIF

      KSTACK (JLON, IKSTPT_IQLIC)=NINT(MAX(0.0_JPRB,-SIGN(1.0_JPRB,-PQLIC(JLON,&
      & JLEV)+0.0_JPRB)))
      ! ENTRAINMENT/DETRAINMENT (IN S**-1).
      PENTR_U(JLON,JLEV)=PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))*PUDAL(JLON,JLEV)*&
      &  PSTACK (JLON, IPSTPT_ZEPSILON_U+JLEV-(1))*KSTACK (JLON, IKSTPT_IQLIC)
      PDETR_U(JLON,JLEV)=KNLAB(JLON,JLEV)*PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))*    &
      & PUDAL(JLON,JLEV)*PSTACK (JLON, IPSTPT_ZDELTA_U+JLEV-(1)) +(1-KNLAB(JLON, &
      & JLEV))*YRPHY0%GCVENTR_MIN
      PENTR_D(JLON,JLEV)=-PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))*PDDAL(JLON,JLEV) *(&
      &  PSTACK (JLON, IPSTPT_ZEPS_ORGD+JLEV-(1))*PAPRSF(JLON,JLEV) /(PR(JLON,  &
      & JLEV)*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))+ZENTRX)*RG*                    &
      &  KSTACK (JLON, IKSTPT_IQLIC)*YRPHY0%GCVFRR
      PDETR_D(JLON,JLEV)=-PSTACK (JLON, IPSTPT_ZWD+JLEV-(1))*PDDAL(JLON,JLEV) *(&
      &  PSTACK (JLON, IPSTPT_ZDEL_ORGD+JLEV-(1))*PAPRSF(JLON,JLEV)/(PR(JLON,   &
      & JLEV )*PSTACK (JLON, IPSTPT_ZT+JLEV-(1)))+ZENTRX)*RG*YRPHY0%GCVFRR
    ENDDO
  ENDDO

  ! -------------------------------------------------
  ! NUMERICAL VERTICAL FILTER OF TRANSPORT FLUXES
  ! TO AVOID 2-VERTICAL-LEVELS INSTABILITY.
  ! -------------------------------------------------

  ZA=0.5_JPRB
  ZA2=ZA*0.5_JPRB
  DO JLEV=KLEV-1,ITOP,-1
    DO JLON=KIDIA,KFDIA
       PDIFCQ(JLON,JLEV)=(1._JPRB-ZA)*PDIFCQ(JLON,JLEV)+ZA2*(PDIFCQ(JLON,JLEV-1)+PDIFCQ(JLON,JLEV+1))
       PDIFCQI(JLON,JLEV)=(1._JPRB-ZA)*PDIFCQI(JLON,JLEV)+ZA2*(PDIFCQI(JLON,JLEV-1)+PDIFCQI(JLON,JLEV+1))
       PDIFCQL(JLON,JLEV)=(1._JPRB-ZA)*PDIFCQL(JLON,JLEV)+ZA2*(PDIFCQL(JLON,JLEV-1)+PDIFCQL(JLON,JLEV+1))
       PDIFCS(JLON,JLEV)=(1._JPRB-ZA)*PDIFCS(JLON,JLEV)+ZA2*(PDIFCS(JLON,JLEV-1)+PDIFCS(JLON,JLEV+1))
       PDIFCTH(JLON,JLEV)=(1._JPRB-ZA)*PDIFCTH(JLON,JLEV)+ZA2*(PDIFCTH(JLON,JLEV-1)+PDIFCTH(JLON,JLEV+1))
       PSTRCU(JLON,JLEV)=(1._JPRB-ZA)*PSTRCU(JLON,JLEV)+ZA2*(PSTRCU(JLON,JLEV-1)+PSTRCU(JLON,JLEV+1))
       PSTRCV(JLON,JLEV)=(1._JPRB-ZA)*PSTRCV(JLON,JLEV)+ZA2*(PSTRCV(JLON,JLEV-1)+PSTRCV(JLON,JLEV+1))
       DO JTRA=1,KTRA
         PSTRCTRA(JLON,JLEV,JTRA)=(1._JPRB-ZA)*PSTRCTRA(JLON,JLEV,JTRA)+ZA2*(PSTRCTRA(JLON,JLEV-1,JTRA)+&
                                 & PSTRCTRA(JLON,JLEV+1,JTRA))
       ENDDO
    ENDDO
  ENDDO

  DO JLEV=ITOP,KLEV-1
    DO JLON=KIDIA,KFDIA
       PMF_UP(JLON,JLEV)=ZGDTI*PSTACK (JLON, IPSTPT_ZFORM+JLEV-(0))  ! "mass flux" for implicit formulation
    ENDDO
  ENDDO
ENDIF ! IF ITOP < KLEV+1

!
!-------------------------------------------------
! Momentum is not transported as thermodynamic variables (theta, qt).
!-------------------------------------------------
!
DO JLEV=KTDIA,KLEV
  DO JLON=KIDIA,KFDIA
    PSTRCU(JLON,JLEV)=YRPHY0%GCVUV*PSTRCU(JLON,JLEV)
    PSTRCV(JLON,JLEV)=YRPHY0%GCVUV*PSTRCV(JLON,JLEV)
  ENDDO
ENDDO


!----------------------------------------------------------------
! ERASE PCAPE COMPUTED PREVIOUSLY IF NCAPEMOD DIFFERENT FROM 0 :
!----------------------------------------------------------------
! NCAPEMOD.EQ.0 : the previous value of PCAPE is retained
! NCAPEMOD.EQ.1 : call FPCINCAPE  with the mask "KNND(JLON)=1"
! NCAPEMOD.EQ.2 : call FPCINCAPE  with the mask "ZDIAG_WMAX>WCAPEMOD"
!
IF (YRPHY0%NCAPEMOD /= 0) THEN
  !
  !- - - - - - - - - - - - - - -
  ! Set the "SBCAPE" to zero :
  !- - - - - - - - - - - - - - -
  DO JLON = KIDIA, KFDIA
  PCAPE(JLON)=0.0_JPRB
  ENDDO
  !
  !- - - - - - - - - - - - - - - - - - - - -
  ! Compute the "SBCAPE" for the parcel at 
  ! the lowest atmospheric model level :
  !- - - - - - - - - - - - - - - - - - - - -
  CALL FPCINCAPE(KIDIA,KFDIA,KLON,KLEV,KLEV, PT,PAPRSF,PQ,PCAPE,             &
  & PSTACK (1, IPSTPT_ZCIN),KSTACK (1, IKSTPT_ILCL),KSTACK (1, IKSTPT_IFCL), &
  & KSTACK (1, IKSTPT_IEL), KSTACK, PSTACK, KPSTSZ, KKSTSZ, IPSTPT, IKSTPT)
  !
  !- - - - - - - - - - - - - - - - - - - - - - -
  ! This "SBCAPE" is set to zero where PCMT is 
  ! "inactive" :
  !- - - - - - - - - - - - - - - - - - - - - - -
  IF (YRPHY0%NCAPEMOD == 1) THEN
    ! "inactive" if : KNND(JLON)=0.0
    DO JLON=KIDIA,KFDIA
      PCAPE(JLON)=MAX(0._JPRB,PCAPE(JLON)) * &
      &           FLOAT(KNND(JLON))
    ENDDO
  ELSEIF (YRPHY0%NCAPEMOD == 2) THEN
    ! "inactive" if : ZDIAG_WMAX(JLON) < WCAPEMOD
    DO JLON=KIDIA,KFDIA
      PCAPE(JLON)=MAX(0._JPRB,PCAPE(JLON)) * MAX(0._JPRB,SIGN(1._JPRB, &
      & PSTACK (JLON, IPSTPT_ZDIAG_WMAX)-YRPHY0%WCAPEMOD))
    ENDDO
  ENDIF
  !
ENDIF ! NCAPEMOD



END SUBROUTINE ACMTUD

