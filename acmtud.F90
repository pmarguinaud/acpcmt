#include "attr.h"
SUBROUTINE ACMTUD ( KIDIA,KFDIA,KLON,KTDIA,KLEV,KTRA,&
!-----------------------------------------------------------------------
! - INPUT  2D .
& PAPRSF,&
& PR,&
& PT,&
& PQLIC,&
& PUDOM,&
& KSTACK, &
& PSTACK, &
& KPSTSZ, &
& KKSTSZ, &
& KPSTPT, &
& KKSTPT)

USE PARKIND1, ONLY : JPIM, JPRB

USE YOMCST   , ONLY : RG    
USE YOMPHY0  , ONLY : YRPHY0


IMPLICIT NONE

!     DUMMY ARGUMENTS.

INTEGER(KIND=JPIM), INTENT(IN) :: KFDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KIDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KLEV
INTEGER(KIND=JPIM), INTENT(IN) :: KLON
INTEGER(KIND=JPIM), INTENT(IN) :: KTDIA
INTEGER(KIND=JPIM), INTENT(IN) :: KTRA

REAL(KIND=JPRB), INTENT(IN)    :: PAPRSF(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PR(KLON,KLEV)
REAL(KIND=JPRB), INTENT(IN)    :: PT(KLON,KLEV)
REAL(KIND=JPRB), INTENT(OUT)   :: PQLIC(KLON,KLEV)
REAL(KIND=JPRB), INTENT(INOUT) :: PUDOM(KLON,KLEV)
REAL(KIND=JPRB),   INTENT(OUT)   :: PSTACK (KLON, KPSTSZ)
INTEGER(KIND=JPIM),INTENT(OUT)   :: KSTACK (KLON, KKSTSZ)
INTEGER(KIND=JPIM),INTENT(IN)    :: KPSTSZ, KKSTSZ, KPSTPT, KKSTPT

! LOCALS.

INTEGER(KIND=JPIM) :: JLEV, JLON


INTEGER(KIND=JPIM) :: IPSTPT_ZT

INTEGER(KIND=JPIM) :: IPSTPT_ZPREVIOUST

INTEGER(KIND=JPIM) :: IPSTPT_ZDIAG_WMAX

INTEGER(KIND=JPIM) :: IPSTPT_ZWU

INTEGER(KIND=JPIM) :: IPSTPT, IKSTPT


IPSTPT = KPSTPT

IKSTPT = KKSTPT

IPSTPT_ZWU = IPSTPT

IPSTPT = IPSTPT + KLEV+1

IPSTPT_ZDIAG_WMAX = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZPREVIOUST = IPSTPT

IPSTPT = IPSTPT + 1

IPSTPT_ZT = IPSTPT

IPSTPT = IPSTPT + KLEV

DO JLEV = 1, KLEV+1
DO JLON = KIDIA, KFDIA
PSTACK (JLON, IPSTPT_ZWU+JLEV-(1)) = 0._JPRB
ENDDO
ENDDO

DO JLON=KIDIA,KFDIA
  PSTACK (JLON, IPSTPT_ZPREVIOUST)=PT(JLON,KTDIA)
ENDDO

DO JLEV=KTDIA,KLEV
  DO JLON=KIDIA,KFDIA
    PSTACK (JLON, IPSTPT_ZT+JLEV-(1))=MIN(PT(JLON,JLEV),&
    &  PSTACK (JLON, IPSTPT_ZPREVIOUST)+YRPHY0%GINSTX)
    PSTACK (JLON, IPSTPT_ZPREVIOUST)=PSTACK (JLON, IPSTPT_ZT+JLEV-(1))

    PSTACK (JLON, IPSTPT_ZWU+JLEV-(1))=-PUDOM(JLON,JLEV)*PR(JLON,JLEV)*&
    &  PSTACK (JLON, IPSTPT_ZT+JLEV-(1))/(PAPRSF(JLON,JLEV)*RG)

  ENDDO
ENDDO

DO JLEV=KTDIA,KLEV
  DO JLON=KIDIA,KFDIA

    PSTACK (JLON, IPSTPT_ZDIAG_WMAX)=MAX(PSTACK (JLON, IPSTPT_ZDIAG_WMAX), &
    & PSTACK (JLON, IPSTPT_ZWU+JLEV-(1)))
    PQLIC (JLON,JLEV) = PSTACK (JLON, IPSTPT_ZDIAG_WMAX)

  ENDDO
ENDDO

END SUBROUTINE
